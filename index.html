<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Adjustable Gantt Chart</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    /* TEMPORARY: test font TT Norms® Pro Regular — replace with production font when final typeface is chosen */
    @font-face {
      font-family: 'TT Norms Pro';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('TT Norms Pro Trial 4-000/TTNormsPro-Regular.woff2') format('woff2'),
           url('TT Norms Pro Trial 4-000/TTNormsPro-Regular.woff') format('woff');
    }
    :root {
      /* Motion — reusable across pages and elements */
      --motion-duration-fast: 150ms;
      --motion-duration-normal: 200ms;
      --motion-duration-slow: 280ms;
      --motion-easing: ease-out;
      --motion-easing-emphasis: cubic-bezier(0.2, 0, 0, 1);
      --motion-easing-decelerate: cubic-bezier(0, 0, 0.2, 1);
      --button-radius: 999px;
      --input-radius: 6px;
      --color-general-primary: #171717;
      --color-general-primary-hover: #262626;
      --color-general-primary-active: #0a0a0a;
      --bg-body: #fafafa;
      --bg-surface: #fff;
      --bg-hover: #f5f5f5;
      --row-bg-default: #ffffff;
      --row-bg-hover: #fafafa;
      --row-bg-selected: #fafafa;
      --text-primary: #171717;
      --text-secondary: #525252;
      --text-tertiary: #737373;
      --border-default: #ebebeb;
      --border-strong: #e5e5e5;
      --border-subtle: #f0f0f0;
      --bg-subtle: #f5f5f5;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --color-general-primary: #fafafa;
        --color-general-primary-hover: #f5f5f5;
        --color-general-primary-active: #ffffff;
        --bg-body: #121212;
        --bg-surface: #1a1a1a;
        --bg-hover: #262626;
        --row-bg-default: #1a1a1a;
        --row-bg-hover: #121212;
        --row-bg-selected: #121212;
        --bg-subtle: #0d0d0d;
        --text-primary: #fafafa;
        --text-secondary: #737373;
        --text-tertiary: #525252;
        --border-default: #1f1f1f;
        --border-strong: #2e2e2e;
        --border-subtle: #1a1a1a;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
      }
    }
    /* Motion utilities — use for cohesive transitions */
    .motion-fast { transition-duration: var(--motion-duration-fast); transition-timing-function: var(--motion-easing); }
    .motion-normal { transition-duration: var(--motion-duration-normal); transition-timing-function: var(--motion-easing); }
    .motion-slow { transition-duration: var(--motion-duration-slow); transition-timing-function: var(--motion-easing-decelerate); }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
      background: var(--bg-body);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
    }
    @media (max-width: 480px) and (orientation: portrait) {
      body { padding-left: 8px; padding-right: 8px; overflow-x: hidden; }
      #ganttView { width: 100%; max-width: 100vw; box-sizing: border-box; }
    }
    body.gantt-view-active { padding-left: 0; padding-right: 0; }
    #ganttView.active { width: 100%; display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; }
    #ganttView.active .page-header,
    #ganttView.active .home-back-link { padding-left: 24px; padding-right: 24px; }
    #ganttView.active .collaborators-avatar-bar { padding-left: 24px; padding-right: 24px; }
    /* TEMPORARY: headers use TT Norms Pro (test font) */
    h1, h2 {
      font-family: 'TT Norms Pro', 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    }
    h1 {
      font-size: 32px;
      font-weight: 400;
      line-height: 1.3;
      letter-spacing: -0.02em;
      margin: 0 0 4px 0;
    }
    .subtitle {
      font-size: 14px;
      font-weight: 400;
      color: var(--text-secondary);
      margin: 0;
      max-width: 640px;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }
    .gantt-wrapper {
      position: relative;
      background: var(--bg-surface);
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      flex: 1;
      min-height: 0;
      min-width: 0;
      width: 100%;
      container-type: inline-size;
      container-name: gantt;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }
    .gantt-grid {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .gantt-cell {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border-default);
      border-right: 1px solid var(--border-default);
      min-height: 36px;
      color: var(--text-primary);
    }
    .gantt-cell:last-child { border-right: none; }
    .gantt-row:not(.gantt-header) .gantt-cell {
      background: var(--row-bg-default);
    }
    .gantt-row .gantt-cell:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 10002;
    }
    .gantt-row:not(.gantt-header) .gantt-cell:nth-child(1) {
      background-color: var(--row-bg-default, #ffffff);
    }
    .gantt-header .gantt-cell:nth-child(1) {
      background-color: var(--bg-subtle, #f5f5f5);
    }
    .phase-header-row > .phase-header-cell:first-child {
      position: sticky;
      left: 0;
      z-index: 10002;
      background-color: transparent;
    }
    .gantt-header {
      background: var(--bg-subtle, #f5f5f5);
      color: var(--text-primary, #171717);
      font-weight: 600;
      font-size: 12px;
      letter-spacing: -0.01em;
      text-transform: none;
    }
    .gantt-header .gantt-cell {
      border-color: var(--border-subtle);
      color: var(--text-primary, #171717);
      visibility: visible;
    }
    .gantt-header .gantt-cell.week-label {
      color: var(--text-secondary, #525252);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .gantt-header .gantt-cell.week-label .date-month,
    .gantt-header .gantt-cell.week-label .date-day {
      display: block;
    }
    .gantt-header .gantt-cell:nth-child(2),
    .gantt-header .gantt-cell:nth-child(3),
    .gantt-header .gantt-cell:nth-child(4),
    .gantt-header .gantt-cell:nth-child(5) {
      text-align: center;
    }
    /* Week divider lines only in table body, not in date header */
    .gantt-header .gantt-cell:nth-child(n+6) { border-right: none; }
    #ganttHeaderRow.gantt-header {
      grid-template-columns: 200px 100px 140px 120px 88px repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
    }
    .gantt-row {
      display: grid;
      grid-template-columns: 200px 100px 140px 120px 88px repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
      width: 100%;
      min-height: 36px;
      flex-shrink: 0;
      position: relative;
    }
    .gantt-wrapper[data-row-appearance="compact"] .gantt-row:not(.gantt-header) {
      min-height: 36px;
    }
    .gantt-wrapper[data-row-appearance="compact"] .gantt-task-cell .task-name-wrap {
      align-items: flex-start;
      min-height: 0;
    }
    .gantt-wrapper[data-row-appearance="compact"] .gantt-task-cell .task-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
      word-break: break-word;
    }
    .gantt-wrapper[data-row-appearance="default"] .gantt-row:not(.gantt-header) {
      min-height: 84px;
    }
    .gantt-wrapper[data-row-appearance="default"] .gantt-row:not(.gantt-header) .gantt-timeline-cell .gantt-bar {
      height: 40px;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-grid {
      min-height: 100%;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) {
      flex: 1 1 0;
      min-height: 120px;
      align-items: stretch;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-cell {
      padding-top: 16px;
      padding-bottom: 16px;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-task-cell {
      align-items: stretch;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-task-cell .task-name-wrap {
      align-items: center;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-task-cell .task-chevron,
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-task-cell .task-actions {
      align-self: center;
      flex-shrink: 0;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-phase-cell,
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-party-cell,
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-status-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-phase-cell .gantt-phase-dropdown,
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-party-cell .gantt-party-dropdown,
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-status-cell .gantt-party-dropdown {
      flex: 1;
      min-height: 0;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-date-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-date-cell .gantt-date-input-wrap {
      flex: 1;
      min-height: 0;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-row:not(.gantt-header) .gantt-timeline-cell .gantt-bar {
      top: 16px;
      bottom: 16px;
      height: auto;
      transform: none;
      min-height: 24px;
    }
    .gantt-row[draggable="true"] { cursor: grab; }
    .gantt-row:not(.gantt-header):hover .gantt-cell,
    .gantt-row:not(.gantt-header):has(+ .gantt-detail-row:hover) .gantt-cell {
      background: var(--row-bg-hover);
    }
    .gantt-row.selected .gantt-cell {
      background: var(--row-bg-selected);
    }
    .gantt-row.selected:hover .gantt-cell,
    .gantt-row.selected:has(+ .gantt-detail-row:hover) .gantt-cell {
      background: var(--row-bg-selected);
    }
    .gantt-row.dragging { opacity: 0.5; cursor: grabbing; }
    .task-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      padding: 0;
      margin-left: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .gantt-delete-btn,
    .gantt-duplicate-btn {
      width: 20px;
      height: 20px;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .gantt-delete-btn:hover {
      color: #dc2626;
    }
    .gantt-duplicate-btn:hover {
      color: var(--text-primary);
    }
    .gantt-header-delete-cell {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 96px;
      background: inherit;
      z-index: 4;
      grid-column: 1 / -1;
    }
    .gantt-header .gantt-header-delete-cell { background: transparent; }
    .gantt-task-cell { font-weight: 500; font-size: 14px; cursor: pointer; }
    .gantt-task-cell .star { color: #f59e0b; margin-right: 4px; }
    .gantt-task-cell:focus-within { cursor: text; }
    .gantt-task-cell {
      display: flex;
      align-items: center;
    }
    .gantt-task-cell .task-name-wrap { flex: 1; min-width: 0; display: flex; align-items: center; gap: 4px; }
    .gantt-task-cell .task-text { flex: 1; min-width: 0; }
    .task-cell-phase-pill {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      margin-left: auto;
      font-size: 12px;
      color: var(--text-secondary, #737373);
    }
    .task-cell-phase-pill-label { white-space: nowrap; flex-shrink: 0; overflow: visible; }
    .task-in-progress-tag { display: none; }
    .task-cell-phase-pill-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .task-cell-right-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      margin-left: auto;
    }
    @media (min-width: 769px) {
      .task-cell-phase-pill { display: none !important; }
    }
    .task-dependency-icon {
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      color: #737373;
      cursor: help;
      position: relative;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .gantt-row:hover .task-dependency-icon { opacity: 1; }
    .task-dependency-tooltip {
      position: fixed;
      z-index: 100050;
      padding: 8px 12px;
      background: #171717;
      color: #fafafa;
      font-size: 12px;
      line-height: 1.4;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .task-dependency-tooltip.visible { opacity: 1; }
    .custom-tooltip {
      position: fixed;
      z-index: 100100;
      padding: 6px 10px;
      background: var(--text-primary);
      color: var(--bg-body);
      font-size: 12px;
      font-weight: 500;
      line-height: 1.35;
      border-radius: 6px;
      box-shadow: var(--shadow-md);
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s, transform 0.1s;
      max-width: 240px;
      white-space: normal;
      word-wrap: break-word;
    }
    .custom-tooltip.visible { opacity: 1; visibility: visible; }
    .custom-tooltip.measuring { opacity: 0; visibility: hidden; left: 0; top: 0; }
    .detach-confirm-popup {
      position: fixed;
      z-index: 10000;
      padding: 12px 16px;
      background: #171717;
      color: #fafafa;
      font-size: 13px;
      line-height: 1.5;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      max-width: 280px;
      pointer-events: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }
    .detach-confirm-popup.visible { opacity: 1; visibility: visible; }
    .detach-confirm-popup .detach-confirm-msg { margin-bottom: 12px; }
    .detach-confirm-hint {
      font-size: 11px;
      color: var(--text-tertiary);
      margin: 0 0 12px 0;
      line-height: 1.35;
      max-width: 260px;
    }
    .detach-confirm-hint.hidden { display: none; }
    .phase-confirm-hint {
      font-size: 11px;
      color: var(--text-tertiary);
      margin: 0 0 12px 0;
      line-height: 1.35;
      max-width: 260px;
    }
    .detach-confirm-popup .detach-confirm-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .detach-confirm-popup button {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: var(--button-radius);
      border: none;
      cursor: pointer;
      font-family: inherit;
    }
    .detach-confirm-popup .detach-confirm-cancel {
      background: #404040;
      color: #fafafa;
    }
    .detach-confirm-popup .detach-confirm-cancel:hover { background: #525252; }
    .detach-confirm-popup .detach-confirm-detach {
      background: var(--color-general-primary);
      color: #fff;
    }
    .detach-confirm-popup .detach-confirm-detach:hover { background: var(--color-general-primary-hover); }
    .phase-confirm-popup .phase-confirm-keep {
      background: #404040;
      color: #fafafa;
    }
    .phase-confirm-popup .phase-confirm-keep:hover { background: #525252; }
    .phase-confirm-popup .phase-confirm-move {
      background: var(--color-general-primary);
      color: #fff;
    }
    .phase-confirm-popup .phase-confirm-move:hover { background: var(--color-general-primary-hover); }
    @media (prefers-color-scheme: dark) {
      .phase-confirm-popup .phase-confirm-move,
      .detach-confirm-popup .detach-confirm-detach {
        color: #171717;
      }
      .phase-confirm-popup .phase-confirm-move:hover,
      .detach-confirm-popup .detach-confirm-detach:hover {
        color: #171717;
      }
      .share-modal-copy {
        color: #171717;
      }
      .collaborators-avatar,
      .collaborators-dropdown-user-avatar {
        color: #171717;
      }
    }
    .delete-confirm-cancel { background: #404040; color: #fafafa; }
    .delete-confirm-cancel:hover { background: #525252; }
    .delete-confirm-delete { background: #dc2626; color: #fff; }
    .delete-confirm-delete:hover { background: #b91c1c; }
    .phase-select-menu {
      position: fixed;
      z-index: 10000;
      padding: 8px 0;
      background: #171717;
      color: #fafafa;
      font-size: 13px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      min-width: 160px;
      max-width: 240px;
      pointer-events: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }
    .phase-select-menu.visible { opacity: 1; visibility: visible; }
    .phase-select-menu-title {
      padding: 8px 14px 6px;
      font-weight: 600;
      font-size: 12px;
      color: #a3a3a3;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .phase-select-menu-list { display: flex; flex-direction: column; gap: 2px; }
    .phase-select-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #fafafa;
      font-size: 13px;
      font-family: inherit;
      text-align: left;
      width: 100%;
    }
    .phase-select-menu-item:hover { background: rgba(255,255,255,0.06); }
    .phase-select-menu-item .phase-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .gantt-dependency-line {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9998;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .gantt-dependency-line.visible { opacity: 1; z-index: 100001; }
    .gantt-dependency-line path {
      pointer-events: none;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .gantt-dependency-line path:hover { opacity: 1; }
    .gantt-dependency-line .connector-dot {
      pointer-events: none;
      cursor: grab;
      opacity: 0.9;
      transition: fill 0.15s, stroke 0.15s, opacity 0.15s;
    }
    .gantt-dependency-line .connector-dot {
      visibility: hidden;
      pointer-events: none !important;
    }
    .gantt-dependency-line .connector-dot:hover {
      opacity: 1;
      stroke: #171717;
    }
    .gantt-dependency-line .connector-dot.connector-dot-dragging {
      opacity: 1;
      cursor: grabbing;
    }
    .gantt-all-dependency-lines .connector-path:hover { opacity: 1; }
    .gantt-dependency-unlink-btn {
      position: fixed;
      width: 6px;
      height: 6px;
      min-width: 6px;
      min-height: 6px;
      padding: 0;
      box-sizing: border-box;
      border-radius: 50%;
      background: #a3a3a3;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: width 0.2s ease, height 0.2s ease, opacity 0.2s, visibility 0.2s, background 0.2s, border 0.2s, transform 0.2s ease;
      overflow: hidden;
    }
    .gantt-dependency-unlink-btn.visible {
      opacity: 1;
      visibility: visible;
      z-index: 100002;
    }
    body.shift-mode .gantt-dependency-unlink-btn.connector-unlink-always-visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .gantt-dependency-unlink-btn:hover {
      width: 20px;
      height: 20px;
      background: white !important;
      border: 1.5px solid #d4d4d4;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transform: translate(-50%, -50%);
    }
    .gantt-dependency-unlink-btn:active {
      transform: translate(-50%, -50%) scale(0.95);
    }
    .gantt-dependency-unlink-btn svg {
      transition: opacity 0.2s ease, stroke 0.15s;
      width: 10px;
      height: 10px;
      stroke: #262626;
      opacity: 0;
      flex-shrink: 0;
    }
    .gantt-dependency-unlink-btn:hover svg {
      opacity: 1;
      stroke: #dc2626;
    }
    .gantt-connector-count-badge {
      position: fixed;
      z-index: 9999;
      transform: translate(-50%, -50%);
      width: 18px;
      height: 18px;
      min-width: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: #fff;
      pointer-events: none;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      .gantt-dependency-unlink-btn:hover {
        background: white !important;
        border-color: #404040;
      }
      .gantt-dependency-unlink-btn:hover svg {
        stroke: #262626;
      }
    }
    .gantt-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 16px;
      background: #2e2e2e;
      color: #fafafa;
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      border: 1px solid #404040;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 999999;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--motion-duration-normal) var(--motion-easing-decelerate), transform var(--motion-duration-normal) var(--motion-easing-decelerate), visibility var(--motion-duration-normal) var(--motion-easing-decelerate);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .gantt-toast svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .gantt-toast-message-wrap {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      min-width: 0;
    }
    .gantt-toast-message-wrap .gantt-toast-icon {
      flex-shrink: 0;
      line-height: 0;
    }
    .gantt-toast-message-wrap .gantt-toast-icon svg {
      width: 14px;
      height: 14px;
      vertical-align: top;
    }
    .gantt-toast-message {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .gantt-toast-message .gantt-toast-line1 {
      display: block;
    }
    .gantt-toast-hint {
      display: block;
      font-size: 12px;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.92);
    }
    .gantt-toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    @media (max-width: 768px) {
      .gantt-toast {
        left: 50%;
        right: auto;
        width: max-content;
        max-width: 420px;
        bottom: 100px;
        transform: translateX(-50%) translateY(20px);
      }
      .gantt-toast.visible {
        transform: translateX(-50%) translateY(0);
      }
    }
    .gantt-toast.error {
      background: #3d2a2a;
      border-color: #5c4040;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .gantt-toast-undo {
      margin-left: 4px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.12);
      border: none;
      border-radius: 4px;
      color: #fafafa;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .gantt-toast-undo:hover {
      background: rgba(255,255,255,0.2);
    }
    .gantt-toast-link {
      margin-left: 6px;
      padding: 2px 0;
      background: none;
      border: none;
      border-radius: 0;
      color: #93c5fd;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline;
      white-space: nowrap;
    }
    .gantt-toast-link:hover {
      color: #bfdbfe;
    }
    .gantt-toast-btn-secondary {
      margin-left: 8px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      color: #fafafa;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    .gantt-toast-btn-secondary:hover {
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.35);
      color: #fff;
    }
    .gantt-toast-btn-secondary svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .gantt-toast-dismiss {
      margin-left: auto;
      padding: 2px 6px;
      background: transparent;
      border: none;
      border-radius: 4px;
      color: #a3a3a3;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      flex-shrink: 0;
    }
    .gantt-toast-dismiss:hover {
      color: #fafafa;
      background: rgba(255,255,255,0.1);
    }
    .gantt-toast-dismiss.gantt-toast-dismiss-label {
      font-size: 13px;
      font-weight: 500;
      padding: 6px 12px;
      font-family: inherit;
    }
    .gantt-drag-guide {
      position: fixed;
      left: 0;
      top: 0;
      width: 2px;
      height: 0;
      background: #525252;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    .gantt-drag-guide.visible { display: block !important; }
    .gantt-drag-guide.snap-zone {
      background: #737373;
      width: 2px;
    }
    .gantt-bar-snap-indicator {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      opacity: 0;
      pointer-events: none;
      z-index: 3;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .gantt-bar-snap-indicator.visible { opacity: 1; }
    .gantt-bar-snap-indicator svg {
      width: 12px;
      height: 12px;
      color: inherit;
    }
    .gantt-all-dependency-lines { pointer-events: none; }
    .gantt-all-dependency-lines.visible { pointer-events: auto; }
    #ganttChildConnectorsContainer { pointer-events: none; }
    body.shift-mode .gantt-all-dependency-lines.visible { z-index: 100003; }
    .gantt-all-dependency-lines.visible .connector-dot { visibility: visible !important; pointer-events: auto !important; }
    .gantt-all-dependency-lines .connector-path { opacity: 0.5; stroke-dasharray: 4 3; }
    .gantt-all-dependency-lines .connector-path-wrap:hover .connector-path { opacity: 1; }
    .gantt-all-dependency-lines .connector-path-hit { cursor: pointer; }
    .gantt-all-dependency-lines .connector-path.connector-dragging { opacity: 1; }
    .gantt-all-dependency-lines .connector-dot {
      cursor: grab;
      opacity: 0.5;
      transition: fill 0.15s, stroke 0.15s, opacity 0.15s;
    }
    .gantt-all-dependency-lines .connector-dot:hover {
      opacity: 1;
      stroke: #171717;
      stroke-width: 1px;
    }
    .gantt-all-dependency-lines .connector-dot[data-base-count] {
      cursor: default;
    }
    .gantt-all-dependency-lines .connector-dot.connector-dot-dragging {
      opacity: 1;
      fill: var(--color-general-primary);
      stroke: #171717;
      stroke-width: 1px;
      cursor: grabbing;
    }
    .task-rename-btn {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gantt-task-cell:hover .task-actions { opacity: 1; }
    .gantt-task-cell:focus-within .task-actions { display: none; }
    .task-rename-btn:hover { color: var(--text-primary); }
    .gantt-date-cell {
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gantt-date-input-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }
    .gantt-date-input-wrap input[type="text"] {
      flex: 1;
      min-width: 0;
      max-width: 36px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: inherit;
      color: var(--text-secondary);
    }
    .gantt-date-input-wrap input[type="text"]:focus { outline: none; }
    .gantt-date-input-wrap .gantt-date-sep {
      flex-shrink: 0;
      color: var(--text-tertiary);
      font-size: 12px;
      user-select: none;
    }
    .gantt-status-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-size: 13px;
    }
    .gantt-status-cell .gantt-party-dropdown { flex: 1; min-width: 0; }
    .gantt-status-cell .gantt-party-dropdown-trigger { justify-content: center; text-align: center; }
    .gantt-party-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--text-primary);
    }
    /* Legacy party select styles - now using custom dropdown */
    .gantt-party-input {
      width: 100%;
      min-width: 0;
      padding: 4px 8px;
      border: 1px solid var(--border-strong);
      border-radius: 4px;
      background: var(--bg-surface);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
    }
    .gantt-party-input:focus { outline: none; border-color: var(--color-general-primary); }
    .gantt-timeline-cell {
      position: relative;
      padding: 4px;
      background: inherit;
    }
    .gantt-bar {
      position: absolute;
      height: 24px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 4px;
      cursor: grab;
      user-select: none;
      transition: opacity 0.2s ease, box-shadow 0.15s;
      min-width: 8px;
      container-type: size;
      z-index: 9999;
    }
    .gantt-bar-stroke {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      z-index: 0;
    }
    .gantt-bar-inner {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      z-index: 1;
    }
    .gantt-bar:focus { outline: none; }
    .gantt-bar:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .gantt-bar.dragging { cursor: grabbing; opacity: 1; z-index: 5; }
    .gantt-wrapper:has(.gantt-bar.dragging) .gantt-bar:not(.dragging),
    .gantt-wrapper:has(.gantt-bar.resizing) .gantt-bar:not(.resizing) { opacity: 0.75; }
    .gantt-bar.resizing { cursor: ew-resize; }
    .gantt-bar.selected { box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 4; }
    .gantt-bar.selected:focus { outline: none; }
    .gantt-wrapper:has(.gantt-bar.selected) .gantt-bar:not(.bar-family):not(.dragging):not(.resizing) {
      opacity: 0.16;
      transition: opacity 0.2s ease;
    }
    .gantt-wrapper:has(.gantt-bar.selected) .gantt-row:not(.gantt-header):not(:has(.gantt-bar.bar-family)) .gantt-cell > * {
      opacity: 0.16;
      transition: opacity 0.2s ease;
    }
    .gantt-bar .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: clamp(8px, 33cqh, 24px);
      cursor: ew-resize;
      background: transparent;
    }
    .gantt-bar .resize-handle-left {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: clamp(8px, 33cqh, 24px);
      min-width: 8px;
      cursor: ew-resize;
      background: transparent;
    }
    .gantt-bar .resize-handle:hover,
    .gantt-bar .resize-handle-left:hover { background: rgba(0,0,0,0.15); }
    .gantt-bar.resizing .resize-handle,
    .gantt-bar.resizing .resize-handle-left { background: rgba(0,0,0,0.25); }
    .gantt-read-only .gantt-bar { cursor: pointer; }
    .gantt-read-only .gantt-bar .resize-handle,
    .gantt-read-only .gantt-bar .resize-handle-left,
    .gantt-read-only .gantt-row:not(.gantt-header) .gantt-cell:not(.gantt-timeline-cell) { pointer-events: none; }
    .gantt-read-only .gantt-row:not(.gantt-header) { cursor: default; }
    .gantt-bar-duration-hint {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 600;
      color: inherit;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1;
    }
    .gantt-bar-duration-hint-hover {
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }
    .gantt-bar-duration-input {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 2.75em;
      min-width: 28px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      color: #171717;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 4px;
      padding: 4px 6px;
      z-index: 2;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }
    .gantt-bar-duration-input::placeholder {
      color: #737373;
    }
    .gantt-bar-duration-input:focus {
      outline: none;
      border-color: var(--accent, #6d28d9);
      box-shadow: 0 0 0 1px var(--accent, #6d28d9);
    }
    .gantt-bar:not(.dragging):not(.resizing):hover .gantt-bar-duration-hint-hover {
      opacity: 1;
    }
    .gantt-bar.selected .gantt-bar-duration-hint-hover,
    .gantt-bar.selected:hover .gantt-bar-duration-hint-hover {
      opacity: 0 !important;
      pointer-events: none;
    }
    body.shift-mode .gantt-bar,
    body.shift-mode .gantt-bar .resize-handle,
    body.shift-mode .gantt-bar .resize-handle-left { cursor: default; pointer-events: none; }
    .gantt-read-only .gantt-bar .resize-handle,
    .gantt-read-only .gantt-bar .resize-handle-left,
    .gantt-read-only .gantt-row:not(.gantt-header) .gantt-cell[contenteditable],
    .gantt-read-only .task-detail-content input,
    .gantt-read-only .task-detail-content select,
    .gantt-read-only .task-detail-content textarea,
    .gantt-read-only .task-detail-list-remove,
    .gantt-read-only .task-detail-add-btn { cursor: default; pointer-events: none; }
    .gantt-read-only .task-detail-edit-btn,
    .gantt-read-only .task-detail-done-btn { display: none !important; }
    .gantt-read-only .gantt-phase-dropdown { pointer-events: none; cursor: default; }
    .gantt-read-only .gantt-phase-dropdown-trigger .phase-chevron { opacity: 0; }
    body.shift-mode .gantt-bar-duration-hint-hover {
      opacity: 1 !important;
    }
    .gantt-wrapper[data-show-duration-on-bar="true"] .gantt-bar-duration-hint-hover {
      opacity: 1;
    }
    .gantt-wrapper[data-show-duration-on-bar="true"] .gantt-bar.selected .gantt-bar-duration-hint-hover {
      opacity: 0 !important;
    }
    .gantt-bar-tooltip {
      position: fixed;
      z-index: 100050;
      min-width: 200px;
      max-width: 240px;
      padding: 10px 12px;
      background: rgba(23, 23, 23, 0.96);
      color: #fafafa;
      font-size: 13px;
      line-height: 1.4;
      border-radius: 6px;
      border: 1px solid transparent;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .gantt-bar-tooltip.visible { opacity: 1; visibility: visible; }
    .gantt-bar-tooltip.gantt-bar-tooltip-static {
      position: static !important;
      width: 100%;
      min-width: 0;
      max-width: none;
      opacity: 1;
      visibility: visible;
      background: var(--bg-surface);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      box-shadow: var(--shadow-sm);
    }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-title { color: var(--text-primary); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-row { color: var(--text-secondary); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-actions { border-top-color: var(--border-default); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-move-label { color: var(--text-tertiary); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-trigger { color: var(--text-primary); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-trigger .phase-chevron { color: var(--text-tertiary); }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-dep-unlink { color: var(--color-general-primary); }
    .gantt-bar-tooltip.has-actions { pointer-events: auto; }
    .gantt-bar-tooltip-actions { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-default); display: flex; flex-direction: column; gap: 6px; }
    .gantt-bar-tooltip-move-label { font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.04em; }
    .gantt-bar-tooltip-title { font-weight: 600; margin-bottom: 4px; }
    .gantt-bar-tooltip-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      color: #a3a3a3;
      font-size: 12px;
      margin-top: 4px;
    }
    .gantt-bar-tooltip-row .gantt-bar-tooltip-icon {
      flex-shrink: 0;
      width: 14px;
      height: 14px;
      margin-top: 1px;
      opacity: 0.8;
    }
    .gantt-bar-tooltip-row .gantt-bar-tooltip-text { flex: 1; min-width: 0; }
    .gantt-bar-tooltip-dep-unlink-wrap { margin-left: 6px; flex-shrink: 0; }
    .gantt-bar-tooltip-dep-unlink {
      background: none; border: none; padding: 2px; font-size: 0; cursor: pointer;
      color: var(--color-general-primary); text-decoration: none;
      display: inline-flex; align-items: center; justify-content: center;
      opacity: 1;
    }
    .gantt-bar-tooltip-dep-unlink svg { flex-shrink: 0; stroke: currentColor; stroke-width: 2.25; }
    .gantt-bar-tooltip-dep-unlink:hover { opacity: 0.9; }
    .gantt-bar-tooltip-depends .gantt-bar-tooltip-dep-unlink { color: var(--color-general-primary, #6d28d9); }
    .gantt-bar-tooltip .gantt-bar-tooltip-dep-unlink { color: #fafafa; }
    .gantt-bar-tooltip-desc .gantt-bar-tooltip-text { max-height: 120px; overflow-y: auto; }
    .gantt-cell[contenteditable] {
      outline: none;
      cursor: text;
    }
    .gantt-cell[contenteditable]:focus,
    .gantt-task-cell:focus-within {
      background: var(--row-bg-default);
      box-shadow: inset 0 0 0 1px var(--color-general-primary);
    }
    .add-task-fab {
      position: fixed;
      bottom: calc(24px + env(safe-area-inset-bottom, 0px));
      right: calc(24px + env(safe-area-inset-right, 0px));
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      font-size: 24px;
      font-weight: 300;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s, color 0.2s;
      z-index: 1000;
      background: var(--color-general-primary);
      color: var(--bg-body);
    }
    .add-task-fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    .add-task-fab:active {
      transform: scale(0.98);
    }
    .add-task-fab-icon {
      display: inline-block;
      transition: transform 0.25s ease;
    }
    .add-task-fab.fab-open .add-task-fab-icon {
      transform: rotate(45deg);
    }
    .fab-phase-menu {
      position: fixed;
      z-index: 10001;
      padding: 8px 0;
      background: #171717;
      color: #fafafa;
      font-size: 13px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      min-width: 160px;
      max-width: 240px;
      pointer-events: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }
    .fab-phase-menu.visible { opacity: 1; visibility: visible; }
    .fab-phase-menu-title {
      padding: 8px 14px 6px;
      font-weight: 600;
      font-size: 12px;
      color: #a3a3a3;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .fab-phase-menu-list { display: flex; flex-direction: column; gap: 2px; }
    .fab-phase-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #fafafa;
      font-size: 13px;
      font-family: inherit;
      text-align: left;
      width: 100%;
    }
    .fab-phase-menu-item:hover { background: rgba(255,255,255,0.06); }
    .fab-phase-menu-item .phase-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .fab-phase-menu-item-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.9;
    }
    .fab-phase-menu-item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    .fab-phase-menu-item-label {
      font-weight: 500;
    }
    .fab-phase-menu-item-desc {
      font-size: 11px;
      color: #a3a3a3;
      font-weight: 400;
    }
    .fab-phase-menu-item-disabled .fab-phase-menu-item-icon {
      opacity: 0.6;
    }
    .fab-phase-menu-item-disabled {
      cursor: default;
      opacity: 0.6;
    }
    .fab-phase-menu-item-disabled:hover { background: transparent; }
    .fab-phase-menu-badge {
      font-size: 11px;
      color: #a3a3a3;
      font-weight: 400;
      margin-left: auto;
      flex-shrink: 0;
    }
    .home-new-board-menu.home-new-board-menu-drop-up {
      min-width: auto;
      max-width: none;
      padding: 8px 0;
      font-size: 16px;
    }
    .home-new-board-menu.home-new-board-menu-drop-up .fab-phase-menu-item {
      padding: 12px 20px;
      font-size: 16px;
      gap: 14px;
    }
    .home-new-board-menu.home-new-board-menu-drop-up .fab-phase-menu-item-icon {
      width: 22px;
      height: 22px;
    }
    .home-new-board-menu.home-new-board-menu-drop-up .fab-phase-menu-item-icon svg {
      width: 22px;
      height: 22px;
    }
    .home-new-board-menu.home-new-board-menu-drop-up .fab-phase-menu-item-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .home-new-board-menu.fab-phase-menu {
      background: #ffffff !important;
      color: #171717 !important;
      border: 1px solid #e5e5e5;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .home-new-board-menu .fab-phase-menu-item {
      color: #171717 !important;
      padding-left: 20px;
      padding-right: 20px;
    }
    .home-new-board-menu .fab-phase-menu-item:hover {
      background: rgba(0,0,0,0.05) !important;
    }
    .home-new-board-menu .fab-phase-menu-item-icon {
      color: #171717 !important;
      opacity: 0.9;
    }
    .home-new-board-menu .fab-phase-menu-item-desc {
      color: #525252 !important;
    }
    .home-new-board-menu .fab-phase-menu-item-disabled .fab-phase-menu-item-icon {
      opacity: 0.5;
    }
    .home-new-board-menu .fab-phase-menu-badge {
      color: #737373 !important;
    }
    @media (prefers-color-scheme: dark) {
      .add-task-fab {
        background: #ffffff;
        color: #171717;
      }
      .add-task-fab:hover {
        background: #f0f0f0;
      }
    }
    .home-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .home-new-project-btn {
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: var(--button-radius);
      border: none;
      cursor: pointer;
      font-family: inherit;
      background: var(--color-general-primary);
      color: var(--bg-body);
      transition: opacity 0.2s;
    }
    .home-new-project-btn:hover {
      opacity: 0.9;
    }
    .home-new-project-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .home-new-project-btn:disabled:hover {
      opacity: 0.5;
    }
    .home-new-project-btn-dropdown {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .home-new-project-chevron {
      font-size: 10px;
      opacity: 0.8;
    }
    .home-readonly-badge {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
    }
    .home-readonly-badge:hover { background: var(--bg-hover); }
    .home-readonly-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      background: #238636;
    }
    .home-readonly-badge.status-syncing .home-readonly-badge-dot { background: #d97706; animation: home-sync-dot-pulse 1.2s ease-in-out infinite; }
    .home-readonly-badge.status-error .home-readonly-badge-dot { background: #dc2626; }
    .home-mobile-fab-bar {
      display: none;
    }
    @media (max-width: 768px) {
      .home-header-actions .home-new-project-btn:not(.home-mobile-fab-trigger) {
        display: none;
      }
      .home-mobile-fab-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: transparent;
        border-top: none;
        z-index: 1000;
        box-shadow: none;
      }
      .home-mobile-fab-bar .home-new-project-btn {
        width: 100%;
        max-width: 280px;
        padding: 14px 20px;
        font-size: 16px;
      }
      .home-mobile-fab-bar {
        padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      }
      #homeView.active { padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px)); }
    }
    @media (prefers-color-scheme: dark) {
      .home-new-project-btn {
        background: #ffffff;
        color: #171717;
      }
      .home-readonly-badge:hover { background: var(--bg-hover); }
    }
    .week-label {
      font-weight: 500;
      color: var(--text-secondary, #525252);
      visibility: visible;
    }
    .gantt-phase-cell {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 4px;
      color: var(--text-primary);
    }
    .gantt-phase-cell select {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      padding: 2px 0;
      color: inherit;
    }
    .gantt-phase-cell select:focus { outline: none; }
    .gantt-phase-dropdown {
      flex: 1;
      min-width: 0;
      position: relative;
    }
    .gantt-phase-dropdown-trigger {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      width: 100%;
      padding: 2px 0;
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      color: inherit;
      text-align: left;
    }
    .gantt-phase-dropdown-trigger:focus { outline: none; }
    .gantt-phase-dropdown-trigger .phase-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .gantt-phase-dropdown-trigger .phase-chevron {
      margin-left: auto;
      opacity: 0;
      font-size: 10px;
      flex-shrink: 0;
      color: var(--text-tertiary);
      transition: opacity 0.15s ease;
    }
    .gantt-phase-cell:hover .gantt-phase-dropdown-trigger .phase-chevron,
    .gantt-phase-dropdown.open .gantt-phase-dropdown-trigger .phase-chevron {
      opacity: 0.6;
    }
    .gantt-phase-dropdown-list {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 120px;
      margin-top: 0;
      background: var(--bg-surface);
      border: 1px solid var(--border-strong);
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: var(--shadow-md);
      z-index: 10001;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .gantt-phase-dropdown.open .gantt-phase-dropdown-list { display: block; }
    .gantt-phase-dropdown-list.drop-up {
      border-radius: 6px 6px 0 0;
      border-top: 1px solid var(--border-strong);
      border-bottom: none;
    }
    .gantt-phase-dropdown-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-primary);
      text-align: left;
      width: 100%;
      white-space: nowrap;
    }
    .gantt-phase-dropdown-option:hover { background: var(--bg-hover); }
    .gantt-phase-dropdown-option.selected { font-weight: 600; }
    .gantt-phase-dropdown-option.phase-secondary::after {
      content: " 2nd";
      font-size: 11px;
      font-weight: 400;
      color: var(--text-tertiary);
      margin-left: 4px;
    }
    .gantt-phase-dropdown-option .phase-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .gantt-bar-tooltip-phase-dropdown { width: 100%; }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-trigger {
      color: #fafafa;
      width: 100%;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-trigger .phase-chevron {
      color: #a3a3a3;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-trigger:hover .phase-chevron,
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown.open .gantt-phase-dropdown-trigger .phase-chevron {
      opacity: 1;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-list,
    .gantt-phase-dropdown-list.gantt-bar-tooltip-phase-dropdown-list {
      z-index: 100001;
      background: #171717 !important;
      border: 1px solid #404040 !important;
      border-top: 1px solid #404040 !important;
    }
    .gantt-phase-dropdown-list.gantt-bar-tooltip-phase-dropdown-list.drop-up {
      border-radius: 6px 6px 0 0;
      border-bottom: none;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option {
      color: #fafafa !important;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option:hover {
      background: #262626 !important;
    }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option {
      color: var(--text-primary) !important;
    }
    .gantt-bar-tooltip.gantt-bar-tooltip-static .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option:hover {
      background: var(--bg-hover) !important;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option.selected {
      font-weight: 600;
      color: #fafafa !important;
    }
    .gantt-bar-tooltip-phase-dropdown .gantt-phase-dropdown-option.phase-secondary::after {
      content: " 2nd";
      font-size: 11px;
      font-weight: 400;
      color: #a3a3a3;
      margin-left: 4px;
    }
    .gantt-party-dropdown {
      flex: 1;
      min-width: 0;
      position: relative;
    }
    .gantt-party-dropdown-trigger {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 2px 0;
      border: none;
      background: transparent;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      color: inherit;
      text-align: center;
    }
    .gantt-party-dropdown-trigger:focus { outline: none; }
    .gantt-party-dropdown-trigger .party-chevron {
      margin-left: auto;
      opacity: 0;
      font-size: 10px;
      flex-shrink: 0;
      color: var(--text-tertiary);
      transition: opacity 0.15s ease;
    }
    .gantt-party-cell:hover .gantt-party-dropdown-trigger .party-chevron,
    .gantt-party-dropdown.open .gantt-party-dropdown-trigger .party-chevron {
      opacity: 0.6;
    }
    .gantt-party-dropdown-list {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 120px;
      margin-top: 0;
      background: var(--bg-surface);
      border: 1px solid var(--border-strong);
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: var(--shadow-md);
      z-index: 10001;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .gantt-party-dropdown.open .gantt-party-dropdown-list { display: block; }
    .gantt-party-dropdown-list.drop-up {
      border-radius: 6px 6px 0 0;
      border-top: 1px solid var(--border-strong);
      border-bottom: none;
    }
    .gantt-party-dropdown-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-primary);
      text-align: left;
      width: 100%;
      white-space: nowrap;
    }
    .gantt-party-dropdown-option:hover { background: var(--bg-hover); }
    .gantt-party-dropdown-option.selected { font-weight: 600; }
    .gantt-party-dropdown-option.gantt-party-add-new {
      border-top: 1px solid var(--border-default);
      color: var(--text-tertiary);
    }
    .page-header {
      position: relative;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      gap: 24px;
      flex-shrink: 0;
    }
    .page-header-title-wrap { flex: 1; min-width: 0; max-width: 100%; overflow-wrap: break-word; word-break: break-word; }
    .page-header-title-wrap h1,
    .page-header-title-wrap .subtitle {
      cursor: text;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }
    .board-info-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 20px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-tertiary);
      user-select: none;
    }
    .board-info-strip .board-info-label {
      color: var(--text-secondary);
      margin-right: 4px;
    }
    .board-info-strip .board-info-item {
      white-space: nowrap;
      min-width: 0;
    }
    .page-header-title-wrap h1:focus,
    .page-header-title-wrap .subtitle:focus {
      outline: none;
      box-shadow: inset 0 0 0 1px var(--color-general-primary);
    }
    .settings-btn {
      width: 40px;
      height: 40px;
      padding: 0;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--button-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-btn:hover { color: var(--text-primary); background: transparent; }
    .settings-btn svg { width: 18px; height: 18px; transition: transform 0.3s ease; }
    .settings-btn:hover svg { transform: rotate(90deg); }
    #ganttView #settingsBtn {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 0px));
      right: max(12px, env(safe-area-inset-right, 0px));
      margin: 0;
      z-index: 1000;
    }
    .share-modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .share-modal {
      background: var(--bg-surface);
      border-radius: 12px;
      padding: 24px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    .share-modal h3 { margin: 0 0 12px; font-size: 18px; font-weight: 600; }
    .share-modal-desc { margin: 0 0 16px; font-size: 14px; color: var(--text-secondary); }
    .share-modal-link-wrap { display: flex; gap: 8px; margin-bottom: 12px; }
    .share-modal-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-subtle);
      color: var(--text-primary);
    }
    .share-modal-copy {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: var(--color-general-primary);
      color: white;
      font-weight: 500;
      cursor: pointer;
      font-size: 14px;
    }
    .share-modal-copy:hover { opacity: 0.9; }
    .share-modal-status { min-height: 20px; font-size: 13px; color: var(--text-tertiary); margin-bottom: 16px; }
    .share-modal-close {
      padding: 8px 16px;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
    }
    .share-modal-close:hover { background: var(--bg-subtle); color: var(--text-primary); }
    .settings-overlay {
      display: none;
    }
    .settings-drawer {
      width: 100%;
      height: 100%;
      max-height: 100%;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    .settings-sidebar-overlay {
      position: fixed;
      inset: 0;
      z-index: 99;
      background: rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--motion-duration-normal) var(--motion-easing-decelerate);
    }
    .app-views-wrap.settings-sidebar-open .settings-sidebar-overlay {
      opacity: 1;
      pointer-events: auto;
    }
    @media (prefers-color-scheme: dark) {
      .settings-sidebar-overlay { background: rgba(0, 0, 0, 0.55); }
    }
    .settings-sidebar {
      position: fixed;
      inset: 0;
      left: auto;
      width: 376px;
      max-height: 100vh;
      max-height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--bg-surface);
      border-left: none;
      min-height: 0;
      z-index: 100;
      box-shadow: none;
      transform: translateX(100%);
      transition: transform var(--motion-duration-slow) var(--motion-easing-decelerate);
      padding: 0;
      margin: 0;
    }
    .app-views-wrap.settings-sidebar-open .settings-sidebar {
      transform: translateX(0);
      overflow: hidden;
      border-left: 1px solid var(--border-default);
      box-shadow: -4px 0 16px rgba(0,0,0,0.08);
    }
    .settings-drawer-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-default);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .settings-drawer-header h2 { margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .settings-drawer-close {
      width: 36px;
      height: 36px;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 8px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--motion-duration-fast) var(--motion-easing), color var(--motion-duration-fast) var(--motion-easing);
    }
    .settings-drawer-close:hover { background: var(--bg-subtle); color: var(--text-primary); }
    .settings-tabs {
      display: flex;
      gap: 0;
      padding:  0px;
      border-bottom: 1px solid var(--border-default);
      flex-shrink: 0;
      min-height:60px;
      min-width: 0;
    }
    .settings-tab {
      flex: 1 1 0;
      min-width: 0;
      padding: 12px 10px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-tertiary);
      cursor: pointer;
      border-bottom: 1px solid transparent;
      margin-bottom: -1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color var(--motion-duration-fast) var(--motion-easing), border-bottom-color var(--motion-duration-fast) var(--motion-easing), background var(--motion-duration-fast) var(--motion-easing);
    }
    .settings-tab:hover { color: var(--text-primary); }
    .settings-tab.active {
      color: var(--color-general-primary);
      border-bottom-color: var(--color-general-primary);
      background: var(--bg-surface);
    }
    .settings-drawer-body {
      display: block;
      padding: 24px;
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    .settings-tab-panel {
      display: none;
    }
    .settings-tab-panel.active {
      display: block;
    }
    .settings-section { margin-bottom: 24px; }
    .settings-section:last-child { margin-bottom: 0; }
    .settings-section label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .settings-section input[type="text"],
    .settings-section input[type="date"],
    .settings-section textarea,
    .settings-section select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-strong);
      background-color: transparent;
      color: var(--text-primary);
      border-radius: var(--input-radius);
      font-size: 14px;
      font-family: inherit;
    }
    .settings-section input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 0.8;
      cursor: pointer;
    }
    @media (prefers-color-scheme: dark) {
      .settings-section input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        opacity: 0.9;
      }
    }
    .settings-section select {
      padding-right: 40px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }
    .settings-section textarea { min-height: 80px; resize: vertical; }
    .settings-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      line-height: 1.2;
      min-height: 18px;
    }
    .settings-checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      min-width: 18px;
      margin: 0;
      cursor: pointer;
      flex-shrink: 0;
    }
    .settings-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .settings-toggle-label {
      font-weight: 500;
      line-height: 1.2;
      cursor: pointer;
      flex: 1;
    }
    .settings-toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
      cursor: pointer;
    }
    .settings-toggle-switch input {
      opacity: 0;
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      cursor: pointer;
    }
    .settings-toggle-slider {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: var(--border-strong);
      transition: background var(--motion-duration-normal) var(--motion-easing);
    }
    .settings-toggle-slider::after {
      content: "";
      position: absolute;
      left: 2px;
      top: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-body);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      transition: transform var(--motion-duration-normal) var(--motion-easing-decelerate);
    }
    .settings-toggle-switch input:checked + .settings-toggle-slider {
      background: var(--color-general-primary);
    }
    .settings-toggle-switch input:checked + .settings-toggle-slider::after {
      transform: translateX(20px);
    }
    .settings-toggle-switch input:focus-visible + .settings-toggle-slider {
      box-shadow: 0 0 0 1px var(--color-general-primary);
    }
    .settings-segmented {
      display: flex;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      overflow: hidden;
      width: 100%;
    }
    .settings-segmented-option {
      flex: 1;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border 0.15s;
    }
    .settings-segmented-option:hover {
      background: transparent;
      color: var(--text-primary);
    }
    .settings-segmented-option.selected {
      background: transparent;
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px var(--border-strong);
    }
    .settings-hint { display: block; margin-top: 6px; font-size: 12px; color: var(--text-tertiary); }
    .settings-hint kbd { display: inline-block; padding: 1px 5px; font-size: 11px; font-family: inherit; background: var(--bg-hover); border: 1px solid var(--border-default); border-radius: 4px; }
    .settings-section input:focus,
    .settings-section textarea:focus,
    .settings-section select:focus { outline: none; border-color: var(--color-general-primary); }
    .settings-phase-list { display: flex; flex-direction: column; gap: 8px; }
    .settings-phase-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .settings-phase-item.dragging { opacity: 0.5; }
    .settings-phase-input-wrap {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 36px 6px 8px;
      border: 1px solid var(--border-strong);
      border-radius: var(--input-radius);
      background: transparent;
      min-height: 36px;
      box-sizing: border-box;
    }
    .settings-phase-input-wrap .settings-phase-swatch {
      width: 20px;
      height: 20px;
      min-width: 20px;
      border: none;
      border-radius: 4px;
      padding: 0;
      cursor: pointer;
      background: transparent;
      flex-shrink: 0;
    }
    .settings-phase-input-wrap .settings-phase-swatch::-webkit-color-swatch-wrapper { padding: 0; }
    .settings-phase-input-wrap .settings-phase-swatch::-webkit-color-swatch { border: none; border-radius: 4px; }
    .settings-phase-input-wrap input[type="text"] {
      flex: 1;
      min-width: 0;
      padding: 0;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
    }
    .settings-phase-input-wrap input[type="text"]:focus { outline: none; }
    .settings-phase-input-wrap:focus-within { border-color: var(--color-general-primary); }
    .settings-phase-remove {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 4px;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .settings-phase-remove:hover { color: #dc2626; background: rgba(220, 38, 38, 0.1); }
    .settings-phase-remove:disabled { opacity: 0.4; cursor: not-allowed; }
    .settings-add-phase {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text-primary);
      border: 1px solid var(--border-strong);
      background: transparent;
      border-radius: var(--button-radius);
      cursor: pointer;
      font-family: inherit;
      box-sizing: border-box;
    }
    .settings-add-phase:hover { background: transparent; border-color: var(--border-strong); }
    .settings-phase-list-header {
      display: none;
      align-items: center;
      gap: 12px;
      padding-bottom: 4px;
      margin-bottom: 2px;
    }
    .settings-phase-list[data-phase-mode="fixed"] .settings-phase-list-header {
      display: flex;
    }
    .settings-phase-list-header-phase {
      flex: 1;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-tertiary);
    }
    .settings-phase-list-header-sprints {
      width: 100px;
      min-width: 100px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-tertiary);
    }
    .settings-phase-sprints {
      display: none;
      align-items: stretch;
      height: 36px;
      width: 100px;
      min-width: 100px;
    }
    .settings-phase-list[data-phase-mode="fixed"] .settings-phase-sprints {
      display: flex;
    }
    .settings-phase-sprints-inner {
      display: flex;
      align-items: center;
      height: 36px;
      padding: 0 4px;
      font-size: 13px;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      background: transparent;
      box-sizing: border-box;
      gap: 0;
    }
    .settings-phase-sprints-stepper-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 4px;
      background: transparent;
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .settings-phase-sprints-stepper-btn:hover { background: var(--bg-hover); color: var(--color-general-primary); }
    .settings-phase-sprints-stepper-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .settings-phase-sprints input {
      width: 28px;
      padding: 0;
      margin: 0;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      text-align: center;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .settings-phase-sprints input::-webkit-outer-spin-button,
    .settings-phase-sprints input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }
    .settings-palette-dropdown-wrap {
      position: relative;
      width: 100%;
    }
    .settings-palette-trigger {
      position: relative;
      width: 100%;
      padding: 10px 40px 10px 12px;
      border: 1px solid var(--border-strong);
      border-radius: var(--input-radius);
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .settings-palette-trigger:hover { border-color: var(--border-default); }
    .settings-palette-dropdown-wrap.open .settings-palette-trigger { border-color: var(--color-general-primary); }
    .settings-palette-trigger-label {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .settings-palette-trigger-swatches {
      display: flex;
      gap: 2px;
      flex-shrink: 0;
    }
    .settings-palette-trigger-swatches span {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid var(--border-strong);
    }
    .settings-palette-trigger::after {
      content: "";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      pointer-events: none;
    }
    .settings-palette-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      margin-bottom: 0;
      padding: 8px;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      background: var(--bg-surface);
      box-shadow: var(--shadow-md);
      z-index: 100;
      max-height: 280px;
      overflow-y: auto;
    }
    .settings-palette-panel.drop-up {
      top: auto;
      bottom: 100%;
      margin-top: 0;
      margin-bottom: 4px;
    }
    .settings-palette-dropdown-wrap.open .settings-palette-panel { display: block; }
    .settings-palette-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .settings-palette-option {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border-strong);
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
      text-align: left;
    }
    .settings-palette-option:hover { border-color: var(--border-default); }
    .settings-palette-option.selected { border-color: var(--color-general-primary); }
    .settings-dependent-wrap {
      position: relative;
      width: 100%;
    }
    .settings-dependent-trigger {
      width: 100%;
      padding: 10px 40px 10px 12px;
      border: 1px solid var(--border-strong);
      border-radius: var(--input-radius);
      background: transparent;
      background-color: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      text-align: left;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }
    .settings-dependent-trigger:hover { border-color: var(--border-default); }
    .settings-dependent-trigger:disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
    .settings-dependent-wrap.open .settings-dependent-trigger { border-color: var(--color-general-primary); }
    .settings-dependent-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      margin-bottom: 0;
      padding: 8px 0;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      background: var(--bg-surface);
      box-shadow: var(--shadow-md);
      z-index: 100;
      max-height: 320px;
      overflow-y: auto;
    }
    .settings-dependent-panel.drop-up {
      top: auto;
      bottom: 100%;
      margin-top: 0;
      margin-bottom: 4px;
    }
    .settings-dependent-wrap.open .settings-dependent-panel { display: block; }
    .settings-dependent-option {
      display: block;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      text-align: left;
      cursor: pointer;
    }
    .settings-dependent-option:hover { background: var(--bg-hover); }
    .settings-dependent-divider {
      height: 1px;
      margin: 8px 0;
      background: var(--border-default);
    }
    .settings-dependent-checkbox-wrap {
      padding: 8px 12px 4px;
    }
    .settings-dependent-checkbox-wrap .settings-hint { margin-top: 4px; margin-bottom: 0; padding: 0 0 4px; }
    .settings-dependent-options { margin-top: 12px; }
    .settings-dependent-options .settings-checkbox-label { margin-bottom: 4px; }
    .settings-palette-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .settings-palette-option .settings-palette-name-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
      max-width: 100px;
    }
    .settings-palette-option .settings-palette-name-input {
      flex: 1;
      min-width: 0;
      max-width: 100%;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      background: transparent;
      border: none !important;
      box-shadow: none !important;
      padding: 0;
      font-family: inherit;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .settings-palette-option .settings-palette-name-input:focus {
      outline: none;
    }
    .settings-palette-option .settings-palette-name-input:read-only {
      cursor: default;
      caret-color: transparent;
    }
    .settings-palette-option .settings-palette-rename-btn {
      flex-shrink: 0;
      padding: 2px 6px;
      font-size: 11px;
      color: var(--text-tertiary);
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
    }
    .settings-palette-option .settings-palette-rename-btn:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    .settings-palette-swatches {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
      align-items: center;
    }
    .settings-palette-swatches span {
      width: 20px;
      height: 20px;
      min-width: 20px;
      flex-shrink: 0;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .settings-party-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .settings-party-item { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--bg-hover); border-radius: 6px; font-size: 13px; }
    .settings-party-item span { flex: 1; min-width: 0; }
    .settings-party-item button { flex-shrink: 0; padding: 2px 8px; font-size: 12px; color: var(--text-tertiary); background: transparent; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; }
    .settings-party-item button:hover { color: #b91c1c; background: rgba(185,28,28,0.1); }
    .settings-add-party-row { display: flex; flex-direction: column; gap: 8px; width: 100%; box-sizing: border-box; }
    .settings-add-party-row .settings-add-phase { width: 100%; margin-top: 0; }
    .settings-party-input { flex: 1; min-width: 0; padding: 10px 14px; font-size: 14px; border: 1px solid var(--border-strong); border-radius: var(--input-radius); font-family: inherit; min-height: 40px; box-sizing: border-box; }
    .settings-auto-populate-btn {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      background: transparent;
      border: 1px solid var(--border-strong);
      border-radius: var(--button-radius);
      cursor: pointer;
      font-family: inherit;
      box-sizing: border-box;
    }
    .settings-auto-populate-btn:hover {
      background: var(--bg-hover);
    }
    .settings-export-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .settings-export-btn { display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 14px; border: 1px solid var(--border-default); border-radius: var(--button-radius); background: var(--bg-subtle); color: var(--text-primary); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; text-align: left; transition: border-color var(--motion-duration-fast) var(--motion-easing), background var(--motion-duration-fast) var(--motion-easing); }
    .settings-export-btn:hover { border-color: var(--border-strong); background: var(--bg-hover); }
    .settings-export-btn-icon { font-size: 11px; opacity: 0.8; }
    .settings-export-json-wrap { margin-top: 12px; }
    .settings-export-json-label { display: block; font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
    .settings-export-json { width: 100%; padding: 10px; font-family: ui-monospace, "SF Mono", Monaco, "Cascadia Mono", monospace; font-size: 11px; line-height: 1.4; border: 1px solid var(--border-default); border-radius: var(--input-radius); background: var(--bg-subtle); color: var(--text-primary); resize: vertical; }
    .settings-drawer-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-default);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
      background: var(--bg-surface);
    }
    @media (prefers-color-scheme: dark) {
      .settings-sidebar {
        background: #141414;
      }
      .settings-drawer-header,
      .settings-drawer-footer,
      .settings-tab.active {
        background: #141414;
      }
      .app-views-wrap.settings-sidebar-open .settings-sidebar {
        border-left-color: #1f1f1f;
        box-shadow: -4px 0 20px rgba(0,0,0,0.4);
      }
    }
    @media (max-width: 900px), (max-height: 700px) {
      .settings-sidebar { inset: 0; left: auto; }
      .settings-drawer { max-height: 100%; }
    }
    @media (max-width: 480px) {
      .settings-sidebar { width: 100%; left: 0; }
      .settings-drawer { width: 100%; }
      .settings-drawer-header { padding: 16px 16px 16px 20px; }
      .settings-drawer-header h2 { font-size: 17px; }
      .settings-drawer-close { width: 44px; height: 44px; font-size: 24px; flex-shrink: 0; }
      .settings-drawer-body { padding: 16px; }
      .settings-drawer-footer { padding-left: 16px; padding-right: 16px; }
      .settings-tabs { padding: 0 16px; }
      .settings-tab { padding: 12px 14px; font-size: 13px; }
    }
    @media print {
      .settings-sidebar, .settings-sidebar-overlay, .home-header, .gantt-header-row .settings-btn, #addTaskFab, .fab-phase-menu, .gantt-empty-state { display: none !important; }
      .app-views-inner { padding: 0 !important; }
      .gantt-view { padding: 0 !important; }
      body.gantt-view-active .gantt-wrapper { overflow: visible !important; height: auto !important; min-height: 0 !important; }
      body.gantt-view-active .gantt-chart-scroll { overflow: visible !important; height: auto !important; min-height: 0 !important; max-height: none !important; flex: none !important; }
      body.gantt-view-active .gantt-wrapper .gantt-grid { flex: none !important; }
      /* Force bar colors and backgrounds to print (browsers often skip them by default) */
      #ganttView .gantt-bar,
      #ganttView .gantt-bar-inner,
      #ganttView .gantt-bar-stroke,
      #ganttView .gantt-timeline-cell,
      #ganttView .phase-header-cell-dynamic,
      #ganttView .phase-header-cell,
      #ganttView .gantt-cell,
      #ganttView .gantt-row {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
    .settings-cancel-btn {
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--button-radius);
      border: 0px solid var(--border-strong);
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      font-family: inherit;
    }
    .settings-cancel-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-default);
    }
    .settings-save-btn {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--button-radius);
      border: none;
      background: var(--text-primary);
      color: var(--bg-body);
      cursor: pointer;
    }
    .settings-save-btn:hover {
      background: var(--text-secondary);
      color: var(--bg-body);
    }
    .chart-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .chart-controls label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .chart-controls select {
      padding: 6px 40px 6px 10px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: var(--bg-surface);
      color: var(--text-primary);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
    }
    .chart-controls select:focus { outline: none; border-color: var(--color-general-primary); }
    .gantt-header-sticky {
      position: sticky;
      top: 0;
      z-index: 10003;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
      background: var(--bg-body);
    }
    .gantt-header-sticky .gantt-header {
      flex-shrink: 0;
      min-height: 40px;
      visibility: visible;
      display: grid;
    }
    .phase-header-row {
      display: grid;
      grid-template-columns: 200px 100px 140px 120px 88px repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
      width: 100%;
      min-height: 44px;
      border-bottom: 1px solid var(--border-default);
      flex-shrink: 0;
      background: var(--bg-body);
    }
    .phase-header-timeline {
      grid-column: 6 / -1;
      display: flex;
      position: relative;
      z-index: 2;
    }
    .phase-header-timeline-dynamic {
      display: block;
    }
    .phase-header-timeline-dynamic .phase-header-cell-dynamic {
      position: absolute;
      top: 0;
      bottom: 0;
      box-sizing: border-box;
      min-width: 0;
    }
    .phase-header-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.25;
      text-align: center;
      color: var(--text-primary);
      border-right: 1px solid rgba(0,0,0,0.06);
      box-sizing: border-box;
    }
    @media (prefers-color-scheme: dark) {
      .phase-header-cell {
        border-right: 1px solid rgba(255,255,255,0.06);
      }
    }
    .phase-header-cell:last-child { border-right: none; }
    .phase-header-timeline .phase-header-cell:first-child {
      border-top-left-radius: 8px;
    }
    .phase-header-timeline .phase-header-cell {
      cursor: pointer;
      transition: opacity 0.2s ease, filter 0.15s ease;
    }
    .phase-header-timeline .phase-header-cell:hover {
      filter: brightness(1.08);
    }
    .phase-focus-active .phase-header-cell {
      opacity: 0.16;
    }
    .phase-focus-active .phase-header-cell.phase-focused {
      opacity: 1;
    }
    .phase-focus-active .gantt-row:not(.gantt-header) {
      opacity: 0.16;
      transition: opacity 0.2s ease;
    }
    .phase-focus-active .gantt-row.phase-focused {
      opacity: 1;
    }
    .phase-focus-active .gantt-row.selected {
      opacity: 1 !important;
    }
    /* Simple mode: hide Status, Phase, Responsible, Date so user can focus on task names and bars. Toggle with S. */
    .gantt-wrapper .gantt-header .gantt-cell:nth-child(2),
    .gantt-wrapper .gantt-header .gantt-cell:nth-child(3),
    .gantt-wrapper .gantt-header .gantt-cell:nth-child(4),
    .gantt-wrapper .gantt-header .gantt-cell:nth-child(5),
    .gantt-wrapper .gantt-status-cell,
    .gantt-wrapper .gantt-phase-cell,
    .gantt-wrapper .gantt-party-cell,
    .gantt-wrapper .gantt-date-cell {
      transition: opacity 0.2s ease;
    }
    .gantt-wrapper.simple-mode-hiding .gantt-header .gantt-cell:nth-child(2),
    .gantt-wrapper.simple-mode-hiding .gantt-header .gantt-cell:nth-child(3),
    .gantt-wrapper.simple-mode-hiding .gantt-header .gantt-cell:nth-child(4),
    .gantt-wrapper.simple-mode-hiding .gantt-header .gantt-cell:nth-child(5),
    .gantt-wrapper.simple-mode-hiding .gantt-status-cell,
    .gantt-wrapper.simple-mode-hiding .gantt-phase-cell,
    .gantt-wrapper.simple-mode-hiding .gantt-party-cell,
    .gantt-wrapper.simple-mode-hiding .gantt-date-cell {
      opacity: 0;
      pointer-events: none;
    }
    .gantt-wrapper.simple-mode-reveal .gantt-header .gantt-cell:nth-child(2),
    .gantt-wrapper.simple-mode-reveal .gantt-header .gantt-cell:nth-child(3),
    .gantt-wrapper.simple-mode-reveal .gantt-header .gantt-cell:nth-child(4),
    .gantt-wrapper.simple-mode-reveal .gantt-header .gantt-cell:nth-child(5),
    .gantt-wrapper.simple-mode-reveal .gantt-status-cell,
    .gantt-wrapper.simple-mode-reveal .gantt-phase-cell,
    .gantt-wrapper.simple-mode-reveal .gantt-party-cell,
    .gantt-wrapper.simple-mode-reveal .gantt-date-cell {
      opacity: 0;
    }
    .gantt-wrapper[data-simple-mode="true"] #ganttHeaderRow.gantt-header,
    .gantt-wrapper[data-simple-mode="true"] .gantt-row {
      grid-template-columns: 240px repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
    }
    .gantt-wrapper[data-simple-mode="true"] .gantt-header .gantt-cell:nth-child(2),
    .gantt-wrapper[data-simple-mode="true"] .gantt-header .gantt-cell:nth-child(3),
    .gantt-wrapper[data-simple-mode="true"] .gantt-header .gantt-cell:nth-child(4),
    .gantt-wrapper[data-simple-mode="true"] .gantt-header .gantt-cell:nth-child(5) {
      display: none !important;
    }
    .gantt-wrapper[data-simple-mode="true"] .gantt-status-cell,
    .gantt-wrapper[data-simple-mode="true"] .gantt-phase-cell,
    .gantt-wrapper[data-simple-mode="true"] .gantt-party-cell,
    .gantt-wrapper[data-simple-mode="true"] .gantt-date-cell {
      display: none !important;
    }
    .gantt-wrapper[data-simple-mode="true"] .gantt-timeline-cell {
      grid-column: 2 / -1;
      min-width: 0;
    }
    .gantt-wrapper[data-simple-mode="true"] .gantt-task-cell {
      min-width: 0;
    }
    .gantt-wrapper[data-simple-mode="true"] .phase-header-row {
      grid-template-columns: 240px repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
    }
    .gantt-wrapper[data-simple-mode="true"] .phase-header-row .phase-header-cell:first-child {
      grid-column: 1;
    }
    .gantt-wrapper[data-simple-mode="true"] .phase-header-timeline {
      grid-column: 2 / -1;
      min-width: 0;
    }
    .gantt-wrapper[data-simple-mode="true"] .gantt-header-sticky .gantt-header {
      min-height: 40px;
    }
    .gantt-wrapper[data-simple-mode="true"] .phase-header-row {
      min-height: 44px;
    }
    .gantt-task-cell .task-chevron { transform: rotate(-90deg); }
    .gantt-row.expanded .gantt-task-cell .task-chevron { transform: rotate(0deg); }
    .gantt-detail-row {
      background: var(--bg-subtle);
      border-bottom: 1px solid var(--border-subtle);
      padding: 8px 24px 20px 32px;
      flex-shrink: 0;
      position: sticky;
      left: 0;
      width: 100cqw;
      max-width: 100cqw;
      min-width: 0;
      z-index: 6;
      animation: detailExpand 0.3s ease forwards;
      overflow: hidden;
      box-sizing: border-box;
    }
    .gantt-detail-row.closing {
      animation: detailCollapse 0.2s ease forwards;
    }
    .gantt-wrapper[data-row-appearance="default"] .gantt-detail-row .gantt-detail-row-inner {
      min-height: 280px;
    }
    .gantt-wrapper[data-row-appearance="fill"] .gantt-detail-row .gantt-detail-row-inner {
      min-height: 280px;
    }
    @keyframes detailExpand {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes detailCollapse {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-6px); }
    }
    .gantt-detail-row-inner {
      min-width: 0;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      max-height: min(60vh, 480px);
      overflow-y: auto;
      box-sizing: border-box;
    }
    .task-detail-content {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      transition: opacity 0.15s ease;
      gap: 20px 24px;
      padding-top: 28px;
      min-width: 0;
      max-width: 100%;
    }
    .task-detail-content .task-detail-field:nth-child(n) { grid-column: span 1; }
    .task-detail-field {
      margin-bottom: 0;
      min-width: 0;
      overflow-wrap: break-word;
    }
    .task-detail-field label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    .task-detail-field .field-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      color: var(--text-primary);
    }
    .task-detail-field input[type="text"],
    .task-detail-field textarea,
    .task-detail-field select {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      padding: 10px 12px;
      border: 1px solid var(--border-strong);
      background: var(--bg-surface);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    .task-detail-field select {
      padding-right: 40px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: var(--bg-surface);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }
    .task-detail-field select:focus {
      outline: none;
      border-color: var(--color-general-primary);
    }
    .task-detail-field textarea {
      min-height: 80px;
      resize: vertical;
    }
    .task-detail-field input:focus,
    .task-detail-field textarea:focus {
      outline: none;
      border-color: var(--color-general-primary);
    }
    .task-detail-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .task-detail-list li {
      display: flex;
      align-items: center;
      padding: 4px 0;
    }
    .task-detail-list-input-wrap {
      flex: 1;
      min-width: 0;
      position: relative;
    }
    .task-detail-list input {
      width: 100%;
      min-width: 0;
      padding: 6px 36px 6px 10px;
      border: 1px solid var(--border-strong);
      background: var(--bg-surface);
      color: var(--text-primary);
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
    }
    .task-detail-list input:focus { outline: none; border-color: var(--color-general-primary); }
    .task-detail-list-remove {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      padding: 0;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .task-detail-list-remove:hover { color: #dc2626; }
    .task-detail-add-btn {
      display: block;
      width: 100%;
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-tertiary);
      background: transparent;
      border: none;
      border-radius: var(--button-radius);
      cursor: pointer;
      box-sizing: border-box;
    }
    .task-detail-add-btn:hover { color: var(--text-primary); }
    .task-detail-toolbar {
      position: absolute;
      top: 12px;
      right: 24px;
    }
    .task-detail-edit-btn,
    .task-detail-done-btn {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--border-strong);
      background: var(--bg-surface);
      color: var(--text-secondary);
    }
    .task-detail-edit-btn:hover,
    .task-detail-done-btn:hover {
      background: var(--bg-subtle);
      color: var(--text-primary);
    }
    .task-detail-done-btn {
      background: var(--color-general-primary);
      border-color: var(--color-general-primary);
      color: #fff;
    }
    .task-detail-done-btn:hover {
      background: var(--color-general-primary-active);
      border-color: var(--color-general-primary-active);
      color: #fff;
    }
    @media (prefers-color-scheme: dark) {
      .task-detail-done-btn,
      .task-detail-done-btn:hover {
        color: #171717;
      }
    }
    .task-detail-view-value {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      min-width: 0;
    }
    .task-detail-view-value.empty {
      color: var(--text-tertiary);
      font-style: italic;
    }
    .task-detail-link-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .task-detail-link-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-surface);
      border: 1px solid var(--border-strong);
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-primary);
      transition: border-color 0.15s, box-shadow 0.15s;
      min-width: 0;
    }
    .task-detail-link-card:hover {
      border-color: var(--color-general-primary);
      box-shadow: var(--shadow-md);
    }
    .task-detail-link-card-icon {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-hover);
      color: var(--text-tertiary);
    }
    .task-detail-link-card-icon.figma { background: var(--bg-hover); color: var(--text-tertiary); }
    .task-detail-link-card-icon.jira { background: #0052CC; color: #fff; }
    .task-detail-link-card-icon.google { background: var(--bg-surface); color: #4285F4; border: 1px solid var(--border-strong); }
    .task-detail-link-card-content {
      flex: 1;
      min-width: 0;
    }
    .task-detail-link-card-title {
      font-weight: 400;
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .task-detail-link-card-url {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .task-detail-link-card-arrow {
      flex-shrink: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }
    .task-detail-view-list {
      list-style: disc;
      margin: 0 0 0 18px;
      padding: 0;
    }
    .task-detail-view-list li {
      padding: 2px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .task-detail-view-list.empty { color: var(--text-tertiary); font-style: italic; }
    .task-detail-dependents-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .task-detail-dependent-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      border: 1px solid var(--border-default);
      border-radius: 6px;
      background: var(--bg-surface);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .task-detail-dependent-item:hover {
      border-color: var(--color-general-primary);
      background: var(--bg-hover);
    }
    .task-detail-dependent-item-view {
      cursor: default;
      pointer-events: none;
    }
    .task-detail-dependent-item-view:hover {
      border-color: var(--border-default);
      background: var(--bg-surface);
    }
    .task-detail-mobile-summary {
      display: none;
    }
    .task-detail-mobile-floating-actions {
      display: none !important;
    }
    @media (max-width: 480px) {
      #ganttView { min-width: 0; max-width: 100vw; overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; box-sizing: border-box; }
      #ganttView .page-header { padding-top: 16px; min-width: 0; max-width: 100%; }
      #ganttView .page-header-title-wrap { max-width: 100%; }
      #ganttView .page-header .subtitle { max-width: 100%; }
      #ganttView .board-info-strip { min-width: 0; display: flex !important; }
      #ganttView .board-info-strip .board-info-item { white-space: normal; overflow-wrap: break-word; }
      .gantt-wrapper { max-width: 100%; min-width: 0; box-sizing: border-box; overflow-x: hidden; flex: 0 1 auto; min-height: 0; }
      .gantt-wrapper .gantt-grid { max-width: 100%; min-width: 0; }
      .gantt-header-sticky { min-width: 0; max-width: 100%; }
    }
    /* Mobile portrait only: minimal task view (task only, no status col), hide bars and phase header */
    @media (max-width: 480px) and (orientation: portrait) {
      .gantt-header-sticky .phase-header-row {
        display: none !important;
      }
      /* Single column: task only; status column hidden. Left padding matches page header (24px). */
      #ganttHeaderRow.gantt-header {
        grid-template-columns: minmax(0, 1fr);
        min-width: 0;
        max-width: 100%;
      }
      #ganttHeaderRow.gantt-header .gantt-cell:nth-child(n+2) {
        display: none !important;
      }
      #ganttHeaderRow.gantt-header .gantt-cell:first-child {
        grid-column: 1;
        min-width: 0;
        padding-left: 24px;
        padding-right: 0;
      }
      .gantt-row:not(.gantt-header) {
        grid-template-columns: minmax(0, 1fr);
        min-width: 0;
        max-width: 100%;
        min-height: 52px;
      }
      .gantt-row:not(.gantt-header) .gantt-cell:nth-child(n+2) {
        display: none !important;
      }
      .gantt-row:not(.gantt-header) .gantt-cell:first-child {
        grid-column: 1;
        min-width: 0;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        padding: 14px 0 14px 24px;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-wrap {
        flex-shrink: 0;
        min-width: max-content;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown {
        flex: none;
        min-width: 0;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-trigger {
        font-size: 13px;
        width: auto;
        min-width: 0;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-trigger,
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-trigger span {
        color: var(--text-primary);
      }
      .gantt-row .gantt-task-cell .task-name-wrap,
      .gantt-row .gantt-task-cell .task-text {
        min-width: 0;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
      }
      .gantt-row .gantt-task-cell {
        overflow: hidden;
        font-size: 16px;
        display: grid;
        grid-template-columns: 1fr auto auto;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .gantt-row .gantt-task-cell .task-name-wrap {
        min-width: 0;
        grid-column: 1;
      }
      .gantt-row .gantt-task-cell .task-cell-phase-pill {
        grid-column: 2;
        margin-left: 0;
      }
      .gantt-row .gantt-task-cell .task-actions {
        grid-column: 3;
      }
      /* Portrait: grid so phase/actions stay right-aligned; name + tag on the left */
      /* Fixed width for right column so left column (task name + In progress tag) doesn't shift when row expands */
      .gantt-row .gantt-task-cell {
        display: grid;
        grid-template-columns: 1fr 100px;
        align-items: center;
        gap: 8px;
        min-width: 0;
        overflow: hidden;
      }
      .gantt-row .gantt-task-cell .task-name-wrap {
        grid-column: 1;
        min-width: 0;
      }
      /* Right column: phase and actions swap; same padding so both look aligned */
      .gantt-row .gantt-task-cell .task-cell-right-group {
        grid-column: 2;
        justify-self: end;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        flex-shrink: 0;
        gap: 4px;
        min-width: 0;
        padding-right: 8px;
        min-height: 28px;
      }
      .gantt-row .gantt-task-cell .task-cell-phase-pill {
        margin-left: 0;
        flex-shrink: 0;
      }
      .task-cell-phase-pill {
        display: flex !important;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
        margin-left: 0;
        font-size: 12px;
        color: var(--text-secondary);
        min-height: 28px;
        padding: 0 4px;
        box-sizing: border-box;
      }
      .task-cell-phase-pill-label {
        white-space: nowrap;
        overflow: visible;
        min-width: 0;
        flex-shrink: 0;
      }
      .gantt-row .gantt-task-cell .task-actions .gantt-delete-btn,
      .gantt-row .gantt-task-cell .task-actions .gantt-duplicate-btn,
      .gantt-row .gantt-task-cell .task-actions .task-rename-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
      }
      .gantt-row .gantt-task-cell .task-actions .gantt-delete-btn svg,
      .gantt-row .gantt-task-cell .task-actions .gantt-duplicate-btn svg,
      .gantt-row .gantt-task-cell .task-actions .task-rename-btn svg {
        width: 14px;
        height: 14px;
      }
      .gantt-detail-row {
        padding: 20px 10px 24px;
        max-width: 100%;
        box-sizing: border-box;
      }
      .gantt-detail-row-inner {
        max-height: none;
      }
      .task-detail-mobile-summary {
        display: none !important;
      }
      .gantt-detail-row .task-detail-content {
        grid-template-columns: 1fr;
        gap: 20px 0;
        padding-top: 0;
      }
      .gantt-detail-row .task-detail-content .task-detail-field {
        grid-column: 1 / -1;
        width: 100%;
      }
      /* Portrait: hide actions from layout when collapsed so phase can sit flush right */
      .gantt-row:not(.gantt-header) .gantt-task-cell .task-actions {
        display: none !important;
        pointer-events: none;
      }
      .gantt-row.expanded .gantt-task-cell .task-cell-phase-pill {
        display: none !important;
      }
      .gantt-row.expanded .gantt-task-cell .task-actions {
        display: flex !important;
        opacity: 1 !important;
        pointer-events: auto;
      }
      /* Task table height = content (all rows); view scrolls so no fixed table height */
      .gantt-wrapper {
        width: 100%;
        max-width: 100%;
        flex: 0 0 auto;
      }
      .gantt-chart-scroll {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        overflow-x: hidden;
        overflow-y: visible;
        flex: 0 0 auto;
      }
      .gantt-wrapper .gantt-grid {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        margin-left: 0;
        margin-right: 0;
      }
      .gantt-header-sticky {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        margin-left: 0;
        margin-right: 0;
      }
    }
    /* Small viewport portrait (e.g. 481–768px): same minimal task view, no status col */
    @media (min-width: 481px) and (max-width: 768px) and (orientation: portrait) {
      .gantt-header-sticky .phase-header-row {
        display: none !important;
      }
      /* Single column: task only; status column hidden. Left padding matches page header (24px). */
      #ganttHeaderRow.gantt-header {
        grid-template-columns: minmax(0, 1fr);
        min-width: 0;
        max-width: 100%;
      }
      #ganttHeaderRow.gantt-header .gantt-cell:nth-child(n+2) {
        display: none !important;
      }
      #ganttHeaderRow.gantt-header .gantt-cell:first-child {
        grid-column: 1;
        min-width: 0;
        padding-left: 24px;
        padding-right: 0;
      }
      .gantt-row:not(.gantt-header) {
        grid-template-columns: minmax(0, 1fr);
        min-width: 0;
        max-width: 100%;
      }
      .gantt-row:not(.gantt-header) .gantt-cell:nth-child(n+2) {
        display: none !important;
      }
      .gantt-row:not(.gantt-header) .gantt-cell:first-child {
        padding-left: 24px;
        padding-right: 0;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-wrap {
        flex-shrink: 0;
        min-width: max-content;
      }
      .gantt-row .gantt-phase-cell .gantt-phase-dropdown-trigger {
        width: auto;
      }
      .gantt-header .gantt-cell:nth-child(2) {
        text-align: right;
      }
      .gantt-row .gantt-task-cell {
        display: grid;
        grid-template-columns: 1fr auto auto;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .gantt-row .gantt-task-cell .task-name-wrap {
        min-width: 0;
        grid-column: 1;
      }
      .gantt-row .gantt-task-cell .task-cell-phase-pill {
        grid-column: 2;
        margin-left: 0;
      }
      .gantt-row .gantt-task-cell .task-actions {
        grid-column: 3;
      }
      /* Portrait: grid so phase/actions stay right-aligned; name + tag on the left */
      /* Fixed width for right column so task name + In progress tag don't shift when row expands */
      .gantt-row .gantt-task-cell {
        display: grid;
        grid-template-columns: 1fr 100px;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .gantt-row .gantt-task-cell .task-name-wrap {
        grid-column: 1;
        min-width: 0;
      }
      /* Right column: phase and actions swap; same padding so both look aligned */
      .gantt-row .gantt-task-cell .task-cell-right-group {
        grid-column: 2;
        justify-self: end;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        flex-shrink: 0;
        gap: 4px;
        min-width: 0;
        padding-right: 8px;
        min-height: 28px;
      }
      .gantt-row .gantt-task-cell .task-cell-phase-pill {
        margin-left: 0;
        flex-shrink: 0;
      }
      .task-cell-phase-pill {
        display: flex !important;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
        margin-left: 0;
        font-size: 12px;
        color: var(--text-secondary);
        min-height: 28px;
        padding: 0 4px;
        box-sizing: border-box;
      }
      .task-cell-phase-pill-label {
        white-space: nowrap;
        overflow: visible;
        min-width: 0;
        flex-shrink: 0;
      }
      .gantt-row .gantt-task-cell {
        overflow: hidden;
      }
      .gantt-row .gantt-task-cell .task-actions .gantt-delete-btn,
      .gantt-row .gantt-task-cell .task-actions .gantt-duplicate-btn,
      .gantt-row .gantt-task-cell .task-actions .task-rename-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
      }
      .gantt-row .gantt-task-cell .task-actions .gantt-delete-btn svg,
      .gantt-row .gantt-task-cell .task-actions .gantt-duplicate-btn svg,
      .gantt-row .gantt-task-cell .task-actions .task-rename-btn svg {
        width: 14px;
        height: 14px;
      }
      /* Portrait: hide actions from layout when collapsed so phase can sit flush right */
      .gantt-row:not(.gantt-header) .gantt-task-cell .task-actions {
        display: none !important;
        pointer-events: none;
      }
      .gantt-row.expanded .gantt-task-cell .task-cell-phase-pill {
        display: none !important;
      }
      .gantt-row.expanded .gantt-task-cell .task-actions {
        display: flex !important;
        opacity: 1 !important;
        pointer-events: auto;
      }
    }
    /* Mobile portrait: hide sprint view selector, move settings to top right; keep board info visible */
    @media (max-width: 768px) and (orientation: portrait) {
      #ganttView { overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; min-height: 0; }
      /* Table height grows with tasks; whole view scrolls */
      .gantt-wrapper { flex: 0 0 auto; }
      .gantt-chart-scroll { flex: 0 0 auto; overflow-y: visible; overflow-x: hidden; }
      #ganttView .page-header .chart-controls label[for="viewMode"],
      #ganttView .page-header .chart-controls #viewMode {
        display: none !important;
      }
      #ganttView .page-header {
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-start;
      }
      #ganttView .page-header .chart-controls {
        position: absolute;
        top: 0;
        right: 0;
      }
      #ganttView .page-header .page-header-title-wrap {
        padding-right: 52px;
      }
      #ganttView .board-info-strip {
        display: flex !important;
        visibility: visible;
      }
      /* Mobile portrait: show "In progress" tag right after task name when status is In progress */
      .gantt-row .gantt-task-cell .task-name-wrap.has-in-progress-tag .task-in-progress-tag {
        display: inline-flex !important;
        align-items: center;
        margin-left: 0;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary, #525252);
        background: var(--bg-subtle, #f5f5f5);
        border: 1px solid var(--border-default, #e5e5e5);
        border-radius: 4px;
        flex-shrink: 0;
        white-space: nowrap;
      }
      .gantt-row .gantt-task-cell .task-name-wrap {
        display: flex;
        align-items: center;
        gap: 4px;
        min-width: 0;
      }
      .gantt-row .gantt-task-cell .task-name-wrap .task-text {
        min-width: 0;
      }
      /* All portrait: table fits viewport, no horizontal scroll */
      #ganttView { width: 100%; max-width: 100vw; box-sizing: border-box; }
      .gantt-wrapper { width: 100%; max-width: 100%; min-width: 0; overflow-x: hidden; }
      .gantt-chart-scroll { width: 100%; max-width: 100%; min-width: 0; overflow-x: hidden; overflow-y: visible; }
      .gantt-wrapper .gantt-grid {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        margin-left: 0;
        margin-right: 0;
        flex: 0 0 auto;
      }
      .gantt-header-sticky {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        margin-left: 0;
        margin-right: 0;
      }
      .gantt-row { min-width: 0; }
      .gantt-detail-row {
        max-width: 100%;
        box-sizing: border-box;
      }
      .gantt-detail-row .task-detail-toolbar {
        right: 8px;
      }
    }
    /* Mobile landscape: compact grid so task + timeline fit in viewport (no large gap) */
    @media (max-width: 768px) and (orientation: landscape) {
      .gantt-wrapper .gantt-row,
      #ganttHeaderRow.gantt-header {
        grid-template-columns: 140px 0fr 0fr 0fr 0fr repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
      }
      .gantt-wrapper .phase-header-row {
        grid-template-columns: 140px 0fr 0fr 0fr 0fr repeat(var(--gantt-weeks, 8), var(--gantt-week-width, 1fr));
      }
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(2),
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(3),
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(4),
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(5) {
        overflow: hidden;
        min-width: 0;
        padding: 0;
        border: none;
      }
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(1),
      .gantt-wrapper .gantt-row .gantt-cell:nth-child(n+6) {
        min-width: 0;
      }
      .gantt-wrapper .gantt-timeline-cell {
        grid-column: 6 / -1;
      }
      .gantt-wrapper .phase-header-row .phase-header-cell:first-child {
        grid-column: 1;
      }
      .gantt-wrapper .phase-header-timeline {
        grid-column: 6 / -1;
      }
      /* Landscape: no phase label in row; show action icons only when row is expanded */
      .gantt-wrapper .gantt-row .gantt-task-cell .task-cell-phase-pill {
        display: none !important;
      }
      .gantt-wrapper .gantt-row:not(.gantt-header) .gantt-task-cell .task-actions {
        opacity: 0;
      }
      .gantt-wrapper .gantt-row.expanded .gantt-task-cell .task-actions {
        opacity: 1;
      }
    }
    /* Mobile landscape only: always show task row action icons (no hover on touch). Portrait: only on expand (see portrait blocks). */
    @media (max-width: 768px) and (orientation: landscape) {
      .gantt-row:not(.gantt-header) .gantt-task-cell .task-actions {
        opacity: 1;
      }
    }
    /* Mobile landscape: keep bars visible (no minimal-view collapse) — handled by portrait-only rules above */
    @media (max-width: 768px) {
      /* Bottom padding for FAB + iOS home indicator / safe area */
      #ganttView.active {
        padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
      }
      .gantt-detail-row .task-detail-toolbar {
        right: 10px;
      }
      .task-detail-mobile-tooltip {
        display: block !important;
        min-width: 0;
        width: 100%;
        margin-bottom: 20px;
        visibility: visible;
        opacity: 1;
      }
      .task-detail-mobile-tooltip .gantt-bar-tooltip-static {
        display: block !important;
      }
      .task-detail-mobile-tooltip .gantt-bar-tooltip-title,
      .task-detail-mobile-tooltip .gantt-bar-tooltip-desc {
        display: none !important;
      }
      .task-detail-mobile-tooltip .gantt-bar-tooltip-move-label { font-size: 12px; }
      .task-detail-mobile-tooltip .gantt-bar-tooltip-row { font-size: 14px; color: var(--text-secondary); margin-top: 6px; }
      .task-detail-mobile-tooltip .gantt-bar-tooltip-row .gantt-bar-tooltip-icon { width: 16px; height: 16px; }
      .task-detail-mobile-tooltip .gantt-phase-dropdown-trigger { font-size: 14px; }
      .gantt-detail-row .task-detail-field-depends-on { display: none !important; }
    }
    @media (min-width: 481px) {
      .task-detail-mobile-tooltip { display: none; }
    }
    .app-views-wrap { position: relative; flex: 1; min-height: 0; min-width: 0; display: flex; flex-direction: row; }
    .app-views-inner { flex: 1; min-width: 0; min-height: 0; position: relative; display: flex; flex-direction: column; }
    .app-view {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition-property: opacity;
      transition-duration: 0.25s;
      transition-timing-function: ease;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }
    .app-view.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 1;
    }
    #landingView {
      align-items: stretch;
      justify-content: stretch;
      padding: 0;
      overflow-y: auto;
    }
    @media (min-width: 769px) {
      #landingView {
        flex-direction: row;
        align-items: stretch;
        gap: 0;
        padding: 0;
      }
      .landing-layout {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        flex: 1;
        width: 100%;
        min-height: 100%;
        max-width: none;
        margin: 0;
        gap: 0;
      }
      .landing-sidebar {
        flex: 1 1 50%;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 48px 56px;
        background: var(--bg-surface);
        border-right: 1px solid var(--border-default);
      }
      .landing-main {
        flex: 1 1 50%;
        min-width: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 48px 56px;
        background: var(--bg-body);
      }
    }
    @media (max-width: 768px) {
      #landingView {
        padding: 24px 20px;
      }
      .landing-layout {
        display: flex;
        flex-direction: column;
        gap: 32px;
        max-width: 480px;
        width: 100%;
        margin: 0 auto;
      }
      .landing-sidebar {
        order: 1;
        padding: 0;
      }
      .landing-main {
        order: 2;
      }
    }
    .landing-sidebar {
      text-align: left;
    }
    .landing-sidebar-visual {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
      width: 220px;
    }
    .landing-sidebar-visual .landing-sidebar-bar {
      height: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .landing-sidebar-visual .landing-sidebar-bar.bar-1 {
      width: 40px;
      background: #6366f1;
      margin-left: 0;
    }
    .landing-sidebar-visual .landing-sidebar-bar.bar-2 {
      width: 56px;
      background: #8b5cf6;
      margin-left: 40px;
      animation: home-empty-bar2-pulse 5.4s ease-in-out infinite;
    }
    .landing-sidebar-visual .landing-sidebar-bar.bar-3 {
      width: 52px;
      background: #a78bfa;
      margin-left: 96px;
      animation: home-empty-bar3-pulse 5.4s ease-in-out infinite;
    }
    .landing-sidebar-visual .landing-sidebar-bar.bar-4 {
      width: 28px;
      background: #c4b5fd;
      margin-left: 148px;
      animation: home-empty-bar4-shift 5.4s ease-in-out infinite;
    }
    .landing-sidebar-visual .landing-sidebar-line {
      width: 100%;
      height: 2px;
      background: var(--text-tertiary);
      opacity: 0.2;
      border-radius: 1px;
    }
    @media (prefers-color-scheme: dark) {
      .landing-sidebar-visual .landing-sidebar-bar.bar-1 { background: #818cf8; }
      .landing-sidebar-visual .landing-sidebar-bar.bar-2 { background: #a78bfa; }
      .landing-sidebar-visual .landing-sidebar-bar.bar-3 { background: #c4b5fd; }
      .landing-sidebar-visual .landing-sidebar-bar.bar-4 { background: #ddd6fe; }
    }
    .landing-hero-title {
      font-size: 28px;
      font-weight: 600;
      color: var(--color-general-primary);
      margin: 0 0 8px 0;
      line-height: 1.25;
      letter-spacing: -0.02em;
    }
    @media (min-width: 769px) {
      .landing-hero-title {
        font-size: 32px;
      }
    }
    .landing-hero-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin: 0 0 28px 0;
      line-height: 1.45;
    }
    .landing-features {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .landing-feature {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 16px;
    }
    .landing-feature:last-child {
      margin-bottom: 0;
    }
    .landing-feature-icon {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      color: var(--color-general-primary);
      margin-top: 2px;
    }
    .landing-feature-icon svg {
      width: 100%;
      height: 100%;
    }
    .landing-feature-text {
      font-size: 15px;
      color: var(--text-primary);
      line-height: 1.4;
    }
    @media (prefers-color-scheme: dark) {
      .landing-sidebar {
        background: var(--bg-subtle, #0d0d0d);
      }
      .landing-sidebar .landing-hero-title { color: #a3a3a3; }
      .landing-sidebar .landing-hero-subtitle { color: #737373; }
      .landing-sidebar .landing-feature-icon { color: #8c8c8c; }
      .landing-sidebar .landing-feature-text { color: #8c8c8c; }
    }
    .landing-inner {
      max-width: 360px;
      width: 100%;
      text-align: center;
    }
    @media (min-width: 769px) {
      .landing-inner {
        max-width: 360px;
        text-align: left;
      }
    }
    .landing-step-indicator {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-tertiary);
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }
    .landing-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--color-general-primary);
      margin: 0 0 8px 0;
    }
    .landing-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 32px 0;
      line-height: 1.45;
    }
    .landing-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .landing-option {
      display: block;
      width: 100%;
      padding: 20px 24px;
      text-align: left;
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      color: var(--color-general-primary);
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: var(--button-radius);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
    }
    .landing-option:hover {
      border-color: var(--border-strong);
    }
    .landing-option-desc {
      font-size: 13px;
      font-weight: 400;
      color: var(--text-secondary);
      margin-top: 4px;
      line-height: 1.4;
    }
    .landing-option-badge {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      margin-top: 6px;
    }
    #homeView.active ~ #ganttView #ganttDependencyLine,
    #homeView.active ~ #ganttView #ganttChildConnectorsContainer,
    #homeView.active ~ #ganttView .gantt-dependency-unlink-btn {
      display: none !important;
    }
    body:has(#homeView.active) .add-task-fab {
      display: none !important;
    }
    #homeView.active {
      padding: 24px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    #homeView.active:has(.home-project-list.is-empty) {
      display: flex;
      flex-direction: column;
      min-height: 100%;
      overflow-y: visible;
    }
    @media (max-width: 480px) {
      #homeView.active { padding: 16px 10px calc(88px + env(safe-area-inset-bottom, 0px)); }
    }
    .home-sticky-header {
      flex-shrink: 0;
      margin-bottom: 16px;
    }
    #homeView h1 { margin-bottom: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .home-project-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 100px;
      background: var(--color-general-primary);
      color: var(--bg-body);
    }
    .home-subtitle { color: var(--text-secondary); margin: 0 0 24px 0; font-size: 14px; }
    .home-shared-file { margin-bottom: 24px; }
    .home-shared-file-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
    .home-shared-file-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .home-shared-file-input { flex: 1; min-width: 200px; padding: 8px 10px; font-size: 13px; border: 1px solid var(--border-default); border-radius: var(--input-radius); font-family: inherit; }
    .home-shared-file-btn { padding: 8px 12px; font-size: 13px; border-radius: var(--button-radius); border: 1px solid var(--border-strong); background: var(--bg-surface); color: var(--text-primary); cursor: pointer; font-family: inherit; }
    .home-shared-file-btn:hover { background: var(--bg-hover); }
    .home-settings-icon-btn {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
    }
    .home-settings-icon-btn:hover {
      background: transparent;
      color: var(--text-primary);
    }
    .home-settings-icon-btn svg { width: 18px; height: 18px; transition: transform 0.3s ease; }
    .home-settings-icon-btn:hover svg { transform: rotate(90deg); }
    #homeSettingsBtn {
      position: fixed;
      top: max(12px, env(safe-area-inset-top, 0px));
      right: max(12px, env(safe-area-inset-right, 0px));
      margin: 0;
      z-index: 1000;
    }
    .home-shared-file-push { margin-top: 12px; }
    .home-shared-file-push .home-shared-file-label { margin-bottom: 4px; }
    .home-shared-file-status { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 0; }
    .home-sync-inline { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 8px 12px; border: 1px solid var(--border-default); border-radius: 8px; min-height: 38px; box-sizing: border-box; }
    .home-sync-inline .home-shared-file-status-text { cursor: pointer; font-size: 14px; }
    .home-sync-inline .home-shared-file-status-text:hover { color: var(--text-primary); }
    .home-shared-file-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .home-shared-file-status-dot.github { background: #238636; }
    .home-shared-file-status-dot.synced { background: #238636; }
    .home-shared-file-status-dot.synced.syncing { background: #d97706; }
    .home-shared-file-status-dot.synced.error { background: #dc2626; }
    .home-shared-file-status-dot.custom { background: var(--text-tertiary); }
    .home-shared-file-status-dot.none { background: var(--stroke-default); }
    .home-shared-file-status-dot.local { background: var(--stroke-default); }
    .home-shared-file-status-dot.syncing { animation: home-sync-dot-pulse 1.2s ease-in-out infinite; }
    @keyframes home-sync-dot-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .home-shared-file-status-text { font-size: 13px; color: var(--text-secondary); }
    .home-shared-file-status-text strong { color: var(--text-primary); font-weight: 600; }
    .home-shared-file-open-btn { padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: var(--button-radius); border: 1px solid var(--border-strong); background: var(--bg-surface); color: var(--text-primary); cursor: pointer; font-family: inherit; }
    .home-shared-file-open-btn:hover { background: var(--bg-hover); }
    .shared-file-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 24px; }
    .shared-file-modal-overlay.visible { display: flex; }
    .shared-file-modal { background: var(--bg-surface); border-radius: 12px; padding: 24px; width: 480px; height: 420px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-md); border: 1px solid var(--border-default); box-sizing: border-box; }
    .shared-file-modal-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: -24px -24px 16px -24px; padding: 16px 24px; border-bottom: 1px solid var(--border-default); background: var(--bg-surface); flex-shrink: 0; }
    .shared-file-modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; flex: 1; min-width: 0; }
    .shared-file-modal-close {
      width: 36px; height: 36px; min-width: 36px; min-height: 36px; padding: 0; border: none; background: transparent; border-radius: var(--button-radius); color: var(--text-tertiary); cursor: pointer; font-size: 22px; line-height: 1; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .shared-file-modal-close:hover { background: var(--bg-subtle); color: var(--text-primary); }
    .shared-file-modal h3 { margin: 0 0 16px 0; font-size: 18px; font-weight: 600; }
    .shared-file-modal .shared-file-modal-status { display: flex; align-items: center; gap: 6px; margin-top: 6px; margin-bottom: 0; padding: 0; background: none; border-radius: 0; font-size: 12px; color: var(--text-tertiary); min-height: 18px; }
    .shared-file-modal .shared-file-modal-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .shared-file-modal .shared-file-modal-status-dot.github { background: #238636; }
    .shared-file-modal .shared-file-modal-status-dot.synced { background: #238636; }
    .shared-file-modal .shared-file-modal-status-dot.custom { background: var(--text-tertiary); }
    .shared-file-modal .shared-file-modal-status-dot.none { background: var(--stroke-default); }
    .shared-file-modal .shared-file-modal-status-dot.local { background: var(--stroke-default); }
    .shared-file-modal label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
    .shared-file-input-wrap { display: flex; align-items: stretch; margin-bottom: 12px; border: 1px solid var(--border-strong); border-radius: var(--input-radius); background: var(--bg-surface); transition: box-shadow var(--motion-duration-fast) var(--motion-easing); }
    .shared-file-input-wrap:focus-within { box-shadow: 0 0 0 1px var(--color-general-primary); outline: none; }
    .shared-file-input-wrap input { flex: 1; min-width: 0; padding: 10px 12px; border: none; border-radius: var(--input-radius) 0 0 var(--input-radius); font-size: 14px; box-sizing: border-box; background: transparent; color: var(--text-primary); font-family: inherit; }
    .shared-file-input-wrap input::placeholder { color: var(--text-tertiary); opacity: 1; }
    .shared-file-input-wrap input:focus { outline: none; }
    .shared-file-input-icons { display: flex; align-items: center; justify-content: center; gap: 2px; padding: 0 6px 0 8px; flex-shrink: 0; background: transparent; border-radius: 0 var(--input-radius) var(--input-radius) 0; border-left: 1px solid var(--border-subtle); }
    .shared-file-input-icons .shared-file-input-icon { width: 28px; height: 28px; min-height: 28px; padding: 0; border: none; border-radius: 4px; background: transparent; color: var(--text-secondary); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .shared-file-input-icons .shared-file-input-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
    .shared-file-input-icons .shared-file-input-icon svg { width: 16px; height: 16px; }
    .shared-file-modal-token-row { display: block; margin-bottom: 12px; }
    .shared-file-modal-token-row .shared-file-input-wrap { margin-bottom: 0; }
    .shared-file-modal .shared-file-modal-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .excel-sync-step-preview .shared-file-modal-actions { justify-content: flex-end; }
    .home-shared-file-open-btn--primary { background: var(--color-general-primary); color: var(--bg-body); border-color: var(--color-general-primary); }
    .home-shared-file-open-btn--primary:hover { background: var(--color-general-primary-hover); border-color: var(--color-general-primary-hover); }
    .shared-file-modal .shared-file-modal-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-default); }
    .excel-sync-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100010; display: none; align-items: center; justify-content: center; padding: 24px; }
    .excel-sync-modal-overlay.visible { display: flex; }
    .excel-sync-modal-overlay .excel-sync-modal { max-height: 85vh; overflow-y: auto; }
    .excel-sync-step { margin-top: 0; }
    .excel-sync-file-label { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border: 1px dashed var(--border-strong); border-radius: var(--button-radius); background: var(--bg-subtle); color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 500; transition: border-color var(--motion-duration-fast) var(--motion-easing), background var(--motion-duration-fast) var(--motion-easing); }
    .excel-sync-file-label:hover { border-color: var(--color-general-primary); background: var(--bg-hover); color: var(--text-primary); }
    .excel-sync-file-label.drag-over { border-color: var(--color-general-primary); background: var(--bg-hover); color: var(--color-general-primary); }
    .excel-sync-hint { font-size: 12px; color: var(--text-tertiary); margin: 8px 0 0 0; }
    .excel-sync-preview-table-wrap { max-height: 200px; overflow: auto; margin: 12px 0; border: 1px solid var(--border-default); border-radius: 6px; }
    .excel-sync-preview-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .excel-sync-preview-table th, .excel-sync-preview-table td { padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border-subtle); }
    .excel-sync-preview-table th { background: var(--bg-subtle); font-weight: 600; color: var(--text-secondary); position: sticky; top: 0; }
    .excel-sync-preview-table tr:last-child td { border-bottom: none; }
    .excel-sync-error { margin-top: 12px; padding: 10px 12px; border-radius: 6px; background: #fef2f2; color: #991b1b; font-size: 13px; }
    @media (prefers-color-scheme: dark) { .excel-sync-error { background: rgba(127,29,29,0.3); color: #fca5a5; } }
    .excel-sync-map-grid { display: flex; flex-direction: column; gap: 10px; margin: 16px 0; }
    .excel-sync-map-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .excel-sync-map-row label { min-width: 100px; font-size: 13px; font-weight: 500; color: var(--text-primary); }
    .excel-sync-map-row label .excel-sync-map-required { color: var(--text-tertiary); font-weight: 400; }
    .excel-sync-map-row select { flex: 1; min-width: 160px; padding: 8px 10px; border: 1px solid var(--border-default); border-radius: var(--input-radius); font-size: 13px; background: var(--bg-default); color: var(--text-primary); }
    .excel-sync-change-mapping-btn { margin-left: 8px; padding: 0; border: none; background: none; color: var(--color-general-primary); font-size: 13px; cursor: pointer; text-decoration: underline; }
    .excel-sync-change-mapping-btn:hover { text-decoration: none; }
    .project-setup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100010; display: none; align-items: center; justify-content: center; padding: 24px; }
    .project-setup-overlay.visible { display: flex; }
    .project-setup-overlay .project-setup-modal { position: relative; display: flex; flex-direction: column; height: 85vh; min-height: 520px; max-height: 90vh; min-width: 320px; max-width: 420px; padding: 16px 20px 20px 20px; overflow: hidden; }
    .project-setup-overlay .project-setup-modal .shared-file-modal-header { margin: -16px -20px 12px -20px; padding: 12px 20px; flex-shrink: 0; }
    .project-setup-overlay .project-setup-modal .project-setup-body { flex: 1; overflow-y: auto; min-height: 0; padding-bottom: 100px; }
    .project-setup-overlay .project-setup-modal .project-setup-footer { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1; border-top: 1px solid var(--border-default); background: var(--bg-surface); padding: 12px 20px 20px 20px; border-radius: 0 0 12px 12px; }
    .project-setup-step { margin-top: 0; }
    .project-setup-step .storage-modal-panel-desc { margin-bottom: 16px; }
    .project-setup-body .settings-section { margin-bottom: 20px; }
    .project-setup-body .settings-section:last-child { margin-bottom: 0; }
    .project-setup-phases { display: flex; flex-direction: column; gap: 8px; margin: 12px 0; }
    .project-setup-phase-row { display: flex; align-items: center; gap: 8px; cursor: grab; }
    .project-setup-phase-row:active { cursor: grabbing; }
    .project-setup-phase-row.dragging { opacity: 0.6; }
    .project-setup-phase-row .project-setup-phase-grip { width: 20px; flex-shrink: 0; color: var(--text-tertiary); cursor: grab; display: flex; align-items: center; justify-content: center; }
    .project-setup-phase-row .project-setup-phase-grip:active { cursor: grabbing; }
    .project-setup-phase-row input[type="color"] { width: 32px; height: 32px; padding: 2px; border: 1px solid var(--border-strong); border-radius: var(--input-radius); cursor: pointer; background-color: transparent; }
    .project-setup-phase-row input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid var(--border-strong); border-radius: var(--input-radius); font-size: 14px; font-family: inherit; background-color: transparent; color: var(--text-primary); }
    .project-setup-phase-remove { width: 28px; height: 28px; padding: 0; border: none; border-radius: 6px; background: var(--bg-hover); color: var(--text-secondary); font-size: 18px; line-height: 1; cursor: pointer; flex-shrink: 0; }
    .project-setup-phase-remove:hover { background: var(--border-strong); color: var(--text-primary); }
    .project-setup-phase-remove:disabled { opacity: 0.5; cursor: not-allowed; }
    .project-setup-add-phase { margin-top: 4px; padding: 8px 12px; border: 1px dashed var(--border-strong); border-radius: var(--button-radius); background: transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer; }
    .project-setup-add-phase:hover { border-color: var(--color-general-primary); color: var(--color-general-primary); }
    .project-setup-step .settings-add-phase { border: 1px solid var(--border-strong); background: transparent; color: var(--text-secondary); }
    .project-setup-step .settings-add-phase:hover { background: var(--bg-hover); color: var(--text-primary); }
    .project-setup-team-list { display: flex; flex-direction: column; gap: 6px; margin: 12px 0; }
    #projectSetupStep4 .settings-party-list { gap: 14px; }
    .project-setup-team-row { display: flex; align-items: center; gap: 8px; }
    .project-setup-team-row span { flex: 1; font-size: 13px; color: var(--text-primary); }
    .project-setup-team-row .project-setup-team-remove { padding: 4px 8px; font-size: 12px; border: none; border-radius: 6px; background: var(--bg-hover); color: var(--text-secondary); cursor: pointer; }
    .project-setup-team-row .project-setup-team-remove:hover { color: var(--text-primary); }
    .project-setup-team-add { display: flex; gap: 8px; margin-top: 8px; }
    .project-setup-team-add input { flex: 1; padding: 10px 12px; border: 1px solid var(--border-strong); border-radius: var(--input-radius); font-size: 14px; font-family: inherit; background-color: transparent; color: var(--text-primary); min-height: 40px; box-sizing: border-box; }
    .project-setup-team-add button { padding: 8px 14px; border-radius: var(--button-radius); border: 1px solid var(--border-strong); background: transparent; color: var(--text-primary); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; }
    .project-setup-team-add button:hover { background: var(--bg-hover); }
    .project-setup-done-desc { margin-bottom: 16px; }
    .project-setup-done-actions { display: flex; justify-content: flex-start; }
    .project-setup-progress { display: flex; gap: 8px; justify-content: center; margin-bottom: 8px; }
    .project-setup-progress-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border-strong); transition: background var(--motion-duration-fast) var(--motion-easing); }
    .project-setup-progress-dot[aria-current="true"] { background: var(--color-general-primary); }
    .project-setup-actions { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
    .project-setup-actions .project-setup-actions-left { display: flex; gap: 12px; align-items: center; }
    .project-setup-actions #projectSetupNext { margin-left: 0; }
    .project-setup-actions #projectSetupNext.home-shared-file-open-btn--primary { flex-shrink: 0; }
    .storage-modal-tabs { display: flex; gap: 0; margin: 0 0 20px 0; border-bottom: 1px solid var(--border-default); }
    .storage-modal-tab { padding: 10px 16px; font-size: 13px; font-weight: 500; color: var(--text-secondary); background: none; border: none; border-bottom: 1px solid transparent; margin-bottom: -1px; cursor: pointer; font-family: inherit; }
    .storage-modal-tab:hover { color: var(--text-primary); }
    .storage-modal-tab.active { color: var(--color-general-primary); border-bottom-color: var(--color-general-primary); }
    .storage-modal-tab .storage-tab-check { margin-left: 4px; }
    .storage-modal-tab .storage-tab-check::before { content: "\2713"; font-weight: 700; }
    .storage-modal-tab:not(.storage-tab-selected) .storage-tab-check { visibility: hidden; }
    .storage-modal-tab.storage-tab-selected .storage-tab-check { visibility: visible; color: var(--color-general-primary); }
    .storage-modal-panel { display: none; }
    .storage-modal-panel.active { display: block; }
    .storage-modal-panel-desc { font-size: 13px; color: var(--text-secondary); margin: 0 0 16px 0; line-height: 1.45; }
    .storage-modal-use-btn { margin-top: 16px; }
    .settings-storage-inline .storage-modal-tabs { margin-top: 8px; margin-bottom: 12px; }
    .settings-storage-inline .storage-modal-panel { margin-top: 0; }
    .storage-type-picker { margin-top: 8px; }
    .storage-type-tiles { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .storage-type-tile {
      position: relative;
      display: block;
      width: 100%;
      padding: 12px 14px;
      text-align: left;
      font-family: inherit;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      cursor: pointer;
      transition: border-color var(--motion-duration-normal) var(--motion-easing), background var(--motion-duration-normal) var(--motion-easing);
      box-sizing: border-box;
    }
    .storage-type-tile:hover { border-color: var(--border-strong); background: transparent; }
    .storage-type-tile:focus { outline: none; }
    .storage-type-tile:focus-visible { outline: 1px solid rgba(99, 102, 241, 0.4); outline-offset: 1px; }
    .storage-type-tile.selected {
      border-color: var(--color-general-primary);
    }
    .storage-type-tile.selected::after {
      content: "";
      position: absolute;
      top: 12px;
      right: 12px;
      width: 18px;
      height: 18px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      pointer-events: none;
    }
    .storage-type-tile.selected .storage-type-tile-title { font-weight: 600; }
    .storage-type-tile-content { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); }
    .storage-type-tile.selected .storage-type-tile-content { display: block; }
    .storage-type-tile-content .shared-file-input-wrap { margin-bottom: 8px; }
    .storage-type-tile-content .shared-file-modal-section { margin-top: 12px; }
    .storage-type-tile-content .shared-file-modal-status { display: flex; align-items: center; gap: 6px; margin-top: 6px; margin-bottom: 0; padding: 0; font-size: 12px; color: var(--text-tertiary); min-height: 18px; }
    .storage-type-tile-content .shared-file-modal-status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .storage-type-tile-content .shared-file-modal-status-dot.github,
    .storage-type-tile-content .shared-file-modal-status-dot.synced { background: #238636; }
    .storage-type-tile-content .shared-file-modal-status-dot.syncing { animation: home-sync-dot-pulse 1.2s ease-in-out infinite; }
    .storage-type-tile-content .shared-file-modal-status-dot.custom { background: var(--text-tertiary); }
    .storage-type-tile-content .shared-file-modal-status-dot.none,
    .storage-type-tile-content .shared-file-modal-status-dot.local { background: var(--stroke-default); }
    .storage-type-tile-content label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
    .storage-type-tile-content .shared-file-input-wrap { display: flex; align-items: stretch; border: 1px solid var(--border-strong); border-radius: var(--input-radius); background: transparent; transition: box-shadow var(--motion-duration-fast) var(--motion-easing); }
    .storage-type-tile-content .shared-file-input-wrap:focus-within { box-shadow: 0 0 0 1px var(--color-general-primary); outline: none; }
    .storage-type-tile-content .shared-file-input-wrap input { flex: 1; min-width: 0; padding: 10px 12px; border: none; border-radius: var(--input-radius) 0 0 var(--input-radius); font-size: 14px; box-sizing: border-box; background: transparent; color: var(--text-primary); font-family: inherit; }
    .storage-type-tile-content .shared-file-input-icons { display: flex; align-items: center; gap: 2px; padding: 0 6px 0 8px; flex-shrink: 0; border-left: 1px solid var(--border-subtle); }
    .storage-type-tile-content .shared-file-input-icon { width: 28px; height: 28px; min-height: 28px; padding: 0; border: none; border-radius: 4px; background: transparent; color: var(--text-secondary); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    .storage-type-tile-content .shared-file-input-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
    .storage-type-tile-content .shared-file-input-icon svg { width: 16px; height: 16px; }
    .storage-type-tile-content .storage-github-error { display: none; margin-top: 10px; padding: 8px 10px; font-size: 12px; color: #b91c1c; background: rgba(185, 28, 28, 0.1); border: 1px solid rgba(185, 28, 28, 0.3); border-radius: 6px; }
    .storage-type-tile-content .storage-github-error.visible { display: block; }
    .storage-type-tile-actions { display: flex; flex-wrap: wrap; gap: 8px; }
    .storage-type-tile-actions .home-shared-file-btn { margin: 0; }
    .storage-type-tile-heading { display: flex; align-items: center; gap: 10px; margin-bottom: 2px; }
    .storage-type-tile-icon { flex-shrink: 0; color: var(--text-secondary); }
    .storage-type-tile-icon svg { width: 20px; height: 20px; }
    .storage-type-tile-title { font-size: 14px; font-weight: 500; color: var(--text-primary); margin: 0; }
    .storage-type-tile-desc { font-size: 12px; color: var(--text-secondary); margin: 0; line-height: 1.35; }
    .storage-local-tile-actions { margin-top: 0; padding-top: 0; border-top: none; display: flex; flex-wrap: wrap; gap: 8px; }
    .storage-local-tile-actions .home-shared-file-btn { margin: 0; }
    .storage-local-tiles { display: flex; flex-direction: column; gap: 12px; margin-top: 12px; }
    .storage-local-tile {
      position: relative;
      display: block;
      width: 100%;
      padding: 16px 18px;
      text-align: left;
      font-family: inherit;
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
      box-sizing: border-box;
    }
    .storage-local-tile:hover { border-color: var(--border-strong); background: transparent; }
    .storage-local-tile.selected {
      border: 1px solid #059669;
      background: transparent;
      box-shadow: none;
    }
    .storage-local-tile.selected .storage-local-tile-title { color: var(--text-primary); font-weight: 600; }
    .storage-local-tile.selected .storage-local-tile-desc { color: var(--text-secondary); }
    .storage-local-tile.selected::after {
      content: "";
      position: absolute;
      top: 12px;
      right: 12px;
      width: 18px;
      height: 18px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23059669' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      pointer-events: none;
    }
    .storage-local-tile-title { font-size: 15px; font-weight: 600; color: var(--text-primary); margin: 0 0 4px 0; }
    .storage-local-tile-desc { font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.4; }
    .storage-local-tile-actions { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle); display: flex; flex-wrap: wrap; gap: 8px; }
    .storage-local-tile-actions .home-shared-file-btn { margin: 0; }
    @media (max-width: 480px) {
      .shared-file-modal-overlay { padding: 0; align-items: stretch; justify-content: stretch; }
      .shared-file-modal { width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; border-left: none; border-right: none; border-top: none; padding: 0; }
      .shared-file-modal-header { margin: 0; padding: 16px 16px 16px 20px; border-radius: 0; }
      .shared-file-modal-close { width: 44px; height: 44px; min-width: 44px; min-height: 44px; font-size: 24px; }
      .shared-file-modal .storage-modal-tabs { padding-left: 16px; padding-right: 16px; }
      .shared-file-modal .storage-modal-panel { padding-left: 16px; padding-right: 16px; }
    }
    .home-header-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .home-header-actions { display: flex; align-items: center; gap: 10px; margin-left: auto; flex-wrap: wrap; }
    .home-local-backup-inline { display: flex; align-items: center; gap: 8px; }
    .gantt-auth-btn {
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--button-radius);
      border: 1px solid var(--border-strong);
      background: var(--bg-surface);
      color: var(--text-primary);
      cursor: pointer;
      font-family: inherit;
    }
    .gantt-auth-btn:hover { background: var(--bg-hover); }
    .gantt-auth-user { font-size: 13px; color: var(--text-secondary); margin-right: 4px; }
    .gantt-auth-user-menu {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .gantt-auth-user-trigger {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      border: 1px solid var(--border-strong);
      background: var(--bg-surface);
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, color 0.2s;
    }
    .gantt-auth-user-trigger:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .gantt-auth-user-trigger svg { width: 18px; height: 18px; }
    .gantt-auth-user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 220px;
      padding: 8px 0;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
      pointer-events: none;
    }
    .gantt-auth-user-menu:hover .gantt-auth-user-dropdown,
    .gantt-auth-user-menu.open .gantt-auth-user-dropdown {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .gantt-auth-dropdown-item {
      display: block;
      width: 100%;
      padding: 10px 14px;
      text-align: left;
      font-size: 13px;
      color: var(--text-primary);
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      text-decoration: none;
      box-sizing: border-box;
    }
    .gantt-auth-dropdown-item:hover {
      background: var(--bg-hover);
    }
    .gantt-auth-dropdown-item.text {
      color: var(--text-secondary);
      cursor: default;
      font-size: 12px;
    }
    .gantt-auth-dropdown-item.text:hover { background: transparent; }
    .gantt-auth-dropdown-divider {
      height: 1px;
      margin: 6px 0;
      background: var(--border-default);
    }
    .gantt-auth-dropdown-section-title {
      padding: 8px 14px 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--text-tertiary);
    }
    .gantt-auth-modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10000;
      display: none; align-items: center; justify-content: center; padding: 24px;
    }
    .gantt-auth-modal-overlay.visible { display: flex; }
    .gantt-auth-modal {
      background: var(--bg-surface); border-radius: 12px; padding: 24px; width: 100%; max-width: 360px;
      box-shadow: var(--shadow-md); border: 1px solid var(--border-default);
    }
    .gantt-auth-modal h3 { margin: 0 0 16px 0; font-size: 18px; font-weight: 600; }
    .gantt-auth-modal form { margin: 0; padding: 0; }
    .gantt-auth-modal input[type="email"],
    .gantt-auth-modal input[type="password"],
    .gantt-auth-modal input[type="url"],
    .gantt-auth-modal input[type="text"] { width: 100%; padding: 10px 12px; margin-bottom: 12px; border-radius: var(--input-radius); border: 1px solid var(--border-strong); font-size: 14px; box-sizing: border-box; }
    .gantt-auth-modal .auth-actions { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
    .gantt-auth-modal .auth-error { font-size: 13px; color: #b91c1c; margin: 0 0 12px 0; padding: 8px 10px; background: rgba(185, 28, 28, 0.1); border-radius: 6px; border: 1px solid rgba(185, 28, 28, 0.3); display: none; }
    .gantt-auth-modal .auth-config-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-default); }
    .gantt-auth-modal .auth-config-section label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
    .gantt-auth-modal .auth-login-section.hidden { display: none !important; }
    .gantt-auth-modal .auth-config-section.hidden { display: none !important; }
    .gantt-auth-modal .gantt-auth-btn-primary { background: var(--accent-primary); color: #fff; border: none; font-weight: 600; }
    .gantt-auth-modal .gantt-auth-btn-primary:hover { filter: brightness(1.08); }
    .gantt-auth-modal .gantt-auth-btn-secondary { background: var(--bg-subtle); color: var(--text-primary); border: 1px solid var(--border-strong); }
    .gantt-auth-modal .auth-remember { display: flex; align-items: center; gap: 8px; margin: 10px 0 14px 0; font-size: 13px; color: var(--text-secondary); }
    .gantt-auth-modal .auth-remember input { width: auto; margin: 0; }
    .gantt-auth-modal .auth-use-different { font-size: 12px; color: var(--text-tertiary); margin-top: 16px; }
    .gantt-auth-modal .auth-use-different button { background: none; border: none; color: var(--text-secondary); cursor: pointer; text-decoration: underline; font-size: 12px; padding: 0; font-family: inherit; }
    .gantt-auth-modal .auth-use-different button:hover { color: var(--text-primary); }
    .gantt-auth-modal .auth-use-different-sep { margin: 0 6px; color: var(--text-tertiary); }
    .gantt-auth-modal .auth-project-hint { font-size: 11px; color: var(--text-tertiary); margin: 10px 0 0 0; word-break: break-all; }
    .gantt-auth-modal .auth-test-wrap { margin-top: 14px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .gantt-auth-modal .auth-test-result { font-size: 12px; color: var(--text-secondary); }
    .gantt-auth-modal .auth-test-result.ok { color: #059669; }
    .gantt-auth-modal .auth-test-result.fail { color: #b91c1c; }
    .home-project-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      width: 100%;
    }
    .home-project-list.is-empty {
      flex: 1 1 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .home-project-list.is-empty::before,
    .home-project-list.is-empty::after {
      content: "";
      flex: 1;
      min-height: 0;
    }
    .home-empty-state {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 44px 24px;
      min-height: 120px;
      margin-top: 32px;
    }
    .home-empty-state-visual {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 20px;
      width: 220px;
    }
    .home-empty-state-bar {
      height: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .home-empty-state-bar.bar-1 {
      width: 40px;
      background: #6366f1;
      margin-left: 0;
    }
    .home-empty-state-bar.bar-2 {
      width: 56px;
      background: #8b5cf6;
      margin-left: 40px;
      animation: home-empty-bar2-pulse 5.4s ease-in-out infinite;
    }
    .home-empty-state-bar.bar-3 {
      width: 52px;
      background: #a78bfa;
      margin-left: 96px;
      animation: home-empty-bar3-pulse 5.4s ease-in-out infinite;
    }
    .home-empty-state-bar.bar-4 {
      width: 28px;
      background: #c4b5fd;
      margin-left: 148px;
      animation: home-empty-bar4-shift 5.4s ease-in-out infinite;
    }
    /* Bar 2: expand → hold (through bar 3 cycle) → contract last */
    @keyframes home-empty-bar2-pulse {
      0%, 100% { width: 56px; }
      20%, 70% { width: 78px; }
      85% { width: 56px; }
    }
    /* Bar 3: move with bar 2 expand → grow → contract → (bar 2 contracts) */
    @keyframes home-empty-bar3-pulse {
      0% { margin-left: 96px; width: 52px; }
      20% { margin-left: 118px; width: 52px; }
      45% { margin-left: 118px; width: 74px; }
      70% { margin-left: 118px; width: 52px; }
      85%, 100% { margin-left: 96px; width: 52px; }
    }
    /* Bar 4: follows bar 3 end */
    @keyframes home-empty-bar4-shift {
      0%, 100% { margin-left: 148px; }
      20%, 70% { margin-left: 170px; }
      45% { margin-left: 192px; }
      85% { margin-left: 148px; }
    }
    .home-empty-state-new-btn {
      height: 14px;
      min-width: 72px;
      padding: 0 14px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      border: none;
      background: var(--color-general-primary);
      color: var(--bg-body);
      cursor: pointer;
      font-family: inherit;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    .home-empty-state-new-btn:hover {
      opacity: 0.9;
    }
    @media (prefers-color-scheme: dark) {
      .home-empty-state-new-btn {
        background: #ffffff;
        color: #171717;
      }
      .home-empty-state-bar.bar-1 { background: #818cf8; }
      .home-empty-state-bar.bar-2 { background: #a78bfa; }
      .home-empty-state-bar.bar-3 { background: #c4b5fd; }
      .home-empty-state-bar.bar-4 { background: #ddd6fe; }
    }
    .home-empty-state-create-btn {
      height: auto;
      min-width: auto;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: var(--button-radius);
      border: none;
      background: var(--color-general-primary);
      color: var(--bg-body);
      cursor: pointer;
      font-family: inherit;
      margin-top: 16px;
      transition: opacity 0.2s;
    }
    .home-empty-state-create-btn:hover {
      opacity: 0.9;
    }
    @media (prefers-color-scheme: dark) {
      .home-empty-state-create-btn {
        background: #ffffff;
        color: #171717;
      }
    }
    .home-empty-state-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: stretch;
      margin-top: 20px;
    }
    .home-empty-state-action-btn {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      text-align: left;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s, border-color 0.2s;
      min-width: 0;
      max-width: 220px;
    }
    .home-empty-state-action-btn:hover {
      background: transparent;
      opacity: 0.85;
    }
    .home-empty-state-action-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      opacity: 0.9;
    }
    .home-empty-state-action-icon svg {
      width: 20px;
      height: 20px;
    }
    .home-empty-state-action-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .home-empty-state-action-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .home-empty-state-action-desc {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 400;
      line-height: 1.35;
    }
    @media (min-width: 769px) {
      .home-empty-state-visual {
        display: none;
      }
      .home-empty-state-actions {
        flex-direction: column;
        width: 100%;
        max-width: 320px;
        margin-top: 24px;
        padding: 0;
        background: transparent;
        border: 1px solid var(--border-default);
        border-radius: 10px;
      }
      .home-empty-state-action-btn {
        background: transparent;
        border: none;
        border-bottom: 1px solid var(--border-default);
        color: var(--text-primary);
        padding: 14px 18px;
        border-radius: 0;
        max-width: none;
        gap: 14px;
      }
      .home-empty-state-action-btn:first-child {
        border-radius: 10px 10px 0 0;
      }
      .home-empty-state-action-btn:last-child {
        border-bottom: none;
        border-radius: 0 0 10px 10px;
      }
      .home-empty-state-action-btn:hover {
        background: transparent;
        opacity: 0.85;
      }
      .home-empty-state-action-icon {
        color: var(--text-primary);
        opacity: 0.9;
      }
      .home-empty-state-action-icon svg {
        stroke: currentColor;
      }
      .home-empty-state-action-label {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .home-empty-state-action-desc {
        font-size: 13px;
        color: var(--text-secondary);
      }
    }
    @media (max-width: 768px) {
      .home-empty-state-action-btn {
        border-bottom: 1px solid var(--border-default);
      }
      .home-empty-state-action-btn:last-child {
        border-bottom: none;
      }
    }
    @media (max-width: 480px) {
      .home-empty-state-actions {
        flex-direction: column;
        width: 100%;
        max-width: 280px;
      }
      .home-empty-state-action-btn {
        max-width: none;
      }
    }
    .home-empty-state-line {
      width: 100%;
      height: 2px;
      background: var(--text-tertiary);
      opacity: 0.2;
      border-radius: 1px;
      margin-top: 4px;
    }
    .home-empty-state-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px 0;
      line-height: 1.3;
    }
    .home-empty-state-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin: 0 0 0 0;
      line-height: 1.4;
      max-width: 280px;
    }
    .home-empty-state-hint {
      font-size: 12px;
      color: var(--text-tertiary);
      margin: 0;
    }
    @media (max-width: 900px) {
      .home-project-list { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px) {
      .home-project-list { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      .chart-controls {
        justify-content: flex-start;
      }
    }
    .home-project-card {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      animation: home-project-card-appear 0.35s ease-out forwards;
      animation-fill-mode: both;
    }
    .home-project-card.edit-mode { animation-delay: 0; }
    .home-project-list .home-project-card:nth-child(1) { animation-delay: 0ms; }
    .home-project-list .home-project-card:nth-child(2) { animation-delay: 45ms; }
    .home-project-list .home-project-card:nth-child(3) { animation-delay: 90ms; }
    .home-project-list .home-project-card:nth-child(4) { animation-delay: 135ms; }
    .home-project-list .home-project-card:nth-child(5) { animation-delay: 180ms; }
    .home-project-list .home-project-card:nth-child(6) { animation-delay: 225ms; }
    .home-project-list .home-project-card:nth-child(7) { animation-delay: 270ms; }
    .home-project-list .home-project-card:nth-child(8) { animation-delay: 315ms; }
    .home-project-list .home-project-card:nth-child(9) { animation-delay: 360ms; }
    .home-project-list .home-project-card:nth-child(10) { animation-delay: 405ms; }
    .home-project-list .home-project-card:nth-child(n+11) { animation-delay: 450ms; }
    @keyframes home-project-card-appear {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .home-project-card { cursor: pointer; }
    .home-project-card:hover { border-color: var(--border-strong); }
    .home-project-card .home-project-card-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 0;
      padding: 14px 16px 16px;
    }
    .home-project-card .home-project-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 0 16px 16px;
      margin-top: auto;
    }
    .home-project-card .home-project-card-footer .home-project-footer-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
      transition: opacity 0.2s ease;
    }
    @media (hover: hover) {
      .home-project-card:not(.edit-mode) .home-project-card-footer .home-project-footer-actions {
        opacity: 0;
      }
      .home-project-card:not(.edit-mode):hover .home-project-card-footer .home-project-footer-actions {
        opacity: 1;
      }
    }
    .home-project-timeline-preview {
      flex-shrink: 0;
      width: 100%;
      height: 200px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      background: var(--bg-subtle, #f5f5f5);
      contain: layout;
    }
    @media (prefers-color-scheme: dark) {
      .home-project-timeline-preview { background: var(--bg-subtle, #262626); }
    }
    .home-project-timeline-preview.home-timeline-empty {
      background: transparent;
    }
    .home-project-timeline-preview.home-timeline-empty .home-timeline-preview-caption {
      font-size: 12px;
      color: var(--text-tertiary);
      text-align: center;
      padding: 0 16px;
      line-height: 1.4;
    }
    .home-project-timeline-preview .home-timeline-svg {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
      object-position: center center;
      color: var(--text-secondary, #525252);
    }
    .home-project-info { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 0; }
    .home-project-name { font-weight: 600; font-size: 20px; color: var(--text-primary); line-height: 1.3; }
    .home-project-description { font-size: 15px; color: var(--text-secondary); line-height: 1.45; }
    .home-project-row { width: 100%; font-size: 14px; color: var(--text-secondary); }
    .home-project-card.edit-mode .home-project-card-body { padding: 16px; }
    .home-project-card.edit-mode .home-project-card-footer { padding: 0 16px 16px; }
    .home-project-card.edit-mode .home-project-name-input,
    .home-project-card.edit-mode .home-project-desc-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      border: 1px solid var(--border-strong);
      border-radius: 6px;
      background: var(--bg-surface);
      color: var(--text-primary);
      box-sizing: border-box;
    }
    .home-project-card.edit-mode .home-project-name-input { font-weight: 600; }
    .home-project-card.edit-mode .home-project-desc-input {
      min-height: 60px;
      resize: vertical;
    }
    .home-project-done-btn {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      background: var(--color-general-primary);
      color: var(--bg-body);
      cursor: pointer;
      font-family: inherit;
    }
    .home-project-done-btn:hover { opacity: 0.9; }
    .home-project-task-count { font-weight: 500; color: var(--text-secondary); }
    .home-project-phase-tag {
      display: inline-block;
      padding: 3px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 4px;
      border: 1px solid transparent;
      align-self: flex-start;
    }
    .home-project-card-footer .home-project-phase-tag { margin-top: 0; }
    .home-project-local-tag {
      display: inline-block;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 500;
      border-radius: 4px;
      background: var(--bg-subtle, #f0f0f0);
      color: var(--text-secondary);
      border: 1px solid var(--border-default, #e5e5e5);
      align-self: flex-start;
    }
    .home-project-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .home-project-action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 6px;
      border: none;
      background: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      transition: color 0.2s;
    }
    .home-project-action-btn:hover {
      color: var(--text-primary);
    }
    .home-project-action-btn svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
    .home-project-delete-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 6px;
      border: none;
      background: none;
      color: var(--text-tertiary);
      cursor: pointer;
      font-family: inherit;
      transition: color 0.2s;
    }
    .home-project-delete-btn svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
    .home-project-delete-btn:hover {
      color: #b91c1c;
    }
    @media (prefers-color-scheme: dark) {
      .home-project-delete-btn:hover {
        color: #fca5a5;
      }
    }
    .home-back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
    }
    .home-back-link:hover { color: var(--text-primary); }
    .collaborators-avatar-bar {
      position: absolute;
      left: 8px;
      top: 40px;
      z-index: 10;
    }
    .collaborators-avatar-trigger {
      position: relative;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }
    .collaborators-avatar-list {
      display: flex;
      align-items: center;
      gap: 2px;
      flex-wrap: wrap;
    }
    .collaborators-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: white;
      background: var(--color-general-primary, #6d28d9);
      border: 2px solid var(--bg-surface);
      box-sizing: border-box;
    }
    .collaborators-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .collaborators-avatar-dropdown {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      margin-top: -4px;
      padding: 10px 0 6px 0;
      min-width: 180px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      box-shadow: var(--shadow-md);
    }
    .collaborators-avatar-trigger:hover .collaborators-avatar-dropdown {
      display: block;
    }
    .collaborators-dropdown-users {
      padding: 4px 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .collaborators-dropdown-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-primary);
    }
    .collaborators-dropdown-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
      background: var(--color-general-primary, #6d28d9);
    }
    .collaborators-dropdown-invite {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-top: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-general-primary);
      background: none;
      border: none;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
    }
    .collaborators-dropdown-invite:hover {
      background: var(--bg-hover);
    }
    .gantt-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      justify-content: flex-start;
    }
    .gantt-chart-scroll {
      flex: 1 1 0;
      min-height: 0;
      min-width: 0;
      width: 100%;
      overflow: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .gantt-wrapper .gantt-grid {
      flex: 1 0 auto;
      min-height: 0;
      min-width: 100%;
      width: 100%;
    }
    .gantt-wrapper:has(#ganttEmptyState:not(.hidden)) .gantt-chart-scroll {
      flex: 0 0 auto;
    }
    .gantt-wrapper:has(#ganttEmptyState:not(.hidden)) .gantt-grid {
      flex: 0 0 auto;
    }
    @media (max-width: 480px) {
      .gantt-wrapper { overflow-x: hidden; overflow-y: visible; flex: 0 1 auto; max-width: 100%; }
      .gantt-chart-scroll { overflow-x: hidden; overflow-y: auto; flex: 0 1 auto; max-width: 100%; }
      .gantt-wrapper .gantt-grid { flex: 0 1 auto; min-width: 0; max-width: 100%; width: 100%; }
    }
    @media (max-width: 768px) and (orientation: portrait) {
      .gantt-wrapper { flex: 0 0 auto !important; }
      .gantt-chart-scroll { flex: 0 0 auto !important; overflow-y: visible; }
      .gantt-wrapper .gantt-grid { min-width: 0 !important; max-width: 100%; width: 100%; flex: 0 0 auto !important; }
      .gantt-header-sticky { min-width: 0 !important; }
    }
    .gantt-empty-state {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: var(--bg-surface);
      color: var(--text-secondary);
      text-align: center;
      padding: 40px 24px;
      min-height: 200px;
      box-sizing: border-box;
      border-top: 1px solid var(--border-default);
      position: relative;
    }
    .gantt-empty-state-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      border-radius: var(--button-radius);
      transition: color 0.15s, background 0.15s;
    }
    .gantt-empty-state-close:hover {
      background: var(--bg-subtle);
      color: var(--text-primary);
    }
    .gantt-empty-state.hidden { display: none !important; }
    .settings-auto-populate-section.hidden { display: none !important; }
    .gantt-empty-state .empty-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .gantt-empty-state-actions { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; align-items: center; }
    .gantt-empty-state .btn-empty-primary,
    .gantt-empty-state .btn-empty-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      border-radius: var(--button-radius);
      cursor: pointer;
      font-family: inherit;
      transition: opacity 0.2s, background 0.15s;
    }
    .gantt-empty-state .btn-empty-primary {
      background: var(--color-general-primary);
      color: var(--bg-body);
      border: none;
      font-weight: 600;
    }
    .gantt-empty-state .btn-empty-primary:hover { opacity: 0.9; }
    .gantt-empty-state .btn-empty-secondary {
      background: var(--bg-surface);
      color: var(--text-primary);
      border: 1px solid var(--border-strong);
    }
    .gantt-empty-state .btn-empty-secondary:hover { background: var(--bg-hover); }
    .gantt-empty-state .btn-empty-primary svg,
    .gantt-empty-state .btn-empty-secondary svg { width: 16px; height: 16px; flex-shrink: 0; }
    .task-chevron {
      display: inline-flex;
      margin-right: 8px;
      color: var(--text-tertiary);
      font-size: 10px;
      transition: transform 0.2s, opacity 0.15s ease;
      pointer-events: none;
      opacity: 0;
    }
    .gantt-task-cell:hover .task-chevron,
    .gantt-row.expanded .gantt-task-cell .task-chevron {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="task-dependency-tooltip" id="taskDependencyTooltip" role="tooltip"></div>
  <div class="custom-tooltip" id="customTooltip" role="tooltip" aria-hidden="true"></div>
  <div class="gantt-toast" id="ganttToast" role="status" aria-live="polite"></div>
  <div class="detach-confirm-popup" id="detachConfirmPopup" role="dialog" aria-labelledby="detachConfirmMsg">
    <div class="detach-confirm-msg" id="detachConfirmMsg"></div>
    <p class="detach-confirm-hint" id="detachConfirmHint">You can allow dependent tasks to have their own dates in Board settings → Tasks → Dependent tasks.</p>
    <div class="detach-confirm-actions">
      <button type="button" class="detach-confirm-cancel">Keep link</button>
      <button type="button" class="detach-confirm-detach">Detach</button>
    </div>
  </div>
  <div class="detach-confirm-popup phase-confirm-popup" id="phaseConfirmPopup" role="dialog" aria-labelledby="phaseConfirmMsg">
    <div class="detach-confirm-msg" id="phaseConfirmMsg"></div>
    <p class="phase-confirm-hint">You can allow dependent tasks to have their own dates in Board settings → Tasks → Dependent tasks.</p>
    <div class="detach-confirm-actions">
      <button type="button" class="phase-confirm-keep">Keep current phase</button>
      <button type="button" class="phase-confirm-move">Move to phase</button>
    </div>
  </div>
  <div class="detach-confirm-popup" id="deleteConfirmPopup" role="dialog" aria-labelledby="deleteConfirmMsg">
    <div class="detach-confirm-msg" id="deleteConfirmMsg"></div>
    <div class="detach-confirm-actions">
      <button type="button" class="delete-confirm-cancel">Cancel</button>
      <button type="button" class="delete-confirm-delete">Delete</button>
    </div>
  </div>
  <div class="phase-select-menu" id="phaseSelectMenu" role="menu" aria-label="Phase">
    <div class="phase-select-menu-title">Phase</div>
    <div class="phase-select-menu-list" id="phaseSelectMenuList"></div>
  </div>
  <div class="fab-phase-menu" id="fabPhaseMenu" role="menu" aria-label="New task">
    <div class="fab-phase-menu-title">New task</div>
    <div class="fab-phase-menu-list" id="fabPhaseMenuList"></div>
  </div>
  <div class="home-new-board-menu fab-phase-menu" id="homeNewBoardMenu" role="menu" aria-label="New board options">
    <div class="fab-phase-menu-list">
      <button type="button" class="fab-phase-menu-item" data-action="scratch" role="menuitem"><span class="fab-phase-menu-item-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg></span><span class="fab-phase-menu-item-text"><span class="fab-phase-menu-item-label">Empty</span><span class="fab-phase-menu-item-desc">Blank canvas for your project</span></span></button>
      <button type="button" class="fab-phase-menu-item fab-phase-menu-item-cloud-only" id="homeNewBoardSharedItem" data-action="shared" role="menuitem" style="display:none"><span class="fab-phase-menu-item-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"/></svg></span><span class="fab-phase-menu-item-text"><span class="fab-phase-menu-item-label">Shared</span><span class="fab-phase-menu-item-desc">Collaborate in realtime with your team</span></span></button>
      <button type="button" class="fab-phase-menu-item" data-action="linked" role="menuitem"><span class="fab-phase-menu-item-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg></span><span class="fab-phase-menu-item-text"><span class="fab-phase-menu-item-label">Linked</span><span class="fab-phase-menu-item-desc">Start with some connected tasks</span></span></button>
      <button type="button" class="fab-phase-menu-item fab-phase-menu-item-disabled" data-action="templates" role="menuitem" disabled><span class="fab-phase-menu-item-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z"/></svg></span><span class="fab-phase-menu-item-text"><span class="fab-phase-menu-item-label">Templates</span><span class="fab-phase-menu-item-desc">Select from common projects</span></span><span class="fab-phase-menu-badge">soon</span></button>
      <button type="button" class="fab-phase-menu-item" id="homeNewBoardExcelItem" data-action="excel" role="menuitem"><span class="fab-phase-menu-item-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 12l3 3m0 0 3-3m-3 3V2.25"/></svg></span><span class="fab-phase-menu-item-text"><span class="fab-phase-menu-item-label">Excel sync</span><span class="fab-phase-menu-item-desc">Upload Excel to jumpstart timeline</span></span></button>
    </div>
  </div>
  <div class="app-views-wrap" id="appViewsWrap">
  <div class="app-views-inner">
  <div id="landingView" class="app-view">
    <div class="landing-layout">
      <aside class="landing-sidebar">
        <div class="landing-sidebar-visual" aria-hidden="true">
          <span class="landing-sidebar-bar bar-1"></span>
          <span class="landing-sidebar-bar bar-2"></span>
          <span class="landing-sidebar-bar bar-3"></span>
          <span class="landing-sidebar-bar bar-4"></span>
          <div class="landing-sidebar-line"></div>
        </div>
        <h1 class="landing-hero-title">Manage your tasks as they transform</h1>
        <p class="landing-hero-subtitle">Interactive gaant styles project boards that evolve with your project.</p>
        <ul class="landing-features">
          <li class="landing-feature">
            <span class="landing-feature-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 8.25V6ZM3.75 15.75a2.25 2.25 0 0 1 2.25-2.25h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z"/></svg></span>
            <span class="landing-feature-text">Define project phases</span>
          </li>
          <li class="landing-feature">
            <span class="landing-feature-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg></span>
            <span class="landing-feature-text">Link dependent tasks</span>
          </li>
          <li class="landing-feature">
            <span class="landing-feature-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.402M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3H5.25a3 3 0 0 1 3 3v3.75M6.75 21a3.75 3.75 0 0 0 3.75-3.75V12m-1.5-9H6.75A2.25 2.25 0 0 0 4.5 5.25v1.5M12 21a3.75 3.75 0 0 1-.75-7.5v-3.75m9 0V9A2.25 2.25 0 0 0 18.75 6.75h-1.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg></span>
            <span class="landing-feature-text">Customize your color theme</span>
          </li>
          <li class="landing-feature">
            <span class="landing-feature-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"/></svg></span>
            <span class="landing-feature-text">Work alone or with your team</span>
          </li>
          <li class="landing-feature">
            <span class="landing-feature-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/></svg></span>
            <span class="landing-feature-text">Set your view preferences</span>
          </li>
        </ul>
      </aside>
      <div class="landing-main">
    <div class="landing-inner" data-step="1" data-total-steps="1">
      <div class="landing-step-indicator" id="landingStepIndicator">Step 1 of 1</div>
      <h2 class="landing-title">Choose how to store your data</h2>
      <p class="landing-subtitle">Pick one option to get started. You can continue with full editing in all modes.</p>
      <div class="landing-options">
        <button type="button" class="landing-option" id="landingOptionGitHub">
          Sync with GitHub
          <div class="landing-option-desc">Load and push a gantt-data.json file to a GitHub repo. Share with others and keep a remote backup.</div>
        </button>
        <button type="button" class="landing-option" id="landingOptionSupabase">
          Save to Supabase (cloud)
          <div class="landing-option-desc">Cloud save with login. Boards sync across devices.</div>
        </button>
        <button type="button" class="landing-option" id="landingOptionLocalStorage">
          Use local storage
          <div class="landing-option-desc">Store data in the browser and optionally backup or restore from a gantt-data.json file on your device.</div>
        </button>
        <button type="button" class="landing-option" id="landingOptionLocalCache">
          Use local cache (not recommended)
          <div class="landing-option-desc">Rely only on browser cache. No file backup; data can be lost if cache is cleared.</div>
          <div class="landing-option-badge">Not recommended</div>
        </button>
      </div>
    </div>
      </div>
    </div>
  </div>
  <div id="homeView" class="app-view">
    <div class="home-sticky-header">
      <div class="home-header-row">
        <h1><span id="homePageTitle">Boards</span> <span class="home-project-count-badge" id="homeProjectCountBadge" contenteditable="false">0</span></h1>
        <div class="home-header-actions">
          <div class="gantt-auth-wrap gantt-auth-user-menu" id="ganttAuthWrap" style="display: none;">
            <button type="button" class="gantt-auth-user-trigger" id="ganttAuthUserTrigger" aria-label="Account menu" aria-expanded="false" aria-haspopup="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z"/></svg>
            </button>
            <div class="gantt-auth-user-dropdown" id="ganttAuthUserDropdown" role="menu">
              <div class="gantt-auth-dropdown-section-title">Account</div>
              <div class="gantt-auth-dropdown-item text" id="ganttAuthUserEmail" role="presentation"></div>
              <a href="#" target="_blank" rel="noopener noreferrer" class="gantt-auth-dropdown-item" id="ganttAuthSupabaseLink" role="menuitem">Supabase dashboard</a>
              <div class="gantt-auth-dropdown-divider"></div>
              <div class="gantt-auth-dropdown-section-title">Session</div>
              <button type="button" class="gantt-auth-dropdown-item" id="ganttAuthLogout" role="menuitem">Log out</button>
            </div>
          </div>
          <span id="ganttAuthLoginWrap"><button type="button" class="gantt-auth-btn" id="ganttAuthLogin">Log in (save to cloud)</button></span>
          <div class="home-sync-inline" id="sharedFileSection">
            <div class="home-shared-file-status">
              <span class="home-shared-file-status-dot local" id="sharedFileStatusDot"></span>
              <span class="home-shared-file-status-text" id="sharedFileStatusText">Local</span>
              <button type="button" class="home-shared-file-open-btn" id="sharedFileOpenModal">Sync Settings</button>
            </div>
          </div>
          <div class="home-local-backup-inline" id="localBackupSection" style="display: none;">
            <button type="button" class="home-shared-file-btn" id="localBackupToFile">Backup to file</button>
            <input type="file" id="localRestoreFileInput" accept=".json,application/json" style="display: none;">
            <button type="button" class="home-shared-file-btn" id="localRestoreFromFile">Restore from file</button>
          </div>
          <button type="button" class="home-shared-file-btn home-settings-icon-btn" id="homeSettingsBtn" data-tooltip="Settings" aria-label="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
          </button>
          <button type="button" class="home-new-project-btn" id="homeFab" aria-label="New board" data-tooltip-disabled="Read-only: add an access token in Sync Settings to create boards.">+ New board</button>
        </div>
      </div>
      <p class="home-subtitle" id="homePageDescription">Create and open boards. Each board has its own tasks and settings.</p>
    </div>
    <div class="home-project-list" id="homeProjectList"></div>
    <div class="home-mobile-fab-bar" id="homeMobileFabBar" aria-hidden="true">
      <button type="button" class="home-new-project-btn home-mobile-fab-trigger" id="homeFabMobile" aria-label="New board" data-tooltip-disabled="Read-only: add an access token in Sync Settings to create boards.">+ New board</button>
    </div>
  </div>

  <div id="ganttView" class="app-view">
    <a href="#/" class="home-back-link" id="homeBackLink">← All boards</a>
    <div class="collaborators-avatar-bar" id="collaboratorsAvatarBar" style="display:none" aria-label="Collaborators on this board">
      <div class="collaborators-avatar-trigger" id="collaboratorsAvatarTrigger">
        <div class="collaborators-avatar-list" id="collaboratorsAvatarList"></div>
        <div class="collaborators-avatar-dropdown" id="collaboratorsAvatarDropdown">
          <div class="collaborators-dropdown-users" id="collaboratorsDropdownUsers"></div>
          <button type="button" class="collaborators-dropdown-invite" id="collaboratorsInviteBtn" style="display:none">Invite</button>
        </div>
      </div>
    </div>
    <header class="page-header">
      <div class="page-header-title-wrap">
        <h1 id="pageTitle">Project Schedule</h1>
        <p class="subtitle" id="pageDescription">Drag bars to reschedule • Drag edges to change dates • Drag rows to reorder • Click a row to expand details • Click cells to edit</p>
        <div class="board-info-strip" id="boardInfoStrip" aria-label="Board summary">
          <span class="board-info-item"><span class="board-info-label">Start</span> <span id="boardInfoStart">—</span></span>
          <span class="board-info-item"><span class="board-info-label">End</span> <span id="boardInfoEnd">—</span></span>
          <span class="board-info-item"><span class="board-info-label">Tasks</span> <span id="boardInfoTaskCount">0</span></span>
          <span class="board-info-item"><span class="board-info-label">Current</span> <span id="boardInfoCurrentTasks">0</span></span>
          <span class="board-info-item"><span class="board-info-label">Phase</span> <span id="boardInfoPhase">—</span></span>
        </div>
      </div>
      <div class="chart-controls">
      <label for="viewMode">View:</label>
      <select id="viewMode">
        <option value="sprint">Sprint (2 weeks)</option>
        <option value="month">Month (4 weeks)</option>
        <option value="default">Default (8 weeks)</option>
        <option value="project">Entire project</option>
      </select>
      <button type="button" class="settings-btn share-btn" id="shareBoardBtn" data-tooltip="Share board" style="display:none">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
      </button>
      <button type="button" class="settings-btn" id="settingsBtn" data-tooltip="Board settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
      </button>
    </div>
  </header>

  <svg class="gantt-dependency-line" id="ganttDependencyLine" aria-hidden="true">
    <path id="ganttDependencyLinePathHover" d="" stroke="transparent" stroke-width="12" fill="none"/>
    <path id="ganttDependencyLinePath" d="" stroke="#a3a3a3" stroke-width="1" stroke-dasharray="4 3" fill="none"/>
    <g id="ganttDependencyLineDot1" class="connector-dot">
      <circle cx="0" cy="0" r="12" fill="transparent" stroke="none" aria-hidden="true"/>
      <circle cx="0" cy="0" r="3" fill="white" stroke="#d4d4d4" stroke-width="1"/>
      <line x1="-2" y1="0" x2="2" y2="0" stroke="#737373" stroke-width="1" stroke-linecap="round"/>
      <line x1="0" y1="-2" x2="0" y2="2" stroke="#737373" stroke-width="1" stroke-linecap="round"/>
    </g>
    <g id="ganttDependencyLineDot2" class="connector-dot">
      <circle cx="0" cy="0" r="12" fill="transparent" stroke="none" aria-hidden="true"/>
      <circle cx="0" cy="0" r="3" fill="white" stroke="#d4d4d4" stroke-width="1"/>
      <line x1="-2" y1="0" x2="2" y2="0" stroke="#737373" stroke-width="1" stroke-linecap="round"/>
      <line x1="0" y1="-2" x2="0" y2="2" stroke="#737373" stroke-width="1" stroke-linecap="round"/>
    </g>
  </svg>
  <button class="gantt-dependency-unlink-btn" id="ganttDependencyUnlinkBtn" type="button" data-tooltip="Unlink tasks">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/>
      <path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/>
      <line x1="8" y1="2" x2="8" y2="5"/>
      <line x1="2" y1="8" x2="5" y2="8"/>
      <line x1="16" y1="19" x2="16" y2="22"/>
      <line x1="19" y1="16" x2="22" y2="16"/>
    </svg>
  </button>
  <div id="ganttChildConnectorsContainer"></div>
  <div class="gantt-bar-tooltip" id="ganttBarTooltip" role="tooltip">
    <div class="gantt-bar-tooltip-title"></div>
    <div class="gantt-bar-tooltip-row gantt-bar-tooltip-desc">
      <span class="gantt-bar-tooltip-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg></span>
      <span class="gantt-bar-tooltip-text"></span>
    </div>
    <div class="gantt-bar-tooltip-row gantt-bar-tooltip-status">
      <span class="gantt-bar-tooltip-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span>
      <span class="gantt-bar-tooltip-text"></span>
    </div>
    <div class="gantt-bar-tooltip-row gantt-bar-tooltip-party">
      <span class="gantt-bar-tooltip-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
      <span class="gantt-bar-tooltip-text"></span>
    </div>
    <div class="gantt-bar-tooltip-row gantt-bar-tooltip-depends">
      <span class="gantt-bar-tooltip-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg></span>
      <span class="gantt-bar-tooltip-text"></span>
      <span class="gantt-bar-tooltip-dep-unlink-wrap" style="display:none"><button type="button" class="gantt-bar-tooltip-dep-unlink" data-tooltip="Unlink" aria-label="Unlink"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg></button></span>
    </div>
    <div class="gantt-bar-tooltip-row gantt-bar-tooltip-dates">
      <span class="gantt-bar-tooltip-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg></span>
      <span class="gantt-bar-tooltip-text"></span>
    </div>
    <div class="gantt-bar-tooltip-actions" id="ganttBarTooltipActions" style="display:none">
      <label class="gantt-bar-tooltip-move-label">Phase</label>
      <div class="gantt-phase-dropdown gantt-bar-tooltip-phase-dropdown" id="ganttBarTooltipPhaseDropdown"></div>
    </div>
  </div>

  <div class="share-modal-overlay" id="shareModalOverlay" role="dialog" aria-labelledby="shareModalTitle" aria-modal="true" style="display:none">
    <div class="share-modal">
      <h3 id="shareModalTitle">Share board</h3>
      <p class="share-modal-desc">Anyone with this link can join the board and collaborate in real time. Link expires in 7 days.</p>
      <div class="share-modal-link-wrap">
        <input type="text" id="shareModalLink" readonly class="share-modal-input" value="">
        <button type="button" class="share-modal-copy" id="shareModalCopy">Copy</button>
      </div>
      <div class="share-modal-status" id="shareModalStatus"></div>
      <button type="button" class="share-modal-close" id="shareModalClose">Close</button>
    </div>
  </div>
  <div class="gantt-drag-guide" id="ganttDragGuide" aria-hidden="true"></div>
  <div class="gantt-wrapper" id="ganttWrapper">
    <div class="gantt-chart-scroll" id="ganttChartScroll">
      <div class="gantt-header-sticky">
        <!-- Phase header: dynamic spans based on task duration (populated by JS) -->
        <div class="phase-header-row" id="phaseHeaderRow"></div>
        <!-- Main header row -->
        <div class="gantt-row gantt-header" id="ganttHeaderRow" style="cursor:default">
          <div class="gantt-cell">Task</div>
          <div class="gantt-cell">Status</div>
          <div class="gantt-cell">Phase</div>
          <div class="gantt-cell">Responsible</div>
          <div class="gantt-cell">Date</div>
          <!-- Week labels populated by JS -->
        </div>
      </div>
      <div class="gantt-grid" id="ganttGrid">
        <svg class="gantt-dependency-line gantt-all-dependency-lines" id="ganttAllDependencyLines" aria-hidden="true"></svg>
        <!-- Data rows populated by JS -->
      </div>
    </div>
    <div class="gantt-empty-state hidden" id="ganttEmptyState" aria-live="polite">
      <button type="button" class="gantt-empty-state-close" id="ganttEmptyClose" aria-label="Dismiss empty state for this board">&times;</button>
      <span class="empty-title">No tasks yet</span>
      <p>Set up your project name, start date, and phases, then add tasks or sample data to build your timeline.</p>
      <div class="gantt-empty-state-actions">
        <button type="button" class="btn-empty-primary" id="ganttEmptyConfigure">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
          Set up project
        </button>
        <button type="button" class="btn-empty-secondary" id="ganttEmptyPopulate">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0 1 18 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.25m-8.25-3 1.5 1.5 3-3.75"/></svg>
          Add sample tasks
        </button>
      </div>
    </div>
  </div>
  </div><!-- /#ganttView -->
  </div><!-- /.app-views-inner -->
  <div class="settings-sidebar-overlay" id="settingsSidebarOverlay" aria-hidden="true"></div>
  <div class="settings-sidebar" id="settingsSidebar">
  <div class="settings-drawer">
      <div class="settings-drawer-header">
        <h2 id="settingsSidebarTitle">Settings</h2>
        <button type="button" class="settings-drawer-close" id="settingsClose">&times;</button>
      </div>
      <div class="settings-tabs settings-tabs--home" id="settingsTabsHome">
        <button type="button" class="settings-tab active" data-tab="function">General</button>
        <button type="button" class="settings-tab" data-tab="storage">Storage</button>
      </div>
      <div class="settings-tabs settings-tabs--board" id="settingsTabsBoard" style="display: none;">
        <button type="button" class="settings-tab active" data-tab="function">General</button>
        <button type="button" class="settings-tab" data-tab="details">Details</button>
        <button type="button" class="settings-tab" data-tab="tasks">Tasks</button>
        <button type="button" class="settings-tab" data-tab="style">Style</button>
      </div>
      <div class="settings-drawer-body">
        <div class="settings-tab-panel active" id="settingsTabFunction">
          <div id="settingsGeneralHome" class="settings-general-context">
            <div class="settings-section">
              <label>Name</label>
              <input type="text" id="settingsHomeName" placeholder="Boards">
            </div>
            <div class="settings-section">
              <label>Description</label>
              <textarea id="settingsHomeDescription" placeholder="Describe your boards..."></textarea>
            </div>
            <div class="settings-section">
              <div class="settings-toggle-row">
                <label for="settingsTimelinePreviews" class="settings-toggle-label">Show timeline previews in cards</label>
                <label class="settings-toggle-switch" aria-hidden="true">
                  <input type="checkbox" id="settingsTimelinePreviews" checked>
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <small class="settings-hint">When on, each board card on the home screen shows a small timeline preview.</small>
            </div>
          </div>
          <div id="settingsGeneralBoard" class="settings-general-context" style="display: none;">
            <div class="settings-section">
              <label>Title</label>
              <input type="text" id="settingsTitle" placeholder="Board title">
            </div>
            <div class="settings-section">
              <label>Description</label>
              <textarea id="settingsDescription" placeholder="Describe your board..."></textarea>
            </div>
            <div class="settings-section">
              <label>Project start date</label>
              <input type="date" id="settingsProjectStartDate">
              <small class="settings-hint">When set, the timeline stays fixed at this date; changing task dates won't shift it.</small>
            </div>
            <div class="settings-section">
              <label>Project end date</label>
              <input type="date" id="settingsProjectEndDate">
              <small class="settings-hint">When set, the timeline is capped at this date; the board won't extend beyond it.</small>
            </div>
            <div class="settings-section">
              <button type="button" class="settings-export-btn" id="settingsExportPdf">
                <span class="settings-export-btn-icon" aria-hidden="true">Print</span>
                Print / Save as PDF
              </button>
              <small class="settings-hint" style="margin-top: 8px; display: block;">Uses your browser's print dialog. Choose "Save as PDF" to export. Enable Background graphics if bars do not appear.</small>
            </div>
          </div>
        </div>
        <div class="settings-tab-panel" id="settingsTabDetails">
          <div class="settings-section">
            <label>Phase duration</label>
            <select id="settingsPhaseDurationMode">
              <option value="fixed" selected>Fixed (set sprints per phase)</option>
              <option value="dynamic">Dynamic based on child tasks</option>
            </select>
            <small class="settings-hint">Dynamic: phase header width reflects the date range of tasks in that phase. Fixed: set a number of sprints (2 weeks each) per phase.</small>
          </div>
          <div class="settings-section">
            <label class="settings-phase-section-label" id="settingsPhaseSectionLabel" style="display: none;">Phases</label>
            <div class="settings-phase-list" id="settingsPhaseList" data-phase-mode="fixed"></div>
            <button type="button" class="settings-add-phase" id="settingsAddPhase">+ Add phase</button>
          </div>
          <div class="settings-section">
            <label>Team Members</label>
            <p class="settings-hint" style="margin-top: 0;">Names shown in the Team member dropdown for tasks. Saved with the project.</p>
            <div class="settings-party-list" id="settingsResponsiblePartiesList"></div>
            <div class="settings-add-party-row">
              <input type="text" id="settingsPartyInput" placeholder="Add name, press Enter" class="settings-party-input" />
              <button type="button" class="settings-add-phase" id="settingsAddParty">+ Add</button>
            </div>
          </div>
        </div>
        <div class="settings-tab-panel" id="settingsTabTasks">
          <div class="settings-section">
            <label>Dependent tasks</label>
            <small class="settings-hint" style="margin-top: 0; margin-bottom: 8px; display: block;">Gap between the end of the previous task and the start of the dependent. 0 days = start when previous ends.</small>
            <select id="settingsDependencyGap" aria-hidden="true" style="position:absolute;opacity:0;pointer-events:none;height:0;width:0;">
              <option value="0">0 days</option>
              <option value="1">1 day</option>
              <option value="2">2 days</option>
              <option value="3">3 days</option>
              <option value="5">5 days</option>
              <option value="7">1 week</option>
              <option value="14">2 weeks</option>
            </select>
            <div class="settings-dependent-wrap" id="settingsDependentWrap">
              <button type="button" class="settings-dependent-trigger" id="settingsDependentTrigger" aria-expanded="false" aria-haspopup="true">0 days</button>
              <div class="settings-dependent-panel" id="settingsDependentPanel" role="menu">
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="0">0 days</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="1">1 day</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="2">2 days</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="3">3 days</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="5">5 days</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="7">1 week</button>
                <button type="button" class="settings-dependent-option" role="menuitem" data-value="14">2 weeks</button>
              </div>
            </div>
            <div class="settings-dependent-independent-wrap" style="margin-top: 12px;">
              <div class="settings-toggle-row">
                <label for="settingsIndependentDependencies" class="settings-toggle-label">Independent start dates & phases for dependencies</label>
                <label class="settings-toggle-switch" aria-hidden="true">
                  <input type="checkbox" id="settingsIndependentDependencies">
                  <span class="settings-toggle-slider"></span>
                </label>
              </div>
              <small class="settings-hint">When enabled, dependent tasks can have their own start date and phase instead of following the parent. The link remains for tracking; dates are not auto-adjusted.</small>
            </div>
            <div class="settings-toggle-row" style="margin-top: 12px;">
              <label for="settingsLinkAllTasks" class="settings-toggle-label">Link all tasks</label>
              <label class="settings-toggle-switch" aria-hidden="true">
                <input type="checkbox" id="settingsLinkAllTasks">
                <span class="settings-toggle-slider"></span>
              </label>
            </div>
            <small class="settings-hint">When enabled, every task depends on the one before it (first task has no dependency). The board stays dynamic: moving one task shifts the rest. Turn off to clear all dependency links.</small>
          </div>
          <div class="settings-section">
            <div class="settings-toggle-row" data-tooltip="When enabled (fixed phases only), increasing a phase's sprint count will shift later tasks so they stay after the extended phase.">
              <label for="settingsMoveTasksWhenSprintExtended" class="settings-toggle-label">Move tasks when a sprint is extended</label>
              <label class="settings-toggle-switch" aria-hidden="true">
                <input type="checkbox" id="settingsMoveTasksWhenSprintExtended">
                <span class="settings-toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="settings-section settings-snap-to-sprint-wrap" id="settingsSnapToSprintWrap">
            <div class="settings-toggle-row" data-tooltip="When enabled, dragging a task start or end date near a sprint boundary (every 2 weeks) will snap it to that date.">
              <label for="settingsSnapToSprint" class="settings-toggle-label">Snap to sprint</label>
              <label class="settings-toggle-switch" aria-hidden="true">
                <input type="checkbox" id="settingsSnapToSprint">
                <span class="settings-toggle-slider"></span>
              </label>
            </div>
          </div>
          <div id="settingsAutoPopulateSection" class="settings-section settings-auto-populate-section">
            <label>Sample data</label>
            <button type="button" class="settings-auto-populate-btn" id="settingsAutoPopulate">Auto-populate 5 linked tasks</button>
            <small class="settings-hint">Replaces all tasks with 5 sample tasks (Research → Design → Review → Build → Launch) linked consecutively. Useful to explore the board without starting from scratch.</small>
          </div>
        </div>
        <div class="settings-tab-panel" id="settingsTabStyle">
          <div class="settings-section">
            <label>View</label>
            <select id="settingsRowAppearance" class="settings-select">
              <option value="compact">Compact</option>
              <option value="default">Default</option>
              <option value="fill">Fill</option>
            </select>
            <small class="settings-hint">Row density and how the task bar area is displayed. Press <kbd>c</kbd>, <kbd>d</kbd>, or <kbd>f</kbd> to cycle through Compact, Default, and Fill.</small>
          </div>
          <div class="settings-section">
            <div class="settings-toggle-row">
              <label for="settingsShowDurationOnBar" class="settings-toggle-label">Always show days on bar</label>
              <label class="settings-toggle-switch" aria-hidden="true">
                <input type="checkbox" id="settingsShowDurationOnBar">
                <span class="settings-toggle-slider"></span>
              </label>
            </div>
            <small class="settings-hint">When enabled, the task duration (e.g. 7 days) is shown on every bar instead of only on hover.</small>
          </div>
          <div class="settings-section">
            <label>Bar style</label>
            <div class="settings-segmented" id="settingsBarStyle" role="group" aria-label="Bar style">
              <button type="button" class="settings-segmented-option" data-value="fill">Fill</button>
              <button type="button" class="settings-segmented-option" data-value="stroke">Stroke</button>
            </div>
          </div>
          <div class="settings-section">
            <label>Color Palette</label>
            <div class="settings-palette-dropdown-wrap" id="settingsPaletteDropdownWrap">
              <button type="button" class="settings-palette-trigger" id="settingsPaletteTrigger" aria-expanded="false" aria-haspopup="listbox">
                <span class="settings-palette-trigger-label" id="settingsPaletteTriggerLabel">Palette</span>
                <span class="settings-palette-trigger-swatches" id="settingsPaletteTriggerSwatches"></span>
              </button>
              <div class="settings-palette-panel" id="settingsPalettePanel" role="listbox">
                <div class="settings-palette-grid" id="settingsPaletteGrid"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-tab-panel" id="settingsTabStorage">
          <div class="settings-section settings-storage-inline">
            <label>Where data is stored</label>
            <div class="storage-type-picker" role="group" aria-label="Storage type">
              <div class="storage-type-tiles" id="storageTypeTiles">
                <div class="storage-type-tile" data-value="github" role="button" tabindex="0">
                  <div class="storage-type-tile-heading">
                    <span class="storage-type-tile-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7.5 7.5h-.15A4.5 4.5 0 1 0 7.5 16.5h9a4.5 4.5 0 1 0-.15-9h-.15M12 12v9m0-9l3 3m-3-3l-3 3"/></svg></span>
                    <span class="storage-type-tile-title">GitHub sync</span>
                  </div>
                  <div class="storage-type-tile-desc">Load and push a gantt-data.json file to a GitHub repo.</div>
                  <div class="storage-type-tile-content">
                    <label for="sharedFileUrl" data-tooltip="JSON URL (GitHub raw or any CORS-accessible URL)">Sync File</label>
                    <div class="shared-file-input-wrap">
                      <input type="url" id="sharedFileUrl" placeholder="https://raw.githubusercontent.com/.../gantt-data.json" />
                      <div class="shared-file-input-icons">
                        <button type="button" class="shared-file-input-icon" id="sharedFileLoad" data-tooltip="Load from URL" aria-label="Load from URL"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                        <button type="button" class="shared-file-input-icon" id="sharedFileRefresh" data-tooltip="Refresh" aria-label="Refresh"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
                        <button type="button" class="shared-file-input-icon" id="sharedFileDownload" data-tooltip="Download JSON" aria-label="Download JSON"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                      </div>
                    </div>
                    <div class="shared-file-modal-status" id="sharedFileModalStatus">
                      <span class="shared-file-modal-status-dot none" id="sharedFileModalStatusDot"></span>
                      <span class="shared-file-modal-status-text" id="sharedFileModalStatusText">Not set</span>
                    </div>
                    <div class="shared-file-modal-section">
                      <label for="sharedFileGitHubToken" data-tooltip="Push to GitHub (owner): Personal Access Token with repo scope">Access Token</label>
                      <div class="shared-file-modal-token-row">
                        <div class="shared-file-input-wrap shared-file-input-wrap-token">
                          <input type="text" id="sharedFileGitHubToken" placeholder="ghp_..." autocomplete="off" inputmode="text" />
                          <div class="shared-file-input-icons">
                            <button type="button" class="shared-file-input-icon" id="sharedFileClearToken" data-tooltip="Clear token" aria-label="Clear token"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                            <button type="button" class="shared-file-input-icon" id="sharedFilePush" data-tooltip="Push to GitHub" aria-label="Push to GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></button>
                          </div>
                        </div>
                      </div>
                      <div class="shared-file-modal-status shared-file-modal-token-status" id="sharedFileModalTokenStatus">
                        <span class="shared-file-modal-status-dot none" id="sharedFileModalTokenStatusDot"></span>
                        <span class="shared-file-modal-status-text" id="sharedFileModalTokenStatusText">Not set</span>
                      </div>
                      <small class="settings-hint">Files are read-only without an access token. Add a Personal Access Token with repo scope to push changes.</small>
                    </div>
                    <div class="storage-github-error" id="storageGitHubError" role="alert"></div>
                  </div>
                </div>
                <div class="storage-type-tile" data-value="supabase" role="button" tabindex="0">
                  <div class="storage-type-tile-heading">
                    <span class="storage-type-tile-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></span>
                    <span class="storage-type-tile-title">Supabase (cloud)</span>
                  </div>
                  <div class="storage-type-tile-desc">Cloud save with login. Boards sync across devices.</div>
                  <div class="storage-type-tile-content">
                    <button type="button" class="home-shared-file-btn" id="settingsSupabaseAuthBtn">Log in or configure Supabase</button>
                    <small class="settings-hint" id="settingsSupabaseHint">If the button does nothing, enable Supabase in template.html (uncomment the Supabase script line).</small>
                  </div>
                </div>
                <div class="storage-type-tile" data-value="local_storage" role="button" tabindex="0" data-tooltip="Stored in browser local storage. Data will be erased if browser cache or site data is cleared. Use backup/restore to save a copy.">
                  <div class="storage-type-tile-heading">
                    <span class="storage-type-tile-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg></span>
                    <span class="storage-type-tile-title">Local storage</span>
                  </div>
                  <div class="storage-type-tile-desc">Store in the browser with optional backup/restore to a file.</div>
                  <div class="storage-type-tile-content">
                    <div class="storage-type-tile-actions">
                      <button type="button" class="home-shared-file-btn" id="storageModalBackupToFile">Backup to file</button>
                      <input type="file" id="storageModalRestoreFileInput" accept=".json,application/json" style="display: none;">
                      <button type="button" class="home-shared-file-btn" id="storageModalRestoreFromFile">Restore from file</button>
                    </div>
                  </div>
                </div>
                <div class="storage-type-tile" data-value="local_cache" role="button" tabindex="0" data-tooltip="Stored in browser cache. Data will be erased if browser cache or site data is cleared. Not recommended for important data.">
                  <div class="storage-type-tile-heading">
                    <span class="storage-type-tile-icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"/></svg></span>
                    <span class="storage-type-tile-title">Local cache</span>
                  </div>
                  <div class="storage-type-tile-desc">Browser cache only. Data can be lost if cache is cleared. Not recommended.</div>
                  <div class="storage-type-tile-content">
                    <p class="settings-hint" style="margin: 0;">No configuration needed. Save to apply.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-drawer-footer">
        <button type="button" class="settings-cancel-btn" id="settingsCancel">Cancel</button>
        <button type="button" class="settings-save-btn" id="settingsSave">Save</button>
      </div>
    </div>
  </div><!-- /.settings-sidebar -->
  </div><!-- /.app-views-wrap -->

  <span class="home-readonly-badge" id="homeReadonlyBadge" role="button" tabindex="0" data-tooltip="Sync Settings" style="display: none;">
    <span class="home-readonly-badge-dot synced" id="homeReadonlyBadgeDot"></span>
    <span id="homeReadonlyBadgeText">Synced with Github (read)</span>
  </span>

  <div class="gantt-auth-modal-overlay" id="ganttAuthModalOverlay">
    <div class="gantt-auth-modal">
      <div class="auth-config-section" id="ganttAuthConfigSection">
        <h3 id="ganttAuthConfigTitle">Connect to Supabase</h3>
        <p style="font-size: 13px; color: var(--text-secondary); margin: 0 0 12px 0;">Enter your project URL and API key from Supabase Dashboard → Settings → API. Use the <strong>Publishable</strong> key, or if login times out use the <strong>anon</strong> key from the <strong>Legacy API Keys</strong> tab.</p>
        <label for="ganttAuthConfigUrl">Project URL</label>
        <input type="url" id="ganttAuthConfigUrl" placeholder="https://xxxxx.supabase.co" autocomplete="off" />
        <label for="ganttAuthConfigAnonKey">Publishable key or anon key</label>
        <input type="text" id="ganttAuthConfigAnonKey" placeholder="sb_publishable_... or eyJhbGciOiJIUzI1NiIs..." autocomplete="off" />
        <div class="auth-actions">
          <button type="button" class="gantt-auth-btn" id="ganttAuthConfigSave">Save & continue</button>
          <button type="button" class="gantt-auth-btn" id="ganttAuthCancelConfig">Cancel</button>
        </div>
      </div>
      <div class="auth-login-section hidden" id="ganttAuthLoginSection">
        <h3 id="ganttAuthModalTitle">Log in</h3>
        <form id="ganttAuthLoginForm" name="login" method="post" action="#" autocomplete="on" onsubmit="return false;" aria-label="Log in or sign up">
          <input type="email" id="ganttAuthEmail" name="email" placeholder="Email" autocomplete="email" />
          <input type="password" id="ganttAuthPassword" name="password" placeholder="Password" autocomplete="current-password" />
          <label class="auth-remember">
            <input type="checkbox" id="ganttAuthRemember" checked />
            <span>Remember me</span>
          </label>
          <div class="auth-actions">
            <button type="button" class="gantt-auth-btn gantt-auth-btn-primary" id="ganttAuthSubmit">Log in</button>
            <button type="button" class="gantt-auth-btn gantt-auth-btn-secondary" id="ganttAuthSignupSubmit">Sign up</button>
          </div>
        </form>
        <div class="auth-use-different">
          <button type="button" id="ganttAuthShowConfig">Use different Supabase project</button>
          <span class="auth-use-different-sep">·</span>
          <button type="button" id="ganttAuthClearSession">Clear session and reload</button>
        </div>
        <p class="auth-project-hint" id="ganttAuthProjectHint" aria-live="polite"></p>
        <div class="auth-test-wrap">
          <button type="button" class="gantt-auth-btn gantt-auth-btn-secondary" id="ganttAuthTestConnection">Test connection</button>
          <span class="auth-test-result" id="ganttAuthTestResult"></span>
        </div>
      </div>
      <div class="auth-error" id="ganttAuthError" role="alert"></div>
    </div>
  </div>

  <div class="excel-sync-modal-overlay" id="excelSyncModalOverlay" role="dialog" aria-labelledby="excelSyncModalTitle" aria-modal="true" aria-hidden="true">
    <div class="excel-sync-modal shared-file-modal">
      <div class="shared-file-modal-header">
        <h3 id="excelSyncModalTitle">Excel sync</h3>
        <button type="button" class="shared-file-modal-close" id="excelSyncModalClose" aria-label="Close">&times;</button>
      </div>
      <div class="excel-sync-step excel-sync-step-upload" id="excelSyncStepUpload">
        <p class="storage-modal-panel-desc">Upload an Excel or CSV file. We’ll detect task names, dates, assignees, and phases from column headers — no need for exact names.</p>
        <label for="excelSyncFileInput" class="excel-sync-file-label" id="excelSyncFileLabel">
          <span class="excel-sync-file-label-inner">Choose file or drag and drop</span>
          <input type="file" id="excelSyncFileInput" accept=".xlsx,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="display:none">
        </label>
        <p class="excel-sync-hint" id="excelSyncFileHint">.xlsx, .xls, or .csv</p>
      </div>
      <div class="excel-sync-step excel-sync-step-map" id="excelSyncStepMap" style="display:none">
        <p class="storage-modal-panel-desc" id="excelSyncMapDesc">We couldn’t match all columns automatically. Choose which column to use for each Gantt field (or leave as Don’t map).</p>
        <div class="excel-sync-map-grid" id="excelSyncMapGrid" aria-label="Column mapping"></div>
        <div class="shared-file-modal-actions">
          <button type="button" class="home-shared-file-btn" id="excelSyncMapAutoDetect">Re-run auto-detect</button>
          <button type="button" class="home-shared-file-open-btn" id="excelSyncMapContinue">Continue to preview</button>
        </div>
      </div>
      <div class="excel-sync-step excel-sync-step-preview" id="excelSyncStepPreview" style="display:none">
        <p class="storage-modal-panel-desc" id="excelSyncPreviewDesc">Found <strong id="excelSyncRowCount">0</strong> rows. Mapped columns: <span id="excelSyncMappingSummary"></span> <button type="button" class="excel-sync-change-mapping-btn" id="excelSyncChangeMapping">Change column mapping</button></p>
        <div class="excel-sync-preview-table-wrap">
          <table class="excel-sync-preview-table" id="excelSyncPreviewTable" aria-label="Preview of first rows"></table>
        </div>
        <div class="shared-file-modal-actions">
          <button type="button" class="home-shared-file-btn" id="excelSyncChooseAnother">Choose another file</button>
          <button type="button" class="home-shared-file-open-btn home-shared-file-open-btn--primary" id="excelSyncCreateBoard">Create board</button>
        </div>
      </div>
      <div class="excel-sync-error" id="excelSyncError" role="alert" style="display:none"></div>
    </div>
  </div>

  <div class="project-setup-overlay" id="projectSetupOverlay" role="dialog" aria-labelledby="projectSetupTitle" aria-modal="true" aria-hidden="true">
    <div class="project-setup-modal shared-file-modal">
      <div class="shared-file-modal-header">
        <h3 id="projectSetupTitle">Set up your project</h3>
        <button type="button" class="shared-file-modal-close" id="projectSetupClose" aria-label="Close">&times;</button>
      </div>
      <div class="project-setup-body">
        <div class="project-setup-steps" id="projectSetupSteps">
          <div class="project-setup-step" id="projectSetupStep1" data-step="1">
            <p class="storage-modal-panel-desc">Give your project a name so you can find it later.</p>
            <div class="settings-section">
              <label for="projectSetupName">Project name</label>
              <input type="text" id="projectSetupName" placeholder="e.g. Q1 Launch" maxlength="200">
            </div>
            <div class="settings-section">
              <label for="projectSetupDesc">Description</label>
              <small class="settings-hint" style="margin-bottom: 4px;">Optional.</small>
              <textarea id="projectSetupDesc" placeholder="What’s this project about?" rows="2"></textarea>
            </div>
          </div>
          <div class="project-setup-step" id="projectSetupStep2" data-step="2" style="display:none">
            <p class="storage-modal-panel-desc">When does the project start and end? You can change these anytime in settings.</p>
            <div class="settings-section">
              <label for="projectSetupStartDate">Project start date</label>
              <input type="date" id="projectSetupStartDate">
              <small class="settings-hint">When set, the timeline stays fixed at this date; changing task dates won't shift it.</small>
            </div>
            <div class="settings-section">
              <label for="projectSetupEndDate">Project end date</label>
              <input type="date" id="projectSetupEndDate">
              <small class="settings-hint">When set, the timeline is capped at this date; the board won't extend beyond it.</small>
            </div>
          </div>
          <div class="project-setup-step" id="projectSetupStep3" data-step="3" style="display:none">
            <p class="storage-modal-panel-desc">Add the phases or stages for your timeline (e.g. Discovery, Build, Launch). Drag to reorder.</p>
            <div class="settings-section">
              <label for="projectSetupPhaseDurationMode">Phase duration</label>
              <select id="projectSetupPhaseDurationMode" class="settings-select">
                <option value="fixed" selected>Fixed (set sprints per phase)</option>
                <option value="dynamic">Dynamic based on child tasks</option>
              </select>
              <small class="settings-hint">Dynamic: phase header width reflects the date range of tasks in that phase. Fixed: set a number of sprints (2 weeks each) per phase.</small>
            </div>
            <div class="settings-section">
              <div class="settings-phase-list" id="projectSetupPhases" data-phase-mode="fixed"></div>
              <button type="button" class="settings-add-phase" id="projectSetupAddPhase">+ Add phase</button>
            </div>
          </div>
          <div class="project-setup-step" id="projectSetupStep4" data-step="4" style="display:none">
            <p class="storage-modal-panel-desc">Who’s on the project? Add team members to assign tasks to.</p>
            <div class="settings-section">
              <label>Team Members</label>
              <p class="settings-hint" style="margin-top: 0;">Names shown in the Team member dropdown for tasks. Saved with the project.</p>
              <div class="settings-party-list" id="projectSetupTeamList"></div>
              <div class="settings-add-party-row">
                <input type="text" id="projectSetupTeamInput" placeholder="Add name, press Enter" class="settings-party-input" maxlength="100">
              <button type="button" class="settings-add-phase" id="projectSetupTeamAdd">+ Add</button>
            </div>
          </div>
        </div>
      </div>
      <div class="project-setup-footer" id="projectSetupFooter">
        <div class="project-setup-progress" id="projectSetupProgress" aria-label="Progress">
          <span class="project-setup-progress-dot" data-step="1" aria-current="true"></span>
          <span class="project-setup-progress-dot" data-step="2"></span>
          <span class="project-setup-progress-dot" data-step="3"></span>
          <span class="project-setup-progress-dot" data-step="4"></span>
        </div>
        <div class="shared-file-modal-actions project-setup-actions">
          <div class="project-setup-actions-left">
            <button type="button" class="home-shared-file-btn" id="projectSetupBack" style="display:none">Back</button>
            <button type="button" class="home-shared-file-btn" id="projectSetupSkip" style="display:none">Skip</button>
          </div>
          <button type="button" class="home-shared-file-open-btn home-shared-file-open-btn--primary" id="projectSetupNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load config from config.js (copy config.example.js to config.js and add your Supabase URL + anon key) -->
  <script src="config.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="supabase-storage.js"></script>
  <script>
    (function initCustomTooltips() {
      var tooltip = document.getElementById("customTooltip");
      var showTimer, hideTimer;
      function show(el) {
        clearTimeout(hideTimer);
        var text = el.getAttribute("data-tooltip-disabled") && (el.disabled === true || el.getAttribute("aria-disabled") === "true") ? el.getAttribute("data-tooltip-disabled") : el.getAttribute("data-tooltip");
        if (!text || !text.trim()) return;
        tooltip.textContent = text.trim();
        tooltip.classList.add("measuring");
        tooltip.style.left = "0";
        tooltip.style.top = "0";
        var ttRect = tooltip.getBoundingClientRect();
        tooltip.classList.remove("measuring");
        var rect = el.getBoundingClientRect();
        var x = rect.left + (rect.width / 2) - (ttRect.width / 2);
        var y = rect.top - ttRect.height - 6;
        if (y < 8) y = rect.bottom + 6;
        if (x < 8) x = 8;
        if (x + ttRect.width > window.innerWidth - 8) x = window.innerWidth - ttRect.width - 8;
        tooltip.style.left = x + "px";
        tooltip.style.top = y + "px";
        tooltip.classList.add("visible");
        tooltip.setAttribute("aria-hidden", "false");
      }
      function hide() {
        hideTimer = setTimeout(function () {
          tooltip.classList.remove("visible");
          tooltip.setAttribute("aria-hidden", "true");
        }, 50);
      }
      document.body.addEventListener("mouseenter", function (e) {
        var el = e.target.closest("[data-tooltip]");
        if (!el) return;
        clearTimeout(showTimer);
        showTimer = setTimeout(function () { show(el); }, 400);
      }, true);
      document.body.addEventListener("mouseleave", function (e) {
        var el = e.target.closest("[data-tooltip]");
        if (!el) return;
        clearTimeout(showTimer);
        hide();
      }, true);
      document.body.addEventListener("focusin", function (e) {
        var el = e.target.closest("[data-tooltip]");
        if (!el) return;
        clearTimeout(hideTimer);
        show(el);
      }, true);
      document.body.addEventListener("focusout", function (e) {
        var el = e.target.closest("[data-tooltip]");
        if (!el || !el.contains(e.relatedTarget)) hide();
      }, true);
    })();
    const DEFAULT_WEEK_START = new Date(2026, 1, 2); // Feb 2, 2026
    const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
    let WEEK_START = new Date(DEFAULT_WEEK_START);
    let WEEKS = 8;

    const DEFAULT_PHASES = [
      { id: "discovery", name: "Discovery", color: "#EAB308" },
      { id: "ideation", name: "Ideation", color: "#0D9488" },
      { id: "development", name: "Development", color: "#0284C7" },
      { id: "review", name: "Review", color: "#14B8A6" },
      { id: "delivery", name: "Delivery", color: "#6366F1" }
    ];
    const COLOR_PALETTES = [
      { name: "Teal", colors: ["#EAB308", "#0D9488", "#0284C7", "#14B8A6", "#6366F1"] },
      { name: "Warm", colors: ["#EFCA08", "#305252", "#F78154", "#96C5B0", "#9E4770"] },
      { name: "Ocean", colors: ["#0EA5E9", "#0284C7", "#0369A1", "#0C4A6E", "#164E63"] },
      { name: "Sunset", colors: ["#F97316", "#E11D48", "#A21CAF", "#7C3AED", "#4F46E5"] },
      { name: "Forest", colors: ["#22C55E", "#16A34A", "#15803D", "#166534", "#14532D"] },
      { name: "Slate", colors: ["#64748B", "#475569", "#334155", "#1E293B", "#0F172A"] }
    ];
    let PHASES = [...DEFAULT_PHASES.map(p => ({ ...p }))];

    const PROJECTS_LIST_KEY = "gantt-projects";
    const STORAGE_MODE_KEY = "gantt-storage-mode";
    const SHARED_FILE_URL_KEY = "gantt-shared-file-url";
    const GITHUB_TOKEN_KEY = "gantt-github-token";
    function getStorageMode() {
      try { return localStorage.getItem(STORAGE_MODE_KEY) || null; } catch (e) { return null; }
    }
    function setStorageMode(mode) {
      try { if (mode) localStorage.setItem(STORAGE_MODE_KEY, mode); else localStorage.removeItem(STORAGE_MODE_KEY); } catch (e) {}
    }
    function getStorageModeLabel(mode) {
      if (!mode) return "Local cache";
      if (mode === "github") return "GitHub sync";
      if (mode === "supabase") return "Supabase (cloud)";
      if (mode === "local_storage") return "Local storage";
      if (mode === "local_cache") return "Local cache";
      return mode;
    }
    function clearLocalProjectData() {
      try {
        var keys = [];
        for (var i = 0; i < localStorage.length; i++) {
          var k = localStorage.key(i);
          if (k === PROJECTS_LIST_KEY || k.indexOf("gantt-tasks-") === 0 || k.indexOf("gantt-settings-") === 0 || k.indexOf("gantt-view-") === 0 || k.indexOf("gantt-custom-palettes-") === 0) keys.push(k);
        }
        keys.forEach(function (k) { localStorage.removeItem(k); });
      } catch (e) {}
    }
    const SHARED_FILE_POLL_MS = 30000;
    function getCustomPalettesKey() {
      return "gantt-custom-palettes-" + (currentProjectId || "default");
    }
    let currentProjectId = null;
    let homeEditProjectId = null;
    let realtimeUnsubscribe = null;

    function slugify(text) {
      return String(text || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-|-$/g, "") || "project";
    }
    function getProjectUrl(project) {
      const id = project?.id;
      if (id && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(id)) return "#/project/" + id;
      return "#/project/" + slugify(project?.name || "project");
    }
    const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    function getInviteTokenFromHash() {
      const hash = typeof location !== "undefined" ? (location.hash || "").replace(/^#\/?/, "") : "";
      const q = hash.indexOf("?");
      if (q < 0) return null;
      const params = new URLSearchParams(hash.slice(q));
      return params.get("invite") || null;
    }
    function getProjectIdFromHash() {
      const hash = typeof location !== "undefined" ? (location.hash || "").replace(/^#\/?/, "") : "";
      const m = /^project\/([^?]+)/.exec(hash);
      if (!m) return null;
      const segment = m[1];
      if (UUID_REGEX.test(segment)) return segment;
      const projects = loadProjectsList() || [];
      if (projects.some(p => p.id === segment)) return segment;
      if (/^(p-\d+|default)$/.test(segment)) return segment;
      const bySlug = projects.find(p => slugify(p.name) === segment);
      return bySlug ? bySlug.id : null;
    }
    function getCacheKey() {
      return currentProjectId ? "gantt-tasks-" + currentProjectId : "gantt-tasks-default";
    }
    function getSettingsKey() {
      return currentProjectId ? "gantt-settings-" + currentProjectId : "gantt-settings-default";
    }
    function getViewKey() {
      return currentProjectId ? "gantt-view-" + currentProjectId : "gantt-view-default";
    }
    const VIEW_ORDER = ["sprint", "month", "default", "project"];
    function loadProjectsListLocal() {
      try {
        const raw = localStorage.getItem(PROJECTS_LIST_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    }
    function saveProjectsListLocal(list) {
      try {
        localStorage.setItem(PROJECTS_LIST_KEY, JSON.stringify(list));
        if (window.notifySharedDataChanged) window.notifySharedDataChanged();
      } catch (e) { console.warn("Could not save projects list:", e); }
    }
    function loadProjectsList() {
      if (window.ganttStorage?.isCloudEnabled()) return window.ganttStorage.loadProjectsList() ?? [];
      return loadProjectsListLocal();
    }
    function saveProjectsList(list) {
      if (window.ganttStorage?.isCloudEnabled()) { window.ganttStorage.saveProjectsList(list); return; }
      saveProjectsListLocal(list);
    }
    function exportSharedSnapshot() {
      const rawList = localStorage.getItem(PROJECTS_LIST_KEY);
      const projects = (rawList ? (function () { try { var p = JSON.parse(rawList); return Array.isArray(p) ? p : []; } catch (e) { return []; } })() : []) || [];
      const boards = {};
      projects.forEach(function (p) {
        const id = p.id;
        try {
          const t = localStorage.getItem("gantt-tasks-" + id);
          const s = localStorage.getItem("gantt-settings-" + id);
          const v = localStorage.getItem("gantt-view-" + id);
          const cp = localStorage.getItem("gantt-custom-palettes-" + id);
          boards[id] = {
            tasks: t ? JSON.parse(t) : [],
            settings: s ? JSON.parse(s) : {},
            view: (v && v.trim()) || "default",
            custom_palettes: cp ? JSON.parse(cp) : []
          };
        } catch (e) { boards[id] = { tasks: [], settings: {}, view: "default", custom_palettes: [] }; }
      });
      return { projects: projects, boards: boards };
    }
    function importSharedSnapshot(data) {
      if (!data || !data.projects || !Array.isArray(data.projects)) return;
      try {
        localStorage.setItem(PROJECTS_LIST_KEY, JSON.stringify(data.projects));
        const boards = data.boards || {};
        data.projects.forEach(function (p) {
          const id = p.id;
          const b = boards[id] || {};
          localStorage.setItem("gantt-tasks-" + id, JSON.stringify(b.tasks || []));
          localStorage.setItem("gantt-settings-" + id, JSON.stringify(b.settings || {}));
          localStorage.setItem("gantt-view-" + id, (b.view && b.view.trim()) ? b.view : "default");
          localStorage.setItem("gantt-custom-palettes-" + id, JSON.stringify(b.custom_palettes || []));
        });
      } catch (e) { console.warn("Import shared snapshot failed:", e); }
    }
    function isProjectNameTaken(name, excludeProjectId) {
      if (!name || typeof name !== "string") return false;
      const normalized = name.trim().toLowerCase();
      if (!normalized) return false;
      const list = loadProjectsList();
      return list.some(p => p.id !== excludeProjectId && (p.name || "").trim().toLowerCase() === normalized);
    }
    function getUniqueProjectName(baseName) {
      const base = (baseName || "Untitled project").trim() || "Untitled project";
      if (!isProjectNameTaken(base, null)) return base;
      let n = 2;
      while (isProjectNameTaken(base + " " + n, null)) n++;
      return base + " " + n;
    }
    function ensureProjectInList(id, name) {
      const list = loadProjectsList();
      const i = list.findIndex(p => p.id === id);
      if (i >= 0) {
        if (name != null && !isProjectNameTaken(name, id)) list[i].name = name.trim() || list[i].name;
        saveProjectsList(list);
        return;
      }
      const finalName = getUniqueProjectName(name || "Untitled project");
      list.push({ id, name: finalName, createdAt: Date.now() });
      saveProjectsList(list);
    }
    function duplicateProject(sourceId) {
      if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
      pushProjectsListUndo();
      const list = loadProjectsList();
      const source = list.find(proj => proj.id === sourceId);
      const sourceName = source?.name || "Untitled project";
      const suggestedCopyName = sourceName.trim().toLowerCase().endsWith(" copy")
        ? sourceName + " (2)"
        : sourceName + " copy";
      const copyName = getUniqueProjectName(suggestedCopyName);
      if (window.ganttStorage?.isCloudEnabled()) {
        return window.ganttStorage.duplicateBoard(sourceId, copyName).then(() => {
          if (typeof renderHomeView === "function") renderHomeView();
        });
      }
      const newId = "p-" + Date.now();
      try {
        const tasksRaw = localStorage.getItem("gantt-tasks-" + sourceId);
        const settingsRaw = localStorage.getItem("gantt-settings-" + sourceId);
        const viewRaw = localStorage.getItem("gantt-view-" + sourceId);
        const palettesRaw = localStorage.getItem("gantt-custom-palettes-" + sourceId);
        if (tasksRaw) localStorage.setItem("gantt-tasks-" + newId, tasksRaw);
        if (settingsRaw) {
          const s = JSON.parse(settingsRaw);
          const s2 = { ...s, title: copyName, description: s.description || "" };
          localStorage.setItem("gantt-settings-" + newId, JSON.stringify(s2));
        } else {
          localStorage.setItem("gantt-settings-" + newId, JSON.stringify({ title: copyName, description: "" }));
        }
        if (viewRaw) localStorage.setItem("gantt-view-" + newId, viewRaw);
        if (palettesRaw) localStorage.setItem("gantt-custom-palettes-" + newId, palettesRaw);
      } catch (e) { console.warn("Could not copy project data:", e); }
      ensureProjectInList(newId, copyName);
      if (typeof renderHomeView === "function") renderHomeView();
    }

    function getProjectPhases(projectId) {
      if (window.ganttStorage?.isCloudEnabled()) {
        const s = window.ganttStorage.loadSettings(projectId);
        if (s?.phases && Array.isArray(s.phases)) return s.phases;
      }
      try {
        const raw = localStorage.getItem("gantt-settings-" + projectId);
        const s = raw ? JSON.parse(raw) : null;
        const phases = (s?.phases && Array.isArray(s.phases)) ? s.phases : DEFAULT_PHASES.map(p => ({ ...p }));
        return phases;
      } catch { return DEFAULT_PHASES.map(p => ({ ...p })); }
    }

    function getProjectTasksForPreview(projectId) {
      try {
        let tasks = [];
        if (window.ganttStorage?.isCloudEnabled()) {
          const list = window.ganttStorage.loadTasks(projectId);
          tasks = Array.isArray(list) ? list : [];
        } else {
          const tasksRaw = localStorage.getItem("gantt-tasks-" + projectId);
          const list = tasksRaw ? JSON.parse(tasksRaw) : [];
          tasks = Array.isArray(list) ? list : [];
        }
        const phases = getProjectPhases(projectId);
        const phaseMap = new Map(phases.map(p => [p.id, p.color || "#737373"]));
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();
        return tasks
          .filter(t => t.startDate && t.endDate)
          .map(t => {
            const start = new Date(t.startDate);
            const end = new Date(t.endDate);
            start.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            const phaseId = t.phase || phases[0]?.id;
            const color = phaseMap.get(phaseId) || phases[0]?.color || "#737373";
            const isCurrent = todayMs >= start.getTime() && todayMs <= end.getTime();
            const taskName = (t.task && String(t.task).trim()) || "Task";
            return { start, end, color, isCurrent, task: taskName };
          });
      } catch { return []; }
    }

    function getProjectStrokeMode(projectId) {
      if (window.ganttStorage?.isCloudEnabled()) {
        const s = window.ganttStorage.loadSettings(projectId);
        if (s) return !!s.strokeMode;
      }
      try {
        const raw = localStorage.getItem("gantt-settings-" + projectId);
        const s = raw ? JSON.parse(raw) : null;
        return !!s?.strokeMode;
      } catch { return false; }
    }

    function renderHomeTimelinePreview(projectId, containerEl) {
      if (!containerEl || !document.body.contains(containerEl)) return;
      containerEl.innerHTML = "";
      const bars = getProjectTasksForPreview(projectId);
      if (bars.length === 0) {
        containerEl.classList.add("home-timeline-empty");
        return;
      }
      containerEl.classList.remove("home-timeline-empty");
      const strokeMode = getProjectStrokeMode(projectId);
      const minT = Math.min(...bars.map(b => b.start.getTime()));
      const maxT = Math.max(...bars.map(b => b.end.getTime()));
      const range = Math.max(maxT - minT, 1);
      const labelW = 34;
      const barW = 100;
      const w = labelW + barW;
      const h = 70;
      const rowH = 6;
      const rowGap = 1;
      const padTop = 10;
      const numBars = Math.min(24, bars.length);
      const maxRows = Math.max(1, Math.floor((h - padTop - 4) / (rowH + rowGap)));
      const usedRows = Math.min(maxRows, numBars);
      const contentHeight = usedRows * rowH + (usedRows - 1) * rowGap;
      const padY = padTop;
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", "0 0 " + w + " " + h);
      svg.setAttribute("preserveAspectRatio", "xMidYMid slice");
      svg.setAttribute("class", "home-timeline-svg");
      svg.setAttribute("aria-hidden", "true");
      for (let r = 0; r <= usedRows; r++) {
        const gy = padY + r * (rowH + rowGap);
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", String(labelW));
        line.setAttribute("y1", gy.toFixed(1));
        line.setAttribute("x2", String(w));
        line.setAttribute("y2", gy.toFixed(1));
        line.setAttribute("stroke", "currentColor");
        line.setAttribute("stroke-opacity", "0.2");
        line.setAttribute("stroke-width", "0.4");
        svg.appendChild(line);
      }
      bars.slice(0, 24).forEach((b, i) => {
        const row = i % maxRows;
        const barX = labelW + Math.max(0, ((b.start.getTime() - minT) / range) * (barW - 2));
        const bw = Math.max(2, ((b.end.getTime() - b.start.getTime()) / range) * (barW - 2));
        const y = padY + row * (rowH + rowGap);
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", barX.toFixed(1));
        rect.setAttribute("y", y.toFixed(1));
        rect.setAttribute("width", bw.toFixed(1));
        rect.setAttribute("height", rowH);
        rect.setAttribute("rx", "1.5");
        if (!b.isCurrent) rect.setAttribute("opacity", "0.32");
        if (strokeMode) {
          rect.setAttribute("fill", hexToRgba(b.color, 0.16));
          rect.setAttribute("stroke", b.color);
          rect.setAttribute("stroke-width", "0.3");
        } else {
          rect.setAttribute("fill", b.color);
        }
        svg.appendChild(rect);
      });
      const labelMaxLen = 12;
      bars.slice(0, 24).forEach((b, i) => {
        const row = i % maxRows;
        const y = padY + row * (rowH + rowGap) + rowH / 2 + 1;
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", "2");
        text.setAttribute("y", y.toFixed(1));
        text.setAttribute("font-size", "3.2");
        text.setAttribute("fill", "currentColor");
        text.setAttribute("text-anchor", "start");
        text.setAttribute("dominant-baseline", "middle");
        if (!b.isCurrent) text.setAttribute("opacity", "0.32");
        const label = b.task.length > labelMaxLen ? b.task.substring(0, labelMaxLen) + "…" : b.task;
        text.textContent = label;
        svg.appendChild(text);
      });
      containerEl.appendChild(svg);
    }

    function loadCustomPalettes() {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        const raw = window.ganttStorage.loadCustomPalettes(currentProjectId);
        if (raw != null) return Array.isArray(raw) ? raw : [];
      }
      try {
        const raw = localStorage.getItem(getCustomPalettesKey());
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    }
    function saveCustomPalettes(palettes) {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        window.ganttStorage.saveCustomPalettes(currentProjectId, palettes);
        return;
      }
      try {
        localStorage.setItem(getCustomPalettesKey(), JSON.stringify(palettes));
        if (window.notifySharedDataChanged) window.notifySharedDataChanged();
      } catch (e) { console.warn("Could not save custom palettes:", e); }
    }
    function autoSavePaletteFromPhaseColors() {
      const phaseItems = document.querySelectorAll(".settings-phase-item");
      const colors = [...phaseItems].map(item => {
        const colorInp = item.querySelector('input[type="color"]');
        return colorInp?.value || "#737373";
      }).filter(Boolean);
      if (colors.length === 0) return;
      const titleEl = document.getElementById("settingsTitle");
      const boardName = (titleEl?.value || "").trim() || "Board";
      const custom = loadCustomPalettes();
      let idx = custom.findIndex(p => (p.name || "").trim() === boardName);
      if (idx >= 0) {
        custom[idx].colors = colors;
      } else {
        custom.push({ name: boardName, colors });
        idx = custom.length - 1;
      }
      saveCustomPalettes(custom);
      const paletteGrid = document.getElementById("settingsPaletteGrid");
      if (!paletteGrid) return;
      const strokePreview = document.querySelector("#settingsBarStyle .settings-segmented-option[data-value='stroke']")?.classList.contains("selected");
      const gridIndex = COLOR_PALETTES.length + idx;
      let opt = paletteGrid.querySelector(".settings-palette-option[data-index=\"" + gridIndex + "\"]");
      if (opt) {
        opt.dataset.colors = JSON.stringify(colors);
        const swatchesEl = opt.querySelector(".settings-palette-swatches");
        if (swatchesEl) {
          swatchesEl.innerHTML = "";
          colors.forEach(c => {
            const span = document.createElement("span");
            applyPaletteSwatchStyle(span, c, strokePreview);
            swatchesEl.appendChild(span);
          });
        }
        paletteGrid.querySelectorAll(".settings-palette-option").forEach(o => o.classList.remove("selected"));
        opt.classList.add("selected");
      } else if (idx === custom.length - 1) {
        opt = document.createElement("button");
        opt.type = "button";
        opt.className = "settings-palette-option editable selected";
        opt.dataset.index = String(gridIndex);
        opt.dataset.colors = JSON.stringify(colors);
        const nameWrap = document.createElement("div");
        nameWrap.className = "settings-palette-name-wrap";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "settings-palette-name-input";
        nameInput.value = boardName;
        nameInput.readOnly = false;
        nameInput.addEventListener("click", (e) => e.stopPropagation());
        nameInput.addEventListener("focus", (e) => e.stopPropagation());
        const renameBtn = document.createElement("button");
        renameBtn.type = "button";
        renameBtn.className = "settings-palette-rename-btn";
        renameBtn.textContent = "Rename";
        renameBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const newName = prompt("Palette name", nameInput.value?.trim() || "My palette")?.trim();
          if (newName == null || newName === nameInput.value) return;
          const cust = loadCustomPalettes();
          const customIdx = gridIndex - COLOR_PALETTES.length;
          if (customIdx >= 0 && cust[customIdx]) {
            cust[customIdx].name = newName;
            saveCustomPalettes(cust);
            nameInput.value = newName;
          }
        });
        nameWrap.appendChild(nameInput);
        nameWrap.appendChild(renameBtn);
        opt.appendChild(nameWrap);
        const swatchesEl = document.createElement("div");
        swatchesEl.className = "settings-palette-swatches";
        colors.forEach(c => {
          const span = document.createElement("span");
          applyPaletteSwatchStyle(span, c, strokePreview);
          swatchesEl.appendChild(span);
        });
        opt.appendChild(swatchesEl);
        opt.addEventListener("click", () => {
          paletteGrid.querySelectorAll(".settings-palette-option").forEach(o => o.classList.remove("selected"));
          opt.classList.add("selected");
          document.querySelectorAll(".settings-phase-item").forEach((item, i) => {
            const colorInp = item.querySelector('input[type="color"]');
            if (colorInp && colors[i]) colorInp.value = colors[i];
          });
        });
        paletteGrid.querySelectorAll(".settings-palette-option").forEach(o => o.classList.remove("selected"));
        paletteGrid.appendChild(opt);
        opt.classList.add("selected");
      }
    }
    function getSavedView() {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        const v = window.ganttStorage.loadView(currentProjectId);
        if (v != null) return v;
      }
      return localStorage.getItem(getViewKey());
    }
    function setSavedView(view) {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        window.ganttStorage.saveView(currentProjectId, view);
        return;
      }
      localStorage.setItem(getViewKey(), view);
      if (window.notifySharedDataChanged) window.notifySharedDataChanged();
    }
    const DEFAULT_PAGE_TITLE = "Project Schedule";
    const DEFAULT_PAGE_DESCRIPTION = "Drag bars to reschedule • Drag edges to change dates • Drag rows to reorder • Click a row to expand details • Click cells to edit";

    function loadProjectSettings() {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        const s = window.ganttStorage.loadSettings(currentProjectId);
        if (s != null) return s;
      }
      try {
        const raw = localStorage.getItem(getSettingsKey());
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }
    function saveProjectSettings(settings) {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        window.ganttStorage.saveSettings(currentProjectId, settings);
        return;
      }
      try {
        localStorage.setItem(getSettingsKey(), JSON.stringify(settings));
        if (window.notifySharedDataChanged) window.notifySharedDataChanged();
      } catch (e) { console.warn("Could not save project settings:", e); }
    }
    const JIRA_BASE_URL = ""; // e.g. "https://your-team.atlassian.net" — leave empty to only linkify full URLs
    const DEFAULT_TASKS = [
      { task: "Benchmarking", phase: "discovery", party: "Graham", start: "2/3", end: "2/12", startDate: new Date(2026, 1, 3), endDate: new Date(2026, 1, 12), star: false },
      { task: "Internal Design Audit", phase: "discovery", party: "Kaylan", start: "2/3", end: "2/12", startDate: new Date(2026, 1, 3), endDate: new Date(2026, 1, 12), star: false },
      { task: "Foundations Audit - Content - Strat", phase: "discovery", party: "Charlie", start: "2/3", end: "2/12", startDate: new Date(2026, 1, 3), endDate: new Date(2026, 1, 12), star: false },
      { task: "Principle Workshop & Full team alignment", phase: "ideation", party: "Full Team", start: "2/10", end: "2/10", startDate: new Date(2026, 1, 10), endDate: new Date(2026, 1, 10), star: false },
      { task: "Draft 1: Internal Review & Working Session", phase: "development", party: "Kettle Team", start: "2/18", end: "2/18", startDate: new Date(2026, 1, 18), endDate: new Date(2026, 1, 18), star: false },
      { task: "Full Team Review", phase: "review", party: "Full Team", start: "2/19", end: "2/19", startDate: new Date(2026, 1, 19), endDate: new Date(2026, 1, 19), star: false },
      { task: "Draft 2: Edits", phase: "development", party: "Kettle Team", start: "2/19", end: "2/24", startDate: new Date(2026, 1, 19), endDate: new Date(2026, 1, 24), star: false },
      { task: "Bethany Review & Principle Validation", phase: "review", party: "Full Team", start: "2/25", end: "2/25", startDate: new Date(2026, 1, 25), endDate: new Date(2026, 1, 25), star: true },
      { task: "Draft 3: Bethany Feedback Implemented", phase: "development", party: "Kettle Team", start: "2/26", end: "3/2", startDate: new Date(2026, 1, 26), endDate: new Date(2026, 2, 2), star: false },
      { task: "Sailesh Review & Principle Validation", phase: "review", party: "Full Team", start: "3/3", end: "3/3", startDate: new Date(2026, 2, 3), endDate: new Date(2026, 2, 3), star: true },
      { task: "Draft 4: Sailesh Feedback Implemented", phase: "development", party: "Kettle Team", start: "3/5", end: "3/5", startDate: new Date(2026, 2, 5), endDate: new Date(2026, 2, 5), star: false },
      { task: "Formatting content/guidelines into the documentation template", phase: "development", party: "Kettle Team", start: "3/5", end: "3/16", startDate: new Date(2026, 2, 5), endDate: new Date(2026, 2, 16), star: false },
      { task: "Approval of Guidelines", phase: "delivery", party: "Full Team + VP", start: "", end: "", startDate: null, endDate: null, star: false }
    ];

    let tasks = [];

    function resolveDependsOnIndex(val) {
      if (val == null) return null;
      if (typeof val === "number" && !isNaN(val) && val >= 0) return val;
      if (typeof val === "string" && /^\d+$/.test(val)) return parseInt(val, 10);
      return null;
    }
    function parseTaskRow(t) {
      const links = Array.isArray(t.links) ? t.links : (Array.isArray(t.dependencies) ? t.dependencies : []);
      const migratedLinks = (t.jiraTicket && t.jiraTicket.trim()) ? [t.jiraTicket.trim(), ...links] : links;
      const startDate = t.startDate ? new Date(t.startDate) : null;
      const endDate = t.endDate ? new Date(t.endDate) : null;
      const dependsOn = resolveDependsOnIndex(t.dependsOn);
      return {
        ...t,
        startDate,
        endDate,
        start: t.start || (startDate ? formatDate(startDate) : ""),
        end: t.end || (endDate ? formatDate(endDate) : ""),
        overview: t.overview || "",
        subTasks: Array.isArray(t.subTasks) ? t.subTasks : [],
        blockers: Array.isArray(t.blockers) ? t.blockers : [],
        links: migratedLinks,
        dependsOn: dependsOn,
        phaseSecondary: t.phaseSecondary && t.phaseSecondary !== t.phase ? t.phaseSecondary : null
      };
    }
    function loadTasks() {
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        const raw = window.ganttStorage.loadTasks(currentProjectId);
        if (raw != null) return Array.isArray(raw) ? raw.map(parseTaskRow) : [];
      }
      try {
        const raw = localStorage.getItem(getCacheKey());
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return parsed.map(parseTaskRow);
      } catch {
        return [];
      }
    }

    function applyLinkAllTasks() {
      if (!Array.isArray(tasks)) return;
      tasks.forEach((t, i) => { t.dependsOn = i === 0 ? null : i - 1; });
    }
    function clearAllTaskDependencies() {
      if (!Array.isArray(tasks)) return;
      tasks.forEach(t => { t.dependsOn = null; });
    }
    function saveTasks() {
      if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
      const toSave = tasks.map(t => ({
        task: t.task,
        phase: t.phase,
        phaseSecondary: t.phaseSecondary || null,
        party: t.party,
        status: t.status || "Not started",
        start: t.start,
        end: t.end,
        startDate: t.startDate ? t.startDate.toISOString() : null,
        endDate: t.endDate ? t.endDate.toISOString() : null,
        star: t.star,
        overview: t.overview || "",
        subTasks: t.subTasks || [],
        blockers: t.blockers || [],
        links: t.links || [],
        dependsOn: typeof t.dependsOn === "number" ? t.dependsOn : null
      }));
      if (window.ganttStorage?.isCloudEnabled() && currentProjectId) {
        window.ganttStorage.saveTasks(currentProjectId, toSave);
        return;
      }
      try {
        localStorage.setItem(getCacheKey(), JSON.stringify(toSave));
        if (window.notifySharedDataChanged) window.notifySharedDataChanged();
      } catch (e) {
        console.warn("Could not save tasks:", e);
      }
    }

    function updateCollaboratorsAvatarBar(presenceState, fallbackCurrentUser) {
      const bar = document.getElementById("collaboratorsAvatarBar");
      const list = document.getElementById("collaboratorsAvatarList");
      const dropdownUsers = document.getElementById("collaboratorsDropdownUsers");
      const inviteBtn = document.getElementById("collaboratorsInviteBtn");
      if (!bar || !list) return;
      const users = [];
      const seen = new Set();
      if (presenceState && typeof presenceState === "object") {
        Object.values(presenceState).forEach((presences) => {
          (Array.isArray(presences) ? presences : []).forEach((p) => {
            const uid = p.user_id || p.userId;
            if (uid && !seen.has(uid)) {
              seen.add(uid);
              users.push({ user_id: uid, email: p.email || "", initials: p.initials || "?", avatar_url: p.avatar_url || null });
            }
          });
        });
      }
      if (users.length === 0 && fallbackCurrentUser) {
        users.push(fallbackCurrentUser);
      }
      if (users.length === 0) {
        bar.style.display = "none";
        if (inviteBtn) inviteBtn.style.display = "none";
        return;
      }
      bar.style.display = "block";
      var canInvite = (typeof window.hasWriteAccess === "function" && window.hasWriteAccess()) && (typeof window.ganttStorage?.createBoardInviteLink === "function");
      if (inviteBtn) inviteBtn.style.display = canInvite ? "block" : "none";
      list.innerHTML = users.map((u) => {
        const title = (u.email || "Collaborator").replace(/"/g, "&quot;");
        const safeUrl = (u.avatar_url && typeof u.avatar_url === "string" && u.avatar_url.startsWith("https://")) ? u.avatar_url.replace(/"/g, "&quot;") : null;
        if (safeUrl) {
          return '<span class="collaborators-avatar" title="' + title + '" role="img" aria-label="' + title + '"><img src="' + safeUrl + '" alt=""></span>';
        }
        return '<span class="collaborators-avatar" title="' + title + '" role="img" aria-label="' + title + '">' + (u.initials || "?") + '</span>';
      }).join("");
      if (dropdownUsers) {
        dropdownUsers.innerHTML = users.map((u) => {
          const name = (u.email || "Collaborator").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
          const safeUrl = (u.avatar_url && typeof u.avatar_url === "string" && u.avatar_url.startsWith("https://")) ? u.avatar_url.replace(/"/g, "&quot;") : null;
          var avatarHtml = safeUrl
            ? '<span class="collaborators-dropdown-user-avatar"><img src="' + safeUrl + '" alt="" style="width:100%;height:100%;object-fit:cover"></span>'
            : '<span class="collaborators-dropdown-user-avatar">' + (u.initials || "?") + '</span>';
          return '<div class="collaborators-dropdown-user">' + avatarHtml + '<span>' + name + '</span></div>';
        }).join("");
      }
    }

    function applyRealtimeBoardUpdate() {
      if (!currentProjectId) return;
      tasks.length = 0;
      tasks.push(...loadTasks());
      tasks.forEach((_, i) => { if (tasks.some(t => t.dependsOn === i)) propagateDependencyChanges(i); });
      applyProjectSettings();
      const viewSelect = document.getElementById("viewMode");
      if (viewSelect) {
        const saved = getSavedView();
        if (saved && VIEW_ORDER.includes(saved)) viewSelect.value = saved;
      }
      if (typeof updateChartRange === "function") updateChartRange();
      if (typeof updateEmptyState === "function") updateEmptyState();
      if (typeof renderTasks === "function") renderTasks();
      if (typeof updateWeekWidth === "function") updateWeekWidth();
      if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
      if (typeof showToast === "function") showToast("Board updated by another collaborator");
    }

    const UNDO_MAX = 50;
    let undoStack = [];
    let redoStack = [];
    let isUndoRedoInProgress = false;

    function exportBoardAsDesignJson() {
      var title = (typeof getCurrentProjectTitle === "function" ? getCurrentProjectTitle() : null) || "Gantt Board";
      var taskList = Array.isArray(tasks) ? tasks : [];
      var children = [];
      taskList.forEach(function (t, i) {
        var name = (t.task && String(t.task).trim()) || "Task " + (i + 1);
        var range = (t.start || "") + (t.start && t.end ? " — " : "") + (t.end || "");
        children.push({
          type: "frame",
          name: "Row: " + name,
          width: 360,
          height: 32,
          layoutMode: "HORIZONTAL",
          itemSpacing: 12,
          paddingLeft: 8,
          paddingRight: 8,
          paddingTop: 4,
          paddingBottom: 4,
          fills: [{ type: "SOLID", color: "#FAFAFA" }],
          cornerRadius: 4,
          children: [
            { type: "text", name: "Task", characters: name, fontSize: 13, fontStyle: "Medium", width: 180 },
            { type: "text", name: "Range", characters: range || "—", fontSize: 12, fontStyle: "Regular", fills: [{ type: "SOLID", color: "#737373" }] }
          ]
        });
      });
      return {
        type: "frame",
        name: title,
        width: 400,
        height: Math.max(120, children.length * 40),
        layoutMode: "VERTICAL",
        itemSpacing: 8,
        paddingLeft: 24,
        paddingRight: 24,
        paddingTop: 24,
        paddingBottom: 24,
        fills: [{ type: "SOLID", color: "#FFFFFF" }],
        cornerRadius: 12,
        strokes: [{ type: "SOLID", color: "#E5E5E5" }],
        strokeWeight: 1,
        children: [
          { type: "text", name: "Title", characters: title, fontSize: 18, fontStyle: "Bold", fills: [{ type: "SOLID", color: "#171717" }] }
        ].concat(children)
      };
    }

    function getTasksSnapshot() {
      const toSave = tasks.map(t => ({
        task: t.task,
        phase: t.phase,
        phaseSecondary: t.phaseSecondary || null,
        party: t.party,
        status: t.status || "Not started",
        start: t.start,
        end: t.end,
        startDate: t.startDate ? t.startDate.toISOString() : null,
        endDate: t.endDate ? t.endDate.toISOString() : null,
        star: t.star,
        overview: t.overview || "",
        subTasks: t.subTasks || [],
        blockers: t.blockers || [],
        links: t.links || [],
        dependsOn: typeof t.dependsOn === "number" ? t.dependsOn : null
      }));
      return JSON.stringify(toSave);
    }

    function parseTasksFromSave(jsonStr) {
      try {
        const parsed = JSON.parse(jsonStr);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(t => {
          const links = Array.isArray(t.links) ? t.links : (Array.isArray(t.dependencies) ? t.dependencies : []);
          const startDate = t.startDate ? new Date(t.startDate) : null;
          const endDate = t.endDate ? new Date(t.endDate) : null;
          const dependsOn = resolveDependsOnIndex(t.dependsOn);
          return {
            ...t,
            startDate,
            endDate,
            start: t.start || (startDate ? formatDate(startDate) : ""),
            end: t.end || (endDate ? formatDate(endDate) : ""),
            overview: t.overview || "",
            subTasks: Array.isArray(t.subTasks) ? t.subTasks : [],
            blockers: Array.isArray(t.blockers) ? t.blockers : [],
            links,
            dependsOn,
            phaseSecondary: t.phaseSecondary && t.phaseSecondary !== t.phase ? t.phaseSecondary : null
          };
        });
      } catch { return []; }
    }

    function pushUndo(entry) {
      if (isUndoRedoInProgress) return;
      redoStack = [];
      undoStack.push(entry);
      if (undoStack.length > UNDO_MAX) undoStack.shift();
    }

    function pushTasksUndo() {
      if (!currentProjectId) return;
      pushUndo({ type: "tasks", projectId: currentProjectId, prev: getTasksSnapshot() });
    }

    function pushProjectsListUndo() {
      pushUndo({ type: "projectsList", prev: JSON.stringify(loadProjectsList()) });
    }

    function performUndo() {
      if (undoStack.length === 0) return;
      const entry = undoStack.pop();
      isUndoRedoInProgress = true;
      try {
        if (entry.type === "tasks" && entry.projectId === currentProjectId) {
          const nextSnapshot = getTasksSnapshot();
          tasks.length = 0;
          tasks.push(...parseTasksFromSave(entry.prev));
          saveTasks();
          redoStack.push({ type: "tasks", projectId: currentProjectId, prev: nextSnapshot });
          if (typeof updateChartRange === "function") updateChartRange();
          if (typeof renderTasks === "function") renderTasks();
          if (typeof updateEmptyState === "function") updateEmptyState();
        } else if (entry.type === "projectsList") {
          const next = JSON.stringify(loadProjectsList());
          const list = JSON.parse(entry.prev);
          const idsBefore = new Set(list.map((x) => x.id));
          saveProjectsList(list);
          redoStack.push({ type: "projectsList", prev: next });
          if (currentProjectId && !idsBefore.has(currentProjectId)) {
            if (typeof location !== "undefined") location.hash = "#/";
          }
          if (typeof renderHomeView === "function" && !currentProjectId) renderHomeView();
        } else if (entry.type === "tasks") {
          undoStack.push(entry);
        }
      } finally {
        isUndoRedoInProgress = false;
      }
    }

    function performRedo() {
      if (redoStack.length === 0) return;
      const entry = redoStack.pop();
      isUndoRedoInProgress = true;
      try {
        if (entry.type === "tasks" && entry.projectId === currentProjectId) {
          const nextSnapshot = getTasksSnapshot();
          tasks.length = 0;
          tasks.push(...parseTasksFromSave(entry.prev));
          saveTasks();
          undoStack.push({ type: "tasks", projectId: currentProjectId, prev: nextSnapshot });
          if (typeof updateChartRange === "function") updateChartRange();
          if (typeof renderTasks === "function") renderTasks();
          if (typeof updateEmptyState === "function") updateEmptyState();
        } else if (entry.type === "projectsList") {
          const next = JSON.stringify(loadProjectsList());
          const list = JSON.parse(entry.prev);
          const idsAfter = new Set(list.map((x) => x.id));
          saveProjectsList(list);
          undoStack.push({ type: "projectsList", prev: next });
          if (currentProjectId && !idsAfter.has(currentProjectId)) {
            if (typeof location !== "undefined") location.hash = "#/";
          }
          if (typeof renderHomeView === "function" && !currentProjectId) renderHomeView();
        } else {
          redoStack.push(entry);
        }
      } finally {
        isUndoRedoInProgress = false;
      }
    }

    function wouldCreateCycle(dependentIdx, primaryIdx) {
      const seen = new Set();
      let curr = primaryIdx;
      while (curr !== null && curr !== undefined && !seen.has(curr)) {
        if (curr === dependentIdx) return true;
        seen.add(curr);
        const t = tasks[curr];
        curr = typeof t?.dependsOn === "number" ? t.dependsOn : null;
      }
      return false;
    }
    function getDependencyGapDays() {
      const s = loadProjectSettings();
      const n = parseInt(s?.dependencyGapDays, 10);
      return isNaN(n) || n < 0 ? 0 : n;
    }
    function getAllowIndependentDependencies() {
      const s = loadProjectSettings();
      return !!s?.allowIndependentDependencies;
    }
    function getProjectStartDate() {
      const s = loadProjectSettings();
      const raw = s?.projectStartDate;
      if (!raw || typeof raw !== "string") return null;
      const parts = raw.trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (!parts) return null;
      const d = new Date(parseInt(parts[1], 10), parseInt(parts[2], 10) - 1, parseInt(parts[3], 10));
      return isNaN(d.getTime()) ? null : d;
    }
    function getProjectEndDate() {
      const s = loadProjectSettings();
      const raw = s?.projectEndDate;
      if (!raw || typeof raw !== "string") return null;
      const parts = raw.trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (!parts) return null;
      const d = new Date(parseInt(parts[1], 10), parseInt(parts[2], 10) - 1, parseInt(parts[3], 10));
      return isNaN(d.getTime()) ? null : d;
    }
    function clampTaskDatesToProjectRange(startDate, endDate) {
      if (!startDate || !endDate) return { startDate, endDate };
      let start = new Date(startDate.getTime());
      let end = new Date(endDate.getTime());
      const projectStart = getProjectStartDate();
      const projectEnd = getProjectEndDate();
      if (projectStart) {
        const minStart = new Date(projectStart.getFullYear(), projectStart.getMonth(), projectStart.getDate());
        if (start.getTime() < minStart.getTime()) {
          start = new Date(minStart);
          if (end.getTime() < start.getTime()) end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
        }
      }
      if (projectEnd) {
        const maxEnd = new Date(projectEnd.getFullYear(), projectEnd.getMonth(), projectEnd.getDate(), 23, 59, 59, 999);
        if (end.getTime() > maxEnd.getTime()) {
          end = new Date(maxEnd);
          if (start.getTime() > end.getTime()) start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
        }
      }
      return { startDate: start, endDate: end };
    }
    let lastBarChangeOriginalDurationMs = null;
    let lastBarChangeTaskIndex = null;
    let lastBarChangeOriginalStartDate = null;
    let lastBarChangeOriginalEndDate = null;
    let selectedBarIndex = null;
    let selectedBarElement = null;
    let selectedBarClickOutside = null;
    let selectedBarDepLineCleanup = null;
    function updateBarPosition(barElement, taskIndex) {
      if (!barElement) return;
      const task = tasks[taskIndex];
      if (!task || !task.startDate || !task.endDate) return;
      const startOffset = Math.max(0, dateToOffset(task.startDate));
      let endOffset = dateToOffset(task.endDate);
      if (endOffset <= startOffset) endOffset = startOffset + 1/7;
      endOffset = Math.min(WEEKS, endOffset);
      barElement.style.left = (startOffset / WEEKS) * 100 + "%";
      barElement.style.width = ((endOffset - startOffset) / WEEKS) * 100 + "%";
      setBarPhaseStyle(barElement, task);
      const row = document.querySelector(`.gantt-row[data-index="${taskIndex}"]`);
      if (row) {
        const startInp = row.querySelector('.gantt-date-start');
        const endInp = row.querySelector('.gantt-date-end');
        if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
        if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
      }
    }

    function propagateDependencyChanges(primaryIndex, visited, durationOverride, updateVisuals) {
      if (getAllowIndependentDependencies()) return;
      if (visited && visited.has(primaryIndex)) return;
      const seen = visited || new Set();
      seen.add(primaryIndex);
      const primary = tasks[primaryIndex];
      if (!primary || !primary.endDate) return;
      const gapMs = getDependencyGapDays() * 24 * 60 * 60 * 1000;
      const dependentStartBase = new Date(primary.endDate.getTime() + gapMs);
      tasks.forEach((t, i) => {
        if (t.dependsOn === primaryIndex && t.startDate && t.endDate) {
          const durationMs = (durationOverride && durationOverride.taskIndex === i)
            ? durationOverride.durationMs
            : (t.endDate.getTime() - t.startDate.getTime());
          t.startDate = new Date(dependentStartBase);
          t.endDate = new Date(dependentStartBase.getTime() + durationMs);
          t.start = formatDate(t.startDate);
          t.end = formatDate(t.endDate);
          if (updateVisuals) {
            const bar = document.querySelector(`.gantt-bar[data-index="${i}"]`);
            updateBarPosition(bar, i);
          }
          propagateDependencyChanges(i, seen, undefined, updateVisuals);
        }
      });
    }

    function loadPageHeader() {
      const s = loadProjectSettings();
      if (s) return { title: s.title || DEFAULT_PAGE_TITLE, description: s.description || DEFAULT_PAGE_DESCRIPTION };
      return { title: DEFAULT_PAGE_TITLE, description: DEFAULT_PAGE_DESCRIPTION };
    }
    function savePageHeader(title, description) {
      const s = loadProjectSettings() || {};
      saveProjectSettings({ ...s, title: title || DEFAULT_PAGE_TITLE, description: description || DEFAULT_PAGE_DESCRIPTION });
    }
    function formatDate(d) {
      if (!d) return "";
      return (d.getMonth() + 1) + "/" + d.getDate();
    }
    function formatDateFull(d) {
      if (!d || !d.getTime || isNaN(d.getTime())) return "";
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return months[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();
    }

    function parseDateStr(str) {
      if (!str || !str.trim()) return null;
      const s = str.trim().replace(/\s*-\s*/g, "-");
      const parts = s.split("-");
      const parsePart = (p) => {
        const m = p.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
        if (m) {
          const month = parseInt(m[1], 10) - 1;
          const day = parseInt(m[2], 10);
          const year = m[3] ? parseInt(m[3], 10) : 2026;
          const yr = year < 100 ? 2000 + year : year;
          return new Date(yr, month, day);
        }
        const d = new Date(p);
        return isNaN(d.getTime()) ? null : d;
      };
      const start = parsePart(parts[0].trim());
      if (!start) return null;
      const end = parts[1] ? parsePart(parts[1].trim()) : start;
      return { start, end: end || start };
    }

    function toDateInputValue(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    let toastTimer = null;
    function showToast(message, options) {
      const el = document.getElementById("ganttToast");
      if (!el) return;
      if (toastTimer) clearTimeout(toastTimer);
      el.classList.remove("error");
      if (options?.type === "error") el.classList.add("error");
      el.innerHTML = message;
      if (options?.onUndo && typeof options.onUndo === "function") {
        const undoBtn = document.createElement("button");
        undoBtn.type = "button";
        undoBtn.className = "gantt-toast-undo";
        undoBtn.textContent = "Undo";
        undoBtn.addEventListener("click", () => {
          if (toastTimer) clearTimeout(toastTimer);
          toastTimer = null;
          el.classList.remove("visible");
          options.onUndo();
        });
        el.appendChild(undoBtn);
      }
      if (options?.action && typeof options.action === "object" && options.action.label && typeof options.action.onClick === "function") {
        const actionBtn = document.createElement("button");
        actionBtn.type = "button";
        actionBtn.className = options.action.secondary ? "gantt-toast-btn-secondary" : "gantt-toast-link";
        if (options.action.icon) {
          actionBtn.innerHTML = options.action.icon + " " + (options.action.label || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        } else {
          actionBtn.textContent = options.action.label;
        }
        actionBtn.addEventListener("click", () => {
          if (toastTimer) clearTimeout(toastTimer);
          toastTimer = null;
          el.classList.remove("visible");
          options.action.onClick();
        });
        el.appendChild(actionBtn);
      }
      if (options?.persistent) {
        const dismissBtn = document.createElement("button");
        dismissBtn.type = "button";
        dismissBtn.className = "gantt-toast-dismiss" + (options.dismissLabel ? " gantt-toast-dismiss-label" : "");
        dismissBtn.setAttribute("aria-label", options.dismissLabel || "Dismiss");
        dismissBtn.textContent = options.dismissLabel || "×";
        dismissBtn.addEventListener("click", () => {
          el.classList.remove("visible");
          if (typeof options?.onDismiss === "function") options.onDismiss();
        });
        el.appendChild(dismissBtn);
      }
      el.classList.add("visible");
      if (!options?.persistent) {
        toastTimer = setTimeout(() => {
          el.classList.remove("visible");
          toastTimer = null;
        }, 2500);
      }
    }
    function openSettingsToTasksTab() {
      if (typeof openSettingsModal !== "function") return;
      openSettingsModal();
      var tabsBoard = document.getElementById("settingsTabsBoard");
      var tasksTab = tabsBoard ? tabsBoard.querySelector('.settings-tab[data-tab="tasks"]') : null;
      var tasksPanel = document.getElementById("settingsTabTasks");
      if (tasksTab) {
        document.querySelectorAll(".settings-tab").forEach(function (t) { t.classList.remove("active"); });
        document.querySelectorAll(".settings-tab-panel").forEach(function (p) { p.classList.remove("active"); });
        tasksTab.classList.add("active");
        if (tasksPanel) tasksPanel.classList.add("active");
        if (typeof updateAutoPopulateSectionVisibility === "function") updateAutoPopulateSectionVisibility();
      }
    }
    var LINK_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
    function showLinkedTasksToast() {
      const s = loadProjectSettings() || {};
      if (s.linkedTasksToastSeen) return;
      const line1 = 'Linked tasks move with the parent by default.';
      const line2 = 'You can allow independent dates in Settings.';
      const msg = '<div class="gantt-toast-message-wrap"><span class="gantt-toast-icon">' + LINK_ICON_SVG + '</span><div class="gantt-toast-message"><span class="gantt-toast-line1">' + line1 + '</span><span class="gantt-toast-hint">' + line2 + '</span></div></div>';
      const el = document.getElementById("ganttToast");
      if (!el || typeof showToast !== "function") return;
      const projectId = currentProjectId;
      function markSeen() {
        const settings = loadProjectSettings() || {};
        if (projectId && !settings.linkedTasksToastSeen) {
          saveProjectSettings({ ...settings, linkedTasksToastSeen: true });
        }
      }
      showToast(msg, {
        persistent: true,
        dismissLabel: "Got it",
        action: {
          label: 'Settings',
          secondary: true,
          onClick: function () { markSeen(); if (typeof openSettingsToTasksTab === "function") openSettingsToTasksTab(); }
        },
        onDismiss: markSeen
      });
    }

    function dateToOffset(date) {
      return (date - WEEK_START) / WEEK_MS;
    }

    function offsetToDate(offset) {
      return new Date(WEEK_START.getTime() + offset * WEEK_MS);
    }

    const SPRINT_DAYS = 14;
    const SNAP_THRESHOLD_DAYS = 2;
    const DAY_MS = 24 * 60 * 60 * 1000;

    function getSprintSnapBase() {
      const base = getProjectStartDate() || WEEK_START;
      return new Date(base.getFullYear(), base.getMonth(), base.getDate());
    }

    function wouldSnapToSprint(date) {
      const s = loadProjectSettings();
      const snapEnabled = s == null ? true : !!s.snapToSprint;
      if (!snapEnabled || !date) return false;
      const base = getSprintSnapBase();
      const baseMs = base.getTime();
      const dateMs = date.getTime();
      const daysFromBase = (dateMs - baseMs) / DAY_MS;
      for (let n = -1; n <= Math.ceil(daysFromBase / SPRINT_DAYS) + 1; n++) {
        const sprintStartMs = baseMs + n * SPRINT_DAYS * DAY_MS;
        const sprintEndMs = sprintStartMs + (SPRINT_DAYS - 1) * DAY_MS;
        const distStart = Math.abs(dateMs - sprintStartMs) / DAY_MS;
        const distEnd = Math.abs(dateMs - sprintEndMs) / DAY_MS;
        if (distStart <= SNAP_THRESHOLD_DAYS || distEnd <= SNAP_THRESHOLD_DAYS) {
          return true;
        }
      }
      return false;
    }

    function getSprintBoundaryInfo(date) {
      const s = loadProjectSettings();
      const snapEnabled = s == null ? true : !!s.snapToSprint;
      if (!snapEnabled || !date) return null;
      const base = getSprintSnapBase();
      const baseMs = base.getTime();
      const dateMs = date.getTime();
      const daysFromBase = (dateMs - baseMs) / DAY_MS;
      let bestBoundary = null;
      let bestDist = SNAP_THRESHOLD_DAYS + 1;
      let bestType = null;
      for (let n = -1; n <= Math.ceil(daysFromBase / SPRINT_DAYS) + 1; n++) {
        const sprintStartMs = baseMs + n * SPRINT_DAYS * DAY_MS;
        const sprintEndMs = sprintStartMs + (SPRINT_DAYS - 1) * DAY_MS;
        const distStart = Math.abs(dateMs - sprintStartMs) / DAY_MS;
        const distEnd = Math.abs(dateMs - sprintEndMs) / DAY_MS;
        if (distStart <= SNAP_THRESHOLD_DAYS && distStart < bestDist) {
          bestDist = distStart;
          bestBoundary = sprintStartMs;
          bestType = "start";
        }
        if (distEnd <= SNAP_THRESHOLD_DAYS && distEnd < bestDist) {
          bestDist = distEnd;
          bestBoundary = sprintEndMs;
          bestType = "end";
        }
      }
      if (bestBoundary != null) {
        return { date: new Date(bestBoundary), type: bestType };
      }
      return null;
    }

    function snapDateToSprint(date) {
      const info = getSprintBoundaryInfo(date);
      return info ? info.date : date;
    }

    function getFixedPhaseTotalWeeks() {
      const s = loadProjectSettings();
      if (s?.phaseDurationMode === "dynamic") return null;
      return PHASES.reduce((sum, p) => sum + (Math.max(1, parseInt(p.sprints, 10) || 2) * 2), 0);
    }

    function computeChartRange() {
      const fixedStart = getProjectStartDate();
      const fixedPhaseWeeks = getFixedPhaseTotalWeeks();
      let minDate = null, maxDate = null;
      tasks.forEach(t => {
        if (t.startDate) minDate = minDate ? new Date(Math.min(minDate.getTime(), t.startDate.getTime())) : new Date(t.startDate);
        if (t.endDate) maxDate = maxDate ? new Date(Math.max(maxDate.getTime(), t.endDate.getTime())) : new Date(t.endDate);
      });
      if (!minDate && !maxDate && !fixedStart) {
        const today = new Date();
        WEEK_START = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        WEEK_START.setDate(WEEK_START.getDate() - WEEK_START.getDay());
        WEEKS = fixedPhaseWeeks != null ? Math.max(8, fixedPhaseWeeks) : 8;
        return;
      }
      const end = maxDate || minDate || fixedStart;
      let weekStart;
      if (fixedStart) {
        const anchor = new Date(fixedStart.getFullYear(), fixedStart.getMonth(), fixedStart.getDate());
        weekStart = new Date(anchor);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      } else {
        // Default: anchor to current week so moving the default task doesn't shift the chart
        const today = new Date();
        weekStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        // Extend chart left only if a task is earlier than current week so it stays visible
        if (minDate && minDate.getTime() < weekStart.getTime()) {
          const earlier = new Date(minDate);
          earlier.setDate(earlier.getDate() - earlier.getDay());
          weekStart = earlier;
        }
      }
      WEEK_START = weekStart;
      const projectStart = getProjectStartDate();
      if (projectStart) {
        const projectStartOfDay = new Date(projectStart.getFullYear(), projectStart.getMonth(), projectStart.getDate());
        const chartStartMs = WEEK_START.getTime();
        if (chartStartMs < projectStartOfDay.getTime()) {
          WEEK_START = new Date(projectStartOfDay);
          WEEK_START.setDate(WEEK_START.getDate() - WEEK_START.getDay());
        }
      }
      if (fixedPhaseWeeks != null) {
        WEEKS = Math.max(8, fixedPhaseWeeks);
      } else {
        const weeksNeeded = Math.floor((end - WEEK_START) / WEEK_MS) + 1;
        WEEKS = Math.max(8, weeksNeeded);
      }
      const fixedEnd = getProjectEndDate();
      if (fixedEnd) {
        const weeksToFixedEnd = Math.ceil((fixedEnd.getTime() - WEEK_START.getTime()) / WEEK_MS);
        if (weeksToFixedEnd > 0 && weeksToFixedEnd < WEEKS) WEEKS = Math.max(8, weeksToFixedEnd);
      }
    }

    let grid;
    let addedPlaceholderThisSession = false;

    function getPhaseColor(phaseId) {
      const p = PHASES.find(x => x.id === phaseId);
      return (p && p.color) || (PHASES[0] && PHASES[0]?.color) || "#737373";
    }
    function hexToRgba(hex, alpha) {
      const n = parseInt(hex.slice(1), 16);
      const r = (n >> 16) & 255, g = (n >> 8) & 255, b = n & 255;
      return "rgba(" + r + "," + g + "," + b + "," + alpha + ")";
    }
    function applyPaletteSwatchStyle(span, hex, strokeMode) {
      if (strokeMode) {
        span.style.background = hexToRgba(hex, 0.16);
        span.style.border = "1px solid " + hex;
      } else {
        span.style.background = hex;
        span.style.border = "none";
      }
    }
    function updatePaletteSwatchPreviews() {
      const strokePreview = document.querySelector("#settingsBarStyle .settings-segmented-option[data-value='stroke']")?.classList.contains("selected");
      document.querySelectorAll(".settings-palette-option").forEach(opt => {
        let colors = [];
        try { colors = JSON.parse(opt.dataset.colors || "[]"); } catch (e) {}
        const swatches = opt.querySelectorAll(".settings-palette-swatches span");
        colors.forEach((c, i) => { if (swatches[i]) applyPaletteSwatchStyle(swatches[i], c, strokePreview); });
      });
      const triggerSwatches = document.getElementById("settingsPaletteTriggerSwatches");
      const selectedOpt = document.querySelector(".settings-palette-option.selected");
      if (triggerSwatches && selectedOpt) {
        let colors = [];
        try { colors = JSON.parse(selectedOpt.dataset.colors || "[]"); } catch (e) {}
        triggerSwatches.innerHTML = "";
        colors.forEach(c => {
          const span = document.createElement("span");
          applyPaletteSwatchStyle(span, c, strokePreview);
          triggerSwatches.appendChild(span);
        });
      }
    }
    function setBarPhaseStyle(barElement, task) {
      const strokeMode = document.querySelector(".gantt-wrapper")?.getAttribute("data-bar-stroke-mode") === "true";
      const primary = task.phase || PHASES[0]?.id;
      const secondary = task.phaseSecondary && task.phaseSecondary !== primary ? task.phaseSecondary : null;
      const strokeEl = barElement.querySelector(".gantt-bar-stroke");
      const inner = barElement.querySelector(".gantt-bar-inner");
      if (secondary) {
        const c1 = getPhaseColor(primary);
        const c2 = getPhaseColor(secondary);
        if (strokeMode) {
          barElement.style.background = "none";
          barElement.style.border = "none";
          barElement.style.color = "var(--text-primary)";
          if (strokeEl) {
            strokeEl.style.border = "1px solid transparent";
            strokeEl.style.background = "linear-gradient(transparent, transparent) padding-box, linear-gradient(to right, " + c1 + ", " + c2 + ") border-box";
            strokeEl.style.backgroundClip = "padding-box, border-box";
            strokeEl.style.webkitBackgroundClip = "padding-box, border-box";
          }
          if (inner) {
            inner.style.inset = "1px";
            inner.style.borderRadius = "3px";
            inner.style.background = "linear-gradient(to right, " + hexToRgba(c1, 0.16) + ", " + hexToRgba(c2, 0.16) + ")";
          }
        } else {
          barElement.style.background = "linear-gradient(to right, " + c1 + ", " + c2 + ")";
          barElement.style.border = "none";
          barElement.style.color = getContrastColor(c1);
          if (strokeEl) {
            strokeEl.style.border = "";
            strokeEl.style.background = "";
            strokeEl.style.backgroundClip = "";
            strokeEl.style.webkitBackgroundClip = "";
          }
          if (inner) { inner.style.inset = ""; inner.style.borderRadius = ""; inner.style.background = ""; }
        }
      } else {
        const c = getPhaseColor(primary);
        if (strokeMode) {
          barElement.style.background = hexToRgba(c, 0.16);
          barElement.style.border = "1px solid " + c;
          barElement.style.color = "var(--text-primary)";
          if (strokeEl) {
            strokeEl.style.border = "";
            strokeEl.style.background = "";
            strokeEl.style.backgroundClip = "";
            strokeEl.style.webkitBackgroundClip = "";
          }
          if (inner) { inner.style.inset = ""; inner.style.borderRadius = ""; inner.style.background = ""; }
        } else {
          barElement.style.background = c;
          barElement.style.border = "none";
          barElement.style.color = getContrastColor(c);
          if (strokeEl) {
            strokeEl.style.border = "";
            strokeEl.style.background = "";
            strokeEl.style.backgroundClip = "";
            strokeEl.style.webkitBackgroundClip = "";
          }
          if (inner) { inner.style.inset = ""; inner.style.borderRadius = ""; inner.style.background = ""; }
        }
      }
      barElement.dataset.phase = primary;
    }
    const CONNECTOR_CORNER_RADIUS = 10;
    const CONNECTOR_ON_PATH_OFFSET = 14;
    function pointOnConnectorNearParent(parentX, parentY, childX, childY) {
      return { x: parentX, y: parentY + CONNECTOR_ON_PATH_OFFSET };
    }
    function pointOnConnectorNearChild(parentX, parentY, childX, childY) {
      return { x: childX, y: childY };
    }
    /** Point on the connector path between the two bars (e.g. corner or midpoint of a segment). */
    function pointOnConnectorBetween(parentX, parentY, childX, childY) {
      return { x: parentX, y: childY };
    }
    function connectorPathD(x1, y1, x2, y2) {
      const dy = y2 - y1;
      const dx = x2 - x1;
      const goingDown = dy >= 0;
      const goingRight = dx >= 0;
      const absDy = Math.abs(dy);
      const absDx = Math.abs(dx);
      const r = Math.min(CONNECTOR_CORNER_RADIUS, absDy / 2, absDx / 2);
      if (r <= 0) return "M " + x1 + " " + y1 + " L " + x1 + " " + y2 + " L " + x2 + " " + y2;
      if (goingDown) {
        return "M " + x1 + " " + y1 + " L " + x1 + " " + (y2 - r) + " Q " + x1 + " " + y2 + " " + (x1 + (goingRight ? r : -r)) + " " + y2 + " L " + x2 + " " + y2;
      } else {
        return "M " + x1 + " " + y1 + " L " + x1 + " " + (y2 + r) + " Q " + x1 + " " + y2 + " " + (x1 + (goingRight ? r : -r)) + " " + y2 + " L " + x2 + " " + y2;
      }
    }

    let expandedTaskIndex = null;
    let detailEditMode = false;

    function getLinkCardInfo(item) {
      const isUrl = /^https?:\/\//i.test(item);
      const href = isUrl ? item : (JIRA_BASE_URL && /^[A-Z]+-\d+$/i.test(item) ? (JIRA_BASE_URL.replace(/\/$/, "") + "/browse/" + encodeURIComponent(item)) : null);
      if (!href) return { href: null, title: item, shortUrl: "", type: "generic" };
      try {
        const u = new URL(href);
        const host = u.hostname.replace(/^www\./, "");
        if (/figma\.com/i.test(host)) {
          const match = u.pathname.match(/\/design\/[^/]+\/([^/?]+)/);
          const raw = match ? match[1] : "";
          const title = raw ? decodeURIComponent(raw).replace(/-/g, " ").trim() || "Figma Design" : "Figma Design";
          return { href, title, shortUrl: "figma.com", type: "figma" };
        }
        if (/atlassian\.net|jira\./i.test(host) || /^[A-Z]+-\d+$/i.test(item)) {
          const ticketMatch = item.match(/[A-Z]+-\d+/i) || href.match(/\/browse\/([A-Z]+-\d+)/i);
          const title = ticketMatch ? ticketMatch[1] : "Jira";
          return { href, title, shortUrl: host, type: "jira" };
        }
        if (/google\.com/i.test(host)) {
          const title = host === "docs.google.com" ? "Google Docs" : host === "drive.google.com" ? "Google Drive" : "Google";
          return { href, title, shortUrl: host, type: "google" };
        }
        const title = u.pathname && u.pathname !== "/" ? u.pathname.split("/").filter(Boolean).pop().replace(/-/g, " ") : host;
        return { href, title: decodeURIComponent(title).slice(0, 50), shortUrl: host, type: "generic" };
      } catch {
        return { href, title: item.slice(0, 50), shortUrl: "", type: "generic" };
      }
    }

    const FIELD_ICONS = {
      overview: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
      status: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
      tasks: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      subTasks: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      blockers: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
      links: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
      dependsOn: '<svg class="field-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>'
    };

    function collapseDetail(animate) {
      const existing = grid.querySelector(".gantt-detail-row");
      if (!existing) {
        expandedTaskIndex = null;
        grid.querySelectorAll(".gantt-row.expanded").forEach(r => r.classList.remove("expanded"));
        return;
      }
      if (!animate) {
        existing.remove();
        expandedTaskIndex = null;
        grid.querySelectorAll(".gantt-row.expanded").forEach(r => r.classList.remove("expanded"));
        return;
      }
      existing.classList.add("closing");
      existing.addEventListener("animationend", () => {
        existing.remove();
        expandedTaskIndex = null;
        grid.querySelectorAll(".gantt-row.expanded").forEach(r => r.classList.remove("expanded"));
      }, { once: true });
    }

    function expandTaskDetail(index) {
      if (expandedTaskIndex === index) {
        collapseDetail(true);
        return;
      }
      collapseDetail(false);
      const task = tasks[index];
      if (!task) return;
      const row = grid.querySelector('.gantt-row[data-index="' + index + '"]');
      if (!row) return;
      expandedTaskIndex = index;
      detailEditMode = false;
      row.classList.add("expanded");
      const detailRow = document.createElement("div");
      detailRow.className = "gantt-detail-row";
      const inner = document.createElement("div");
      inner.className = "gantt-detail-row-inner";
      detailRow.appendChild(inner);
      renderTaskDetailContent(task, inner, detailRow);
      row.insertAdjacentElement("afterend", detailRow);
      if (window.matchMedia("(max-width: 480px)").matches) {
        row.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    document.addEventListener("keydown", (e) => {
      const inFormControl = e.target.closest("input, select, textarea");
      if (e.key === "z" || e.key === "y") {
        const isUndo = (e.key === "z" && e.shiftKey === false) || (e.key === "y" && e.shiftKey === true);
        const isRedo = (e.key === "z" && e.shiftKey === true) || (e.key === "y" && e.shiftKey === false);
        if ((e.metaKey || e.ctrlKey) && !e.altKey && !inFormControl) {
          if (isUndo) {
            e.preventDefault();
            performUndo();
          } else if (isRedo) {
            e.preventDefault();
            performRedo();
          }
        }
        return;
      }
      if (selectedBarIndex !== null && !inFormControl && e.shiftKey && (e.key === "ArrowUp" || e.key === "ArrowDown")) {
        const from = selectedBarIndex;
        const to = e.key === "ArrowUp" ? from - 1 : from + 1;
        if (to < 0 || to >= tasks.length) return;
        e.preventDefault();
        pushTasksUndo();
        const [moved] = tasks.splice(from, 1);
        tasks.splice(to, 0, moved);
        tasks.forEach((t) => {
          if (typeof t.dependsOn !== "number") return;
          const i = t.dependsOn;
          if (i === from) t.dependsOn = to;
          else if (from < i && i < to) t.dependsOn = i - 1;
          else if (i === to) t.dependsOn = to + 1;
        });
        if (typeof updateChartRange === "function") updateChartRange();
        saveTasks();
        renderTasks();
        const newBar = document.querySelector('.gantt-bar[data-index="' + to + '"]');
        if (newBar && typeof selectBar === "function") selectBar(newBar, to);
        return;
      }
      if (e.key !== "Escape") return;
      let closedDropdown = false;
      document.querySelectorAll(".settings-dependent-wrap.open").forEach(w => {
        w.classList.remove("open");
        const panel = w.querySelector(".settings-dependent-panel");
        if (panel) panel.classList.remove("drop-up");
        const trigger = w.querySelector(".settings-dependent-trigger");
        if (trigger) trigger.setAttribute("aria-expanded", "false");
        closedDropdown = true;
      });
      document.querySelectorAll(".settings-palette-dropdown-wrap.open").forEach(w => {
        w.classList.remove("open");
        const panel = w.querySelector(".settings-palette-panel");
        if (panel) panel.classList.remove("drop-up");
        const trigger = w.querySelector(".settings-palette-trigger");
        if (trigger) trigger.setAttribute("aria-expanded", "false");
        closedDropdown = true;
      });
      document.querySelectorAll(".gantt-auth-user-menu.open").forEach(w => {
        w.classList.remove("open");
        const trigger = w.querySelector(".gantt-auth-user-trigger");
        if (trigger) trigger.setAttribute("aria-expanded", "false");
        closedDropdown = true;
      });
      if (document.querySelector(".gantt-phase-dropdown.open") || document.querySelector(".gantt-party-dropdown.open")) {
        if (typeof closeAllGanttDropdowns === "function") closeAllGanttDropdowns();
        closedDropdown = true;
      }
      if (closedDropdown) {
        e.preventDefault();
        return;
      }
      if (selectedBarElement) {
        e.preventDefault();
        deselectBar();
        return;
      }
      if (expandedTaskIndex !== null) {
        e.preventDefault();
        collapseDetail(true);
      }
    });

    function renderTaskDetailContent(task, container, detailRow) {
      if (!container) {
        const row = grid.querySelector(".gantt-detail-row");
        if (row) {
          container = row.querySelector(".gantt-detail-row-inner");
          detailRow = row;
        }
        if (!container) return;
      }
      container.innerHTML = "";
      const mobileSummary = document.createElement("div");
      mobileSummary.className = "task-detail-mobile-summary";
      const mobileName = document.createElement("span");
      mobileName.className = "task-detail-mobile-summary-name";
      mobileName.textContent = task.task || "Task";
      const mobileHint = document.createElement("span");
      mobileHint.className = "task-detail-mobile-summary-hint";
      mobileHint.textContent = "Tap for details";
      mobileSummary.appendChild(mobileName);
      mobileSummary.appendChild(mobileHint);
      const mobileTooltipEl = document.createElement("div");
      mobileTooltipEl.className = "task-detail-mobile-tooltip";
      function populateMobileTooltip() {
        mobileTooltipEl.innerHTML = "";
        var inner = document.createElement("div");
        inner.className = "gantt-bar-tooltip gantt-bar-tooltip-static";
        inner.setAttribute("role", "tooltip");
        var titleEl = document.createElement("div");
        titleEl.className = "gantt-bar-tooltip-title";
        titleEl.textContent = (task.star ? "\u2605 " : "") + (task.task || "Task");
        inner.appendChild(titleEl);
        var descRow = document.createElement("div");
        descRow.className = "gantt-bar-tooltip-row gantt-bar-tooltip-desc";
        descRow.innerHTML = "<span class=\"gantt-bar-tooltip-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"/><path d=\"M14 2v6h6\"/><path d=\"M16 13H8\"/><path d=\"M16 17H8\"/><path d=\"M10 9H8\"/></svg></span><span class=\"gantt-bar-tooltip-text\"></span>";
        descRow.querySelector(".gantt-bar-tooltip-text").textContent = (task.overview || "").trim() || "\u2014";
        inner.appendChild(descRow);
        var statusRow = document.createElement("div");
        statusRow.className = "gantt-bar-tooltip-row gantt-bar-tooltip-status";
        statusRow.innerHTML = "<span class=\"gantt-bar-tooltip-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 6v6l4 2\"/></svg></span><span class=\"gantt-bar-tooltip-text\"></span>";
        statusRow.querySelector(".gantt-bar-tooltip-text").textContent = task.status || "Not started";
        inner.appendChild(statusRow);
        var partyRow = document.createElement("div");
        partyRow.className = "gantt-bar-tooltip-row gantt-bar-tooltip-party";
        partyRow.innerHTML = "<span class=\"gantt-bar-tooltip-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/></svg></span><span class=\"gantt-bar-tooltip-text\"></span>";
        partyRow.querySelector(".gantt-bar-tooltip-text").textContent = task.party || "";
        if (!task.party) partyRow.style.display = "none";
        inner.appendChild(partyRow);
        var depRow = document.createElement("div");
        depRow.className = "gantt-bar-tooltip-row gantt-bar-tooltip-depends";
        depRow.innerHTML = "<span class=\"gantt-bar-tooltip-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M5 12h14\"/><path d=\"M12 5l7 7-7 7\"/></svg></span><span class=\"gantt-bar-tooltip-text\"></span><span class=\"gantt-bar-tooltip-dep-unlink-wrap\" style=\"display:none\"><button type=\"button\" class=\"gantt-bar-tooltip-dep-unlink\" data-tooltip=\"Unlink\" aria-label=\"Unlink\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71\"/><path d=\"M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71\"/><line x1=\"8\" y1=\"2\" x2=\"8\" y2=\"5\"/><line x1=\"2\" y1=\"8\" x2=\"5\" y2=\"8\"/><line x1=\"16\" y1=\"19\" x2=\"16\" y2=\"22\"/><line x1=\"19\" y1=\"16\" x2=\"22\" y2=\"16\"/></svg></button></span>";
        if (typeof task.dependsOn === "number" && tasks[task.dependsOn]) {
          var primary = tasks[task.dependsOn];
          depRow.querySelector(".gantt-bar-tooltip-text").textContent = "Depends on: " + ((primary.star ? "\u2605 " : "") + (primary.task || "Task"));
          depRow.style.color = typeof getPhaseColor === "function" ? getPhaseColor(primary.phase || (typeof PHASES !== "undefined" && PHASES[0] ? PHASES[0].id : "")) : "";
          var depUnlinkWrap = depRow.querySelector(".gantt-bar-tooltip-dep-unlink-wrap");
          var depUnlinkBtn = depRow.querySelector(".gantt-bar-tooltip-dep-unlink");
          if (depUnlinkWrap) depUnlinkWrap.style.display = "";
          if (depUnlinkBtn) {
            depUnlinkBtn.onclick = function (e) {
              e.stopPropagation();
              var parentIdx = task.dependsOn;
              var p = parentIdx !== null && tasks[parentIdx] ? tasks[parentIdx] : null;
              if (!p) return;
              pushTasksUndo();
              task.dependsOn = null;
              saveTasks();
              renderTasks();
              var parentName = (p.star ? "\u2605 " : "") + (p.task || "Task");
              var childName = (task.star ? "\u2605 " : "") + (task.task || "Task");
              showToast("<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71\"/><path d=\"M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71\"/><line x1=\"8\" y1=\"2\" x2=\"8\" y2=\"5\"/><line x1=\"2\" y1=\"8\" x2=\"5\" y2=\"8\"/><line x1=\"16\" y1=\"19\" x2=\"16\" y2=\"22\"/><line x1=\"19\" y1=\"16\" x2=\"22\" y2=\"16\"/></svg> \"" + childName + "\" unlinked from \"" + parentName + "\"", { onUndo: performUndo });
              if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
              populateMobileTooltip();
            };
          }
        } else {
          depRow.style.display = "none";
        }
        inner.appendChild(depRow);
        var datesRow = document.createElement("div");
        datesRow.className = "gantt-bar-tooltip-row gantt-bar-tooltip-dates";
        datesRow.innerHTML = "<span class=\"gantt-bar-tooltip-icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><rect x=\"3\" y=\"4\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><path d=\"M16 2v4\"/><path d=\"M8 2v4\"/><path d=\"M3 10h18\"/></svg></span><span class=\"gantt-bar-tooltip-text\"></span>";
        var datesStr = "";
        if (task.start && task.end) {
          datesStr = task.start === task.end ? task.start : task.start + " \u2013 " + task.end;
          if (task.startDate && task.endDate) {
            var days = Math.ceil((task.endDate - task.startDate) / (24 * 60 * 60 * 1000)) + 1;
            var sprints = Math.ceil(days / 14);
            datesStr += " \u00b7 " + sprints + " sprint" + (sprints !== 1 ? "s" : "");
          }
        }
        datesRow.querySelector(".gantt-bar-tooltip-text").textContent = datesStr;
        if (!datesStr) datesRow.style.display = "none";
        inner.appendChild(datesRow);
        var actionsEl = document.createElement("div");
        actionsEl.className = "gantt-bar-tooltip-actions";
        var moveLabel = document.createElement("label");
        moveLabel.className = "gantt-bar-tooltip-move-label";
        moveLabel.textContent = "Phase";
        actionsEl.appendChild(moveLabel);
        var phaseWrap = document.createElement("div");
        phaseWrap.className = "gantt-bar-tooltip-phase-dropdown";
        var phaseTrigger = document.createElement("div");
        phaseTrigger.className = "gantt-phase-dropdown-trigger";
        phaseTrigger.style.cursor = "default";
        var phaseDot = document.createElement("span");
        phaseDot.className = "phase-dot";
        var primaryId = typeof PHASES !== "undefined" && PHASES.length ? (task.phase || PHASES[0].id) : "";
        var secondaryId = task.phaseSecondary && task.phaseSecondary !== primaryId ? task.phaseSecondary : null;
        phaseDot.style.background = typeof getPhaseColor === "function" ? getPhaseColor(primaryId) : "#737373";
        var phaseLabelSpan = document.createElement("span");
        if (typeof PHASES !== "undefined" && PHASES.length) {
          var pName = PHASES.find(function (p) { return p.id === primaryId; });
          var sName = secondaryId ? (PHASES.find(function (p) { return p.id === secondaryId; })?.name || secondaryId) : null;
          phaseLabelSpan.textContent = sName ? (pName ? pName.name : primaryId) + " \u2192 " + sName : (pName ? pName.name : primaryId);
        } else {
          phaseLabelSpan.textContent = primaryId || "—";
        }
        phaseTrigger.appendChild(phaseDot);
        phaseTrigger.appendChild(phaseLabelSpan);
        phaseWrap.appendChild(phaseTrigger);
        actionsEl.appendChild(phaseWrap);
        inner.appendChild(actionsEl);
        if (typeof getPhaseColor === "function" && primaryId) {
          var hex = getPhaseColor(primaryId);
          if (hex && hex.indexOf("#") === 0) {
            var r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            inner.style.borderColor = "rgba(" + r + "," + g + "," + b + ",0.24)";
          }
        }
        mobileTooltipEl.appendChild(inner);
      }
      mobileSummary.addEventListener("click", function () {
        detailRow.classList.toggle("detail-expanded");
        mobileHint.textContent = detailRow.classList.contains("detail-expanded") ? "Tap to collapse" : "Tap for details";
        if (detailRow.classList.contains("detail-expanded")) populateMobileTooltip();
      });
      container.appendChild(mobileSummary);
      container.appendChild(mobileTooltipEl);
      populateMobileTooltip();
      const toolbar = document.createElement("div");
      toolbar.className = "task-detail-toolbar";
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "task-detail-edit-btn";
      editBtn.textContent = "Edit";
      const doneBtn = document.createElement("button");
      doneBtn.type = "button";
      doneBtn.className = "task-detail-done-btn";
      doneBtn.textContent = "Done";
      const contentArea = document.createElement("div");
      contentArea.className = "task-detail-content";

      function showView() {
        detailEditMode = false;
        editBtn.style.display = "";
        doneBtn.style.display = "none";
        contentArea.style.opacity = "0";
        setTimeout(() => {
          contentArea.innerHTML = "";
          renderTaskDetailView(task, contentArea);
          contentArea.style.opacity = "1";
        }, 150);
      }
      function showEdit() {
        detailEditMode = true;
        editBtn.style.display = "none";
        doneBtn.style.display = "";
        contentArea.style.opacity = "0";
        setTimeout(() => {
          contentArea.innerHTML = "";
          renderTaskDetailForm(task, contentArea);
          contentArea.style.opacity = "1";
        }, 150);
      }

      editBtn.addEventListener("click", showEdit);
      doneBtn.addEventListener("click", showView);
      toolbar.appendChild(editBtn);
      toolbar.appendChild(doneBtn);
      detailRow.appendChild(toolbar);
      var floatingActions = document.createElement("div");
      floatingActions.className = "task-detail-mobile-floating-actions";
      var floatingPhase = document.createElement("div");
      floatingPhase.className = "task-detail-floating-phase";
      var floatingPhaseDot = document.createElement("span");
      floatingPhaseDot.className = "task-detail-floating-phase-dot";
      var phaseId = typeof PHASES !== "undefined" && PHASES.length ? (task.phase || PHASES[0].id) : "";
      floatingPhaseDot.style.background = typeof getPhaseColor === "function" ? getPhaseColor(phaseId) : "#737373";
      var phaseName = typeof PHASES !== "undefined" && PHASES.length ? (PHASES.find(function (p) { return p.id === phaseId; })?.name || phaseId) : phaseId;
      floatingPhase.appendChild(floatingPhaseDot);
      floatingPhase.appendChild(document.createTextNode(phaseName || "—"));
      floatingActions.appendChild(floatingPhase);
      var floatingBtns = document.createElement("div");
      floatingBtns.className = "task-detail-floating-actions-btns";
      function triggerRowButton(className) {
        var row = grid.querySelector(".gantt-row.expanded");
        if (row) {
          var btn = row.querySelector(className);
          if (btn) btn.click();
        }
      }
      var renameSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>';
      var duplicateSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      var deleteSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
      var editFloatingBtn = document.createElement("button");
      editFloatingBtn.type = "button";
      editFloatingBtn.className = "task-detail-floating-btn";
      editFloatingBtn.title = "Rename";
      editFloatingBtn.innerHTML = renameSvg;
      editFloatingBtn.addEventListener("click", function () { triggerRowButton(".task-rename-btn"); });
      var dupFloatingBtn = document.createElement("button");
      dupFloatingBtn.type = "button";
      dupFloatingBtn.className = "task-detail-floating-btn";
      dupFloatingBtn.title = "Duplicate";
      dupFloatingBtn.innerHTML = duplicateSvg;
      dupFloatingBtn.addEventListener("click", function () { triggerRowButton(".gantt-duplicate-btn"); });
      var delFloatingBtn = document.createElement("button");
      delFloatingBtn.type = "button";
      delFloatingBtn.className = "task-detail-floating-btn";
      delFloatingBtn.title = "Delete";
      delFloatingBtn.innerHTML = deleteSvg;
      delFloatingBtn.addEventListener("click", function () { triggerRowButton(".gantt-delete-btn"); });
      floatingBtns.appendChild(editFloatingBtn);
      floatingBtns.appendChild(dupFloatingBtn);
      floatingBtns.appendChild(delFloatingBtn);
      floatingActions.appendChild(floatingBtns);
      detailRow.appendChild(floatingActions);
      container.appendChild(contentArea);
      if (detailEditMode) {
        editBtn.style.display = "none";
        doneBtn.style.display = "";
        renderTaskDetailForm(task, contentArea);
      } else {
        doneBtn.style.display = "none";
        renderTaskDetailView(task, contentArea);
      }
    }

    function renderTaskDetailView(task, container) {
      container.innerHTML = "";
      const currentIdx = tasks.indexOf(task);
      const dependents = tasks.map((t, idx) => ({ task: t, idx })).filter(({ task: t }) => typeof t.dependsOn === "number" && t.dependsOn === currentIdx);
      const hasDependents = dependents.length > 0;
      const depFields = [
        { key: "dependsOn", label: "Depends on", type: "dependsOn" },
        { key: "dependents", label: "Dependents", type: "dependents", dependents }
      ];
      const fields = [
        { key: "overview", label: "Overview / Description", type: "textarea" },
        ...(hasDependents ? depFields.slice().reverse() : depFields),
        { key: "subTasks", label: "Tasks", type: "list" },
        { key: "links", label: "Links", type: "list" }
      ];
      fields.forEach((f, i) => {
        const field = document.createElement("div");
        field.className = "task-detail-field" + (f.type === "dependsOn" ? " task-detail-field-depends-on" : "");
        field.innerHTML = "<label>" + (FIELD_ICONS[f.key] || FIELD_ICONS.dependsOn) + "<span>" + f.label + "</span></label>";
        const value = document.createElement("div");
        value.className = "task-detail-view-value";
        if (f.type === "dependsOn") {
          const idx = task.dependsOn;
          if (typeof idx !== "number" || !tasks[idx]) {
            value.textContent = "—";
            value.classList.add("empty");
          } else {
            const t = tasks[idx];
            value.textContent = (t.star ? "★ " : "") + (t.task || "Task " + (idx + 1));
          }
        } else if (f.type === "dependents") {
          const list = f.dependents || [];
          if (list.length === 0) {
            value.textContent = "No dependent tasks";
            value.classList.add("empty");
          } else {
            const wrap = document.createElement("div");
            wrap.className = "task-detail-dependents-list";
            list.forEach(({ task: depTask }) => {
              const span = document.createElement("span");
              span.className = "task-detail-dependent-item task-detail-dependent-item-view";
              span.textContent = (depTask.star ? "★ " : "") + (depTask.task || "Task");
              wrap.appendChild(span);
            });
            value.appendChild(wrap);
          }
        } else if (f.type === "text" || f.type === "textarea") {
          const v = (task[f.key] || "").trim();
          if (!v) {
            value.textContent = "—";
            value.classList.add("empty");
          } else {
            value.textContent = v;
          }
        } else {
          const arr = task[f.key] || [];
          if (arr.length === 0) {
            value.textContent = "—";
            value.classList.add("empty");
          } else {
            if (f.key === "links") {
              const cardsWrap = document.createElement("div");
              cardsWrap.className = "task-detail-link-cards";
              arr.filter(Boolean).forEach(item => {
                const info = getLinkCardInfo(item);
                if (!info.href) {
                  const fallback = document.createElement("div");
                  fallback.className = "task-detail-view-value";
                  fallback.textContent = item;
                  cardsWrap.appendChild(fallback);
                  return;
                }
                const a = document.createElement("a");
                a.href = info.href;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.className = "task-detail-link-card";
                const icon = document.createElement("div");
                icon.className = "task-detail-link-card-icon " + info.type;
                if (info.type === "figma") {
                  const img = document.createElement("img");
                  img.src = "https://upload.wikimedia.org/wikipedia/commons/3/33/Figma-logo.svg";
                  img.alt = "Figma";
                  img.width = 18;
                  img.height = 27;
                  img.style.objectFit = "contain";
                  icon.appendChild(img);
                }
                else if (info.type === "jira") icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11.571 11.513H0a5.218 5.218 0 0 0 5.232 5.215h2.13v2.057A5.215 5.215 0 0 0 12.575 24V12.518a1.005 1.005 0 0 0-1.005-1.005zm5.723-5.756H5.736a5.215 5.215 0 0 0 5.215 5.214h2.129v2.058a5.218 5.218 0 0 0 5.215 5.214h2.016V6.758a1.001 1.001 0 0 0-1.001-1.001zM23.013 0H11.455a5.215 5.215 0 0 0 5.215 5.215h2.129v2.057a5.215 5.215 0 0 0 5.215 5.215h2.016V1.005A1.001 1.001 0 0 0 23.013 0z"/></svg>';
                else if (info.type === "google") icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>';
                else icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
                const content = document.createElement("div");
                content.className = "task-detail-link-card-content";
                const titleEl = document.createElement("div");
                titleEl.className = "task-detail-link-card-title";
                titleEl.textContent = info.title;
                const urlEl = document.createElement("div");
                urlEl.className = "task-detail-link-card-url";
                urlEl.textContent = info.shortUrl || item;
                content.appendChild(titleEl);
                content.appendChild(urlEl);
                const arrow = document.createElement("span");
                arrow.className = "task-detail-link-card-arrow";
                arrow.textContent = "→";
                a.appendChild(icon);
                a.appendChild(content);
                a.appendChild(arrow);
                cardsWrap.appendChild(a);
              });
              value.appendChild(cardsWrap);
            } else {
              const ul = document.createElement("ul");
              ul.className = "task-detail-view-list";
              arr.filter(Boolean).forEach(item => {
                const li = document.createElement("li");
                li.textContent = item;
                ul.appendChild(li);
              });
              value.appendChild(ul);
            }
          }
        }
        field.appendChild(value);
        container.appendChild(field);
      });
    }

    function renderListField(container, items, task, key, placeholder, onRerender) {
      container.innerHTML = "";
      const ul = document.createElement("ul");
      ul.className = "task-detail-list";
      (items || []).forEach((item, i) => {
        const li = document.createElement("li");
        const wrap = document.createElement("div");
        wrap.className = "task-detail-list-input-wrap";
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = typeof item === "string" ? item : "";
        inp.placeholder = placeholder;
        inp.addEventListener("change", () => {
          task[key] = task[key] || [];
          task[key][i] = inp.value.trim();
          task[key] = task[key].filter(Boolean);
          saveTasks();
        });
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "task-detail-list-remove";
        removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
        removeBtn.title = "Remove";
        removeBtn.addEventListener("click", () => {
          task[key] = (task[key] || []).filter((_, j) => j !== i);
          if (onRerender) onRerender();
          saveTasks();
        });
        wrap.appendChild(inp);
        wrap.appendChild(removeBtn);
        li.appendChild(wrap);
        ul.appendChild(li);
      });
      container.appendChild(ul);
      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "task-detail-add-btn";
      addBtn.textContent = "+ Add";
      addBtn.addEventListener("click", () => {
        task[key] = task[key] || [];
        task[key].push("");
        if (onRerender) onRerender();
        saveTasks();
      });
      container.appendChild(addBtn);
    }

    function renderTaskDetailForm(task, container) {
      if (!container) {
        const detailRow = grid.querySelector(".gantt-detail-row");
        if (detailRow) container = detailRow.querySelector(".task-detail-content");
        if (!container) return;
      }
      container.innerHTML = "";
      const rerender = () => renderTaskDetailForm(task, container);

      const overviewField = document.createElement("div");
      overviewField.className = "task-detail-field";
      overviewField.innerHTML = '<label>' + FIELD_ICONS.overview + '<span>Overview / Description</span></label>';
      const overviewInput = document.createElement("textarea");
      overviewInput.placeholder = "Describe the task, goals, and context...";
      overviewInput.value = task.overview || "";
      overviewInput.addEventListener("change", () => { task.overview = overviewInput.value; saveTasks(); });
      overviewField.appendChild(overviewInput);
      container.appendChild(overviewField);

      const statusField = document.createElement("div");
      statusField.className = "task-detail-field";
      statusField.innerHTML = '<label>' + FIELD_ICONS.status + '<span>Status</span></label>';
      const statusDetailSelect = document.createElement("select");
      ["Not started", "In progress", "Done", "Blocked"].forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if ((task.status || "Not started") === opt) o.selected = true;
        statusDetailSelect.appendChild(o);
      });
      statusDetailSelect.addEventListener("change", () => {
        task.status = statusDetailSelect.value;
        saveTasks();
        const statusWrap = detailRow?.previousElementSibling?.querySelector(".gantt-status-cell .gantt-party-dropdown");
        if (statusWrap) {
          const label = statusWrap.querySelector(".gantt-party-dropdown-trigger span");
          if (label) label.textContent = task.status;
          statusWrap.querySelectorAll(".gantt-party-dropdown-option").forEach(o => {
            o.classList.toggle("selected", o.textContent === task.status);
          });
        }
        if (typeof updateChartRange === "function") updateChartRange();
      });
      statusField.appendChild(statusDetailSelect);
      container.appendChild(statusField);

      const dependsOnField = document.createElement("div");
      dependsOnField.className = "task-detail-field task-detail-field-depends-on";
      dependsOnField.innerHTML = '<label>' + FIELD_ICONS.dependsOn + '<span>Depends on</span></label>';
      const dependsOnSelect = document.createElement("select");
      dependsOnSelect.className = "task-detail-depends-on";
      const currentIdx = tasks.indexOf(task);
      const optNone = document.createElement("option");
      optNone.value = "";
      optNone.textContent = "— No dependency";
      dependsOnSelect.appendChild(optNone);
      tasks.forEach((t, idx) => {
        if (idx === currentIdx) return;
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = (t.star ? "★ " : "") + (t.task || "Task " + (idx + 1));
        if (task.dependsOn === idx) opt.selected = true;
        dependsOnSelect.appendChild(opt);
      });
      dependsOnSelect.addEventListener("change", () => {
        const v = dependsOnSelect.value;
        const oldParentIdx = task.dependsOn;
        const wasLinked = oldParentIdx !== null;
        pushTasksUndo();
        task.dependsOn = v === "" ? null : parseInt(v, 10);
        const taskName = (task.star ? "★ " : "") + (task.task || "Task");
        if (task.dependsOn !== null) {
          const parentTask = tasks[task.dependsOn];
          const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
          propagateDependencyChanges(task.dependsOn);
          showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${taskName}" → "${parentName}"`, { onUndo: performUndo });
          if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
        } else if (wasLinked && tasks[oldParentIdx]) {
          const oldParentTask = tasks[oldParentIdx];
          const oldParentName = (oldParentTask.star ? "★ " : "") + (oldParentTask.task || "Task");
          showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${taskName}" unlinked from "${oldParentName}"`, { onUndo: performUndo });
        }
        if (typeof updateChartRange === "function") updateChartRange();
        saveTasks();
        if (rerender) rerender();
      });
      dependsOnField.appendChild(dependsOnSelect);
      container.appendChild(dependsOnField);

      const dependentsField = document.createElement("div");
      dependentsField.className = "task-detail-field";
      dependentsField.innerHTML = '<label>' + FIELD_ICONS.dependsOn + '<span>Dependents</span></label>';
      const dependentsList = document.createElement("div");
      dependentsList.className = "task-detail-dependents-list";
      const dependents = tasks.map((t, idx) => ({ task: t, idx })).filter(({ task: t }) => typeof t.dependsOn === "number" && t.dependsOn === currentIdx);
      if (dependents.length === 0) {
        const empty = document.createElement("div");
        empty.className = "task-detail-view-value empty";
        empty.textContent = "No dependent tasks";
        dependentsList.appendChild(empty);
      } else {
        dependents.forEach(({ task: depTask, idx: depIdx }) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "task-detail-dependent-item";
          btn.textContent = (depTask.star ? "★ " : "") + (depTask.task || "Task " + (depIdx + 1));
          btn.addEventListener("click", () => {
            const bar = document.querySelector('.gantt-bar[data-index="' + depIdx + '"]');
            if (bar && typeof selectBar === "function") selectBar(bar, depIdx);
          });
          dependentsList.appendChild(btn);
        });
      }
      dependentsField.appendChild(dependentsList);
      container.appendChild(dependentsField);

      const tasksField = document.createElement("div");
      tasksField.className = "task-detail-field";
      tasksField.innerHTML = '<label>' + FIELD_ICONS.tasks + '<span>Tasks</span></label>';
      const tasksList = document.createElement("div");
      renderListField(tasksList, task.subTasks, task, "subTasks", "Sub-task or checklist item", rerender);
      tasksField.appendChild(tasksList);
      container.appendChild(tasksField);

      const linksField = document.createElement("div");
      linksField.className = "task-detail-field";
      linksField.innerHTML = '<label>' + FIELD_ICONS.links + '<span>Links</span></label>';
      const linksList = document.createElement("div");
      renderListField(linksList, task.links, task, "links", "Jira ticket, Figma URL, or other link", rerender);
      linksField.appendChild(linksList);
      container.appendChild(linksField);
    }

    function getContrastColor(hex) {
      const h = hex.replace("#", "");
      const r = parseInt(h.substr(0, 2), 16) / 255;
      const g = parseInt(h.substr(2, 2), 16) / 255;
      const b = parseInt(h.substr(4, 2), 16) / 255;
      const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
      return luminance < 0.5 ? "#ffffff" : "#1a1a1a";
    }

    function deselectBar() {
      document.querySelectorAll(".gantt-bar.bar-family").forEach((b) => b.classList.remove("bar-family"));
      if (selectedBarElement) {
        if (selectedBarElement._selectionDurationHint) {
          selectedBarElement._selectionDurationHint.remove();
          selectedBarElement._selectionDurationHint = null;
        }
        selectedBarElement.classList.remove("selected");
        selectedBarElement = null;
      }
      selectedBarIndex = null;
      const phaseWrap = document.getElementById("ganttBarTooltipPhaseDropdown")?.firstElementChild;
      if (phaseWrap?._tooltipList?.parentNode) {
        phaseWrap._tooltipList.remove();
        phaseWrap.classList.remove("open");
      }
      const tooltipEl = document.getElementById("ganttBarTooltip");
      const actionsEl = document.getElementById("ganttBarTooltipActions");
      if (tooltipEl) {
        tooltipEl.classList.remove("visible", "has-actions");
        tooltipEl.style.borderColor = "";
      }
      if (actionsEl) actionsEl.style.display = "none";
      if (selectedBarClickOutside) {
        document.removeEventListener("click", selectedBarClickOutside);
        selectedBarClickOutside = null;
      }
      const depLineEl = document.getElementById("ganttDependencyLine");
      if (depLineEl) depLineEl.classList.remove("visible");
      const mainUnlinkBtn = document.getElementById("ganttDependencyUnlinkBtn");
      if (mainUnlinkBtn) {
        mainUnlinkBtn.classList.remove("visible");
        mainUnlinkBtn.style.pointerEvents = "none";
      }
      if (selectedBarDepLineCleanup) {
        selectedBarDepLineCleanup();
        selectedBarDepLineCleanup = null;
      }
      const childContainer = document.getElementById("ganttChildConnectorsContainer");
      if (childContainer) childContainer.innerHTML = "";
      grid?.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(r => { r.draggable = typeof window.hasWriteAccess !== "function" || window.hasWriteAccess(); });
    }

    function populateTooltipForBar(tooltipEl, task, index) {
      if (!tooltipEl || !task) return;
      const titleEl = tooltipEl.querySelector(".gantt-bar-tooltip-title");
      const partyRow = tooltipEl.querySelector(".gantt-bar-tooltip-party");
      const partyText = partyRow?.querySelector(".gantt-bar-tooltip-text");
      const descRow = tooltipEl.querySelector(".gantt-bar-tooltip-desc");
      const descText = descRow?.querySelector(".gantt-bar-tooltip-text");
      const statusRow = tooltipEl.querySelector(".gantt-bar-tooltip-status");
      const statusText = statusRow?.querySelector(".gantt-bar-tooltip-text");
      const datesRow = tooltipEl.querySelector(".gantt-bar-tooltip-dates");
      const datesText = datesRow?.querySelector(".gantt-bar-tooltip-text");
      if (titleEl) titleEl.textContent = (task.star ? "★ " : "") + (task.task || "Task");
      if (statusRow && statusText) statusText.textContent = task.status || "Not started";
      if (partyRow && partyText) {
        partyText.textContent = task.party || "";
        partyRow.style.display = task.party ? "" : "none";
      }
      const depRow = tooltipEl.querySelector(".gantt-bar-tooltip-depends");
      const depText = depRow?.querySelector(".gantt-bar-tooltip-text");
      const depUnlinkWrap = depRow?.querySelector(".gantt-bar-tooltip-dep-unlink-wrap");
      const depUnlinkBtn = depUnlinkWrap?.querySelector(".gantt-bar-tooltip-dep-unlink");
      const depIdx = resolveDependsOnIndex(task.dependsOn);
      if (depRow && depText) {
        if (depIdx !== null && tasks[depIdx]) {
          const primary = tasks[depIdx];
          depText.textContent = "Depends on: " + ((primary.star ? "★ " : "") + (primary.task || "Task"));
          depRow.style.display = "";
          depRow.style.color = getPhaseColor(primary.phase || PHASES[0]?.id);
          if (depUnlinkWrap) depUnlinkWrap.style.display = "";
          if (depUnlinkBtn) {
            depUnlinkBtn.onclick = (e) => {
              e.stopPropagation();
              const t = tasks[index];
              const parentIdx = t ? resolveDependsOnIndex(t.dependsOn) : null;
              const p = parentIdx !== null ? tasks[parentIdx] : null;
              if (!t || !p) return;
              pushTasksUndo();
              t.dependsOn = null;
              saveTasks();
              renderTasks();
              deselectBar();
              const parentName = (p.star ? "★ " : "") + (p.task || "Task");
              const childName = (t.star ? "★ " : "") + (t.task || "Task");
              showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
            };
          }
        } else {
          depRow.style.display = "none";
          depRow.style.color = "";
          if (depUnlinkWrap) depUnlinkWrap.style.display = "none";
          if (depUnlinkBtn) depUnlinkBtn.onclick = null;
        }
      }
      if (descText) descText.textContent = (task.overview || "").trim() || "—";
      if (datesRow && datesText) {
        let datesStr = "";
        if (task.start && task.end) {
          datesStr = task.start === task.end ? task.start : task.start + " – " + task.end;
          if (task.startDate && task.endDate) {
            const days = Math.ceil((task.endDate - task.startDate) / (24 * 60 * 60 * 1000)) + 1;
            const sprints = Math.ceil(days / 14);
            datesStr += " · " + sprints + " sprint" + (sprints !== 1 ? "s" : "");
          }
        }
        datesText.textContent = datesStr;
        datesRow.style.display = datesStr ? "" : "none";
      }
    }

    function getRelatedBarIndices(index) {
      const set = new Set([index]);
      const task = tasks[index];
      const parentIdx = task && typeof task.dependsOn === "number" ? task.dependsOn : null;
      if (parentIdx !== null) set.add(parentIdx);
      tasks.forEach((t, j) => {
        if (typeof t.dependsOn === "number" && t.dependsOn === index) set.add(j);
      });
      return set;
    }

    function attachSingleLineDotHandlers(depLineDot1, depLineDot2, depLinePath, depLinePathHover, primaryIdx, dependentIdx, getCoords, primaryColor) {
      const circle1 = depLineDot1?.querySelector?.("circle") || depLineDot1?.firstElementChild;
      const circle2 = depLineDot2?.querySelector?.("circle") || depLineDot2?.firstElementChild;
      const path = depLinePath;
      const pathHit = depLinePathHover;
      const dotR = 3;
      const addHandlers = (circle, end, dotEl) => {
        const onDown = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const coords = getCoords();
          const { x1, y1, x2, y2 } = coords;
          const fixedX = end === "primary" ? x2 : x1;
          const fixedY = end === "primary" ? y2 : y1;
          const otherX = end === "primary" ? x1 : x2;
          const otherY = end === "primary" ? y1 : y2;
          dotEl.classList.add("connector-dot-dragging");
          path.classList.add("connector-dragging");
          const onMove = (e2) => {
            e2.preventDefault();
            const cx = e2.clientX;
            const cy = e2.clientY;
            dotEl.setAttribute("transform", `translate(${cx}, ${cy - (end === "primary" ? dotR : 0)})`);
            const newD = end === "primary" ? connectorPathD(cx, cy, fixedX, fixedY) : connectorPathD(fixedX, fixedY, cx, cy);
            path.setAttribute("d", newD);
            if (pathHit) pathHit.setAttribute("d", newD);
            const depLineSvg = path.closest("svg");
            const prevSvgPE = depLineSvg ? depLineSvg.style.pointerEvents : "";
            const prevSvgVis = depLineSvg ? depLineSvg.style.visibility : "";
            if (depLineSvg) {
              depLineSvg.style.pointerEvents = "none";
              depLineSvg.style.visibility = "hidden";
            }
            const ganttWrapper = document.querySelector(".gantt-wrapper");
            const prevWrapperPE = ganttWrapper?.style.pointerEvents;
            if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
            const elements = document.elementsFromPoint(cx, cy);
            if (depLineSvg) {
              depLineSvg.style.pointerEvents = prevSvgPE || "";
              depLineSvg.style.visibility = prevSvgVis || "";
            }
            if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
            let hoveredIdx = null;
            for (const el of elements) {
              const row = el.closest?.(".gantt-row[data-index]");
              if (row && !row.classList.contains("gantt-header")) {
                hoveredIdx = parseInt(row.getAttribute("data-index"), 10);
                break;
              }
              const barEl = el.closest?.(".gantt-bar");
              if (barEl) {
                hoveredIdx = parseInt(barEl.getAttribute("data-index"), 10);
                break;
              }
            }
            let previewColor = "#a3a3a3";
            if (hoveredIdx !== null && !isNaN(hoveredIdx)) {
              if (end === "primary" && hoveredIdx !== dependentIdx && !wouldCreateCycle(dependentIdx, hoveredIdx)) {
                previewColor = getPhaseColor(tasks[hoveredIdx].phase || PHASES[0]?.id);
              } else if (end === "dependent" && hoveredIdx !== primaryIdx && !wouldCreateCycle(hoveredIdx, primaryIdx)) {
                previewColor = getPhaseColor(tasks[hoveredIdx].phase || PHASES[0]?.id);
              }
            }
            path.setAttribute("stroke", previewColor);
          };
          const onUp = (e2) => {
            e2.preventDefault();
            e2.stopPropagation();
            document.removeEventListener("mousemove", onMove);
            document.removeEventListener("mouseup", onUp);
            const ganttWrapper = document.querySelector(".gantt-wrapper");
            const prevWrapperPE = ganttWrapper?.style.pointerEvents;
            if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
            const elements = document.elementsFromPoint(e2.clientX, e2.clientY);
            if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
            const overUnlink = elements.some((el) => el.id === "ganttDependencyUnlinkBtn" || el.closest?.("#ganttDependencyUnlinkBtn"));
            if (overUnlink) {
              dotEl.classList.remove("connector-dot-dragging");
              path.classList.remove("connector-dragging");
              const childTask = tasks[dependentIdx];
              const parentTask = tasks[primaryIdx];
              const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
              const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
              pushTasksUndo();
              tasks[dependentIdx].dependsOn = null;
              saveTasks();
              renderTasks();
              showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
              return;
            }
            let newIdx = null;
            for (const el of elements) {
              const row = el.closest?.(".gantt-row[data-index]");
              if (row && !row.classList.contains("gantt-header")) {
                newIdx = parseInt(row.getAttribute("data-index"), 10);
                break;
              }
              const bar = el.closest?.(".gantt-bar");
              if (bar) {
                newIdx = parseInt(bar.getAttribute("data-index"), 10);
                break;
              }
            }
            dotEl.classList.remove("connector-dot-dragging");
            path.classList.remove("connector-dragging");
            let didUpdate = false;
            let toastMessage = "";
            if (newIdx !== null && !isNaN(newIdx)) {
              if (end === "primary" && newIdx !== dependentIdx && !wouldCreateCycle(dependentIdx, newIdx)) {
                pushTasksUndo();
                tasks[dependentIdx].dependsOn = newIdx;
                propagateDependencyChanges(newIdx);
                didUpdate = true;
                const childTask = tasks[dependentIdx];
                const newParentTask = tasks[newIdx];
                const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                const parentName = (newParentTask.star ? "★ " : "") + (newParentTask.task || "Task");
                toastMessage = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`;
              } else if (end === "dependent" && newIdx !== primaryIdx && !wouldCreateCycle(newIdx, primaryIdx)) {
                pushTasksUndo();
                tasks[dependentIdx].dependsOn = null;
                tasks[newIdx].dependsOn = primaryIdx;
                propagateDependencyChanges(primaryIdx);
                didUpdate = true;
                const newChildTask = tasks[newIdx];
                const parentTask = tasks[primaryIdx];
                const childName = (newChildTask.star ? "★ " : "") + (newChildTask.task || "Task");
                const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
                toastMessage = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`;
              }
            }
            if (didUpdate) {
              saveTasks();
              renderTasks();
              if (toastMessage) showToast(toastMessage, { onUndo: performUndo });
              if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
            } else if (path && primaryColor) {
              path.setAttribute("stroke", primaryColor);
            }
          };
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", onUp, { once: true });
          onMove(e);
        };
        circle.addEventListener("mousedown", onDown);
        return () => circle.removeEventListener("mousedown", onDown);
      };
      const off1 = circle1 ? addHandlers(circle1, "primary", depLineDot1) : () => {};
      const off2 = circle2 ? addHandlers(circle2, "dependent", depLineDot2) : () => {};
      return () => { off1(); off2(); };
    }

    function selectBar(bar, index) {
      if (selectedBarIndex === index && selectedBarElement === bar) {
        deselectBar();
        return;
      }
      deselectBar();
      const t = tasks[index];
      if (!t) return;
      const tooltipEl = document.getElementById("ganttBarTooltip");
      const actionsEl = document.getElementById("ganttBarTooltipActions");
      if (!tooltipEl) return;
      selectedBarIndex = index;
      selectedBarElement = bar;
      bar.classList.add("selected");
      grid?.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(r => { r.draggable = false; });
      const related = getRelatedBarIndices(index);
      document.querySelectorAll(".gantt-bar").forEach((b) => {
        const idx = b.getAttribute("data-index");
        if (idx !== null && related.has(parseInt(idx, 10))) b.classList.add("bar-family");
      });
      if (t.startDate && t.endDate) {
        const days = Math.max(1, Math.ceil((t.endDate - t.startDate) / (24 * 60 * 60 * 1000)) + 1);
        const hintEl = document.createElement("span");
        hintEl.className = "gantt-bar-duration-hint";
        hintEl.textContent = days + " day" + (days !== 1 ? "s" : "");
        bar.appendChild(hintEl);
        bar._selectionDurationHint = hintEl;
      }
      const depLineEl = document.getElementById("ganttDependencyLine");
      const depLinePath = document.getElementById("ganttDependencyLinePath");
      const depLinePathHover = document.getElementById("ganttDependencyLinePathHover");
      const depLineDot1 = document.getElementById("ganttDependencyLineDot1");
      const depLineDot2 = document.getElementById("ganttDependencyLineDot2");
      if (typeof t.dependsOn === "number" && tasks[t.dependsOn]) {
        const primaryBar = document.querySelector('.gantt-bar[data-index="' + t.dependsOn + '"]');
        if (primaryBar && depLineEl && depLinePath) {
          const primaryColor = getPhaseColor(tasks[t.dependsOn].phase || PHASES[0]?.id);
          const unlinkBtn = document.getElementById("ganttDependencyUnlinkBtn");
          const updateLine = () => {
            const pr = primaryBar.getBoundingClientRect();
            const dr = bar.getBoundingClientRect();
            const parentX = pr.left + pr.width / 2;
            const parentY = pr.bottom;
            const childX = dr.left;
            const childY = dr.top + dr.height / 2 + 2;
            const pathD = connectorPathD(parentX, parentY, childX, childY);
            depLinePath.setAttribute("d", pathD);
            depLinePath.setAttribute("stroke", primaryColor);
            if (depLinePathHover) depLinePathHover.setAttribute("d", pathD);
            const dotR = 3;
            const ptParent = pointOnConnectorNearParent(parentX, parentY, childX, childY);
            const ptChild = pointOnConnectorNearChild(parentX, parentY, childX, childY);
            const ptOnLine = pointOnConnectorBetween(parentX, parentY, childX, childY);
            if (depLineDot1) { depLineDot1.setAttribute("transform", `translate(${ptParent.x}, ${ptParent.y - dotR})`); }
            if (depLineDot2) { depLineDot2.setAttribute("transform", `translate(${ptChild.x}, ${ptChild.y})`); }
            depLineEl.setAttribute("viewBox", "0 0 " + window.innerWidth + " " + window.innerHeight);
            depLineEl.setAttribute("width", window.innerWidth);
            depLineEl.setAttribute("height", window.innerHeight);
            depLineEl.classList.add("visible");
            if (unlinkBtn) {
              unlinkBtn.style.left = ptOnLine.x + "px";
              unlinkBtn.style.top = ptOnLine.y + "px";
              unlinkBtn.style.backgroundColor = primaryColor;
              unlinkBtn.classList.add("visible");
              unlinkBtn.style.pointerEvents = "auto";
            }
          };
          updateLine();
          if (unlinkBtn && !unlinkBtn._unlinkHandler) {
            const parentTask = tasks[t.dependsOn];
            const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
            const taskName = (t.star ? "★ " : "") + (t.task || "Task");
            const unlinkHandler = () => {
              pushTasksUndo();
              t.dependsOn = null;
              deselectBar();
              saveTasks();
              renderTasks();
              showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${taskName}" unlinked from "${parentName}"`, { onUndo: performUndo });
            };
            unlinkBtn._unlinkHandler = unlinkHandler;
            unlinkBtn.addEventListener("click", unlinkHandler);
          }
          const getCoords = () => {
            const pr = primaryBar.getBoundingClientRect();
            const dr = bar.getBoundingClientRect();
            return { x1: pr.left + pr.width / 2, y1: pr.bottom, x2: dr.left, y2: dr.top + dr.height / 2 + 2 };
          };
          const singleLineDotCleanup = attachSingleLineDotHandlers(depLineDot1, depLineDot2, depLinePath, depLinePathHover, t.dependsOn, index, getCoords, primaryColor);
          const wrapper = document.querySelector(".gantt-wrapper");
          wrapper?.addEventListener("scroll", updateLine, true);
          window.addEventListener("scroll", updateLine, true);
          window.addEventListener("resize", updateLine);
          selectedBarDepLineCleanup = () => {
            singleLineDotCleanup();
            wrapper?.removeEventListener("scroll", updateLine, true);
            window.removeEventListener("scroll", updateLine, true);
            window.removeEventListener("resize", updateLine);
            if (unlinkBtn) {
              unlinkBtn.classList.remove("visible");
              if (unlinkBtn._unlinkHandler) {
                unlinkBtn.removeEventListener("click", unlinkBtn._unlinkHandler);
                unlinkBtn._unlinkHandler = null;
              }
            }
          };
        }
      }
      populateTooltipForBar(tooltipEl, t, index);
      const phaseDropdownContainer = document.getElementById("ganttBarTooltipPhaseDropdown");
      if (phaseDropdownContainer) {
        phaseDropdownContainer.innerHTML = "";
        const phaseDropdown = createTooltipPhaseDropdown(t.phase || PHASES[0]?.id, t.phaseSecondary || null, async (phaseId, isSecondary) => {
          if (isSecondary) {
            t.phaseSecondary = t.phaseSecondary === phaseId ? null : (phaseId === (t.phase || PHASES[0]?.id) ? null : phaseId);
            setBarPhaseStyle(bar, t);
            phaseDropdown._updateLabel(t.phase || PHASES[0]?.id, t.phaseSecondary || null);
            if (phaseDropdown._updateOptionStates) phaseDropdown._updateOptionStates(t.phase || PHASES[0]?.id, t.phaseSecondary || null);
            const rowPhaseWrap = bar.closest(".gantt-row")?.querySelector(".gantt-phase-dropdown-wrap");
            if (rowPhaseWrap && rowPhaseWrap._setPhaseSecondary) rowPhaseWrap._setPhaseSecondary(t.phaseSecondary || null);
            saveTasks();
            return;
          }
          if (!phaseId || !t.startDate || !t.endDate) return;
          const hasTwoPhases = t.phaseSecondary && t.phaseSecondary !== (t.phase || PHASES[0]?.id);
          if (!getAllowIndependentDependencies() && !hasTwoPhases && typeof t.dependsOn === "number" && tasks[t.dependsOn]) {
            const phaseName = PHASES.find(p => p.id === phaseId)?.name || phaseId;
            const parentTask = tasks[t.dependsOn];
            const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
            const taskName = (t.star ? "★ " : "") + (t.task || "Task");
            const msg = `"${taskName.trim() || "This task"}" is linked to "${parentName}". Unlink before moving to ${phaseName}?`;
            const connectorEl = document.getElementById("ganttDependencyLinePath");
            const anchor = (connectorEl && connectorEl.getAttribute("d")) ? connectorEl : phaseDropdown;
            const unlink = await showDetachConfirm(anchor, msg, { showSettingsHint: true });
            if (!unlink) {
              phaseDropdown._updateLabel(t.phase || PHASES[0]?.id, t.phaseSecondary || null);
              return;
            }
            t.dependsOn = null;
          }
          const phaseIdx = PHASES.findIndex(p => p.id === phaseId);
          if (phaseIdx < 0) return;
          const startWeekOffset = getPhaseStartWeekOffset(phaseIdx);
          const durationMs = t.endDate.getTime() - t.startDate.getTime();
          const oldPhase = t.phase;
          t.phase = phaseId;
          t.phaseSecondary = null;
          t.startDate = offsetToDate(startWeekOffset);
          t.endDate = new Date(t.startDate.getTime() + durationMs);
          t.start = formatDate(t.startDate);
          t.end = formatDate(t.endDate);
          setBarPhaseStyle(bar, t);
          const dateCell = bar.closest(".gantt-row")?.querySelector(".gantt-date-cell");
          const startInp = dateCell?.querySelector('.gantt-date-start');
          const endInp = dateCell?.querySelector('.gantt-date-end');
          if (startInp) { startInp.value = t.start; startInp.title = t.startDate ? formatDateFull(t.startDate) : ""; }
          if (endInp) { endInp.value = t.end; endInp.title = t.endDate ? formatDateFull(t.endDate) : ""; }
          const rowPhaseWrap = bar.closest(".gantt-row")?.querySelector(".gantt-phase-dropdown-wrap");
          if (rowPhaseWrap && rowPhaseWrap._updateLabel) rowPhaseWrap._updateLabel(phaseId);
          const so = dateToOffset(t.startDate);
          let eo = dateToOffset(t.endDate);
          if (eo <= so) eo = so + 1 / 7;
          eo = Math.min(WEEKS, eo);
          bar.style.left = (Math.max(0, so) / WEEKS) * 100 + "%";
          bar.style.width = ((eo - Math.max(0, so)) / WEEKS) * 100 + "%";
          // Update child tasks to the same phase (only when not using independent deps)
          if (oldPhase !== phaseId && !getAllowIndependentDependencies()) {
            tasks.forEach((childTask) => {
              if (childTask.dependsOn === index) {
                childTask.phase = phaseId;
              }
            });
            saveTasks();
            renderTasks(); // Refresh to show updated child phases
            return; // Skip additional updates since renderTasks() handles everything
          }
          if (typeof propagateDependencyChanges === "function") propagateDependencyChanges(index);
          if (typeof updateChartRange === "function") updateChartRange();
          saveTasks();
        });
        phaseDropdownContainer.appendChild(phaseDropdown);
      }
      if (actionsEl) actionsEl.style.display = "";
      tooltipEl.style.borderColor = hexToRgba(getPhaseColor(t.phase || PHASES[0]?.id), 0.24);
      tooltipEl.classList.add("has-actions", "visible");
      const rect = bar.getBoundingClientRect();
      tooltipEl.style.left = rect.left + rect.width / 2 + "px";
      tooltipEl.style.transform = "translate(-50%, calc(-100% - 8px))";
      tooltipEl.style.top = rect.top + "px";
      selectedBarClickOutside = (e) => {
        if (bar.contains(e.target) || tooltipEl.contains(e.target)) return;
        if (tooltipEl.contains(document.activeElement)) return;
        if (e.target.closest(".gantt-phase-dropdown-list") || e.target.closest(".gantt-party-dropdown-list")) return;
        const depLineEl = document.getElementById("ganttDependencyLine");
        const childContainer = document.getElementById("ganttChildConnectorsContainer");
        if ((depLineEl && depLineEl.contains(e.target)) || (childContainer && childContainer.contains(e.target))) return;
        deselectBar();
      };
      document.addEventListener("click", selectedBarClickOutside);
      
      // Show connectors to child tasks
      const childTasks = tasks.map((task, idx) => ({ task, idx })).filter(({ task }) => task.dependsOn === index);
      if (childTasks.length > 0) {
        const container = document.getElementById("ganttChildConnectorsContainer");
        if (container) {
          container.innerHTML = ""; // Clear previous child connectors
          const childColor = getPhaseColor(t.phase || PHASES[0]?.id);
          let countBadge = null;
          if (childTasks.length > 1) {
            countBadge = document.createElement("div");
            countBadge.className = "gantt-connector-count-badge";
            countBadge.style.backgroundColor = childColor;
            countBadge.textContent = String(childTasks.length);
            container.appendChild(countBadge);
          }
          
          childTasks.forEach(({ task: childTask, idx: childIdx }) => {
            const childBar = document.querySelector('.gantt-bar[data-index="' + childIdx + '"]');
            if (!childBar) return;
            
            // Create SVG for this child connector
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.classList.add("gantt-dependency-line", "visible");
            svg.style.position = "fixed";
            svg.style.top = "0";
            svg.style.left = "0";
            svg.style.pointerEvents = "auto";
            svg.style.zIndex = "9998";
            
            const pathHover = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathHover.setAttribute("stroke", "transparent");
            pathHover.setAttribute("stroke-width", "12");
            pathHover.setAttribute("fill", "none");
            pathHover.style.pointerEvents = "stroke";
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("stroke", childColor);
            path.setAttribute("stroke-width", "1");
            path.setAttribute("stroke-dasharray", "4 3");
            path.setAttribute("fill", "none");
            path.style.pointerEvents = "none";
            
            const dot1 = document.createElementNS("http://www.w3.org/2000/svg", "g");
            dot1.setAttribute("class", "connector-dot");
            const dot1Circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot1Circle.setAttribute("r", "3");
            dot1Circle.setAttribute("fill", "white");
            dot1Circle.setAttribute("stroke", "#d4d4d4");
            dot1Circle.setAttribute("stroke-width", "1");
            dot1.appendChild(dot1Circle);
            dot1.style.pointerEvents = "none";
            
            const dot2 = document.createElementNS("http://www.w3.org/2000/svg", "g");
            dot2.setAttribute("class", "connector-dot");
            const dot2Circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot2Circle.setAttribute("r", "3");
            dot2Circle.setAttribute("fill", "white");
            dot2Circle.setAttribute("stroke", "#d4d4d4");
            dot2Circle.setAttribute("stroke-width", "1");
            dot2.appendChild(dot2Circle);
            dot2.style.pointerEvents = "none";
            
            svg.appendChild(pathHover);
            svg.appendChild(path);
            svg.appendChild(dot1);
            svg.appendChild(dot2);
            container.appendChild(svg);
            
            // Create unlink button for this child
            const unlinkBtn = document.createElement("button");
            unlinkBtn.className = "gantt-dependency-unlink-btn visible";
            unlinkBtn.type = "button";
            unlinkBtn.title = "Unlink tasks";
            unlinkBtn.style.backgroundColor = childColor;
            unlinkBtn.style.pointerEvents = "auto";
            unlinkBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/>
              <path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/>
              <line x1="8" y1="2" x2="8" y2="5"/>
              <line x1="2" y1="8" x2="5" y2="8"/>
              <line x1="16" y1="19" x2="16" y2="22"/>
              <line x1="19" y1="16" x2="22" y2="16"/>
            </svg>`;
            container.appendChild(unlinkBtn);
            
            const updateChildLine = () => {
              const pr = bar.getBoundingClientRect();
              const cr = childBar.getBoundingClientRect();
              const parentX = pr.left + pr.width / 2;
              const parentY = pr.bottom;
              const childX = cr.left;
              const childY = cr.top + cr.height / 2 + 2;
              const pathD = connectorPathD(parentX, parentY, childX, childY);
              path.setAttribute("d", pathD);
              pathHover.setAttribute("d", pathD);
              const dotR = 3;
              const ptParent = pointOnConnectorNearParent(parentX, parentY, childX, childY);
              const ptChild = pointOnConnectorNearChild(parentX, parentY, childX, childY);
              const ptOnLine = pointOnConnectorBetween(parentX, parentY, childX, childY);
              dot1.setAttribute("transform", `translate(${ptParent.x}, ${ptParent.y - dotR})`);
              dot2.setAttribute("transform", `translate(${ptChild.x}, ${ptChild.y})`);
              svg.setAttribute("viewBox", "0 0 " + window.innerWidth + " " + window.innerHeight);
              svg.setAttribute("width", window.innerWidth);
              svg.setAttribute("height", window.innerHeight);
              unlinkBtn.style.left = ptOnLine.x + "px";
              unlinkBtn.style.top = ptOnLine.y + "px";
              if (countBadge) {
                const badgeOffsetY = 36;
                countBadge.style.left = parentX + "px";
                countBadge.style.top = (parentY + badgeOffsetY) + "px";
              }
            };
            updateChildLine();
            
            // Unlink handler
            const unlinkHandler = () => {
              const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
              const parentName = (t.star ? "★ " : "") + (t.task || "Task");
              pushTasksUndo();
              childTask.dependsOn = null;
              deselectBar();
              saveTasks();
              renderTasks();
              showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
            };
            unlinkBtn.addEventListener("click", unlinkHandler);
            
            // Hover handlers
            let hoverTimer = null;
            const showBtn = () => {
              if (hoverTimer) clearTimeout(hoverTimer);
              unlinkBtn.classList.add("visible");
            };
            const hideBtn = () => {
              hoverTimer = setTimeout(() => {
                if (selectedBarElement === bar) unlinkBtn.classList.add("visible");
                else unlinkBtn.classList.remove("visible");
              }, 200);
            };
            svg.addEventListener("mouseenter", showBtn);
            svg.addEventListener("mouseleave", hideBtn);
            unlinkBtn.addEventListener("mouseenter", showBtn);
            unlinkBtn.addEventListener("mouseleave", hideBtn);
            
            // Scroll/resize handlers
            const wrapper = document.querySelector(".gantt-wrapper");
            wrapper?.addEventListener("scroll", updateChildLine, true);
            window.addEventListener("scroll", updateChildLine, true);
            window.addEventListener("resize", updateChildLine);
            
            // Store cleanup
            if (!selectedBarDepLineCleanup) {
              selectedBarDepLineCleanup = () => {};
            }
            const prevCleanup = selectedBarDepLineCleanup;
            selectedBarDepLineCleanup = () => {
              prevCleanup();
              wrapper?.removeEventListener("scroll", updateChildLine, true);
              window.removeEventListener("scroll", updateChildLine, true);
              window.removeEventListener("resize", updateChildLine);
              svg.removeEventListener("mouseenter", showBtn);
              svg.removeEventListener("mouseleave", hideBtn);
              unlinkBtn.removeEventListener("mouseenter", showBtn);
              unlinkBtn.removeEventListener("mouseleave", hideBtn);
              unlinkBtn.removeEventListener("click", unlinkHandler);
            };
          });
        }
      }
    }

    function closeAllGanttDropdowns() {
      document.querySelectorAll(".gantt-phase-dropdown.open").forEach(w => {
        w.classList.remove("open");
      });
      document.querySelectorAll(".gantt-phase-dropdown-list").forEach(list => {
        list.classList.remove("drop-up");
        if (list.parentNode) list.remove();
      });
      document.querySelectorAll(".gantt-party-dropdown.open").forEach(w => {
        w.classList.remove("open");
      });
      document.querySelectorAll(".gantt-party-dropdown-list.drop-up").forEach(list => {
        list.classList.remove("drop-up");
      });
    }

    function createPhaseSelect(task, bar, phaseDotEl, taskIndex) {
      const wrap = document.createElement("div");
      wrap.className = "gantt-phase-dropdown-wrap";
      wrap.style.display = "flex";
      wrap.style.alignItems = "center";
      wrap.style.gap = "6px";
      wrap.style.minWidth = "0";
      const primaryWrap = document.createElement("div");
      primaryWrap.className = "gantt-phase-dropdown";
      const trigger = document.createElement("button");
      trigger.type = "button";
      trigger.className = "gantt-phase-dropdown-trigger";
      const dot = document.createElement("span");
      dot.className = "phase-dot";
      dot.style.background = getPhaseColor(task.phase || PHASES[0]?.id);
      const label = document.createElement("span");
      const primaryId = task.phase || PHASES[0]?.id;
      const secondaryId = task.phaseSecondary && task.phaseSecondary !== primaryId ? task.phaseSecondary : null;
      label.textContent = secondaryId
        ? (PHASES.find(p => p.id === primaryId)?.name || primaryId) + " \u2192 " + (PHASES.find(p => p.id === secondaryId)?.name || secondaryId)
        : (PHASES.find(p => p.id === primaryId)?.name || primaryId);
      const chevron = document.createElement("span");
      chevron.className = "phase-chevron";
      chevron.textContent = "\u25BC";
      trigger.appendChild(dot);
      trigger.appendChild(label);
      trigger.appendChild(chevron);
      const list = document.createElement("div");
      list.className = "gantt-phase-dropdown-list";
      const hint = document.createElement("div");
      hint.className = "gantt-phase-dropdown-hint";
      hint.textContent = "Shift+click for 2nd phase";
      hint.style.cssText = "font-size:10px;color:#a3a3a3;padding:4px 10px 6px;border-bottom:1px solid #ebebeb;";
      list.appendChild(hint);
      PHASES.forEach(p => {
        const opt = document.createElement("button");
        opt.type = "button";
        opt.className = "gantt-phase-dropdown-option";
        opt.dataset.phaseId = p.id;
        const optDot = document.createElement("span");
        optDot.className = "phase-dot";
        optDot.style.background = p.color;
        opt.appendChild(optDot);
        const optLabel = document.createElement("span");
        optLabel.textContent = p.name;
        opt.appendChild(optLabel);
        opt.addEventListener("click", (e) => {
          e.stopPropagation();
          if (e.shiftKey) {
            task.phaseSecondary = task.phaseSecondary === p.id ? null : (p.id === (task.phase || PHASES[0]?.id) ? null : p.id);
            saveTasks();
            setBarPhaseStyle(bar, task);
            updatePhaseLabel();
            updateListOptionStates();
            renderTasks();
          } else {
            const oldPhase = task.phase;
            task.phase = p.id;
            task.phaseSecondary = null;
            if (typeof taskIndex === "number" && oldPhase !== p.id && !getAllowIndependentDependencies()) {
              tasks.forEach((t) => {
                if (t.dependsOn === taskIndex) {
                  t.phase = p.id;
                  t.phaseSecondary = null;
                }
              });
            }
            saveTasks();
            setBarPhaseStyle(bar, task);
            updatePhaseLabel();
            updateListOptionStates();
            primaryWrap.classList.remove("open");
            if (list.parentNode) list.remove();
            renderPhaseHeaders();
            renderTasks();
          }
        });
        list.appendChild(opt);
      });
      function updateListOptionStates() {
        const pid = task.phase || PHASES[0]?.id;
        const sid = task.phaseSecondary && task.phaseSecondary !== pid ? task.phaseSecondary : null;
        list.querySelectorAll(".gantt-phase-dropdown-option").forEach((o) => {
          const id = o.dataset.phaseId;
          o.classList.remove("selected", "phase-primary", "phase-secondary");
          if (id === pid) o.classList.add("selected", "phase-primary");
          if (id === sid) o.classList.add("phase-secondary");
        });
      }
      wrap.addEventListener("click", (e) => e.stopPropagation());
      wrap.addEventListener("mousedown", (e) => e.stopPropagation());
      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = primaryWrap.classList.contains("open");
        closeAllGanttDropdowns();
        primaryWrap.classList.toggle("open");
        if (!wasOpen && primaryWrap.classList.contains("open")) {
          updateListOptionStates();
          const cell = trigger.closest(".gantt-phase-cell");
          const r = cell ? cell.getBoundingClientRect() : trigger.getBoundingClientRect();
          list.classList.remove("drop-up");
          list.style.left = r.left + "px";
          list.style.top = r.bottom + "px";
          list.style.right = "auto";
          list.style.minWidth = r.width + "px";
          list.style.display = "block";
          document.body.appendChild(list);
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              const lr = list.getBoundingClientRect();
              if (lr.right > window.innerWidth) list.style.left = (window.innerWidth - lr.width - 8) + "px";
              if (lr.left < 8) list.style.left = "8px";
              const spaceBelow = window.innerHeight - r.bottom;
              const listH = list.offsetHeight || lr.height || 200;
              if (spaceBelow < listH + 8) {
                list.classList.add("drop-up");
                list.style.top = (r.top - listH) + "px";
              }
            });
          });
        } else if (!primaryWrap.classList.contains("open") && list.parentNode) {
          list.classList.remove("drop-up");
          list.remove();
        }
      });
      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target) && !list.contains(e.target)) {
          primaryWrap.classList.remove("open");
          if (list.parentNode) list.remove();
        }
      });
      primaryWrap.appendChild(trigger);
      wrap.appendChild(primaryWrap);

      function updatePhaseLabel() {
        const pid = task.phase || PHASES[0]?.id;
        const sid = task.phaseSecondary && task.phaseSecondary !== pid ? task.phaseSecondary : null;
        if (PHASES.length === 0 && !pid) {
          label.textContent = "Add phases in Board settings";
        } else {
          label.textContent = sid
            ? (PHASES.find(x => x.id === pid)?.name || pid) + " \u2192 " + (PHASES.find(x => x.id === sid)?.name || sid)
            : (PHASES.find(x => x.id === pid)?.name || pid);
        }
        dot.style.background = getPhaseColor(pid);
      }
      wrap._updateLabel = (phaseId) => {
        task.phase = phaseId;
        task.phaseSecondary = null;
        updatePhaseLabel();
      };
      wrap._setPhaseSecondary = (secondaryId) => {
        task.phaseSecondary = secondaryId || null;
        updatePhaseLabel();
      };
      return wrap;
    }

    function createTooltipPhaseDropdown(currentPhaseId, currentPhaseSecondaryId, onSelect) {
      const wrap = document.createElement("div");
      wrap.className = "gantt-phase-dropdown gantt-bar-tooltip-phase-dropdown";
      const trigger = document.createElement("button");
      trigger.type = "button";
      trigger.className = "gantt-phase-dropdown-trigger";
      const dot = document.createElement("span");
      dot.className = "phase-dot";
      dot.style.background = getPhaseColor(currentPhaseId || PHASES[0]?.id);
      const label = document.createElement("span");
      const sid = currentPhaseSecondaryId && currentPhaseSecondaryId !== currentPhaseId ? currentPhaseSecondaryId : null;
      if (PHASES.length === 0 && !currentPhaseId) {
        label.textContent = "Add phases in Board settings";
      } else {
        label.textContent = sid
          ? (PHASES.find(p => p.id === currentPhaseId)?.name || currentPhaseId) + " \u2192 " + (PHASES.find(p => p.id === sid)?.name || sid)
          : (PHASES.find(p => p.id === currentPhaseId)?.name || currentPhaseId || PHASES[0]?.name);
      }
      const chevron = document.createElement("span");
      chevron.className = "phase-chevron";
      chevron.textContent = "\u25BC";
      trigger.appendChild(dot);
      trigger.appendChild(label);
      trigger.appendChild(chevron);
      const list = document.createElement("div");
      list.className = "gantt-phase-dropdown-list gantt-bar-tooltip-phase-dropdown-list";
      const hint = document.createElement("div");
      hint.className = "gantt-phase-dropdown-hint";
      hint.textContent = PHASES.length === 0 ? "Add phases in Board settings" : "Shift+click for 2nd phase";
      hint.style.cssText = "font-size:10px;color:#a3a3a3;padding:4px 10px 6px;border-bottom:1px solid #404040;";
      list.appendChild(hint);
      PHASES.forEach(p => {
        const opt = document.createElement("button");
        opt.type = "button";
        opt.className = "gantt-phase-dropdown-option";
        if (p.id === currentPhaseId) opt.classList.add("selected");
        if (currentPhaseSecondaryId && currentPhaseSecondaryId !== currentPhaseId && p.id === currentPhaseSecondaryId) opt.classList.add("phase-secondary");
        opt.dataset.phaseId = p.id;
        const optDot = document.createElement("span");
        optDot.className = "phase-dot";
        optDot.style.background = p.color;
        opt.appendChild(optDot);
        opt.appendChild(document.createTextNode(p.name));
        opt.addEventListener("click", (e) => {
          const isSecondary = e.shiftKey;
          onSelect(p.id, isSecondary);
          if (!isSecondary) {
            wrap._updateLabel(p.id, null);
            wrap.classList.remove("open");
            if (list.parentNode) list.remove();
          }
        });
        list.appendChild(opt);
      });
      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        const wasOpen = wrap.classList.contains("open");
        closeAllGanttDropdowns();
        wrap.classList.toggle("open");
        if (!wasOpen && wrap.classList.contains("open")) {
          document.body.appendChild(list);
          list.classList.remove("drop-up");
          list.style.display = "block";
          const r = trigger.getBoundingClientRect();
          list.style.left = r.left + "px";
          list.style.top = r.bottom + "px";
          list.style.right = "auto";
          list.style.minWidth = r.width + "px";
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              const lr = list.getBoundingClientRect();
              if (lr.right > window.innerWidth) list.style.left = (window.innerWidth - lr.width - 8) + "px";
              if (lr.left < 8) list.style.left = "8px";
              const spaceBelow = window.innerHeight - r.bottom;
              const listH = list.offsetHeight || lr.height || 200;
              if (spaceBelow < listH + 8) {
                list.classList.add("drop-up");
                list.style.top = (r.top - listH) + "px";
              }
            });
          });
        } else if (!wrap.classList.contains("open")) {
          if (list.parentNode) {
            list.classList.remove("drop-up");
            list.remove();
          }
        }
      });
      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target) && !list.contains(e.target)) {
          wrap.classList.remove("open");
          if (list.parentNode) {
            list.classList.remove("drop-up");
            list.remove();
          }
        }
      });
      wrap.appendChild(trigger);
      wrap._tooltipList = list;
      wrap._updateLabel = (phaseId, phaseSecondaryId) => {
        const p = PHASES.find(x => x.id === phaseId);
        const sid = phaseSecondaryId && phaseSecondaryId !== phaseId ? phaseSecondaryId : null;
        if (p) {
          label.textContent = sid
            ? p.name + " \u2192 " + (PHASES.find(x => x.id === sid)?.name || sid)
            : p.name;
          dot.style.background = p.color;
        }
      };
      wrap._updateOptionStates = (primaryId, secondaryId) => {
        list.querySelectorAll(".gantt-phase-dropdown-option").forEach((o) => {
          const id = o.dataset.phaseId;
          o.classList.remove("selected", "phase-secondary");
          if (id === primaryId) o.classList.add("selected");
          if (secondaryId && secondaryId !== primaryId && id === secondaryId) o.classList.add("phase-secondary");
        });
      };
      return wrap;
    }

    function updateGanttDragGuide(leftPx) {
      const guideEl = document.getElementById("ganttDragGuide");
      if (!guideEl) return;
      const headerRow = document.getElementById("ganttHeaderRow");
      const wrapper = document.getElementById("ganttWrapper");
      guideEl.style.left = leftPx + "px";
      if (headerRow && wrapper) {
        const hRect = headerRow.getBoundingClientRect();
        const wRect = wrapper.getBoundingClientRect();
        const tableTop = hRect.bottom;
        const tableHeight = Math.max(0, wRect.bottom - tableTop);
        guideEl.style.top = tableTop + "px";
        guideEl.style.height = tableHeight + "px";
      } else {
        guideEl.style.top = "0";
        guideEl.style.height = "100vh";
      }
      guideEl.classList.add("visible");
    }

    function createBar(task, dateCell, timelineCell, index) {
      const bar = document.createElement("div");
      bar.className = "gantt-bar";
      bar.dataset.index = index;
      bar.dataset.phase = task.phase || PHASES[0]?.id;
      bar.title = "Drag to move • Drag edges to resize • Click to select";
      const barStroke = document.createElement("div");
      barStroke.className = "gantt-bar-stroke";
      const barInner = document.createElement("div");
      barInner.className = "gantt-bar-inner";
      bar.appendChild(barStroke);
      bar.appendChild(barInner);
      setBarPhaseStyle(bar, task);
      const startOffset = Math.max(0, dateToOffset(task.startDate));
      let endOffset = dateToOffset(task.endDate);
      if (endOffset <= startOffset) endOffset = startOffset + 1/7;
      endOffset = Math.min(WEEKS, endOffset);
      bar.style.left = (startOffset / WEEKS) * 100 + "%";
      bar.style.width = ((endOffset - startOffset) / WEEKS) * 100 + "%";
      const durationHintHover = document.createElement("span");
      durationHintHover.className = "gantt-bar-duration-hint gantt-bar-duration-hint-hover";
      const updateHoverHint = () => {
        if (!task.startDate || !task.endDate) return;
        const days = Math.max(1, Math.ceil((task.endDate - task.startDate) / (24 * 60 * 60 * 1000)) + 1);
        durationHintHover.textContent = days + " day" + (days !== 1 ? "s" : "");
      };
      updateHoverHint();
      durationHintHover.title = "Double-click to edit days";
      bar.appendChild(durationHintHover);
      bar.addEventListener("mouseenter", updateHoverHint);
      function openDurationInput() {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
        const currentDays = Math.max(1, Math.ceil((task.endDate - task.startDate) / (24 * 60 * 60 * 1000)) + 1);
        durationHintHover.style.visibility = "hidden";
        const input = document.createElement("input");
        input.type = "text";
        input.inputMode = "numeric";
        input.className = "gantt-bar-duration-input";
        input.value = String(currentDays);
        bar.appendChild(input);
        input.focus();
        input.select();
        let committed = false;
        function commit() {
          const raw = parseInt(input.value.trim(), 10);
          let days = isNaN(raw) || raw < 1 ? 1 : Math.max(1, raw);
          const projectEnd = getProjectEndDate();
          if (projectEnd && task.startDate) {
            const maxDays = Math.max(1, Math.ceil((projectEnd.getTime() - task.startDate.getTime()) / (24 * 60 * 60 * 1000)) + 1);
            days = Math.min(days, maxDays);
          }
          const newEndDate = new Date(task.startDate.getTime() + (days - 1) * 24 * 60 * 60 * 1000);
          const clamped = clampTaskDatesToProjectRange(task.startDate, newEndDate);
          task.startDate = clamped.startDate;
          task.endDate = clamped.endDate;
          task.start = formatDate(task.startDate);
          task.end = formatDate(task.endDate);
          const startOffset = Math.max(0, dateToOffset(task.startDate));
          let endOffset = dateToOffset(task.endDate);
          if (endOffset <= startOffset) endOffset = startOffset + 1/7;
          endOffset = Math.min(WEEKS, endOffset);
          bar.style.left = (startOffset / WEEKS) * 100 + "%";
          bar.style.width = ((endOffset - startOffset) / WEEKS) * 100 + "%";
          const startInp = dateCell.querySelector('.gantt-date-start');
          const endInp = dateCell.querySelector('.gantt-date-end');
          if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
          if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
          cleanup();
          propagateDependencyChanges(index, undefined, undefined, false);
          if (typeof onBarChangeEnd === "function") onBarChangeEnd(index);
          saveTasks();
        }
        function cleanup() {
          input.remove();
          durationHintHover.style.visibility = "";
          updateHoverHint();
        }
        input.addEventListener("blur", () => {
          if (!committed) { committed = true; commit(); }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); if (!committed) { committed = true; commit(); } }
          else if (e.key === "Escape") { e.preventDefault(); cleanup(); }
        });
      }
      bar.addEventListener("dblclick", (e) => {
        if (e.target.closest(".resize-handle") || e.target.closest(".resize-handle-left")) return;
        e.stopPropagation();
        e.preventDefault();
        openDurationInput();
      });
      const resizeHandleLeft = document.createElement("span");
      resizeHandleLeft.className = "resize-handle resize-handle-left";
      const resizeHandle = document.createElement("span");
      resizeHandle.className = "resize-handle";
      const DRAG_THRESHOLD_PX = 5;
      bar.addEventListener("mousedown", (e) => {
        if (e.target.closest(".resize-handle")) return;
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
        e.preventDefault();
        const startX = e.clientX;
        const startY = e.clientY;
        let dragStarted = false;
        let durationHint = null;
        let snapIndicator = null;
        let lastClientX = e.clientX;
        let currentLeft = parseFloat(bar.style.left);
        const barWidth = parseFloat(bar.style.width);
        const durationDays = (task.endDate - task.startDate) / (24*60*60*1000);
        let moved = false;
        let lastShownBoundary = null;
        const updateGuide = () => {
          const r = bar.getBoundingClientRect();
          updateGanttDragGuide(r.left);
        };
        const hideGuide = () => {
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) { guideEl.classList.remove("visible", "snap-zone"); }
        };
        const updateDurationHint = () => {
          if (!durationHint) return;
          const w = parseFloat(bar.style.width);
          const days = Math.max(1, Math.round((w / 100) * WEEKS * 7));
          durationHint.textContent = days + " day" + (days !== 1 ? "s" : "");
        };
        function startDrag() {
          if (dragStarted) return;
          dragStarted = true;
          deselectBar();
          bar.classList.add("dragging");
          lastBarChangeOriginalStartDate = new Date(task.startDate);
          lastBarChangeOriginalEndDate = new Date(task.endDate);
          if (typeof task.dependsOn === "number" && tasks[task.dependsOn]) {
            lastBarChangeOriginalDurationMs = task.endDate.getTime() - task.startDate.getTime();
            lastBarChangeTaskIndex = index;
          }
          var wrapper = bar.closest(".gantt-wrapper");
          var existingHint = bar.querySelector(".gantt-bar-duration-hint-hover");
          if (wrapper && wrapper.getAttribute("data-show-duration-on-bar") === "true" && existingHint) {
            durationHint = existingHint;
          } else {
            durationHint = document.createElement("span");
            durationHint.className = "gantt-bar-duration-hint";
            bar.appendChild(durationHint);
          }
          snapIndicator = document.createElement("span");
          snapIndicator.className = "gantt-bar-snap-indicator";
          snapIndicator.title = "Will snap to sprint";
          snapIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg>';
          bar.appendChild(snapIndicator);
          updateDurationHint();
          updateGuide();
        }
        const onMove = (e2) => {
          if (!dragStarted) {
            if (Math.hypot(e2.clientX - startX, e2.clientY - startY) < DRAG_THRESHOLD_PX) return;
            startDrag();
            lastClientX = e2.clientX;
          }
          moved = true;
          const w = timelineCell.offsetWidth;
          if (w <= 0) return;
          const dxPct = (e2.clientX - lastClientX) / w * 100;
          lastClientX = e2.clientX;
          currentLeft = Math.max(-100, Math.min(100 - barWidth, currentLeft + dxPct));
          bar.style.left = currentLeft + "%";
          updateDurationHint();
          updateGuide();
          const offset = (currentLeft / 100) * WEEKS;
          const rawStart = offsetToDate(offset);
          const inSnapZone = wouldSnapToSprint(rawStart);
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) guideEl.classList.toggle("snap-zone", inSnapZone);
          snapIndicator.classList.toggle("visible", inSnapZone);
          if (inSnapZone) {
            const boundaryInfo = getSprintBoundaryInfo(rawStart);
            if (boundaryInfo) {
              const boundaryKey = boundaryInfo.date.getTime() + "-" + boundaryInfo.type;
              if (lastShownBoundary !== boundaryKey) {
                lastShownBoundary = boundaryKey;
                showToast(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg> Snap to: Sprint ${boundaryInfo.type} — ${formatDate(boundaryInfo.date)}`);
              }
            }
          } else {
            lastShownBoundary = null;
          }
          const candidateEnd = new Date(rawStart.getTime() + durationDays * 24 * 60 * 60 * 1000);
          const clamped = clampTaskDatesToProjectRange(rawStart, candidateEnd);
          task.startDate = clamped.startDate;
          task.endDate = clamped.endDate;
          const startOffset = dateToOffset(task.startDate);
          const endOffset = dateToOffset(task.endDate);
          currentLeft = (startOffset / WEEKS) * 100;
          bar.style.left = currentLeft + "%";
          bar.style.width = (Math.max(1/7, endOffset - startOffset) / WEEKS) * 100 + "%";
          task.start = formatDate(task.startDate);
          task.end = formatDate(task.endDate);
          const phaseAtPos = getPhaseForWeekOffset(dateToOffset(task.startDate), index);
          const oldPhase = task.phase;
          if (phaseAtPos && phaseAtPos !== task.phase) {
            task.phase = phaseAtPos;
            task.phaseSecondary = null;
            setBarPhaseStyle(bar, task);
            // Update child tasks to the same phase (only when not using independent deps)
            if (!getAllowIndependentDependencies()) {
              tasks.forEach((t, childIdx) => {
                if (t.dependsOn === index) {
                  t.phase = phaseAtPos;
                  t.phaseSecondary = null;
                  const childBar = grid?.querySelector(`.gantt-bar[data-index="${childIdx}"]`);
                  if (childBar) setBarPhaseStyle(childBar, t);
                }
              });
            }
          } else {
            setBarPhaseStyle(bar, task);
          }
          const startInp = dateCell.querySelector('.gantt-date-start');
          const endInp = dateCell.querySelector('.gantt-date-end');
          if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
          if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
          propagateDependencyChanges(index, undefined, undefined, true);
        };
        const onUp = () => {
          hideGuide();
          if (durationHint && !durationHint.classList.contains("gantt-bar-duration-hint-hover")) durationHint.remove();
          if (snapIndicator) snapIndicator.remove();
          if (dragStarted) bar.classList.remove("dragging");
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
          if (!dragStarted || !moved) {
            return;
          }
          if (wouldSnapToSprint(task.startDate)) {
            const snapped = snapDateToSprint(task.startDate);
            const durationMs = task.endDate.getTime() - task.startDate.getTime();
            const candidateEnd = new Date(snapped.getTime() + durationMs);
            const clamped = clampTaskDatesToProjectRange(snapped, candidateEnd);
            task.startDate = clamped.startDate;
            task.endDate = clamped.endDate;
            task.start = formatDate(task.startDate);
            task.end = formatDate(task.endDate);
            const startOffset = dateToOffset(task.startDate);
            const endOffset = dateToOffset(task.endDate);
            bar.style.left = (startOffset / WEEKS) * 100 + "%";
            bar.style.width = ((endOffset - startOffset) / WEEKS) * 100 + "%";
            const startInp = dateCell.querySelector('.gantt-date-start');
            const endInp = dateCell.querySelector('.gantt-date-end');
            if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
            if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
            propagateDependencyChanges(index, undefined, undefined, false);
          }
          // Save tasks after move to persist phase changes
          saveTasks();
          // Update phase dropdowns to reflect new phase (parent and children)
          const row = bar.closest(".gantt-row");
          if (row) {
            const phaseDropdown = row.querySelector(".gantt-phase-dropdown");
            if (phaseDropdown && phaseDropdown._updateLabel) {
              phaseDropdown._updateLabel(task.phase);
            }
          }
          // Update child phase dropdowns
          tasks.forEach((t, childIdx) => {
            if (t.dependsOn === index) {
              const childRow = grid?.querySelector(`.gantt-row[data-index="${childIdx}"]`);
              if (childRow) {
                const childPhaseWrap = childRow.querySelector(".gantt-phase-dropdown-wrap");
                if (childPhaseWrap && childPhaseWrap._updateLabel) {
                  childPhaseWrap._updateLabel(t.phase);
                }
              }
            }
          });
          if (typeof onBarChangeEnd === "function") onBarChangeEnd(index);
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
      bar.addEventListener("click", (e) => {
        if (e.target.closest(".resize-handle") || e.target.closest(".resize-handle-left")) return;
        e.stopPropagation();
        if (typeof selectBar === "function") selectBar(bar, index);
      });
      resizeHandleLeft.addEventListener("mousedown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        deselectBar();
        bar.classList.add("resizing");
        lastBarChangeOriginalStartDate = new Date(task.startDate);
        lastBarChangeOriginalEndDate = new Date(task.endDate);
        if (typeof task.dependsOn === "number" && tasks[task.dependsOn]) {
          lastBarChangeOriginalDurationMs = task.endDate.getTime() - task.startDate.getTime();
          lastBarChangeTaskIndex = index;
        }
        const durationHint = document.createElement("span");
        durationHint.className = "gantt-bar-duration-hint";
        bar.appendChild(durationHint);
        const snapIndicator = document.createElement("span");
        snapIndicator.className = "gantt-bar-snap-indicator";
        snapIndicator.title = "Will snap to sprint";
        snapIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg>';
        bar.appendChild(snapIndicator);
        const updateDurationHint = () => {
          const w = parseFloat(bar.style.width);
          const days = Math.max(1, Math.round((w / 100) * WEEKS * 7));
          durationHint.textContent = days + " day" + (days !== 1 ? "s" : "");
        };
        updateDurationHint();
        const updateGuide = () => {
          const guideEl = document.getElementById("ganttDragGuide");
          if (!guideEl) return;
          const r = bar.getBoundingClientRect();
          guideEl.style.left = r.left + "px";
          guideEl.style.top = "0";
          guideEl.style.height = "100vh";
          guideEl.classList.add("visible");
        };
        const hideGuide = () => {
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) { guideEl.classList.remove("visible", "snap-zone"); }
        };
        updateGuide();
        let lastClientX = e.clientX;
        let currentLeft = parseFloat(bar.style.left);
        let currentWidth = parseFloat(bar.style.width);
        const rightEdge = currentLeft + currentWidth;
        let lastShownBoundary = null;
        const onMove = (e2) => {
          const w = timelineCell.offsetWidth;
          if (w <= 0) return;
          const dxPct = (e2.clientX - lastClientX) / w * 100;
          lastClientX = e2.clientX;
          currentLeft = Math.max(-100, Math.min(rightEdge - 2, currentLeft + dxPct));
          currentWidth = rightEdge - currentLeft;
          bar.style.left = currentLeft + "%";
          bar.style.width = currentWidth + "%";
          updateDurationHint();
          updateGuide();
          const startOffset = (currentLeft / 100) * WEEKS;
          const rawStart = offsetToDate(startOffset);
          const inSnapZone = wouldSnapToSprint(rawStart);
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) guideEl.classList.toggle("snap-zone", inSnapZone);
          snapIndicator.classList.toggle("visible", inSnapZone);
          if (inSnapZone) {
            const boundaryInfo = getSprintBoundaryInfo(rawStart);
            if (boundaryInfo) {
              const boundaryKey = boundaryInfo.date.getTime() + "-" + boundaryInfo.type;
              if (lastShownBoundary !== boundaryKey) {
                lastShownBoundary = boundaryKey;
                showToast(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg> Snap to: Sprint ${boundaryInfo.type} — ${formatDate(boundaryInfo.date)}`);
              }
            }
          } else {
            lastShownBoundary = null;
          }
          const candidateEnd = offsetToDate(dateToOffset(rawStart) + (currentWidth / 100) * WEEKS);
          const clamped = clampTaskDatesToProjectRange(rawStart, candidateEnd);
          task.startDate = clamped.startDate;
          task.endDate = clamped.endDate;
          const snappedStartOffset = dateToOffset(task.startDate);
          const snappedEndOffset = dateToOffset(task.endDate);
          currentLeft = (snappedStartOffset / WEEKS) * 100;
          bar.style.left = currentLeft + "%";
          bar.style.width = ((snappedEndOffset - snappedStartOffset) / WEEKS) * 100 + "%";
          task.start = formatDate(task.startDate);
          task.end = formatDate(task.endDate);
          const phaseAtPos = getPhaseForWeekOffset(dateToOffset(task.startDate), index);
          if (phaseAtPos) {
            task.phase = phaseAtPos;
            task.phaseSecondary = null;
          }
          setBarPhaseStyle(bar, task);
          const startInp = dateCell.querySelector('.gantt-date-start');
          const endInp = dateCell.querySelector('.gantt-date-end');
          if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
          if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
          propagateDependencyChanges(index, undefined, undefined, true);
        };
        const onUp = () => {
          hideGuide();
          durationHint.remove();
          snapIndicator.remove();
          bar.classList.remove("resizing");
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
          if (wouldSnapToSprint(task.startDate)) {
            const snapped = snapDateToSprint(task.startDate);
            const candidateEnd = offsetToDate(dateToOffset(snapped) + (currentWidth / 100) * WEEKS);
            const clamped = clampTaskDatesToProjectRange(snapped, candidateEnd);
            task.startDate = clamped.startDate;
            task.endDate = clamped.endDate;
            task.start = formatDate(task.startDate);
            task.end = formatDate(task.endDate);
            const startOffset = dateToOffset(task.startDate);
            const endOffset = dateToOffset(task.endDate);
            bar.style.left = (startOffset / WEEKS) * 100 + "%";
            bar.style.width = ((endOffset - startOffset) / WEEKS) * 100 + "%";
            const startInp = dateCell.querySelector('.gantt-date-start');
            const endInp = dateCell.querySelector('.gantt-date-end');
            if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
            if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
            propagateDependencyChanges(index, undefined, undefined, false);
          }
          if (typeof onBarChangeEnd === "function") onBarChangeEnd(index);
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
      bar.appendChild(resizeHandleLeft);
      resizeHandle.addEventListener("mousedown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        deselectBar();
        bar.classList.add("resizing");
        lastBarChangeOriginalStartDate = new Date(task.startDate);
        lastBarChangeOriginalEndDate = new Date(task.endDate);
        var wrapperRight = bar.closest(".gantt-wrapper");
        var existingHintRight = bar.querySelector(".gantt-bar-duration-hint-hover");
        const durationHint = (wrapperRight && wrapperRight.getAttribute("data-show-duration-on-bar") === "true" && existingHintRight)
          ? existingHintRight
          : (function() { var el = document.createElement("span"); el.className = "gantt-bar-duration-hint"; bar.appendChild(el); return el; })();
        const snapIndicator = document.createElement("span");
        snapIndicator.className = "gantt-bar-snap-indicator";
        snapIndicator.title = "Will snap to sprint";
        snapIndicator.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg>';
        bar.appendChild(snapIndicator);
        const updateDurationHint = () => {
          const w = parseFloat(bar.style.width);
          const days = Math.max(1, Math.round((w / 100) * WEEKS * 7));
          durationHint.textContent = days + " day" + (days !== 1 ? "s" : "");
        };
        updateDurationHint();
        const updateGuide = () => {
          const r = bar.getBoundingClientRect();
          updateGanttDragGuide(r.left + r.width);
        };
        const hideGuide = () => {
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) guideEl.classList.remove("visible", "snap-zone");
        };
        updateGuide();
        let lastClientX = e.clientX;
        let currentWidth = parseFloat(bar.style.width);
        const barLeft = parseFloat(bar.style.left);
        let lastShownBoundary = null;
        const onMove = (e2) => {
          const w = timelineCell.offsetWidth;
          if (w <= 0) return;
          const dxPct = (e2.clientX - lastClientX) / w * 100;
          lastClientX = e2.clientX;
          currentWidth = Math.max(2, Math.min(100 - barLeft, currentWidth + dxPct));
          const rawEndDate = offsetToDate(dateToOffset(task.startDate) + (currentWidth / 100) * WEEKS);
          const inSnapZone = wouldSnapToSprint(rawEndDate);
          const guideEl = document.getElementById("ganttDragGuide");
          if (guideEl) guideEl.classList.toggle("snap-zone", inSnapZone);
          snapIndicator.classList.toggle("visible", inSnapZone);
          if (inSnapZone) {
            const boundaryInfo = getSprintBoundaryInfo(rawEndDate);
            if (boundaryInfo) {
              const boundaryKey = boundaryInfo.date.getTime() + "-" + boundaryInfo.type;
              if (lastShownBoundary !== boundaryKey) {
                lastShownBoundary = boundaryKey;
                showToast(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.5 14.98c.02 0 .03.01.05.01 1.4 0 2.5-1.1 2.5-2.5V8c0-1.4-1.1-2.5-2.5-2.5h-3c-.28 0-.5.22-.5.5v7c0 1.4 1.1 2.48 2.5 2.48M20 7h2c.55 0 1 .45 1 1v4.5c0 .55-.45 1-1 1s-1-.45-1-1V7zM6.5 5.5h-3C2.1 5.5 1 6.6 1 8v4.5c0 1.4 1.1 2.5 2.5 2.5.02 0 .03-.01.05-.01C5.05 14.98 6 13.9 6 12.5v-7c0-.28-.22-.5-.5-.5M4 7v5.5c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1h2zM15.5 16H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 16H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M9 19H5.5c-.28 0-.5.22-.5.5s.22.5.5.5H9c.28 0 .5-.22.5-.5s-.22-.5-.5-.5M15.5 19H12c-.28 0-.5.22-.5.5s.22.5.5.5h3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5"/></svg> Snap to: Sprint ${boundaryInfo.type} — ${formatDate(boundaryInfo.date)}`);
              }
            }
          } else {
            lastShownBoundary = null;
          }
          const clamped = clampTaskDatesToProjectRange(task.startDate, rawEndDate);
          task.endDate = clamped.endDate;
          const snappedEndOffset = dateToOffset(task.endDate);
          const snappedStartOffset = dateToOffset(task.startDate);
          currentWidth = ((snappedEndOffset - snappedStartOffset) / WEEKS) * 100;
          bar.style.width = Math.max(2, currentWidth) + "%";
          updateGuide();
          updateDurationHint();
          task.end = formatDate(task.endDate);
          setBarPhaseStyle(bar, task);
          const startInp = dateCell.querySelector('.gantt-date-start');
          const endInp = dateCell.querySelector('.gantt-date-end');
          if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
          if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
          propagateDependencyChanges(index, undefined, undefined, true);
        };
        const onUp = () => {
          hideGuide();
          if (!durationHint.classList.contains("gantt-bar-duration-hint-hover")) durationHint.remove();
          snapIndicator.remove();
          bar.classList.remove("resizing");
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
          if (wouldSnapToSprint(task.endDate)) {
            const snapped = snapDateToSprint(task.endDate);
            const clamped = clampTaskDatesToProjectRange(task.startDate, snapped);
            task.endDate = clamped.endDate;
            task.end = formatDate(task.endDate);
            const startOffset = dateToOffset(task.startDate);
            const endOffset = dateToOffset(task.endDate);
            currentWidth = ((endOffset - startOffset) / WEEKS) * 100;
            bar.style.width = Math.max(2, currentWidth) + "%";
            const endInp = dateCell.querySelector('.gantt-date-end');
            if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
            propagateDependencyChanges(index, undefined, undefined, false);
          }
          if (typeof onBarChangeEnd === "function") onBarChangeEnd(index);
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
      bar.appendChild(resizeHandle);
      return bar;
    }

    function getPhaseTaskCount(phaseId) {
      return tasks.filter(t => t.phase === phaseId).length;
    }

    function getPhaseStartWeekOffset(phaseIndex) {
      let offset = 0;
      for (let i = 0; i < phaseIndex && i < PHASES.length; i++) {
        offset += getPhaseWeekSpan(PHASES[i].id);
      }
      return offset;
    }

    function showPhaseSelectMenu(anchorEl, taskIndex) {
      return new Promise((resolve) => {
        const popup = document.getElementById("phaseSelectMenu");
        const listEl = document.getElementById("phaseSelectMenuList");
        if (!popup || !listEl) return resolve(null);
        listEl.innerHTML = "";
        PHASES.forEach((p, i) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "phase-select-menu-item";
          btn.dataset.phaseId = p.id;
          const swatch = document.createElement("span");
          swatch.className = "phase-swatch";
          swatch.style.background = p.color;
          btn.appendChild(swatch);
          btn.appendChild(document.createTextNode(p.name));
          btn.addEventListener("click", () => {
            finish(p.id);
          });
          listEl.appendChild(btn);
        });
        const rect = anchorEl.getBoundingClientRect();
        popup.style.left = rect.left + rect.width / 2 + "px";
        const popupHeight = 120;
        const spaceBelow = window.innerHeight - rect.bottom;
        if (spaceBelow < popupHeight + 8 && rect.top > popupHeight + 8) {
          popup.style.top = rect.top - 8 + "px";
          popup.style.transform = "translate(-50%, -100%)";
        } else {
          popup.style.top = rect.bottom + 8 + "px";
          popup.style.transform = "translateX(-50%)";
        }
        popup.classList.add("visible");
        const finish = (result) => {
          popup.classList.remove("visible");
          document.removeEventListener("click", onClickOutside);
          document.removeEventListener("keydown", onEscape);
          resolve(result);
        };
        const onClickOutside = (e) => {
          if (!popup.contains(e.target) && !anchorEl.contains(e.target)) finish(null);
        };
        const onEscape = (e) => { if (e.key === "Escape") finish(null); };
        document.addEventListener("keydown", onEscape);
        requestAnimationFrame(() => document.addEventListener("click", onClickOutside));
      });
    }

    function getPhaseWeekSpan(phaseId) {
      const s = loadProjectSettings();
      if (s?.phaseDurationMode !== "dynamic") {
        const p = PHASES.find(x => x.id === phaseId);
        const sprints = Math.max(1, parseInt(p?.sprints, 10) || 2);
        return sprints * 2;
      }
      const phaseTasks = tasks.filter(t => t.phase === phaseId && t.startDate && t.endDate);
      if (phaseTasks.length === 0) return 1;
      const minStart = Math.min(...phaseTasks.map(t => t.startDate.getTime()));
      const maxEnd = Math.max(...phaseTasks.map(t => t.endDate.getTime()));
      return Math.max(1, Math.floor((maxEnd - minStart) / WEEK_MS) + 1);
    }

    /** In dynamic mode: week offset (from chart start) where this phase's tasks start. Used to align phase header bar with timeline. */
    function getPhaseStartWeekOffsetForDisplay(phaseId) {
      const s = loadProjectSettings();
      if (s?.phaseDurationMode !== "dynamic") return null;
      const phaseTasks = tasks.filter(t => t.phase === phaseId && t.startDate && t.endDate);
      if (phaseTasks.length === 0) return 0;
      const offsets = phaseTasks.map(t => dateToOffset(t.startDate));
      return Math.max(0, Math.min(...offsets));
    }

    function getPhaseDateRange(phaseIndex, baseDate) {
      if (phaseIndex < 0 || phaseIndex >= PHASES.length) return null;
      const startWeekOffset = getPhaseStartWeekOffset(phaseIndex);
      const spanWeeks = getPhaseWeekSpan(PHASES[phaseIndex].id);
      const startDate = new Date(baseDate.getTime() + startWeekOffset * WEEK_MS);
      const endDate = new Date(baseDate.getTime() + (startWeekOffset + spanWeeks) * WEEK_MS - DAY_MS);
      return { startDate, endDate };
    }

    function updateBoardInfoStrip() {
      const startEl = document.getElementById("boardInfoStart");
      const endEl = document.getElementById("boardInfoEnd");
      const countEl = document.getElementById("boardInfoTaskCount");
      const currentEl = document.getElementById("boardInfoCurrentTasks");
      const phaseEl = document.getElementById("boardInfoPhase");
      if (!startEl || !endEl || !countEl || !currentEl || !phaseEl) return;
      let startDate = getProjectStartDate();
      let endDate = getProjectEndDate();
      let minDate = null, maxDate = null;
      tasks.forEach(t => {
        if (t.startDate) minDate = minDate ? new Date(Math.min(minDate.getTime(), t.startDate.getTime())) : new Date(t.startDate);
        if (t.endDate) maxDate = maxDate ? new Date(Math.max(maxDate.getTime(), t.endDate.getTime())) : new Date(t.endDate);
      });
      if (!startDate && minDate) startDate = minDate;
      if (!endDate && maxDate) endDate = maxDate;
      startEl.textContent = startDate ? formatDateFull(startDate) : "—";
      endEl.textContent = endDate ? formatDateFull(endDate) : "—";
      countEl.textContent = String(tasks.length);
      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      const todayEnd = todayStart + 24 * 60 * 60 * 1000 - 1;
      const currentCount = tasks.filter(t => {
        if (!t.startDate || !t.endDate) return false;
        const tStart = new Date(t.startDate.getFullYear(), t.startDate.getMonth(), t.startDate.getDate()).getTime();
        const tEnd = new Date(t.endDate.getFullYear(), t.endDate.getMonth(), t.endDate.getDate(), 23, 59, 59, 999).getTime();
        return tStart <= todayEnd && tEnd >= todayStart;
      }).length;
      currentEl.textContent = String(currentCount);
      let currentPhaseName = "—";
      if (PHASES.length > 0 && typeof WEEK_START !== "undefined") {
        for (let i = 0; i < PHASES.length; i++) {
          const range = getPhaseDateRange(i, WEEK_START);
          if (range && today.getTime() >= range.startDate.getTime() && today.getTime() <= range.endDate.getTime()) {
            currentPhaseName = PHASES[i].name || PHASES[i].id || "—";
            break;
          }
        }
      }
      phaseEl.textContent = currentPhaseName;
    }

    function renderPhaseHeaders() {
      if (PHASES.length === 0) {
        const html = '<div class="phase-header-cell" style="grid-column:1/span 5"></div><div class="phase-header-timeline"><div class="phase-header-cell phase-header-empty" style="flex:1;background:var(--bg-hover);color:var(--text-tertiary);font-size:12px;">Add phases in Board settings</div></div>';
        document.getElementById("phaseHeaderRow").innerHTML = html;
        return;
      }
      const s = loadProjectSettings();
      const isDynamic = s?.phaseDurationMode === "dynamic";
      let phaseCells;
      if (isDynamic && typeof WEEKS === "number" && WEEKS > 0) {
        phaseCells = PHASES.map((p, i) => {
          const borderColor = getContrastColor(p.color);
          const startOffset = getPhaseStartWeekOffsetForDisplay(p.id);
          const spanWeeks = getPhaseWeekSpan(p.id);
          const leftPct = Math.max(0, (startOffset / WEEKS) * 100);
          const widthPct = Math.min(100 - leftPct, (spanWeeks / WEEKS) * 100);
          return '<div class="phase-header-cell phase-header-cell-dynamic" data-phase-id="' + p.id + '" style="left:' + leftPct + '%;width:' + widthPct + '%;background:' + p.color + ';color:' + borderColor + '">' + p.name + '</div>';
        }).join("");
      } else {
        const spans = PHASES.map(p => getPhaseWeekSpan(p.id));
        phaseCells = PHASES.map((p, i) => {
          const borderColor = getContrastColor(p.color);
          return '<div class="phase-header-cell" data-phase-id="' + p.id + '" style="flex:' + spans[i] + ';background:' + p.color + ';color:' + borderColor + '">' + p.name + '</div>';
        }).join("");
      }
      const timelineClass = "phase-header-timeline" + (isDynamic ? " phase-header-timeline-dynamic" : "");
      const html = '<div class="phase-header-cell" style="grid-column:1/span 5"></div>' +
        '<div class="' + timelineClass + '">' + phaseCells + '</div>';
      document.getElementById("phaseHeaderRow").innerHTML = html;
      
      // Add hover listeners to phase headers
      const timeline = document.querySelector(".phase-header-timeline");
      if (timeline) {
        const phaseCellElements = timeline.querySelectorAll(".phase-header-cell[data-phase-id]");
        phaseCellElements.forEach(cell => {
          cell.addEventListener("mouseenter", () => {
            const phaseId = cell.dataset.phaseId;
            document.querySelector(".gantt-wrapper")?.classList.add("phase-focus-active");
            // Dim all phase headers except the hovered one
            phaseCellElements.forEach(c => {
              if (c === cell) {
                c.classList.add("phase-focused");
              } else {
                c.classList.remove("phase-focused");
              }
            });
            // Dim all rows and bars except those in the hovered phase
            document.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(row => {
              const taskIndex = parseInt(row.dataset.index, 10);
              const task = tasks[taskIndex];
              if (task && task.phase === phaseId) {
                row.classList.add("phase-focused");
              } else {
                row.classList.remove("phase-focused");
              }
            });
          });
          
          cell.addEventListener("mouseleave", () => {
            document.querySelector(".gantt-wrapper")?.classList.remove("phase-focus-active");
            phaseCellElements.forEach(c => c.classList.remove("phase-focused"));
            document.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(row => {
              row.classList.remove("phase-focused");
            });
          });
        });
      }
    }

    function renderTaskRow(task, i) {
      const row = document.createElement("div");
      row.className = "gantt-row";
      row.dataset.index = i;
      row.draggable = typeof window.hasWriteAccess !== "function" || window.hasWriteAccess();
      const taskCell = document.createElement("div");
      taskCell.className = "gantt-cell gantt-task-cell";
      const nameWrap = document.createElement("span");
      nameWrap.className = "task-name-wrap";
      const taskText = document.createElement("span");
      taskText.className = "task-text";
      taskText.contentEditable = "false";
      const taskLabel = (task.task != null && String(task.task).trim() !== "") ? String(task.task).trim() : "Task " + (i + 1);
      taskText.textContent = (task.star ? "★ " : "") + taskLabel;
      nameWrap.appendChild(taskText);
      const inProgressTag = document.createElement("span");
      inProgressTag.className = "task-in-progress-tag";
      inProgressTag.setAttribute("aria-hidden", "true");
      const isInProgress = (task.status || "").toLowerCase() === "in progress";
      if (isInProgress) {
        inProgressTag.textContent = "In progress";
        nameWrap.classList.add("has-in-progress-tag");
      }
      nameWrap.appendChild(inProgressTag);
      taskCell.appendChild(nameWrap);
      const phasePill = document.createElement("span");
      phasePill.className = "task-cell-phase-pill";
      phasePill.setAttribute("aria-hidden", "true");
      const pillDot = document.createElement("span");
      pillDot.className = "task-cell-phase-pill-dot";
      const pillLabel = document.createElement("span");
      pillLabel.className = "task-cell-phase-pill-label";
      const phaseId = task.phase || (typeof PHASES !== "undefined" && PHASES[0] ? PHASES[0].id : "");
      const phaseName = typeof PHASES !== "undefined" && PHASES.length ? (PHASES.find(function (p) { return p.id === phaseId; })?.name || phaseId) : phaseId;
      pillDot.style.background = typeof getPhaseColor === "function" ? getPhaseColor(phaseId) : "#737373";
      pillLabel.textContent = phaseName || "—";
      phasePill.appendChild(pillDot);
      phasePill.appendChild(pillLabel);
      const rightGroup = document.createElement("div");
      rightGroup.className = "task-cell-right-group";
      rightGroup.appendChild(phasePill);
      const renameBtn = document.createElement("button");
      renameBtn.className = "task-rename-btn";
      renameBtn.type = "button";
      renameBtn.title = "Rename";
      renameBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>';
      renameBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        taskText.contentEditable = "true";
        taskText.focus();
        const sel = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(taskText);
        sel.removeAllRanges();
        sel.addRange(range);
      });
      const taskActions = document.createElement("div");
      taskActions.className = "task-actions";
      taskActions.appendChild(renameBtn);
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "gantt-delete-btn";
      deleteBtn.type = "button";
      deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';
      deleteBtn.title = "Delete task";
      deleteBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const idx = tasks.indexOf(task);
        if (idx < 0) return;
        const dependents = tasks.filter((t, i) => i !== idx && typeof t.dependsOn === "number" && t.dependsOn === idx);
        if (dependents.length > 0) {
          const count = dependents.length;
          const msg = count === 1
            ? `"${(task.task || "Task").trim() || "This task"}" has 1 task that depends on it. Deleting will remove that dependency link.`
            : `"${(task.task || "Task").trim() || "This task"}" has ${count} tasks that depend on it. Deleting will remove those dependency links.`;
          const confirmed = await showDeleteConfirm(deleteBtn, msg);
          if (!confirmed) return;
        }
        const deletedTaskName = task.task || "Task";
        pushTasksUndo();
        tasks.forEach((t) => {
          if (typeof t.dependsOn !== "number") return;
          if (t.dependsOn === idx) t.dependsOn = null;
          else if (t.dependsOn > idx) t.dependsOn--;
        });
        tasks.splice(idx, 1);
        if (tasks.length === 0) {
          const settings = loadProjectSettings() || {};
          saveProjectSettings({ ...settings, placeholderDismissed: true });
        }
        if (typeof updateChartRange === "function") updateChartRange();
        saveTasks();
        showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Task deleted`, { onUndo: performUndo });
      });
      const duplicateBtn = document.createElement("button");
      duplicateBtn.className = "gantt-duplicate-btn";
      duplicateBtn.type = "button";
      duplicateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      duplicateBtn.title = "Duplicate task";
      duplicateBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const idx = tasks.indexOf(task);
        if (idx >= 0) {
          pushTasksUndo();
          const copy = {
            task: (task.task || "").trim() ? (task.task || "").trim() + " copy" : "copy",
            phase: task.phase,
            party: task.party,
            status: task.status || "Not started",
            start: task.start,
            end: task.end,
            startDate: task.startDate ? new Date(task.startDate) : null,
            endDate: task.endDate ? new Date(task.endDate) : null,
            star: task.star,
            overview: task.overview || "",
            subTasks: (task.subTasks || []).slice(),
            blockers: (task.blockers || []).slice(),
            links: (task.links || []).slice(),
            dependsOn: typeof task.dependsOn === "number" ? (task.dependsOn > idx ? task.dependsOn + 1 : task.dependsOn) : null
          };
          tasks.splice(idx + 1, 0, copy);
          if (typeof updateChartRange === "function") updateChartRange();
          saveTasks();
          showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Task duplicated`, { onUndo: performUndo });
        }
      });
      taskActions.appendChild(duplicateBtn);
      taskActions.appendChild(deleteBtn);
      rightGroup.appendChild(taskActions);
      taskCell.appendChild(rightGroup);
      const STATUS_OPTIONS = ["Not started", "In progress", "Done", "Blocked"];
      const statusCell = document.createElement("div");
      statusCell.className = "gantt-cell gantt-status-cell";

      function createStatusDropdown(t) {
        const wrap = document.createElement("div");
        wrap.className = "gantt-party-dropdown";
        const trigger = document.createElement("button");
        trigger.type = "button";
        trigger.className = "gantt-party-dropdown-trigger";
        const label = document.createElement("span");
        label.textContent = t.status || "Not started";
        const chevron = document.createElement("span");
        chevron.className = "party-chevron";
        chevron.textContent = "\u25BC";
        trigger.appendChild(label);
        trigger.appendChild(chevron);
        const list = document.createElement("div");
        list.className = "gantt-party-dropdown-list";
        STATUS_OPTIONS.forEach(opt => {
          const optBtn = document.createElement("button");
          optBtn.type = "button";
          optBtn.className = "gantt-party-dropdown-option";
          if (opt === (t.status || "Not started")) optBtn.classList.add("selected");
          optBtn.textContent = opt;
          optBtn.addEventListener("click", () => {
            t.status = opt;
            label.textContent = opt;
            list.querySelectorAll(".gantt-party-dropdown-option").forEach(o => o.classList.remove("selected"));
            optBtn.classList.add("selected");
            wrap.classList.remove("open");
            saveTasks();
          });
          list.appendChild(optBtn);
        });
        trigger.addEventListener("click", (e) => {
          e.stopPropagation();
          const wasOpen = wrap.classList.contains("open");
          closeAllGanttDropdowns();
          wrap.classList.toggle("open");
          if (!wasOpen && wrap.classList.contains("open")) {
            const cell = trigger.closest(".gantt-status-cell");
            const r = cell ? cell.getBoundingClientRect() : trigger.getBoundingClientRect();
            list.classList.remove("drop-up");
            list.style.left = r.left + "px";
            list.style.top = r.bottom + "px";
            list.style.right = "auto";
            list.style.minWidth = Math.max(r.width, 120) + "px";
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                const lr = list.getBoundingClientRect();
                if (lr.right > window.innerWidth) list.style.left = (window.innerWidth - lr.width - 8) + "px";
                if (lr.left < 8) list.style.left = "8px";
                const spaceBelow = window.innerHeight - r.bottom;
                const listH = list.offsetHeight || lr.height || 200;
                if (spaceBelow < listH + 8) {
                  list.classList.add("drop-up");
                  list.style.top = (r.top - listH) + "px";
                }
              });
            });
          }
        });
        document.addEventListener("click", (e) => {
          if (!wrap.contains(e.target)) wrap.classList.remove("open");
        });
        wrap.appendChild(trigger);
        wrap.appendChild(list);
        return wrap;
      }
      statusCell.appendChild(createStatusDropdown(task));
      const phaseCell = document.createElement("div");
      phaseCell.className = "gantt-cell gantt-phase-cell";
      const partyCell = document.createElement("div");
      partyCell.className = "gantt-cell gantt-party-cell";

      function createPartyDropdown(t) {
        const s = loadProjectSettings() || {};
        const savedParties = Array.isArray(s.responsibleParties) ? s.responsibleParties : [];
        const fromTasks = tasks.map(x => x.party).filter(Boolean);
        const opts = [...new Set([...savedParties, "Unassigned", ...fromTasks])].sort();
        const wrap = document.createElement("div");
        wrap.className = "gantt-party-dropdown";
        const trigger = document.createElement("button");
        trigger.type = "button";
        trigger.className = "gantt-party-dropdown-trigger";
        const label = document.createElement("span");
        label.textContent = t.party || "Unassigned";
        const chevron = document.createElement("span");
        chevron.className = "party-chevron";
        chevron.textContent = "\u25BC";
        trigger.appendChild(label);
        trigger.appendChild(chevron);
        const list = document.createElement("div");
        list.className = "gantt-party-dropdown-list";
        opts.forEach(p => {
          const opt = document.createElement("button");
          opt.type = "button";
          opt.className = "gantt-party-dropdown-option";
          if (p === (t.party || "Unassigned")) opt.classList.add("selected");
          opt.textContent = p;
          opt.addEventListener("click", () => {
            t.party = p;
            label.textContent = p;
            wrap.classList.remove("open");
            saveTasks();
          });
          list.appendChild(opt);
        });
        const addOpt = document.createElement("button");
        addOpt.type = "button";
        addOpt.className = "gantt-party-dropdown-option gantt-party-add-new";
        addOpt.textContent = "+ Add new...";
        addOpt.addEventListener("click", () => {
          wrap.classList.remove("open");
          const inp = document.createElement("input");
          inp.className = "gantt-party-input";
          inp.type = "text";
          inp.placeholder = "Type name and press Enter";
          inp.autocomplete = "off";
          partyCell.replaceChild(inp, wrap);
          inp.focus();
          inp.addEventListener("blur", () => {
            const v = inp.value.trim();
            t.party = v || "Unassigned";
            if (v) {
              const s = loadProjectSettings() || {};
              const list = Array.isArray(s.responsibleParties) ? s.responsibleParties : [];
              if (list.indexOf(v) === -1) {
                list.push(v);
                saveProjectSettings({ ...s, responsibleParties: list });
              }
            }
            partyCell.replaceChild(createPartyDropdown(t), inp);
            saveTasks();
          });
          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter") { e.preventDefault(); inp.blur(); }
            if (e.key === "Escape") partyCell.replaceChild(createPartyDropdown(t), inp);
          });
        });
        list.appendChild(addOpt);
        trigger.addEventListener("click", (e) => {
          e.stopPropagation();
          const wasOpen = wrap.classList.contains("open");
          closeAllGanttDropdowns();
          wrap.classList.toggle("open");
          if (!wasOpen && wrap.classList.contains("open")) {
            const cell = trigger.closest(".gantt-party-cell");
            const r = cell ? cell.getBoundingClientRect() : trigger.getBoundingClientRect();
            list.classList.remove("drop-up");
            list.style.left = r.left + "px";
            list.style.top = r.bottom + "px";
            list.style.right = "auto";
            list.style.minWidth = r.width + "px";
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                const lr = list.getBoundingClientRect();
                if (lr.right > window.innerWidth) list.style.left = (window.innerWidth - lr.width - 8) + "px";
                if (lr.left < 8) list.style.left = "8px";
                const spaceBelow = window.innerHeight - r.bottom;
                const listH = list.offsetHeight || lr.height || 200;
                if (spaceBelow < listH + 8) {
                  list.classList.add("drop-up");
                  list.style.top = (r.top - listH) + "px";
                }
              });
            });
          }
        });
        document.addEventListener("click", (e) => {
          if (!wrap.contains(e.target)) wrap.classList.remove("open");
        });
        wrap.appendChild(trigger);
        wrap.appendChild(list);
        return wrap;
      }
      partyCell.appendChild(createPartyDropdown(task));

      const dateCell = document.createElement("div");
      dateCell.className = "gantt-cell gantt-date-cell";
      const dateWrap = document.createElement("div");
      dateWrap.className = "gantt-date-input-wrap";
      const startInput = document.createElement("input");
      startInput.type = "text";
      startInput.className = "gantt-date-start";
      startInput.placeholder = "Start";
      startInput.value = task.start || "";
      startInput.title = task.startDate ? formatDateFull(task.startDate) : "";
      const endInput = document.createElement("input");
      endInput.type = "text";
      endInput.className = "gantt-date-end";
      endInput.placeholder = "End";
      endInput.value = task.end || "";
      endInput.title = task.endDate ? formatDateFull(task.endDate) : "";
      const updateFromInputs = () => {
        const startParsed = parseDateStr(startInput.value);
        const endParsed = parseDateStr(endInput.value);
        const startDate = startParsed?.start || endParsed?.start;
        const endDate = endParsed?.start || endParsed?.end || startDate;
        if (startDate) {
          task.startDate = startDate;
          task.start = formatDate(startDate);
          startInput.value = task.start;
          startInput.title = formatDateFull(task.startDate);
        }
        if (endDate) {
          task.endDate = endDate;
          task.end = formatDate(endDate);
          endInput.value = task.end;
          endInput.title = formatDateFull(task.endDate);
        }
        if (startDate && endDate && task.startDate.getTime() > task.endDate.getTime()) {
          task.endDate = new Date(task.startDate.getTime());
          task.end = task.start;
          endInput.value = task.end;
          endInput.title = formatDateFull(task.endDate);
        }
        if (startDate || endDate) {
          if (bar) {
            const so = Math.max(0, dateToOffset(task.startDate || task.endDate));
            let eo = dateToOffset(task.endDate || task.startDate);
            if (eo <= so) eo = so + 1/7;
            eo = Math.min(WEEKS, eo);
            bar.style.left = (so / WEEKS) * 100 + "%";
            bar.style.width = ((eo - so) / WEEKS) * 100 + "%";
          }
          propagateDependencyChanges(i);
          if (typeof updateChartRange === "function") updateChartRange();
        }
      };
      startInput.addEventListener("blur", updateFromInputs);
      endInput.addEventListener("blur", updateFromInputs);
      startInput.addEventListener("keydown", (e) => { if (e.key === "Enter") startInput.blur(); });
      endInput.addEventListener("keydown", (e) => { if (e.key === "Enter") endInput.blur(); });
      const dateSep = document.createElement("span");
      dateSep.className = "gantt-date-sep";
      dateSep.textContent = "–";
      dateWrap.appendChild(startInput);
      dateWrap.appendChild(dateSep);
      dateWrap.appendChild(endInput);
      dateCell.appendChild(dateWrap);
      const timelineCell = document.createElement("div");
      timelineCell.className = "gantt-cell gantt-timeline-cell";
      timelineCell.style.gridColumn = "span " + WEEKS;
      let bar = null;
      if (task.startDate && task.endDate) {
        bar = createBar(task, dateCell, timelineCell, i);
        timelineCell.appendChild(bar);
      }
      const phaseSelectEl = createPhaseSelect(task, bar, null, i);
      phaseCell.appendChild(phaseSelectEl);
      taskText.addEventListener("blur", () => {
        const t = taskText.textContent.trim();
        task.task = t.replace(/^★\s*/, "");
        task.star = t.startsWith("★");
        taskText.contentEditable = "false";
        saveTasks();
      });
      taskCell.addEventListener("dblclick", (e) => {
        e.stopPropagation();
        taskText.contentEditable = "true";
        taskText.focus();
        const sel = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(taskText);
        sel.removeAllRanges();
        sel.addRange(range);
      });
      row.appendChild(taskCell);
      row.appendChild(statusCell);
      row.appendChild(phaseCell);
      row.appendChild(partyCell);
      row.appendChild(dateCell);
      row.appendChild(timelineCell);

      row.addEventListener("click", (e) => {
        const isReadOnly = typeof window.hasWriteAccess === "function" && !window.hasWriteAccess();
        const onBar = e.target.closest(".gantt-bar");
        if (e.target.closest(".gantt-delete-btn") || e.target.closest(".gantt-duplicate-btn") || (onBar && !isReadOnly) || e.target.closest(".resize-handle") || e.target.closest(".gantt-phase-cell") || e.target.closest(".gantt-phase-dropdown") || e.target.closest(".gantt-phase-dropdown-list") || e.target.closest(".gantt-party-cell") || e.target.closest(".gantt-party-dropdown-list") || e.target.closest(".gantt-status-cell") || e.target.closest(".gantt-date-cell")) return;
        document.querySelectorAll(".gantt-row.selected").forEach(r => r.classList.remove("selected"));
        row.classList.add("selected");
        const idx = parseInt(row.dataset.index, 10);
        if (!isNaN(idx)) expandTaskDetail(idx);
      });

      return row;
    }

    let draggedIndex = null;
    function setupRowDrag(row, index) {
      row.addEventListener("dragstart", (e) => {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) {
          e.preventDefault();
          return;
        }
        if (e.target.closest(".gantt-bar") || e.target.closest(".gantt-timeline-cell") || e.target.closest(".gantt-party-cell") || e.target.closest(".gantt-status-cell")) {
          e.preventDefault();
          return;
        }
        draggedIndex = index;
        row.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", index);
      });
      row.addEventListener("dragend", () => {
        row.classList.remove("dragging");
        draggedIndex = null;
      });
      row.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;
      });
      row.addEventListener("drop", (e) => {
        e.preventDefault();
        const from = draggedIndex;
        const to = index;
        if (from === null || from === to) return;
        pushTasksUndo();
        const [moved] = tasks.splice(from, 1);
        tasks.splice(to, 0, moved);
        tasks.forEach((t) => {
          if (typeof t.dependsOn !== "number") return;
          const i = t.dependsOn;
          if (i === from) t.dependsOn = to;
          else if (from < i && i < to) t.dependsOn = i - 1;
          else if (i === to) t.dependsOn = to + 1;
        });
        if (typeof updateChartRange === "function") updateChartRange();
        saveTasks();
      });
    }

    const addBtn = document.createElement("button");
    addBtn.id = "addTaskFab";
    addBtn.className = "add-task-fab";
    const addBtnIcon = document.createElement("span");
    addBtnIcon.className = "add-task-fab-icon";
    addBtnIcon.textContent = "+";
    addBtn.appendChild(addBtnIcon);
    addBtn.setAttribute("aria-label", "Add task");
    addBtn.setAttribute("aria-haspopup", "menu");
    addBtn.setAttribute("aria-expanded", "false");
    const fabPhaseMenu = document.getElementById("fabPhaseMenu");
    const fabPhaseMenuList = document.getElementById("fabPhaseMenuList");
    function closeFabPhaseMenu() {
      if (!fabPhaseMenu) return;
      fabPhaseMenu.classList.remove("visible");
      addBtn.classList.remove("fab-open");
      addBtn.setAttribute("aria-expanded", "false");
      document.removeEventListener("click", fabPhaseMenu._outsideClick);
      document.removeEventListener("keydown", fabPhaseMenu._escapeKey);
    }
    function addTaskInPhase(phaseId) {
      if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
      closeFabPhaseMenu();
      pushTasksUndo();
      const resolvedPhaseId = phaseId || PHASES[0]?.id || "";
      let startDate, endDate;
      const phaseIdx = PHASES.findIndex(p => p.id === resolvedPhaseId);
      const projectStart = getProjectStartDate();
      const defaultBase = projectStart || new Date();
      if (resolvedPhaseId && phaseIdx >= 0 && typeof getPhaseStartWeekOffset === "function") {
        const startWeekOffset = getPhaseStartWeekOffset(phaseIdx);
        const base = projectStart && typeof startOfWeek === "function" ? startOfWeek(projectStart) : WEEK_START;
        startDate = new Date(base.getTime() + startWeekOffset * WEEK_MS);
        endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000); // one week from phase start
      } else {
        startDate = new Date(defaultBase.getFullYear(), defaultBase.getMonth(), defaultBase.getDate());
        endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
      }
      const newTask = { task: "New task", phase: resolvedPhaseId, party: "Unassigned", status: "Not started", start: "", end: "", startDate, endDate, star: false, overview: "", subTasks: [], blockers: [], links: [], dependsOn: null };
      newTask.start = formatDate(newTask.startDate);
      newTask.end = formatDate(newTask.endDate);
      tasks.push(newTask);
      saveTasks();
      if (typeof dismissEmptyState === "function") dismissEmptyState();
      if (typeof updateChartRange === "function") updateChartRange();
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const rows = grid.querySelectorAll(".gantt-row[draggable]");
          const lastRow = rows[rows.length - 1];
          if (lastRow) lastRow.scrollIntoView({ behavior: "smooth", block: "end" });
        });
      });
    }
    addBtn.onclick = (e) => {
      e.stopPropagation();
      if (fabPhaseMenu.classList.contains("visible")) {
        closeFabPhaseMenu();
        return;
      }
      const phases = PHASES.length ? PHASES : [{ id: "", name: "Default", color: "#737373" }];
      fabPhaseMenuList.innerHTML = "";
      phases.forEach((p) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "fab-phase-menu-item";
        item.setAttribute("role", "menuitem");
        const swatch = document.createElement("span");
        swatch.className = "phase-swatch";
        swatch.style.background = p.color || "#737373";
        item.appendChild(swatch);
        item.appendChild(document.createTextNode(p.name || p.id || "Default"));
        item.dataset.phaseId = p.id;
        item.addEventListener("click", (ev) => { ev.stopPropagation(); addTaskInPhase(p.id); });
        fabPhaseMenuList.appendChild(item);
      });
      const fabRect = addBtn.getBoundingClientRect();
      fabPhaseMenu.style.left = Math.max(12, fabRect.left + fabRect.width - 200) + "px";
      fabPhaseMenu.style.right = "auto";
      fabPhaseMenu.style.bottom = (window.innerHeight - fabRect.top + 8) + "px";
      fabPhaseMenu.style.top = "auto";
      fabPhaseMenu.classList.add("visible");
      addBtn.classList.add("fab-open");
      addBtn.setAttribute("aria-expanded", "true");
      fabPhaseMenu._outsideClick = (e) => {
        if (fabPhaseMenu.contains(e.target) || addBtn.contains(e.target)) return;
        closeFabPhaseMenu();
      };
      fabPhaseMenu._escapeKey = (e) => { if (e.key === "Escape") closeFabPhaseMenu(); };
      setTimeout(() => {
        document.addEventListener("click", fabPhaseMenu._outsideClick);
        document.addEventListener("keydown", fabPhaseMenu._escapeKey);
      }, 0);
    };

    function ensureOneEmptyTaskWhenEmpty() {
      if (tasks.length !== 0 || addedPlaceholderThisSession) return;
      const s = loadProjectSettings();
      if (s?.placeholderDismissed) return;
      addedPlaceholderThisSession = true;
      pushTasksUndo();
      const base = getProjectStartDate() || new Date();
      const startDate = new Date(base.getFullYear(), base.getMonth(), base.getDate());
      const endDate = new Date(startDate.getTime() + 6 * 24 * 60 * 60 * 1000);
      const empty = { task: "my first task", phase: PHASES[0]?.id || "", party: "Unassigned", start: formatDate(startDate), end: formatDate(endDate), startDate, endDate, star: false, overview: "", subTasks: [], blockers: [], links: [], dependsOn: null };
      tasks.push(empty);
      saveTasks();
    }
    function renderTasks() {
      if (!grid) return;
      ensureOneEmptyTaskWhenEmpty();
      updateEmptyState();
      deselectBar();
      collapseDetail(false);
      const existingRows = grid.querySelectorAll(".gantt-row:not(.gantt-header-sticky)");
      existingRows.forEach(r => r.remove());
      tasks.forEach((task, i) => {
        const row = renderTaskRow(task, i);
        setupRowDrag(row, i);
        grid.appendChild(row);
      });
      renderPhaseHeaders();
    }

    const LEFT_COLS = 540;

    function getVisibleWeeks() {
      const mode = document.getElementById("viewMode")?.value || "default";
      if (mode === "sprint") return 2;
      if (mode === "month") return 4;
      if (mode === "project") return WEEKS;
      return 8;
    }

    function updateWeekWidth() {
      const wrapper = document.querySelector(".gantt-wrapper");
      const gridEl = document.getElementById("ganttGrid");
      if (!wrapper || !gridEl) return;
      const scrollEl = document.getElementById("ganttChartScroll");
      const ganttView = document.getElementById("ganttView");
      const isMobilePortrait = window.matchMedia("(max-width: 768px) and (orientation: portrait)").matches;
      const visibleWeeks = getVisibleWeeks();
      const containerWidth = wrapper.offsetWidth || wrapper.parentElement?.offsetWidth || 1200;
      const weekWidth = Math.max(48, (containerWidth - LEFT_COLS) / visibleWeeks);
      wrapper.style.setProperty("--gantt-weeks", WEEKS);
      wrapper.style.setProperty("--gantt-week-width", weekWidth + "px");
      if (isMobilePortrait) {
        gridEl.style.minWidth = "";
        const headerSticky = wrapper.querySelector(".gantt-header-sticky");
        if (headerSticky) headerSticky.style.minWidth = "";
      } else {
        const minContentWidth = (LEFT_COLS + WEEKS * weekWidth) + "px";
        gridEl.style.minWidth = minContentWidth;
        const headerSticky = wrapper.querySelector(".gantt-header-sticky");
        if (headerSticky) headerSticky.style.minWidth = minContentWidth;
      }
      // #region agent log
      requestAnimationFrame(function() {
        var bodyStyle = document.body && window.getComputedStyle(document.body);
        var bodyPaddingLeft = bodyStyle ? parseInt(bodyStyle.paddingLeft, 10) || 0 : 0;
        var bodyPaddingRight = bodyStyle ? parseInt(bodyStyle.paddingRight, 10) || 0 : 0;
        fetch('http://127.0.0.1:7245/ingest/dd0ecab6-6439-4f49-9fa5-d5cd82409225',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'template.html:updateWeekWidth',message:'layout dimensions',data:{wrapperWidth:wrapper?wrapper.offsetWidth:null,ganttViewWidth:ganttView?ganttView.offsetWidth:null,scrollElClientWidth:scrollEl?scrollEl.clientWidth:null,scrollElScrollWidth:scrollEl?scrollEl.scrollWidth:null,gridOffsetWidth:gridEl?gridEl.offsetWidth:null,bodyPaddingLeft:bodyPaddingLeft,bodyPaddingRight:bodyPaddingRight,windowInnerWidth:window.innerWidth,containerWidthUsed:containerWidth},timestamp:Date.now(),hypothesisId:'H1-H5'})}).catch(function(){});
      });
      // #endregion
    }

    let scrollSaveTid = null;
    function saveScrollPosition() {
      const scrollEl = document.getElementById("ganttChartScroll");
      if (!scrollEl) return;
      const s = loadProjectSettings() || {};
      saveProjectSettings({ ...s, scrollPosition: { scrollTop: scrollEl.scrollTop, scrollLeft: scrollEl.scrollLeft } });
    }
    function restoreScrollPosition() {
      const scrollEl = document.getElementById("ganttChartScroll");
      const pos = loadProjectSettings()?.scrollPosition;
      if (!scrollEl || !pos || typeof pos.scrollTop !== "number" || typeof pos.scrollLeft !== "number") return;
      scrollEl.scrollTop = Math.max(0, pos.scrollTop);
      scrollEl.scrollLeft = Math.max(0, pos.scrollLeft);
    }

    function updateChartRange() {
      computeChartRange();
      const wrapper = document.querySelector(".gantt-wrapper");
      if (wrapper) wrapper.style.setProperty("--gantt-weeks", WEEKS);
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/dd0ecab6-6439-4f49-9fa5-d5cd82409225',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'template.html:updateChartRange',message:'after set --gantt-weeks',data:{WEEKS:typeof WEEKS!=='undefined'?WEEKS:null,wrapperExists:!!wrapper},timestamp:Date.now(),hypothesisId:'H4'})}).catch(()=>{});
      // #endregion
      updateWeekWidth();
      renderWeekLabels();
      renderPhaseHeaders();
      renderTasks();
      saveTasks();
      if (typeof updateBoardInfoStrip === "function") updateBoardInfoStrip();
    }

    function showDetachConfirm(anchorEl, message, options) {
      const { showSettingsHint = false } = options || {};
      return new Promise((resolve) => {
        const popup = document.getElementById("detachConfirmPopup");
        const msgEl = document.getElementById("detachConfirmMsg");
        const hintEl = document.getElementById("detachConfirmHint");
        const cancelBtn = popup?.querySelector(".detach-confirm-cancel");
        const detachBtn = popup?.querySelector(".detach-confirm-detach");
        if (!popup || !msgEl) return resolve(false);
        msgEl.textContent = message;
        if (hintEl) {
          hintEl.classList.toggle("hidden", !showSettingsHint);
        }
        const rect = anchorEl.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        const midY = rect.top + rect.height / 2;
        popup.style.left = midX + "px";
        popup.style.transform = "translate(-50%, -50%)";
        popup.style.top = midY + "px";
        popup.classList.add("visible");
        const finish = (result) => {
          popup.classList.remove("visible");
          cancelBtn?.removeEventListener("click", onCancel);
          detachBtn?.removeEventListener("click", onDetach);
          document.removeEventListener("click", onClickOutside);
          document.removeEventListener("keydown", onEscape);
          resolve(result);
        };
        const onCancel = () => finish(false);
        const onDetach = () => finish(true);
        const onClickOutside = (e) => {
          if (!popup.contains(e.target) && !anchorEl.contains(e.target)) finish(false);
        };
        const onEscape = (e) => { if (e.key === "Escape") finish(false); };
        cancelBtn?.addEventListener("click", onCancel);
        detachBtn?.addEventListener("click", onDetach);
        document.addEventListener("keydown", onEscape);
        requestAnimationFrame(() => document.addEventListener("click", onClickOutside));
      });
    }

    function showDeleteConfirm(anchorEl, message) {
      return new Promise((resolve) => {
        const popup = document.getElementById("deleteConfirmPopup");
        const msgEl = document.getElementById("deleteConfirmMsg");
        const cancelBtn = popup?.querySelector(".delete-confirm-cancel");
        const deleteBtn = popup?.querySelector(".delete-confirm-delete");
        if (!popup || !msgEl) return resolve(false);
        msgEl.textContent = message;
        const rect = anchorEl.getBoundingClientRect();
        popup.style.left = rect.left + rect.width / 2 + "px";
        const popupHeight = 80;
        const spaceBelow = window.innerHeight - rect.bottom;
        if (spaceBelow < popupHeight + 8 && rect.top > popupHeight + 8) {
          popup.style.top = rect.top - 8 + "px";
          popup.style.transform = "translate(-50%, -100%)";
        } else {
          popup.style.top = rect.bottom + 8 + "px";
          popup.style.transform = "translateX(-50%)";
        }
        popup.classList.add("visible");
        const finish = (result) => {
          popup.classList.remove("visible");
          cancelBtn?.removeEventListener("click", onCancel);
          deleteBtn?.removeEventListener("click", onDelete);
          document.removeEventListener("click", onClickOutside);
          document.removeEventListener("keydown", onEscape);
          resolve(result);
        };
        const onCancel = () => finish(false);
        const onDelete = () => finish(true);
        const onClickOutside = (e) => {
          if (!popup.contains(e.target) && !anchorEl.contains(e.target)) finish(false);
        };
        const onEscape = (e) => { if (e.key === "Escape") finish(false); };
        cancelBtn?.addEventListener("click", onCancel);
        deleteBtn?.addEventListener("click", onDelete);
        document.addEventListener("keydown", onEscape);
        requestAnimationFrame(() => document.addEventListener("click", onClickOutside));
      });
    }

    function showPhaseConfirm(anchorEl, message, moveLabel) {
      return new Promise((resolve) => {
        const popup = document.getElementById("phaseConfirmPopup");
        const msgEl = document.getElementById("phaseConfirmMsg");
        const keepBtn = popup?.querySelector(".phase-confirm-keep");
        const moveBtn = popup?.querySelector(".phase-confirm-move");
        if (!popup || !msgEl) return resolve(false);
        msgEl.textContent = message;
        moveBtn.textContent = moveLabel || "Move to phase";
        const rect = anchorEl.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        const midY = rect.top + rect.height / 2;
        popup.style.left = midX + "px";
        popup.style.top = midY + "px";
        popup.style.transform = "translate(-50%, -50%)";
        popup.classList.add("visible");
        const finish = (result) => {
          popup.classList.remove("visible");
          keepBtn?.removeEventListener("click", onKeep);
          moveBtn?.removeEventListener("click", onMove);
          document.removeEventListener("click", onClickOutside);
          document.removeEventListener("keydown", onEscape);
          resolve(result);
        };
        const onKeep = () => finish(false);
        const onMove = () => finish(true);
        const onClickOutside = (e) => {
          if (!popup.contains(e.target) && !anchorEl.contains(e.target)) finish(false);
        };
        const onEscape = (e) => { if (e.key === "Escape") finish(false); };
        keepBtn?.addEventListener("click", onKeep);
        moveBtn?.addEventListener("click", onMove);
        document.addEventListener("keydown", onEscape);
        requestAnimationFrame(() => document.addEventListener("click", onClickOutside));
      });
    }

    function getPhaseWeekSpanExcluding(phaseId, excludeTaskIndex) {
      const s = loadProjectSettings();
      if (s?.phaseDurationMode !== "dynamic") {
        const p = PHASES.find(x => x.id === phaseId);
        const sprints = Math.max(1, parseInt(p?.sprints, 10) || 2);
        return sprints * 2;
      }
      const phaseTasks = tasks.filter((t, i) => i !== excludeTaskIndex && t.phase === phaseId && t.startDate && t.endDate);
      if (phaseTasks.length === 0) return 1;
      const minStart = Math.min(...phaseTasks.map(t => t.startDate.getTime()));
      const maxEnd = Math.max(...phaseTasks.map(t => t.endDate.getTime()));
      return Math.max(1, Math.floor((maxEnd - minStart) / WEEK_MS) + 1);
    }

    function getPhaseForWeekOffset(weekOffset, excludeTaskIndex) {
      const spanFn = (p) => excludeTaskIndex != null ? getPhaseWeekSpanExcluding(p.id, excludeTaskIndex) : getPhaseWeekSpan(p.id);
      const spans = PHASES.map(p => spanFn(p));
      const total = spans.reduce((a, b) => a + b, 0);
      if (total <= 0) return PHASES[0]?.id || null;
      const pos = Math.max(0, Math.min(1, weekOffset / WEEKS));
      let cumulative = 0;
      for (let i = 0; i < PHASES.length; i++) {
        cumulative += spans[i] / total;
        if (pos <= cumulative) return PHASES[i].id;
      }
      return PHASES[PHASES.length - 1]?.id || null;
    }

    async function onBarChangeEnd(taskIndex) {
      const task = typeof taskIndex === "number" ? tasks[taskIndex] : null;
      const primaryIdx = task && typeof task.dependsOn === "number" ? task.dependsOn : null;
      const primary = primaryIdx !== null ? tasks[primaryIdx] : null;
      if (!getAllowIndependentDependencies() && task && primary && primary.endDate && task.startDate) {
        const gapMs = getDependencyGapDays() * 24 * 60 * 60 * 1000;
        const expectedStart = new Date(primary.endDate.getTime() + gapMs);
        const actualStart = task.startDate.getTime();
        const expectedStartTime = expectedStart.getTime();
        if (Math.abs(actualStart - expectedStartTime) > 60 * 60 * 1000) {
          const primaryName = (primary.star ? "★ " : "") + (primary.task || "Task");
          const bar = document.querySelector('.gantt-bar[data-index="' + taskIndex + '"]');
          const connectorEl = document.getElementById("ganttDependencyLinePath");
          const anchor = (connectorEl && connectorEl.getAttribute("d")) ? connectorEl : (bar || document.body);
          const message = "This task depends on \"" + primaryName + "\". Changing the start date would break the link.";
          const detach = await showDetachConfirm(anchor, message, { showSettingsHint: true });
          if (detach) {
            const childName = (task.star ? "★ " : "") + (task.task || "Task");
            const parentName = (primary.star ? "★ " : "") + (primary.task || "Task");
            pushTasksUndo();
            task.dependsOn = null;
            showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
          } else {
            const durationOverride = (lastBarChangeTaskIndex === taskIndex && lastBarChangeOriginalDurationMs != null)
              ? { taskIndex, durationMs: lastBarChangeOriginalDurationMs }
              : undefined;
            propagateDependencyChanges(primaryIdx, undefined, durationOverride);
          }
        }
      }
      lastBarChangeOriginalDurationMs = null;
      lastBarChangeTaskIndex = null;
      if (task && task.startDate && task.phase && lastBarChangeOriginalStartDate && lastBarChangeOriginalEndDate) {
        const weekOffset = dateToOffset(task.startDate);
        const phaseForPosition = getPhaseForWeekOffset(weekOffset, taskIndex);
        if (phaseForPosition && phaseForPosition !== task.phase) {
          const phaseInfo = PHASES.find(p => p.id === phaseForPosition);
          const phaseName = phaseInfo?.name || phaseForPosition;
          const bar = document.querySelector('.gantt-bar[data-index="' + taskIndex + '"]');
          const connectorEl = document.getElementById("ganttDependencyLinePath");
          const anchor = (connectorEl && connectorEl.getAttribute("d")) ? connectorEl : (bar || document.body);
          const message = "This task is now in the \"" + phaseName + "\" region. Move it to this phase or keep it linked to the current one?";
          const moveLabel = "Move to " + phaseName;
          const movePhase = await showPhaseConfirm(anchor, message, moveLabel);
          if (movePhase) {
            task.phase = phaseForPosition;
          } else if (lastBarChangeOriginalStartDate && lastBarChangeOriginalEndDate) {
            task.startDate = new Date(lastBarChangeOriginalStartDate);
            task.endDate = new Date(lastBarChangeOriginalEndDate);
            task.start = formatDate(task.startDate);
            task.end = formatDate(task.endDate);
            const row = grid?.querySelector('.gantt-row[data-index="' + taskIndex + '"]');
            const dateCell = row?.querySelector(".gantt-date-cell");
            if (dateCell) {
              const startInp = dateCell.querySelector('.gantt-date-start');
              const endInp = dateCell.querySelector('.gantt-date-end');
              if (startInp) { startInp.value = task.start; startInp.title = task.startDate ? formatDateFull(task.startDate) : ""; }
              if (endInp) { endInp.value = task.end; endInp.title = task.endDate ? formatDateFull(task.endDate) : ""; }
            }
            const barEl = document.querySelector('.gantt-bar[data-index="' + taskIndex + '"]');
            if (barEl) {
              const so = dateToOffset(task.startDate);
              let eo = dateToOffset(task.endDate);
              if (eo <= so) eo = so + 1 / 7;
              eo = Math.min(WEEKS, Math.max(0, eo));
              barEl.style.left = (Math.max(0, so) / WEEKS) * 100 + "%";
              barEl.style.width = ((eo - Math.max(0, so)) / WEEKS) * 100 + "%";
            }
          }
        }
      }
      lastBarChangeOriginalStartDate = null;
      lastBarChangeOriginalEndDate = null;
      if (typeof taskIndex === "number") propagateDependencyChanges(taskIndex);
      const prevWeeks = WEEKS;
      const prevStart = WEEK_START.getTime();
      computeChartRange();
      const rangeChanged = WEEKS !== prevWeeks || WEEK_START.getTime() !== prevStart;
      if (rangeChanged) {
        updateChartRange();
      } else {
        renderPhaseHeaders();
        renderTasks();
        saveTasks();
      }
    }

    function renderWeekLabels() {
      const headerRow = document.getElementById("ganttHeaderRow");
      // #region agent log
      fetch('http://127.0.0.1:7245/ingest/dd0ecab6-6439-4f49-9fa5-d5cd82409225',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'template.html:renderWeekLabels',message:'renderWeekLabels entry',data:{headerRowExists:!!headerRow,WEEKS:typeof WEEKS!=='undefined'?WEEKS:null,WEEK_START:typeof WEEK_START!=='undefined'&&WEEK_START?WEEK_START.toISOString():null},timestamp:Date.now(),hypothesisId:'H1-H2'})}).catch(()=>{});
      // #endregion
      if (!headerRow) return;
      const existing = headerRow.querySelectorAll(".week-label, .gantt-header-delete-cell");
      existing.forEach(el => el.remove());
      for (let w = 0; w < WEEKS; w++) {
        const cell = document.createElement("div");
        cell.className = "gantt-cell week-label";
        const d = new Date(WEEK_START.getTime() + w * WEEK_MS);
        const month = d.toLocaleDateString("en-US", { month: "short" });
        const day = String(d.getDate());
        cell.innerHTML = `<span class="date-month">${month}</span><span class="date-day">${day}</span>`;
        headerRow.appendChild(cell);
      }
      const deletePlaceholder = document.createElement("div");
      deletePlaceholder.className = "gantt-cell gantt-header-delete-cell";
      headerRow.appendChild(deletePlaceholder);
      // #region agent log
      (function(){
        var r=headerRow.getBoundingClientRect();
        var weekLabels=headerRow.querySelectorAll(".week-label");
        var wrapper=document.querySelector(".gantt-wrapper");
        var ganttWeeks=wrapper?window.getComputedStyle(wrapper).getPropertyValue("--gantt-weeks").trim():null;
        fetch('http://127.0.0.1:7245/ingest/dd0ecab6-6439-4f49-9fa5-d5cd82409225',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'template.html:renderWeekLabels:exit',message:'after week labels rendered',data:{weekLabelCount:weekLabels.length,headerRect:{top:r.top,left:r.left,width:r.width,height:r.height},ganttWeeksCSS:ganttWeeks,headerDisplay:window.getComputedStyle(headerRow).display,headerVisibility:window.getComputedStyle(headerRow).visibility},timestamp:Date.now(),hypothesisId:'H2-H5'})}).catch(()=>{});
      })();
      // #endregion
    }

    function applyRowAppearance() {
      const s = loadProjectSettings();
      const mode = s?.rowAppearance === "compact" || s?.rowAppearance === "fill" ? s.rowAppearance : "default";
      const wrapper = document.querySelector(".gantt-wrapper");
      if (wrapper) {
        wrapper.setAttribute("data-row-appearance", mode);
        if (s?.strokeMode) wrapper.setAttribute("data-bar-stroke-mode", "true");
        else wrapper.removeAttribute("data-bar-stroke-mode");
        if (s?.showDurationOnBar) wrapper.setAttribute("data-show-duration-on-bar", "true");
        else wrapper.removeAttribute("data-show-duration-on-bar");
      }
    }
    function applySettingsPreviewFromForm() {
      const wrapper = document.querySelector(".gantt-wrapper");
      if (!wrapper) return;
      const rowAppearanceEl = document.getElementById("settingsRowAppearance");
      const mode = rowAppearanceEl?.value === "compact" || rowAppearanceEl?.value === "fill" ? rowAppearanceEl.value : "default";
      wrapper.setAttribute("data-row-appearance", mode);
      const barStyleSelected = document.querySelector("#settingsBarStyle .settings-segmented-option.selected");
      const strokeMode = barStyleSelected?.dataset.value === "stroke";
      if (strokeMode) wrapper.setAttribute("data-bar-stroke-mode", "true");
      else wrapper.removeAttribute("data-bar-stroke-mode");
      const showDurationEl = document.getElementById("settingsShowDurationOnBar");
      if (showDurationEl?.checked) wrapper.setAttribute("data-show-duration-on-bar", "true");
      else wrapper.removeAttribute("data-show-duration-on-bar");
    }
    function getDefaultPhasesWithSprints() {
      return DEFAULT_PHASES.map(p => ({ ...p, sprints: 2 }));
    }
    function applyProjectSettings() {
      applyRowAppearance();
      const s = loadProjectSettings();
      if (!s) {
        PHASES = getDefaultPhasesWithSprints();
        return;
      }
      if (Array.isArray(s.phases) && s.phases.length > 0) {
        PHASES = s.phases.map(p => ({ id: p.id, name: p.name || p.id, color: p.color || "#737373", sprints: p.sprints ?? 2 }));
      } else {
        PHASES = getDefaultPhasesWithSprints();
      }
    }
    function setupPhaseListDrag(phaseList) {
      if (!phaseList) return;
      let draggedItem = null;
      phaseList.addEventListener("dragstart", (e) => {
        const item = e.target.closest(".settings-phase-item");
        if (!item || e.target.closest('input[type="text"]') || e.target.closest('input[type="number"]') || e.target.closest('input[type="color"]') || e.target.closest(".settings-phase-remove") || e.target.closest(".settings-phase-sprints-stepper-btn")) return;
        draggedItem = item;
        item.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", item.dataset.phaseId);
      });
      phaseList.addEventListener("dragend", (e) => {
        const item = e.target.closest(".settings-phase-item");
        if (item) {
          item.classList.remove("dragging");
          draggedItem = null;
        }
      });
      phaseList.addEventListener("dragover", (e) => {
        e.preventDefault();
        const item = e.target.closest(".settings-phase-item");
        if (!draggedItem || !item || draggedItem === item) return;
        e.dataTransfer.dropEffect = "move";
      });
      phaseList.addEventListener("drop", (e) => {
        e.preventDefault();
        const item = e.target.closest(".settings-phase-item");
        if (!draggedItem || !item || draggedItem === item) return;
        const all = [...phaseList.querySelectorAll(".settings-phase-item")];
        const fromIdx = all.indexOf(draggedItem);
        const toIdx = all.indexOf(item);
        if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
        if (fromIdx < toIdx) {
          item.after(draggedItem);
        } else {
          item.before(draggedItem);
        }
      });
    }

    function openSettingsSidebar(context) {
      window._settingsContext = context || (currentProjectId ? "board" : "home");
      var titleEl = document.getElementById("settingsSidebarTitle");
      var tabsHome = document.getElementById("settingsTabsHome");
      var tabsBoard = document.getElementById("settingsTabsBoard");
      var homePanel = document.getElementById("settingsGeneralHome");
      var boardPanel = document.getElementById("settingsGeneralBoard");
      if (titleEl) titleEl.textContent = window._settingsContext === "board" ? "Board settings" : "Settings";
      if (tabsHome) tabsHome.style.display = window._settingsContext === "home" ? "" : "none";
      if (tabsBoard) tabsBoard.style.display = window._settingsContext === "board" ? "" : "none";
      if (homePanel) homePanel.style.display = window._settingsContext === "home" ? "" : "none";
      if (boardPanel) boardPanel.style.display = window._settingsContext === "board" ? "" : "none";
      document.getElementById("appViewsWrap")?.classList.add("settings-sidebar-open");
      document.querySelectorAll(".settings-tab").forEach(function (t) { t.classList.remove("active"); });
      document.querySelectorAll(".settings-tab-panel").forEach(function (p) { p.classList.remove("active"); });
      if (window._settingsContext === "board") {
        var generalTab = tabsBoard ? tabsBoard.querySelector('.settings-tab[data-tab="function"]') : null;
        var generalPanel = document.getElementById("settingsTabFunction");
        if (generalTab) generalTab.classList.add("active");
        if (generalPanel) generalPanel.classList.add("active");
      } else {
        var generalTab = tabsHome ? tabsHome.querySelector('.settings-tab[data-tab="function"]') : null;
        var generalPanel = document.getElementById("settingsTabFunction");
        if (generalTab) generalTab.classList.add("active");
        if (generalPanel) generalPanel.classList.add("active");
      }
    }
    function openHomeSettings() {
      openSettingsSidebar("home");
      var nameEl = document.getElementById("settingsHomeName");
      var descEl = document.getElementById("settingsHomeDescription");
      var previewEl = document.getElementById("settingsTimelinePreviews");
      if (nameEl) nameEl.value = (typeof localStorage !== "undefined" && localStorage.getItem(HOME_TITLE_KEY)) || DEFAULT_HOME_TITLE;
      if (descEl) descEl.value = (typeof localStorage !== "undefined" && localStorage.getItem(HOME_DESC_KEY)) || DEFAULT_HOME_DESC;
      if (previewEl) previewEl.checked = (typeof localStorage !== "undefined" && localStorage.getItem(HOME_TIMELINE_PREVIEWS_KEY) !== "false");
    }
    function openSettingsModal() {
      openSettingsSidebar("board");
      const s = loadProjectSettings() || {};
      const header = loadPageHeader();
      document.getElementById("settingsTitle").value = header.title;
      document.getElementById("settingsDescription").value = header.description;
      const gapEl = document.getElementById("settingsDependencyGap");
      if (gapEl) gapEl.value = String(s.dependencyGapDays ?? 0);
      const dependentTrigger = document.getElementById("settingsDependentTrigger");
      if (dependentTrigger && gapEl?.selectedOptions?.[0]) dependentTrigger.textContent = gapEl.selectedOptions[0].textContent;
      function toYYYYMMDD(raw) {
        if (!raw || typeof raw !== "string") return "";
        var trimmed = raw.trim();
        var ymd = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (ymd) return trimmed;
        var d = new Date(trimmed);
        if (isNaN(d.getTime())) return "";
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, "0");
        var day = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + day;
      }
      const psEl = document.getElementById("settingsProjectStartDate");
      if (psEl) {
        if (s.projectStartDate) {
          psEl.value = toYYYYMMDD(s.projectStartDate);
        } else {
          var projects = loadProjectsList() || [];
          var proj = projects.find(function (p) { return p.id === currentProjectId; });
          var createdAt = proj && proj.createdAt != null ? proj.createdAt : null;
          if (createdAt != null) {
            var d = new Date(createdAt);
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart(2, "0");
            var day = String(d.getDate()).padStart(2, "0");
            psEl.value = y + "-" + m + "-" + day;
          } else {
            psEl.value = "";
          }
        }
      }
      const peEl = document.getElementById("settingsProjectEndDate");
      if (peEl) peEl.value = s.projectEndDate ? toYYYYMMDD(s.projectEndDate) : "";
      const snapEl = document.getElementById("settingsSnapToSprint");
      if (snapEl) snapEl.checked = s == null ? true : !!s.snapToSprint;
      const moveTasksEl = document.getElementById("settingsMoveTasksWhenSprintExtended");
      if (moveTasksEl) moveTasksEl.checked = !!s?.moveTasksWhenSprintExtended;
      const indepEl = document.getElementById("settingsIndependentDependencies");
      if (indepEl) indepEl.checked = !!s?.allowIndependentDependencies;
      const linkAllEl = document.getElementById("settingsLinkAllTasks");
      if (linkAllEl) linkAllEl.checked = !!s?.linkAllTasks;
      const dependentTriggerEl = document.getElementById("settingsDependentTrigger");
      if (dependentTriggerEl) dependentTriggerEl.disabled = !!indepEl?.checked;
      const showDurationEl = document.getElementById("settingsShowDurationOnBar");
      if (showDurationEl) showDurationEl.checked = !!s?.showDurationOnBar;
      const phaseDurationEl = document.getElementById("settingsPhaseDurationMode");
      const phaseMode = (s?.phaseDurationMode === "dynamic") ? "dynamic" : "fixed";
      if (phaseDurationEl) phaseDurationEl.value = phaseMode;
      const phaseList = document.getElementById("settingsPhaseList");
      if (phaseList) phaseList.dataset.phaseMode = phaseMode;
      const phaseSectionLabel = document.getElementById("settingsPhaseSectionLabel");
      if (phaseSectionLabel) phaseSectionLabel.style.display = phaseMode === "dynamic" ? "" : "none";
      const snapWrap = document.getElementById("settingsSnapToSprintWrap");
      if (snapWrap) snapWrap.style.display = phaseMode === "fixed" ? "" : "none";
      phaseList.innerHTML = "";
      if (phaseMode === "fixed") {
        const header = document.createElement("div");
        header.className = "settings-phase-list-header";
        const headerPhase = document.createElement("div");
        headerPhase.className = "settings-phase-list-header-phase";
        headerPhase.textContent = "Phases";
        header.appendChild(headerPhase);
        const headerSprints = document.createElement("div");
        headerSprints.className = "settings-phase-list-header-sprints";
        headerSprints.textContent = "Sprints";
        header.appendChild(headerSprints);
        phaseList.appendChild(header);
      }
      const renderPhaseItem = (p, i) => {
        const item = document.createElement("div");
        item.className = "settings-phase-item";
        item.dataset.phaseId = p.id;
        item.draggable = true;
        const inputWrap = document.createElement("div");
        inputWrap.className = "settings-phase-input-wrap";
        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = p.name;
        inp.placeholder = "Phase name";
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "settings-phase-remove";
        removeBtn.textContent = "\u2212";
        removeBtn.title = "Remove phase";
        removeBtn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          item.remove();
          phaseList.querySelectorAll(".settings-phase-remove").forEach(btn => {
            btn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
          });
        });
        const colorInp = document.createElement("input");
        colorInp.type = "color";
        colorInp.className = "settings-phase-swatch";
        colorInp.value = p.color;
        colorInp.addEventListener("change", function () {
          if (typeof autoSavePaletteFromPhaseColors === "function") autoSavePaletteFromPhaseColors();
        });
        inputWrap.appendChild(colorInp);
        inputWrap.appendChild(inp);
        inputWrap.appendChild(removeBtn);
        const sprintsWrap = document.createElement("div");
        sprintsWrap.className = "settings-phase-sprints";
        const sprintsInner = document.createElement("div");
        sprintsInner.className = "settings-phase-sprints-inner";
        const sprintsInp = document.createElement("input");
        sprintsInp.type = "number";
        sprintsInp.min = "1";
        sprintsInp.max = "52";
        sprintsInp.value = Math.max(1, Math.min(52, parseInt(p.sprints, 10) || 2));
        const minusBtn = document.createElement("button");
        minusBtn.type = "button";
        minusBtn.className = "settings-phase-sprints-stepper-btn";
        minusBtn.textContent = "\u2212";
        minusBtn.title = "Decrease sprints";
        const plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className = "settings-phase-sprints-stepper-btn";
        plusBtn.textContent = "+";
        plusBtn.title = "Increase sprints";
        function updateStepperState() {
          var v = Math.max(1, Math.min(52, parseInt(sprintsInp.value, 10) || 2));
          sprintsInp.value = v;
          minusBtn.disabled = v <= 1;
          plusBtn.disabled = v >= 52;
        }
        minusBtn.addEventListener("click", function () {
          var v = Math.max(1, parseInt(sprintsInp.value, 10) || 2) - 1;
          sprintsInp.value = v;
          updateStepperState();
        });
        plusBtn.addEventListener("click", function () {
          var v = Math.min(52, (parseInt(sprintsInp.value, 10) || 2) + 1);
          sprintsInp.value = v;
          updateStepperState();
        });
        sprintsInp.addEventListener("change", updateStepperState);
        sprintsInner.appendChild(minusBtn);
        sprintsInner.appendChild(sprintsInp);
        sprintsInner.appendChild(plusBtn);
        sprintsWrap.appendChild(sprintsInner);
        item.appendChild(inputWrap);
        item.appendChild(sprintsWrap);
        phaseList.appendChild(item);
        updateStepperState();
      };
      PHASES.forEach((p, i) => renderPhaseItem(p, i));
      document.getElementById("settingsAddPhase").onclick = () => {
        const existingIds = [...phaseList.querySelectorAll(".settings-phase-item")].map(it => it.dataset.phaseId);
        let id = "phase-" + (PHASES.length + 1);
        let n = 1;
        while (existingIds.includes(id)) { id = "phase-" + (PHASES.length + n++); }
        const sel = paletteGrid.querySelector(".settings-palette-option.selected");
        let colors = [];
        if (sel?.dataset.colors) { try { colors = JSON.parse(sel.dataset.colors); } catch {} }
        const itemCount = phaseList.querySelectorAll(".settings-phase-item").length;
        const color = colors[itemCount] || "#737373";
        renderPhaseItem({ id, name: "New phase", color, sprints: 2 }, itemCount);
        phaseList.querySelectorAll(".settings-phase-remove").forEach(btn => {
          btn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
        });
      };
      const partyListEl = document.getElementById("settingsResponsiblePartiesList");
      const partyInputEl = document.getElementById("settingsPartyInput");
      const addPartyBtn = document.getElementById("settingsAddParty");
      if (partyListEl) {
        partyListEl.innerHTML = "";
        const savedParties = Array.isArray(s.responsibleParties) ? s.responsibleParties : [];
        savedParties.forEach((name) => {
          const item = document.createElement("div");
          item.className = "settings-party-item";
          const span = document.createElement("span");
          span.textContent = name;
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => item.remove());
          item.appendChild(span);
          item.appendChild(removeBtn);
          partyListEl.appendChild(item);
        });
      }
      function addResponsibleParty() {
        const name = (partyInputEl && partyInputEl.value || "").trim();
        if (!name || !partyListEl) return;
        partyInputEl.value = "";
        const item = document.createElement("div");
        item.className = "settings-party-item";
        const span = document.createElement("span");
        span.textContent = name;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => item.remove());
        item.appendChild(span);
        item.appendChild(removeBtn);
        partyListEl.appendChild(item);
      }
      if (addPartyBtn) addPartyBtn.onclick = addResponsibleParty;
      if (partyInputEl) partyInputEl.onkeydown = (e) => { if (e.key === "Enter") { e.preventDefault(); addResponsibleParty(); } };
      const customPalettes = loadCustomPalettes();
      const allPalettes = [...COLOR_PALETTES, ...customPalettes];
      const rowAppearanceEl = document.getElementById("settingsRowAppearance");
      if (rowAppearanceEl) rowAppearanceEl.value = s.rowAppearance === "compact" || s.rowAppearance === "fill" ? s.rowAppearance : "default";
      const barStyleEl = document.getElementById("settingsBarStyle");
      if (barStyleEl) {
        barStyleEl.querySelectorAll(".settings-segmented-option").forEach(opt => {
          opt.classList.toggle("selected", opt.dataset.value === (s.strokeMode ? "stroke" : "fill"));
        });
      }
      const paletteGrid = document.getElementById("settingsPaletteGrid");
      const paletteWrap = document.getElementById("settingsPaletteDropdownWrap");
      const paletteTrigger = document.getElementById("settingsPaletteTrigger");
      const paletteTriggerLabel = document.getElementById("settingsPaletteTriggerLabel");
      const paletteTriggerSwatches = document.getElementById("settingsPaletteTriggerSwatches");
      paletteGrid.innerHTML = "";
      let paletteIdx = typeof s.paletteIndex === "number" ? s.paletteIndex : 0;
      if (paletteIdx >= allPalettes.length) paletteIdx = 0;
      function updatePaletteTriggerLabel() {
        const sel = paletteGrid.querySelector(".settings-palette-option.selected");
        const idx = sel ? parseInt(sel.dataset.index, 10) : 0;
        const pal = allPalettes[idx];
        const name = (pal && pal.name) ? pal.name : "Palette " + (idx + 1);
        if (paletteTriggerLabel) paletteTriggerLabel.textContent = name;
        if (paletteTriggerSwatches) {
          paletteTriggerSwatches.innerHTML = "";
          const strokePreview = document.querySelector("#settingsBarStyle .settings-segmented-option[data-value='stroke']")?.classList.contains("selected");
          (pal?.colors || []).forEach(c => {
            const span = document.createElement("span");
            applyPaletteSwatchStyle(span, c, strokePreview);
            paletteTriggerSwatches.appendChild(span);
          });
        }
      }
      allPalettes.forEach((pal, i) => {
        const opt = document.createElement("button");
        opt.type = "button";
        const isEditable = i >= COLOR_PALETTES.length;
        opt.className = "settings-palette-option" + (isEditable ? " editable" : "") + (i === paletteIdx ? " selected" : "");
        opt.dataset.index = String(i);
        opt.dataset.colors = JSON.stringify(pal.colors || []);
        const nameWrap = document.createElement("div");
        nameWrap.className = "settings-palette-name-wrap";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "settings-palette-name-input";
        nameInput.value = pal.name || "Palette " + (i + 1);
        nameInput.readOnly = i < COLOR_PALETTES.length;
        nameInput.addEventListener("click", (e) => e.stopPropagation());
        nameInput.addEventListener("focus", (e) => e.stopPropagation());
        nameWrap.appendChild(nameInput);
        if (i >= COLOR_PALETTES.length) {
          const renameBtn = document.createElement("button");
          renameBtn.type = "button";
          renameBtn.className = "settings-palette-rename-btn";
          renameBtn.textContent = "Rename";
          renameBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const newName = prompt("Palette name", nameInput.value?.trim() || "My palette")?.trim();
            if (newName == null || newName === nameInput.value) return;
            const custom = loadCustomPalettes();
            const customIdx = i - COLOR_PALETTES.length;
            if (customIdx >= 0 && custom[customIdx]) {
              custom[customIdx].name = newName;
              saveCustomPalettes(custom);
              nameInput.value = newName;
              updatePaletteTriggerLabel();
            }
          });
          nameWrap.appendChild(renameBtn);
        }
        opt.appendChild(nameWrap);
        const strokePreview = document.querySelector("#settingsBarStyle .settings-segmented-option[data-value='stroke']")?.classList.contains("selected");
        const swatchesEl = document.createElement("div");
        swatchesEl.className = "settings-palette-swatches";
        (pal.colors || []).forEach(c => {
          const span = document.createElement("span");
          applyPaletteSwatchStyle(span, c, strokePreview);
          swatchesEl.appendChild(span);
        });
        opt.appendChild(swatchesEl);
        opt.addEventListener("click", () => {
          paletteGrid.querySelectorAll(".settings-palette-option").forEach(o => o.classList.remove("selected"));
          opt.classList.add("selected");
          const idx = parseInt(opt.dataset.index, 10);
          const p = allPalettes[idx];
          if (p?.colors) {
            document.querySelectorAll(".settings-phase-item").forEach((item, i) => {
              const colorInp = item.querySelector('input[type="color"]');
              if (colorInp && p.colors[i]) colorInp.value = p.colors[i];
            });
          }
          updatePaletteTriggerLabel();
          if (paletteWrap) {
            paletteWrap.classList.remove("open");
            if (paletteTrigger) paletteTrigger.setAttribute("aria-expanded", "false");
          }
        });
        paletteGrid.appendChild(opt);
      });
      updatePaletteTriggerLabel();
      document.getElementById("appViewsWrap")?.classList.add("settings-sidebar-open");
      const addFab = document.getElementById("addTaskFab");
      if (addFab) addFab.style.display = "none";
      document.getElementById("fabPhaseMenu")?.classList.remove("visible");
    }
    function closeSettingsModal() {
      applyRowAppearance();
      document.getElementById("appViewsWrap")?.classList.remove("settings-sidebar-open");
      if (currentProjectId) {
        if (typeof window.updateWriteAccessUI === "function") window.updateWriteAccessUI();
        else {
          var addFab = document.getElementById("addTaskFab");
          if (addFab) addFab.style.display = "";
        }
      }
    }
    function saveSettingsFromModal() {
      var storageTabActive = !!document.querySelector('.settings-tab[data-tab="storage"].active');
      var allowStorageSave = storageTabActive && document.querySelector('.storage-type-tile.selected');
      if (!allowStorageSave && typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
      if (window._settingsContext === "home") {
        var nameEl = document.getElementById("settingsHomeName");
        var homeDescEl = document.getElementById("settingsHomeDescription");
        var previewEl = document.getElementById("settingsTimelinePreviews");
        var name = (nameEl && nameEl.value ? nameEl.value.trim() : "") || DEFAULT_HOME_TITLE;
        var homeDesc = (homeDescEl && homeDescEl.value ? homeDescEl.value.trim() : "") || DEFAULT_HOME_DESC;
        try {
          localStorage.setItem(HOME_TITLE_KEY, name);
          localStorage.setItem(HOME_DESC_KEY, homeDesc);
          localStorage.setItem(HOME_TIMELINE_PREVIEWS_KEY, previewEl && previewEl.checked ? "true" : "false");
        } catch (e) {}
        var homeTitleEl = document.getElementById("homePageTitle");
        var pageDescEl = document.getElementById("homePageDescription");
        if (homeTitleEl) homeTitleEl.textContent = name;
        if (pageDescEl) pageDescEl.textContent = homeDesc;
        var storageTabActive = !!document.querySelector('.settings-tab[data-tab="storage"].active');
        var selectedTile = storageTabActive && document.querySelector('.storage-type-tile.selected');
        var selectedType = selectedTile ? selectedTile.dataset.value : null;
        if (selectedType && typeof setStorageMode === "function") {
          var prevMode = typeof getStorageMode === "function" ? getStorageMode() : null;
          var prevUrl, prevToken;
          try { prevUrl = localStorage.getItem(SHARED_FILE_URL_KEY); prevToken = localStorage.getItem(GITHUB_TOKEN_KEY); } catch (e) {}
          if (selectedType === "github") {
            if (prevMode === "supabase" && window.ganttStorage?.signOut) { window.ganttStorage.signOut().catch(function () {}); }
            var urlEl = document.getElementById("sharedFileUrl");
            var tokenEl = document.getElementById("sharedFileGitHubToken");
            try {
              if (urlEl && (urlEl.value || "").trim()) localStorage.setItem(SHARED_FILE_URL_KEY, urlEl.value.trim());
              if (tokenEl && (tokenEl.value || "").trim()) localStorage.setItem(GITHUB_TOKEN_KEY, tokenEl.value.trim());
            } catch (e) {}
            setStorageMode("github");
            if (typeof applyStorageModeUI === "function") applyStorageModeUI("github");
            currentProjectId = null;
            if (typeof location !== "undefined") location.hash = "#/";
            if (typeof handleRoute === "function") handleRoute();
            if (typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
            else if (typeof window.__fetchSharedUpdates === "function") window.__fetchSharedUpdates();
          } else if (selectedType === "supabase") {
            setStorageMode("supabase");
            if (typeof applyStorageModeUI === "function") applyStorageModeUI("supabase");
          } else if (selectedType === "local_storage" || selectedType === "local_cache") {
            if (prevMode === "supabase" && window.ganttStorage?.signOut) { window.ganttStorage.signOut().catch(function () {}); }
            if (selectedType === "local_cache") {
              try { localStorage.removeItem(SHARED_FILE_URL_KEY); localStorage.removeItem(GITHUB_TOKEN_KEY); } catch (e) {}
              if (typeof clearLocalProjectData === "function") clearLocalProjectData();
            }
            setStorageMode(selectedType);
            if (typeof applyStorageModeUI === "function") applyStorageModeUI(selectedType);
            currentProjectId = null;
            if (typeof location !== "undefined") location.hash = "#/";
            if (typeof handleRoute === "function") handleRoute();
          }
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
          if (typeof showToast === "function" && typeof getStorageModeLabel === "function") {
            showToast("Storage changed to " + getStorageModeLabel(selectedType), {
              onUndo: function () {
                try {
                  if (prevMode === "github" && prevUrl) localStorage.setItem(SHARED_FILE_URL_KEY, prevUrl);
                  if (prevMode === "github" && prevToken) localStorage.setItem(GITHUB_TOKEN_KEY, prevToken);
                  if (selectedType === "local_cache" && prevMode !== "github") {
                    try { if (prevUrl) localStorage.setItem(SHARED_FILE_URL_KEY, prevUrl); if (prevToken) localStorage.setItem(GITHUB_TOKEN_KEY, prevToken); } catch (e) {}
                  }
                } catch (e) {}
                setStorageMode(prevMode || "local_cache");
                if (typeof applyStorageModeUI === "function") applyStorageModeUI(prevMode || "local_cache");
                currentProjectId = null;
                if (typeof location !== "undefined") location.hash = "#/";
                if (typeof handleRoute === "function") handleRoute();
                if (prevMode === "github" && typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
                if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
                if (typeof renderHomeView === "function") renderHomeView();
                if (typeof window.switchStorageTab === "function") window.switchStorageTab(prevMode === "local_storage" || prevMode === "local_cache" ? "local" : "external");
              }
            });
          }
        }
        closeSettingsModal();
        if (typeof renderHomeView === "function") renderHomeView();
        return;
      }
      const title = document.getElementById("settingsTitle").value.trim() || DEFAULT_PAGE_TITLE;
      const desc = document.getElementById("settingsDescription").value.trim() || DEFAULT_PAGE_DESCRIPTION;
      const phases = [];
      const removedIds = PHASES.map(p => p.id).filter(id => !document.querySelector(`.settings-phase-item[data-phase-id="${id}"]`));
      document.querySelectorAll(".settings-phase-item").forEach((item, i) => {
        const inp = item.querySelector('input[type="text"]');
        const colorInp = item.querySelector('input[type="color"]');
        const sprintsInp = item.querySelector('.settings-phase-sprints input[type="number"]');
        const name = (inp?.value || "").trim() || "Phase " + (i + 1);
        const color = colorInp?.value || "#737373";
        const sprints = sprintsInp ? Math.max(1, Math.min(52, parseInt(sprintsInp.value, 10) || 2)) : 2;
        const id = item.dataset.phaseId || name.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "") || "phase-" + (i + 1);
        phases.push({ id, name, color, sprints });
      });
      const firstPhaseId = phases[0]?.id;
      if (firstPhaseId && removedIds.length > 0) {
        tasks.forEach(t => { if (removedIds.includes(t.phase)) t.phase = firstPhaseId; });
        saveTasks();
      }
      const selectedPalette = document.querySelector(".settings-palette-option.selected");
      const paletteIndex = selectedPalette ? parseInt(selectedPalette.dataset.index, 10) : 0;
      const dependencyGapDays = parseInt(document.getElementById("settingsDependencyGap")?.value || "0", 10) || 0;
      const rowAppearance = document.getElementById("settingsRowAppearance")?.value || "default";
      const barStyleSelected = document.querySelector("#settingsBarStyle .settings-segmented-option.selected");
      const strokeMode = barStyleSelected?.dataset.value === "stroke";
      const s = loadProjectSettings() || {};
      /* Capture project start/end from form or existing settings before any other saves (e.g. saveTasks after link-all-tasks) so they are not overwritten. */
      const projectStartDateRaw = document.getElementById("settingsProjectStartDate")?.value?.trim();
      const projectStartDate = projectStartDateRaw ? projectStartDateRaw : (s.projectStartDate || null);
      const projectEndDateRaw = document.getElementById("settingsProjectEndDate")?.value?.trim();
      const projectEndDate = projectEndDateRaw ? projectEndDateRaw : (s.projectEndDate || null);
      const phaseDurationMode = document.getElementById("settingsPhaseDurationMode")?.value === "fixed" ? "fixed" : "dynamic";
      const snapToSprint = !!document.getElementById("settingsSnapToSprint")?.checked;
      const moveTasksWhenSprintExtended = !!document.getElementById("settingsMoveTasksWhenSprintExtended")?.checked;
      const allowIndependentDependencies = !!document.getElementById("settingsIndependentDependencies")?.checked;
      const linkAllTasks = !!document.getElementById("settingsLinkAllTasks")?.checked;
      const showDurationOnBar = !!document.getElementById("settingsShowDurationOnBar")?.checked;
      if (linkAllTasks && typeof applyLinkAllTasks === "function") {
        applyLinkAllTasks();
        if (typeof saveTasks === "function") saveTasks();
      } else if (!linkAllTasks && typeof clearAllTaskDependencies === "function") {
        clearAllTaskDependencies();
        if (typeof saveTasks === "function") saveTasks();
      }
      // When project start date changes, shift all tasks by the same delta so they stay relative to phases
      const oldProjectStart = getProjectStartDate();
      const newProjectStart = (function() {
        if (!projectStartDateRaw || typeof projectStartDateRaw !== "string") return null;
        const parts = projectStartDateRaw.trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (!parts) return null;
        const d = new Date(parseInt(parts[1], 10), parseInt(parts[2], 10) - 1, parseInt(parts[3], 10));
        return isNaN(d.getTime()) ? null : d;
      })();
      if (newProjectStart && tasks.some(function(t) { return t.startDate && t.endDate; })) {
        var refStart = oldProjectStart;
        if (!refStart) {
          var minTaskStart = null;
          tasks.forEach(function(t) {
            if (t.startDate && (!minTaskStart || t.startDate.getTime() < minTaskStart.getTime())) minTaskStart = t.startDate;
          });
          if (minTaskStart) {
            refStart = new Date(minTaskStart.getFullYear(), minTaskStart.getMonth(), minTaskStart.getDate());
            refStart.setDate(refStart.getDate() - refStart.getDay());
          }
        }
        if (refStart && newProjectStart.getTime() !== refStart.getTime()) {
          var deltaMs = newProjectStart.getTime() - refStart.getTime();
          tasks.forEach(function(t) {
            if (t.startDate && t.endDate) {
              t.startDate = new Date(t.startDate.getTime() + deltaMs);
              t.endDate = new Date(t.endDate.getTime() + deltaMs);
              t.start = formatDate(t.startDate);
              t.end = formatDate(t.endDate);
            }
          });
          saveTasks();
        }
      }
      if (phaseDurationMode === "fixed" && moveTasksWhenSprintExtended && PHASES.length === phases.length) {
        const base = getProjectStartDate() || WEEK_START;
        const baseMs = new Date(base.getFullYear(), base.getMonth(), base.getDate()).getTime();
        const DAY_MS = 24 * 60 * 60 * 1000;
        const SPRINT_DAYS = 14;
        const oldStartsDays = [];
        let cum = 0;
        for (let i = 0; i < PHASES.length; i++) {
          oldStartsDays.push(cum);
          cum += (Math.max(1, parseInt(PHASES[i].sprints, 10) || 2) * SPRINT_DAYS);
        }
        oldStartsDays.push(cum);
        let anyShifted = false;
        tasks.forEach(t => {
          if (!t.startDate || !t.endDate) return;
          const taskStartDays = (t.startDate.getTime() - baseMs) / DAY_MS;
          let phaseIdx = 0;
          for (let i = 0; i < oldStartsDays.length - 1; i++) {
            if (taskStartDays >= oldStartsDays[i]) phaseIdx = i;
          }
          let shiftDays = 0;
          for (let k = 0; k < phaseIdx; k++) {
            const oldS = Math.max(1, parseInt(PHASES[k].sprints, 10) || 2);
            const newS = Math.max(1, parseInt(phases[k].sprints, 10) || 2);
            shiftDays += Math.max(0, (newS - oldS) * SPRINT_DAYS);
          }
          if (shiftDays > 0) {
            anyShifted = true;
            t.startDate = new Date(t.startDate.getTime() + shiftDays * DAY_MS);
            t.endDate = new Date(t.endDate.getTime() + shiftDays * DAY_MS);
            t.start = formatDate(t.startDate);
            t.end = formatDate(t.endDate);
          }
        });
        if (anyShifted) saveTasks();
      }
      const partyListContainer = document.getElementById("settingsResponsiblePartiesList");
      let responsibleParties = [];
      if (partyListContainer) {
        const spans = partyListContainer.querySelectorAll(".settings-party-item span");
        responsibleParties = [...spans].map(function(sp) { return (sp.textContent || "").trim(); }).filter(Boolean);
      }
      saveProjectSettings({ ...s, title, description: desc, phases, paletteIndex, dependencyGapDays, rowAppearance, strokeMode, showDurationOnBar, projectStartDate, projectEndDate, phaseDurationMode, snapToSprint, moveTasksWhenSprintExtended, allowIndependentDependencies, linkAllTasks, responsibleParties, emptyStateDismissed: true });
      if (currentProjectId) ensureProjectInList(currentProjectId, title);
      applyRowAppearance();
      if (typeof updateEmptyState === "function") updateEmptyState();
      PHASES = phases.map(p => ({ ...p, sprints: p.sprints ?? 2 }));
      const allPalettes = [...COLOR_PALETTES, ...loadCustomPalettes()];
      const palette = allPalettes[paletteIndex];
      if (palette?.colors) PHASES.forEach((p, i) => { if (palette.colors[i]) p.color = palette.colors[i]; });
      const titleEl = document.getElementById("pageTitle");
      const descEl = document.getElementById("pageDescription");
      if (titleEl) titleEl.textContent = title;
      if (descEl) descEl.textContent = desc;
      tasks.forEach((_, i) => { if (tasks.some(t => t.dependsOn === i)) propagateDependencyChanges(i); });
      if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
      if (typeof updateChartRange === "function") updateChartRange();

      // Apply storage settings only when Storage tab was the active tab in the sidebar
      var storageTabActive = !!document.querySelector('.settings-tab[data-tab="storage"].active');
      var selectedTile = storageTabActive && document.querySelector('.storage-type-tile.selected');
      var selectedType = selectedTile ? selectedTile.dataset.value : null;
      if (selectedType && typeof setStorageMode === "function") {
        var prevMode = typeof getStorageMode === "function" ? getStorageMode() : null;
        var prevUrl, prevToken;
        try { prevUrl = localStorage.getItem(SHARED_FILE_URL_KEY); prevToken = localStorage.getItem(GITHUB_TOKEN_KEY); } catch (e) {}
        if (selectedType === "github") {
          if (prevMode === "supabase" && window.ganttStorage?.signOut) { window.ganttStorage.signOut().catch(function () {}); }
          var urlEl = document.getElementById("sharedFileUrl");
          var tokenEl = document.getElementById("sharedFileGitHubToken");
          try {
            if (urlEl && (urlEl.value || "").trim()) localStorage.setItem(SHARED_FILE_URL_KEY, urlEl.value.trim());
            if (tokenEl && (tokenEl.value || "").trim()) localStorage.setItem(GITHUB_TOKEN_KEY, tokenEl.value.trim());
          } catch (e) {}
          setStorageMode("github");
          if (typeof applyStorageModeUI === "function") applyStorageModeUI("github");
          currentProjectId = null;
          if (typeof location !== "undefined") location.hash = "#/";
          if (typeof handleRoute === "function") handleRoute();
          if (typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
          else if (typeof window.__fetchSharedUpdates === "function") window.__fetchSharedUpdates();
        } else if (selectedType === "supabase") {
          setStorageMode("supabase");
          if (typeof applyStorageModeUI === "function") applyStorageModeUI("supabase");
        } else if (selectedType === "local_storage" || selectedType === "local_cache") {
          if (prevMode === "supabase" && window.ganttStorage?.signOut) { window.ganttStorage.signOut().catch(function () {}); }
          if (selectedType === "local_cache") {
            try { localStorage.removeItem(SHARED_FILE_URL_KEY); localStorage.removeItem(GITHUB_TOKEN_KEY); } catch (e) {}
            if (typeof clearLocalProjectData === "function") clearLocalProjectData();
          }
          setStorageMode(selectedType);
          if (typeof applyStorageModeUI === "function") applyStorageModeUI(selectedType);
          currentProjectId = null;
          if (typeof location !== "undefined") location.hash = "#/";
          if (typeof handleRoute === "function") handleRoute();
        }
        if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
        if (typeof showToast === "function" && typeof getStorageModeLabel === "function") {
          showToast("Storage changed to " + getStorageModeLabel(selectedType), {
            onUndo: function () {
              try {
                if (prevMode === "github" && prevUrl) localStorage.setItem(SHARED_FILE_URL_KEY, prevUrl);
                if (prevMode === "github" && prevToken) localStorage.setItem(GITHUB_TOKEN_KEY, prevToken);
                if (selectedType === "local_cache" && prevMode !== "github") {
                  try { if (prevUrl) localStorage.setItem(SHARED_FILE_URL_KEY, prevUrl); if (prevToken) localStorage.setItem(GITHUB_TOKEN_KEY, prevToken); } catch (e) {}
                }
              } catch (e) {}
              setStorageMode(prevMode || "local_cache");
              if (typeof applyStorageModeUI === "function") applyStorageModeUI(prevMode || "local_cache");
              currentProjectId = null;
              if (typeof location !== "undefined") location.hash = "#/";
              if (typeof handleRoute === "function") handleRoute();
              if (prevMode === "github" && typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
              if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
            }
          });
        }
      }

      closeSettingsModal();
    }

    function getProjectDescription(projectId) {
      if (window.ganttStorage?.isCloudEnabled()) {
        const s = window.ganttStorage.loadSettings(projectId);
        if (s && typeof s.description === "string") return s.description.trim();
      }
      try {
        const raw = localStorage.getItem("gantt-settings-" + projectId);
        if (!raw) return "";
        const s = JSON.parse(raw);
        return (s.description && typeof s.description === "string") ? s.description.trim() : "";
      } catch { return ""; }
    }
    async function saveProjectTitleDescription(projectId, title, description) {
      if (window.ganttStorage?.isCloudEnabled()) {
        await window.ganttStorage.ensureBoardDataLoaded(projectId);
        const s = window.ganttStorage.loadSettings(projectId) || {};
        s.title = title != null ? String(title).trim() : "";
        s.description = description != null ? String(description).trim() : "";
        window.ganttStorage.saveSettings(projectId, s);
        return;
      }
      try {
        const raw = localStorage.getItem("gantt-settings-" + projectId);
        const s = raw ? JSON.parse(raw) : {};
        s.title = title != null ? String(title).trim() : "";
        s.description = description != null ? String(description).trim() : "";
        localStorage.setItem("gantt-settings-" + projectId, JSON.stringify(s));
        if (window.notifySharedDataChanged) window.notifySharedDataChanged();
      } catch (e) { console.warn("Could not save project title/description:", e); }
    }
    function getProjectTaskCount(projectId) {
      if (window.ganttStorage?.isCloudEnabled()) {
        const arr = window.ganttStorage.loadTasks(projectId);
        if (Array.isArray(arr)) return arr.length;
      }
      try {
        const raw = localStorage.getItem("gantt-tasks-" + projectId);
        if (!raw) return 0;
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.length : 0;
      } catch { return 0; }
    }
    function getProjectCurrentTaskCount(projectId) {
      if (window.ganttStorage?.isCloudEnabled()) {
        const arr = window.ganttStorage.loadTasks(projectId);
        if (!Array.isArray(arr)) return 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();
        return arr.filter((t) => {
          if (!t.startDate || !t.endDate) return false;
          const start = new Date(t.startDate);
          const end = new Date(t.endDate);
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          return todayMs >= start.getTime() && todayMs <= end.getTime();
        }).length;
      }
      try {
        const raw = localStorage.getItem("gantt-tasks-" + projectId);
        if (!raw) return 0;
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();
        return arr.filter((t) => {
          if (!t.startDate || !t.endDate) return false;
          const start = new Date(t.startDate);
          const end = new Date(t.endDate);
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);
          return todayMs >= start.getTime() && todayMs <= end.getTime();
        }).length;
      } catch { return 0; }
    }
    function toTitleCase(str) {
      if (!str || typeof str !== "string") return str;
      return str.replace(/\w\S*/g, t => t.charAt(0).toUpperCase() + t.slice(1).toLowerCase());
    }
    function parseProjectStartFromSettings(s) {
      const raw = s?.projectStartDate;
      if (!raw || typeof raw !== "string") return null;
      const parts = raw.trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (!parts) return null;
      const d = new Date(parseInt(parts[1], 10), parseInt(parts[2], 10) - 1, parseInt(parts[3], 10));
      return isNaN(d.getTime()) ? null : d;
    }
    function startOfWeek(date) {
      const d = new Date(date);
      d.setDate(d.getDate() - d.getDay());
      d.setHours(0, 0, 0, 0);
      return d;
    }
    function getProjectCurrentPhase(projectId) {
      try {
        const tasksRaw = localStorage.getItem("gantt-tasks-" + projectId);
        const settingsRaw = localStorage.getItem("gantt-settings-" + projectId);
        const taskList = tasksRaw ? JSON.parse(tasksRaw) : [];
        const tasks = Array.isArray(taskList) ? taskList : [];
        const s = settingsRaw ? JSON.parse(settingsRaw) : null;
        const phases = (s?.phases && Array.isArray(s.phases)) ? s.phases : DEFAULT_PHASES.map(p => ({ ...p }));
        if (phases.length === 0) return null;
        const mode = (s?.phaseDurationMode === "dynamic") ? "dynamic" : "fixed";
        const projectStart = parseProjectStartFromSettings(s);
        const WEEK_MS_LOCAL = 7 * 24 * 60 * 60 * 1000;
        let baseDate = null;
        if (mode === "fixed" && projectStart) {
          baseDate = startOfWeek(projectStart);
        } else if (tasks.length > 0) {
          let minStart = null;
          tasks.forEach(t => {
            const start = t.startDate ? new Date(t.startDate) : null;
            if (start && (!minStart || start.getTime() < minStart.getTime())) minStart = start;
          });
          baseDate = minStart ? startOfWeek(minStart) : startOfWeek(new Date());
        } else {
          baseDate = projectStart ? startOfWeek(projectStart) : startOfWeek(new Date());
        }
        const phaseSpansWeeks = [];
        for (let i = 0; i < phases.length; i++) {
          const p = phases[i];
          if (mode === "fixed") {
            const sprints = Math.max(1, parseInt(p.sprints, 10) || 2);
            phaseSpansWeeks.push(sprints * 2);
          } else {
            const inPhase = tasks.filter(t => (t.phase || p.id) === p.id && t.startDate && t.endDate);
            if (inPhase.length === 0) phaseSpansWeeks.push(1);
            else {
              const minS = Math.min(...inPhase.map(t => new Date(t.startDate).getTime()));
              const maxE = Math.max(...inPhase.map(t => new Date(t.endDate).getTime()));
              phaseSpansWeeks.push(Math.max(1, Math.floor((maxE - minS) / WEEK_MS_LOCAL) + 1));
            }
          }
        }
        let cumulative = 0;
        const phaseRanges = phaseSpansWeeks.map((span, i) => {
          const startMs = baseDate.getTime() + cumulative * WEEK_MS_LOCAL;
          cumulative += span;
          const endMs = baseDate.getTime() + cumulative * WEEK_MS_LOCAL;
          return { startMs, endMs };
        });
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();
        let phaseIndex = 0;
        for (let i = 0; i < phaseRanges.length; i++) {
          if (todayMs >= phaseRanges[i].startMs && todayMs < phaseRanges[i].endMs) {
            phaseIndex = i;
            break;
          }
          if (todayMs < phaseRanges[i].startMs) break;
          phaseIndex = i;
        }
        const phase = phases[phaseIndex];
        const name = phase.name ? toTitleCase(phase.name) : toTitleCase(phase.id);
        const color = phase.color || "#737373";
        return { name, color };
      } catch { return null; }
    }
    const HOME_TITLE_KEY = "gantt-home-title";
    const HOME_DESC_KEY = "gantt-home-description";
    const HOME_TIMELINE_PREVIEWS_KEY = "gantt-home-timeline-previews";
    const DEFAULT_HOME_TITLE = "Boards";
    const DEFAULT_HOME_DESC = "Create and open boards. Each board has its own tasks and settings.";
    let homePageHeaderInited = false;
    function initHomePageHeader() {
      const titleEl = document.getElementById("homePageTitle");
      const descEl = document.getElementById("homePageDescription");
      if (!titleEl || !descEl) return;
      if (homePageHeaderInited) return;
      homePageHeaderInited = true;
      const savedTitle = localStorage.getItem(HOME_TITLE_KEY);
      const savedDesc = localStorage.getItem(HOME_DESC_KEY);
      titleEl.textContent = (savedTitle != null && savedTitle !== "") ? savedTitle : DEFAULT_HOME_TITLE;
      descEl.textContent = (savedDesc != null && savedDesc !== "") ? savedDesc : DEFAULT_HOME_DESC;
    }
    var _renderHomeViewTimer = null;
    var _renderHomeViewDebounceMs = 50;
    function renderHomeView() {
      if (_renderHomeViewTimer) clearTimeout(_renderHomeViewTimer);
      _renderHomeViewTimer = setTimeout(function () {
        _renderHomeViewTimer = null;
        renderHomeViewImmediate();
      }, _renderHomeViewDebounceMs);
    }
    function buildOneProjectCard(p) {
      const isEditMode = p.id === homeEditProjectId;
      const card = document.createElement("div");
      card.setAttribute("data-project-id", p.id);
      card.className = "home-project-card" + (isEditMode ? " edit-mode" : "");
      if (!isEditMode) {
        card.addEventListener("click", (e) => {
          if (e.target.closest(".home-project-delete-btn") || e.target.closest(".home-project-duplicate-btn")) return;
          location.hash = getProjectUrl(p);
        });
      }
      let showPreviews = true;
      try { showPreviews = localStorage.getItem(HOME_TIMELINE_PREVIEWS_KEY) !== "false"; } catch (e) {}
      if (showPreviews) {
        const previewWrap = document.createElement("div");
        previewWrap.className = "home-project-timeline-preview" + (isEditMode ? " home-timeline-empty" : "");
        if (isEditMode) {
          const caption = document.createElement("span");
          caption.className = "home-timeline-preview-caption";
          caption.textContent = "Preview will load once tasks have been added.";
          previewWrap.appendChild(caption);
        } else {
          const loadPreview = () => renderHomeTimelinePreview(p.id, previewWrap);
          if (window.ganttStorage?.isCloudEnabled()) {
            window.ganttStorage.ensureBoardDataLoaded(p.id).then(() => {
              setTimeout(loadPreview, 350);
            });
          } else {
            requestAnimationFrame(() => requestAnimationFrame(loadPreview));
          }
        }
        card.appendChild(previewWrap);
      }
      const body = document.createElement("div");
      body.className = "home-project-card-body";
      const info = document.createElement("div");
      info.className = "home-project-info";
      if (isEditMode) {
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "home-project-name-input";
        nameInput.placeholder = "Board name";
        nameInput.value = p.name || "Untitled board";
        nameInput.addEventListener("click", (e) => e.stopPropagation());
        info.appendChild(nameInput);
        const descInput = document.createElement("textarea");
        descInput.className = "home-project-desc-input";
        descInput.placeholder = "Description (optional)";
        descInput.value = getProjectDescription(p.id);
        descInput.addEventListener("click", (e) => e.stopPropagation());
        info.appendChild(descInput);
      } else {
        const name = document.createElement("div");
        name.className = "home-project-name";
        name.textContent = p.name || "Untitled board";
        info.appendChild(name);
        const desc = getProjectDescription(p.id);
        if (desc) {
          const descEl = document.createElement("div");
          descEl.className = "home-project-description";
          descEl.textContent = desc;
          info.appendChild(descEl);
        }
        const countRow = document.createElement("div");
        countRow.className = "home-project-row";
        const total = getProjectTaskCount(p.id);
        const current = getProjectCurrentTaskCount(p.id);
        const countEl = document.createElement("span");
        countEl.className = "home-project-task-count";
        if (total === 0) {
          countEl.textContent = "No tasks";
        } else {
          const taskWord = total === 1 ? "task" : "tasks";
          countEl.textContent = current + " current / " + total + " " + taskWord;
        }
        countRow.appendChild(countEl);
        info.appendChild(countRow);
      }
      body.appendChild(info);
      card.appendChild(body);
      const footer = document.createElement("div");
      footer.className = "home-project-card-footer";
      const storageMode = typeof getStorageMode === "function" ? getStorageMode() : null;
      const isLocalMode = storageMode === "local_storage" || storageMode === "local_cache";
      const isLocal = !window.ganttStorage?.isCloudEnabled();
      let hasSharedUrl = false;
      try { var u = localStorage.getItem(SHARED_FILE_URL_KEY); hasSharedUrl = !!(u && u.trim()); } catch (e) {}
      if ((isLocalMode || (isLocal && !hasSharedUrl)) && !isEditMode) {
        const localTag = document.createElement("span");
        localTag.className = "home-project-local-tag";
        localTag.textContent = "Local";
        localTag.title = "Stored locally. Data will be erased if browser cache or site data is cleared.";
        footer.appendChild(localTag);
      }
      const phaseInfo = !isEditMode ? getProjectCurrentPhase(p.id) : null;
      if (phaseInfo) {
        const tag = document.createElement("span");
        tag.className = "home-project-phase-tag";
        tag.textContent = phaseInfo.name;
        tag.style.backgroundColor = hexToRgba(phaseInfo.color, 0.16);
        tag.style.color = phaseInfo.color;
        tag.style.borderColor = phaseInfo.color;
        tag.style.borderWidth = "1px";
        tag.style.borderStyle = "solid";
        footer.appendChild(tag);
      }
      const footerActions = document.createElement("div");
      footerActions.className = "home-project-footer-actions";
      var canWrite = typeof window.hasWriteAccess === "function" && window.hasWriteAccess();
      if (isEditMode && canWrite) {
        const doneBtn = document.createElement("button");
        doneBtn.type = "button";
        doneBtn.className = "home-project-done-btn";
        doneBtn.textContent = "Done";
        doneBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const nameVal = card.querySelector(".home-project-name-input").value.trim() || "Untitled board";
          const descVal = card.querySelector(".home-project-desc-input").value.trim();
          if (isProjectNameTaken(nameVal, p.id)) {
            if (typeof showToast === "function") showToast("Duplicate board name. Each board must have a unique name—please choose a different name.", { type: "error" });
            return;
          }
          ensureProjectInList(p.id, nameVal);
          await saveProjectTitleDescription(p.id, nameVal, descVal);
          homeEditProjectId = null;
          var listElDone = document.getElementById("homeProjectList");
          if (listElDone && card && card.parentNode === listElDone) {
            var updated = loadProjectsList().find(function (pr) { return pr.id === p.id; });
            if (updated) {
              card.remove();
              listElDone.appendChild(buildOneProjectCard(updated));
            } else {
              renderHomeView();
            }
          } else {
            renderHomeView();
          }
        });
        footerActions.appendChild(doneBtn);
      } else if (canWrite) {
        const duplicateBtn = document.createElement("button");
        duplicateBtn.type = "button";
        duplicateBtn.className = "home-project-action-btn home-project-duplicate-btn";
        duplicateBtn.title = "Duplicate board";
        duplicateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        duplicateBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
          await duplicateProject(p.id);
        });
        footerActions.appendChild(duplicateBtn);
      }
      if (canWrite) {
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "home-project-delete-btn";
        deleteBtn.title = "Delete this project";
        deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>';
        deleteBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
          if (!confirm("Delete this board? Tasks and settings will be removed. This cannot be undone.")) return;
          pushProjectsListUndo();
          if (p.id === homeEditProjectId) homeEditProjectId = null;
          if (window.ganttStorage?.isCloudEnabled()) {
            await window.ganttStorage.deleteBoard(p.id);
            if (currentProjectId === p.id) {
              currentProjectId = null;
              location.hash = "#/";
              return;
            }
            var listElDel = document.getElementById("homeProjectList");
            var homeActive = document.getElementById("homeView")?.classList.contains("active");
            if (homeActive && listElDel) {
              var cardEl = listElDel.querySelector("[data-project-id=\"" + p.id + "\"]");
              if (cardEl) cardEl.remove();
              var projectsLeft = loadProjectsList();
              var badgeDel = document.getElementById("homeProjectCountBadge");
              if (badgeDel) badgeDel.textContent = String(projectsLeft.length);
              if (projectsLeft.length === 0) renderHomeView();
            } else {
              renderHomeView();
            }
            return;
          }
          const list = loadProjectsList().filter(proj => proj.id !== p.id);
          saveProjectsList(list);
          try {
            localStorage.removeItem("gantt-tasks-" + p.id);
            localStorage.removeItem("gantt-settings-" + p.id);
            localStorage.removeItem("gantt-view-" + p.id);
            localStorage.removeItem("gantt-custom-palettes-" + p.id);
          } catch (err) {}
          var listElLocal = document.getElementById("homeProjectList");
          var homeActiveLocal = document.getElementById("homeView")?.classList.contains("active");
          if (homeActiveLocal && listElLocal) {
            var cardElLocal = listElLocal.querySelector("[data-project-id=\"" + p.id + "\"]");
            if (cardElLocal) cardElLocal.remove();
            var badgeLocal = document.getElementById("homeProjectCountBadge");
            if (badgeLocal) badgeLocal.textContent = String(list.length);
            if (list.length === 0) renderHomeView();
          } else {
            renderHomeView();
          }
        });
        footerActions.appendChild(deleteBtn);
      }
      footer.appendChild(footerActions);
      card.appendChild(footer);
      return card;
    }
    function renderHomeViewImmediate() {
      const listEl = document.getElementById("homeProjectList");
      if (!listEl) return;
      if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) homeEditProjectId = null;
      initHomePageHeader();
      const projects = loadProjectsList();
      const badgeEl = document.getElementById("homeProjectCountBadge");
      if (badgeEl) badgeEl.textContent = String(projects.length);
      listEl.innerHTML = "";
      if (projects.length === 0) {
        const emptyWrap = document.createElement("div");
        emptyWrap.className = "home-empty-state";
        emptyWrap.setAttribute("aria-live", "polite");
        const canWrite = typeof window.hasWriteAccess === "function" && window.hasWriteAccess();
        const cloudEnabled = window.ganttStorage?.isCloudEnabled();
        const emptyIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg>';
        const linkedIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/></svg>';
        const sharedIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"/></svg>';
        const excelIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 12l3 3m0 0 3-3m-3 3V2.25"/></svg>';
        const sharedBtn = (canWrite && cloudEnabled) ? '<button type="button" class="home-empty-state-action-btn" data-action="shared" aria-label="Shared board"><span class="home-empty-state-action-icon" aria-hidden="true">' + sharedIcon + '</span><span class="home-empty-state-action-text"><span class="home-empty-state-action-label">Shared</span><span class="home-empty-state-action-desc">Collaborate in realtime with your team</span></span></button>' : '';
        const excelBtn = '<button type="button" class="home-empty-state-action-btn" data-action="excel" aria-label="Excel sync"><span class="home-empty-state-action-icon" aria-hidden="true">' + excelIcon + '</span><span class="home-empty-state-action-text"><span class="home-empty-state-action-label">Excel sync</span><span class="home-empty-state-action-desc">Import from spreadsheet to jumpstart timeline</span></span></button>';
        const actionBtns = canWrite ? '<div class="home-empty-state-actions"><button type="button" class="home-empty-state-action-btn" data-action="scratch" aria-label="Empty board"><span class="home-empty-state-action-icon" aria-hidden="true">' + emptyIcon + '</span><span class="home-empty-state-action-text"><span class="home-empty-state-action-label">Empty</span><span class="home-empty-state-action-desc">Blank canvas for your project</span></span></button>' + sharedBtn + '<button type="button" class="home-empty-state-action-btn" data-action="linked" aria-label="Linked board"><span class="home-empty-state-action-icon" aria-hidden="true">' + linkedIcon + '</span><span class="home-empty-state-action-text"><span class="home-empty-state-action-label">Linked</span><span class="home-empty-state-action-desc">Start with some connected tasks</span></span></button>' + excelBtn + '</div>' : "";
        emptyWrap.innerHTML = '<div class="home-empty-state-visual"><span class="home-empty-state-bar bar-1" aria-hidden="true"></span><span class="home-empty-state-bar bar-2" aria-hidden="true"></span><span class="home-empty-state-bar bar-3" aria-hidden="true"></span><span class="home-empty-state-bar bar-4" aria-hidden="true"></span><div class="home-empty-state-line" aria-hidden="true"></div></div><h2 class="home-empty-state-title">You don\'t have any boards</h2><p class="home-empty-state-subtitle">Create your first one to start tracking</p>' + actionBtns;
        listEl.appendChild(emptyWrap);
        return;
      }
      projects.forEach(p => {
        const card = buildOneProjectCard(p);
        listEl.appendChild(card);
        if (card.classList.contains("edit-mode")) {
          requestAnimationFrame(() => {
            const input = card.querySelector(".home-project-name-input");
            if (input) { input.focus(); input.select(); }
          });
        }
      });
    }
    function isPlaceholderOnlyProject() {
      if (tasks.length === 0) return true;
      if (tasks.length !== 1) return false;
      const name = tasks[0]?.task == null ? "" : String(tasks[0].task).trim();
      return name === "" || name === "my first task";
    }
    function hasConfiguratorContent(s) {
      if (!s) return false;
      var title = (s.title || "").trim();
      if (title && title !== DEFAULT_PAGE_TITLE) return true;
      if (s.projectStartDate && String(s.projectStartDate).trim()) return true;
      if (s.phases && Array.isArray(s.phases) && s.phases.length > 0) return true;
      return false;
    }
    function updateEmptyState() {
      const rowEl = document.getElementById("ganttEmptyState");
      if (!rowEl) return;
      const s = loadProjectSettings();
      var readOnly = typeof window.hasWriteAccess === "function" && !window.hasWriteAccess();
      var dismissed = !!s?.emptyStateDismissed;
      if (readOnly || dismissed || !isPlaceholderOnlyProject()) {
        rowEl.classList.add("hidden");
      } else {
        rowEl.classList.remove("hidden");
        var configuratorFilled = hasConfiguratorContent(s);
        var configureBtn = document.getElementById("ganttEmptyConfigure");
        if (configureBtn) configureBtn.style.display = configuratorFilled ? "none" : "";
      }
      if (typeof updateAutoPopulateSectionVisibility === "function") updateAutoPopulateSectionVisibility();
    }
    function dismissEmptyState() {
      const s = loadProjectSettings() || {};
      if (s.emptyStateDismissed) return;
      saveProjectSettings({ ...s, emptyStateDismissed: true });
      if (typeof updateEmptyState === "function") updateEmptyState();
    }
    function updateAutoPopulateSectionVisibility() {
      var el = document.getElementById("settingsAutoPopulateSection");
      if (!el) return;
      el.classList.toggle("hidden", !isPlaceholderOnlyProject());
    }
    async function handleRoute() {
      const id = getProjectIdFromHash();
      const homeView = document.getElementById("homeView");
      const ganttView = document.getElementById("ganttView");
      if (!id) {
        if (typeof closeSettingsModal === "function") closeSettingsModal();
        currentProjectId = null;
        renderHomeView();
        const addFab = document.getElementById("addTaskFab");
        if (addFab) addFab.style.display = "none";
        document.getElementById("fabPhaseMenu")?.classList.remove("visible");
        const depLineEl = document.getElementById("ganttDependencyLine");
        if (depLineEl) depLineEl.classList.remove("visible");
        const childContainer = document.getElementById("ganttChildConnectorsContainer");
        if (childContainer) childContainer.innerHTML = "";
        const unlinkBtn = document.getElementById("ganttDependencyUnlinkBtn");
        if (unlinkBtn) unlinkBtn.classList.remove("visible");
        document.body.classList.remove("shift-mode");
        if (document._allConnectorsCleanup) {
          document._allConnectorsCleanup();
          document._allConnectorsCleanup = null;
        }
        document.querySelectorAll("body > .gantt-dependency-unlink-btn.connector-unlink-always-visible").forEach(btn => btn.remove());
        const singleLine = document.getElementById("ganttDependencyLine");
        if (singleLine) singleLine.style.visibility = "";
        const allLines = document.getElementById("ganttAllDependencyLines");
        if (allLines) allLines.classList.remove("visible");
        const ganttGrid = document.getElementById("ganttGrid");
        ganttGrid?.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(r => { r.draggable = true; });
        if (typeof window.updateWriteAccessUI === "function") window.updateWriteAccessUI();
        if (typeof applyStorageModeUI === "function") applyStorageModeUI(getStorageMode() || "local_cache");
        if (realtimeUnsubscribe) { realtimeUnsubscribe(); realtimeUnsubscribe = null; }
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            if (homeView) homeView.classList.add("active");
            if (ganttView) ganttView.classList.remove("active");
            if (document.body) document.body.classList.remove("gantt-view-active");
          });
        });
        return;
      }
      if (homeView && homeView.classList.contains("active")) { /* home title/description edited in settings only */ }
      const inviteToken = getInviteTokenFromHash();
      if (inviteToken && window.ganttStorage?.isCloudEnabled() && UUID_REGEX.test(id)) {
        const result = await window.ganttStorage.acceptBoardInvite(id, inviteToken);
        if (result && result.ok) {
          await window.ganttStorage.ensureBoardsListLoaded();
          if (typeof showToast === "function") showToast("You've been added to \"" + (result.board_name || "this board") + "\"");
          const cleanHash = "#/project/" + id;
          if (typeof location !== "undefined" && location.hash !== cleanHash) location.replace(cleanHash);
        } else if (result && !result.ok && typeof showToast === "function") {
          showToast(result.error || "Invalid or expired invite link", { type: "error" });
        }
      }
      if (realtimeUnsubscribe) { realtimeUnsubscribe(); realtimeUnsubscribe = null; }
      const avatarBar = document.getElementById("collaboratorsAvatarBar");
      if (avatarBar) avatarBar.style.display = "none";
      const sameProject = currentProjectId === id;
      currentProjectId = id;
      ensureProjectInList(id);
      if (homeView) homeView.classList.remove("active");
      if (ganttView) ganttView.classList.add("active");
      if (document.body) document.body.classList.add("gantt-view-active");
      if (!sameProject) initGantt();
      if (window.ganttStorage?.isCloudEnabled()) {
        await window.ganttStorage.ensureBoardDataLoaded(id);
        tasks = loadTasks();
        const linkAllSetting = (typeof loadProjectSettings === "function" && loadProjectSettings())?.linkAllTasks;
        if (linkAllSetting && typeof applyLinkAllTasks === "function") {
          applyLinkAllTasks();
          if (typeof saveTasks === "function") saveTasks();
        }
        if (typeof updateEmptyState === "function") updateEmptyState();
        if (typeof updateChartRange === "function") updateChartRange();
        const showPresence = UUID_REGEX.test(id);
        const subscribe = window.ganttStorage.subscribeToBoardRealtime;
        if (typeof subscribe === "function") {
          realtimeUnsubscribe = subscribe(
            id,
            () => {
              if (currentProjectId !== id) return;
              applyRealtimeBoardUpdate();
            },
            showPresence ? (state) => {
              if (currentProjectId !== id) return;
              updateCollaboratorsAvatarBar(state);
            } : undefined
          );
        }
        if (showPresence) {
          var session = await window.ganttStorage.getSession();
          if (session && session.user) {
            var u = session.user;
            var email = u.email || "";
            var parts = (email.split("@")[0] || "").match(/[a-zA-Z]+/g) || [];
            var initials = ((parts[0]?.[0] || "") + (parts[1]?.[0] || parts[0]?.[1] || "") || "?").toUpperCase();
            updateCollaboratorsAvatarBar(null, { user_id: u.id, email: email, initials: initials, avatar_url: u.user_metadata?.avatar_url || u.user_metadata?.picture || null });
          }
        }
      }
      if (typeof window.updateWriteAccessUI === "function") window.updateWriteAccessUI();
      else {
        var addFab = document.getElementById("addTaskFab");
        if (addFab) addFab.style.display = "";
      }
    }
    var projectSetupCurrentStep = 1;
    function openProjectSetupModal() {
      var overlay = document.getElementById("projectSetupOverlay");
      if (!overlay) return;
      var header = loadPageHeader();
      var s = loadProjectSettings() || {};
      document.getElementById("projectSetupName").value = header.title || "";
      document.getElementById("projectSetupDesc").value = header.description || "";
      function toYYYYMMDD(raw) {
        if (!raw || typeof raw !== "string") return "";
        var trimmed = String(raw).trim();
        var ymd = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (ymd) return trimmed;
        var d = new Date(trimmed);
        if (isNaN(d.getTime())) return "";
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, "0");
        var day = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + day;
      }
      var startVal = s.projectStartDate ? toYYYYMMDD(s.projectStartDate) : "";
      if (!startVal && currentProjectId) {
        var projects = loadProjectsList() || [];
        var proj = projects.find(function (p) { return p.id === currentProjectId; });
        if (proj && proj.createdAt != null) {
          var d = new Date(proj.createdAt);
          startVal = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
        }
      }
      document.getElementById("projectSetupStartDate").value = startVal || "";
      var endVal = s.projectEndDate ? toYYYYMMDD(s.projectEndDate) : "";
      document.getElementById("projectSetupEndDate").value = endVal || "";
      var phases = (s.phases && s.phases.length > 0) ? s.phases : DEFAULT_PHASES.map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373", sprints: 2 }; });
      var phaseList = document.getElementById("projectSetupPhases");
      var phaseDurationSelect = document.getElementById("projectSetupPhaseDurationMode");
      var phaseMode = (s?.phaseDurationMode === "dynamic") ? "dynamic" : "fixed";
      if (phaseDurationSelect) phaseDurationSelect.value = phaseMode;
      if (phaseList) {
        phaseList.setAttribute("data-phase-mode", phaseMode);
        phaseList.innerHTML = "";
        if (phaseList.getAttribute("data-phase-mode") === "fixed") {
          var header = document.createElement("div");
          header.className = "settings-phase-list-header";
          var headerPhase = document.createElement("div");
          headerPhase.className = "settings-phase-list-header-phase";
          headerPhase.textContent = "Phases";
          header.appendChild(headerPhase);
          var headerSprints = document.createElement("div");
          headerSprints.className = "settings-phase-list-header-sprints";
          headerSprints.textContent = "Sprints";
          header.appendChild(headerSprints);
          phaseList.appendChild(header);
        }
        function renderSetupPhaseItem(p) {
          var item = document.createElement("div");
          item.className = "settings-phase-item";
          item.dataset.phaseId = p.id;
          item.draggable = true;
          var inputWrap = document.createElement("div");
          inputWrap.className = "settings-phase-input-wrap";
          var colorInp = document.createElement("input");
          colorInp.type = "color";
          colorInp.className = "settings-phase-swatch";
          colorInp.value = p.color || "#737373";
          var inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = "Phase name";
          inp.value = p.name || "";
          var removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "settings-phase-remove";
          removeBtn.textContent = "\u2212";
          removeBtn.title = "Remove phase";
          removeBtn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
          removeBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            item.remove();
            phaseList.querySelectorAll(".settings-phase-remove").forEach(function (btn) {
              btn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
            });
          });
          inputWrap.appendChild(colorInp);
          inputWrap.appendChild(inp);
          inputWrap.appendChild(removeBtn);
          var sprintsWrap = document.createElement("div");
          sprintsWrap.className = "settings-phase-sprints";
          var sprintsInner = document.createElement("div");
          sprintsInner.className = "settings-phase-sprints-inner";
          var sprintsVal = Math.max(1, Math.min(52, parseInt(p.sprints, 10) || 2));
          var sprintsInp = document.createElement("input");
          sprintsInp.type = "number";
          sprintsInp.min = "1";
          sprintsInp.max = "52";
          sprintsInp.value = sprintsVal;
          var minusBtn = document.createElement("button");
          minusBtn.type = "button";
          minusBtn.className = "settings-phase-sprints-stepper-btn";
          minusBtn.textContent = "\u2212";
          minusBtn.title = "Decrease sprints";
          var plusBtn = document.createElement("button");
          plusBtn.type = "button";
          plusBtn.className = "settings-phase-sprints-stepper-btn";
          plusBtn.textContent = "+";
          plusBtn.title = "Increase sprints";
          function updateStepperState() {
            var v = Math.max(1, Math.min(52, parseInt(sprintsInp.value, 10) || 2));
            sprintsInp.value = v;
            minusBtn.disabled = v <= 1;
            plusBtn.disabled = v >= 52;
          }
          minusBtn.addEventListener("click", function () { sprintsInp.value = Math.max(1, (parseInt(sprintsInp.value, 10) || 2) - 1); updateStepperState(); });
          plusBtn.addEventListener("click", function () { sprintsInp.value = Math.min(52, (parseInt(sprintsInp.value, 10) || 2) + 1); updateStepperState(); });
          sprintsInp.addEventListener("change", updateStepperState);
          sprintsInner.appendChild(minusBtn);
          sprintsInner.appendChild(sprintsInp);
          sprintsInner.appendChild(plusBtn);
          sprintsWrap.appendChild(sprintsInner);
          item.appendChild(inputWrap);
          item.appendChild(sprintsWrap);
          phaseList.appendChild(item);
          updateStepperState();
        }
        phases.forEach(renderSetupPhaseItem);
        phaseList.querySelectorAll(".settings-phase-remove").forEach(function (btn) {
          btn.disabled = phaseList.querySelectorAll(".settings-phase-item").length < 2;
        });
        if (typeof projectSetupInitPhaseDrag === "function") projectSetupInitPhaseDrag(phaseList);
      }
      var teamList = document.getElementById("projectSetupTeamList");
      if (teamList) {
        teamList.innerHTML = "";
        var parties = Array.isArray(s.responsibleParties) ? s.responsibleParties : [];
        parties.forEach(function (name) {
          var item = document.createElement("div");
          item.className = "settings-party-item";
          var span = document.createElement("span");
          span.textContent = name;
          var removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", function () { item.remove(); });
          item.appendChild(span);
          item.appendChild(removeBtn);
          teamList.appendChild(item);
        });
      }
      projectSetupCurrentStep = 1;
      document.querySelectorAll(".project-setup-step").forEach(function (el) { el.style.display = "none"; });
      document.getElementById("projectSetupStep1").style.display = "block";
      var setupTitleEl = document.getElementById("projectSetupTitle");
      if (setupTitleEl && typeof projectSetupStepTitles !== "undefined" && projectSetupStepTitles[1]) setupTitleEl.textContent = projectSetupStepTitles[1];
      document.querySelectorAll(".project-setup-progress-dot").forEach(function (dot) {
        dot.removeAttribute("aria-current");
        if (parseInt(dot.getAttribute("data-step"), 10) === 1) dot.setAttribute("aria-current", "true");
      });
      document.getElementById("projectSetupBack").style.display = "none";
      document.getElementById("projectSetupNext").style.display = "";
      document.getElementById("projectSetupNext").textContent = "Next";
      overlay.style.display = "flex";
      overlay.classList.add("visible");
      overlay.setAttribute("aria-hidden", "false");
    }
    function closeProjectSetupModal() {
      var overlay = document.getElementById("projectSetupOverlay");
      if (overlay) {
        overlay.style.display = "";
        overlay.classList.remove("visible");
        overlay.setAttribute("aria-hidden", "true");
      }
    }
    var projectSetupStepTitles = { 1: "Name your project", 2: "Project dates", 3: "Phases & sprints", 4: "Team members" };
    function projectSetupShowStep(step) {
      projectSetupCurrentStep = step;
      document.querySelectorAll(".project-setup-step").forEach(function (el) { el.style.display = "none"; });
      var stepEl = document.getElementById("projectSetupStep" + step);
      if (stepEl) stepEl.style.display = "block";
      var titleEl = document.getElementById("projectSetupTitle");
      if (titleEl && projectSetupStepTitles[step]) titleEl.textContent = projectSetupStepTitles[step];
      document.querySelectorAll(".project-setup-progress-dot").forEach(function (dot) {
        var n = parseInt(dot.getAttribute("data-step"), 10);
        if (n === step) dot.setAttribute("aria-current", "true"); else dot.removeAttribute("aria-current");
      });
      document.getElementById("projectSetupBack").style.display = (step === 1) ? "none" : "";
      var skipBtn = document.getElementById("projectSetupSkip");
      if (skipBtn) skipBtn.style.display = (step === 1) ? "" : "none";
      var nextBtn = document.getElementById("projectSetupNext");
      if (nextBtn) nextBtn.textContent = (step === 4) ? "Finish" : "Next";
    }
    function projectSetupSaveAndClose() {
      var title = (document.getElementById("projectSetupName").value || "").trim() || DEFAULT_PAGE_TITLE;
      var desc = (document.getElementById("projectSetupDesc").value || "").trim() || DEFAULT_PAGE_DESCRIPTION;
      var startRaw = (document.getElementById("projectSetupStartDate").value || "").trim();
      var projectStartDate = startRaw || null;
      var endRaw = (document.getElementById("projectSetupEndDate").value || "").trim();
      var projectEndDate = endRaw || null;
      var phases = [];
      document.querySelectorAll("#projectSetupPhases .settings-phase-item").forEach(function (row, i) {
        var nameInp = row.querySelector(".settings-phase-input-wrap input[type=\"text\"]");
        var colorInp = row.querySelector(".settings-phase-swatch");
        var sprintsInp = row.querySelector(".settings-phase-sprints input[type=\"number\"]");
        var name = (nameInp && nameInp.value || "").trim() || "Phase " + (i + 1);
        var color = (colorInp && colorInp.value) || "#737373";
        var sprints = (sprintsInp && parseInt(sprintsInp.value, 10)) || 2;
        var id = row.dataset.phaseId || name.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "") || "phase-" + (i + 1);
        phases.push({ id: id, name: name, color: color, sprints: Math.max(1, Math.min(52, sprints)) });
      });
      if (phases.length === 0) phases = DEFAULT_PHASES.map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373", sprints: 2 }; });
      var responsibleParties = [];
      document.querySelectorAll("#projectSetupTeamList .settings-party-item span").forEach(function (span) {
        var t = (span.textContent || "").trim();
        if (t) responsibleParties.push(t);
      });
      var phaseDurationMode = (document.getElementById("projectSetupPhaseDurationMode")?.value === "dynamic") ? "dynamic" : "fixed";
      var s = loadProjectSettings() || {};
      saveProjectSettings({ ...s, title: title, description: desc, projectStartDate: projectStartDate, projectEndDate: projectEndDate, phases: phases, phaseDurationMode: phaseDurationMode, responsibleParties: responsibleParties, onboardingComplete: true });
      if (currentProjectId) ensureProjectInList(currentProjectId, title);
      PHASES = phases.map(function (p) { return { ...p, sprints: p.sprints ?? 2 }; });
      var titleEl = document.getElementById("pageTitle");
      var descEl = document.getElementById("pageDescription");
      if (titleEl) titleEl.textContent = title;
      if (descEl) descEl.textContent = desc;
      if (typeof applyRowAppearance === "function") applyRowAppearance();
      if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
      if (typeof updateChartRange === "function") updateChartRange();
      if (typeof updateEmptyState === "function") updateEmptyState();
      closeProjectSetupModal();
    }
    function projectSetupInitPhaseDrag(container) {
      if (!container) return;
      var dragged = null;
      var itemSel = ".settings-phase-item";
      container.addEventListener("dragstart", function (e) {
        var row = e.target.closest(itemSel);
        if (!row || e.target.closest("input") || e.target.closest(".settings-phase-remove") || e.target.closest(".settings-phase-sprints-stepper-btn")) return;
        dragged = row;
        row.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", row.dataset.phaseId || "");
      });
      container.addEventListener("dragend", function (e) {
        if (dragged) dragged.classList.remove("dragging");
        dragged = null;
      });
      container.addEventListener("dragover", function (e) {
        e.preventDefault();
        if (dragged) e.dataTransfer.dropEffect = "move";
      });
      container.addEventListener("drop", function (e) {
        e.preventDefault();
        if (!dragged) return;
        var row = e.target.closest(itemSel);
        if (row && row !== dragged) {
          var all = [].slice.call(container.querySelectorAll(itemSel));
          var fromIdx = all.indexOf(dragged);
          var toIdx = all.indexOf(row);
          if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
          if (fromIdx < toIdx) row.after(dragged);
          else row.before(dragged);
        }
      });
    }
    (function initProjectSetupModal() {
      var overlay = document.getElementById("projectSetupOverlay");
      var backBtn = document.getElementById("projectSetupBack");
      var nextBtn = document.getElementById("projectSetupNext");
      var closeBtn = document.getElementById("projectSetupClose");
      var addPhaseBtn = document.getElementById("projectSetupAddPhase");
      var phasesContainer = document.getElementById("projectSetupPhases");
      var teamList = document.getElementById("projectSetupTeamList");
      var teamInput = document.getElementById("projectSetupTeamInput");
      var teamAddBtn = document.getElementById("projectSetupTeamAdd");
      var skipBtn = document.getElementById("projectSetupSkip");
      if (backBtn) backBtn.addEventListener("click", function () {
        if (projectSetupCurrentStep > 1) projectSetupShowStep(projectSetupCurrentStep - 1);
      });
      if (skipBtn) skipBtn.addEventListener("click", projectSetupSaveAndClose);
      if (nextBtn) nextBtn.addEventListener("click", function () {
        if (projectSetupCurrentStep === 4) projectSetupSaveAndClose();
        else if (projectSetupCurrentStep < 4) projectSetupShowStep(projectSetupCurrentStep + 1);
      });
      if (closeBtn) closeBtn.addEventListener("click", closeProjectSetupModal);
      if (overlay) overlay.addEventListener("click", function (e) { if (e.target === overlay) closeProjectSetupModal(); });
      if (phasesContainer) projectSetupInitPhaseDrag(phasesContainer);
      var phaseDurationSelect = document.getElementById("projectSetupPhaseDurationMode");
      if (phaseDurationSelect && phasesContainer) phaseDurationSelect.addEventListener("change", function () {
        phasesContainer.setAttribute("data-phase-mode", phaseDurationSelect.value === "dynamic" ? "dynamic" : "fixed");
      });
      function addTeamMember() {
        var name = (teamInput && teamInput.value || "").trim();
        if (!name || !teamList) return;
        teamInput.value = "";
        var item = document.createElement("div");
        item.className = "settings-party-item";
        var span = document.createElement("span");
        span.textContent = name;
        var removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", function () { item.remove(); });
        item.appendChild(span);
        item.appendChild(removeBtn);
        teamList.appendChild(item);
      }
      if (teamAddBtn) teamAddBtn.addEventListener("click", addTeamMember);
      if (teamInput) teamInput.addEventListener("keydown", function (e) { if (e.key === "Enter") { e.preventDefault(); addTeamMember(); } });
      if (addPhaseBtn && phasesContainer) addPhaseBtn.addEventListener("click", function () {
        var existingIds = [].map.call(phasesContainer.querySelectorAll(".settings-phase-item"), function (it) { return it.dataset.phaseId; });
        var nextN = existingIds.length + 1;
        var id = "phase-" + nextN;
        var n = 1;
        while (existingIds.indexOf(id) !== -1) { id = "phase-" + (nextN + n++); }
        var colors = ["#EAB308", "#0D9488", "#0284C7", "#14B8A6", "#6366F1", "#F97316"];
        var p = { id: id, name: "Phase " + nextN, color: colors[(nextN - 1) % colors.length], sprints: 2 };
        var item = document.createElement("div");
        item.className = "settings-phase-item";
        item.dataset.phaseId = p.id;
        item.draggable = true;
        var inputWrap = document.createElement("div");
        inputWrap.className = "settings-phase-input-wrap";
        var colorInp = document.createElement("input");
        colorInp.type = "color";
        colorInp.className = "settings-phase-swatch";
        colorInp.value = p.color;
        var inp = document.createElement("input");
        inp.type = "text";
        inp.placeholder = "Phase name";
        inp.value = p.name;
        var removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "settings-phase-remove";
        removeBtn.textContent = "\u2212";
        removeBtn.title = "Remove phase";
        removeBtn.disabled = phasesContainer.querySelectorAll(".settings-phase-item").length < 2;
        removeBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          item.remove();
          phasesContainer.querySelectorAll(".settings-phase-remove").forEach(function (btn) {
            btn.disabled = phasesContainer.querySelectorAll(".settings-phase-item").length < 2;
          });
        });
        inputWrap.appendChild(colorInp);
        inputWrap.appendChild(inp);
        inputWrap.appendChild(removeBtn);
        var sprintsWrap = document.createElement("div");
        sprintsWrap.className = "settings-phase-sprints";
        var sprintsInner = document.createElement("div");
        sprintsInner.className = "settings-phase-sprints-inner";
        var sprintsInp = document.createElement("input");
        sprintsInp.type = "number";
        sprintsInp.min = "1";
        sprintsInp.max = "52";
        sprintsInp.value = "2";
        var minusBtn = document.createElement("button");
        minusBtn.type = "button";
        minusBtn.className = "settings-phase-sprints-stepper-btn";
        minusBtn.textContent = "\u2212";
        minusBtn.title = "Decrease sprints";
        var plusBtn = document.createElement("button");
        plusBtn.type = "button";
        plusBtn.className = "settings-phase-sprints-stepper-btn";
        plusBtn.textContent = "+";
        plusBtn.title = "Increase sprints";
        function updateStepperState() {
          var v = Math.max(1, Math.min(52, parseInt(sprintsInp.value, 10) || 2));
          sprintsInp.value = v;
          minusBtn.disabled = v <= 1;
          plusBtn.disabled = v >= 52;
        }
        minusBtn.addEventListener("click", function () { sprintsInp.value = Math.max(1, (parseInt(sprintsInp.value, 10) || 2) - 1); updateStepperState(); });
        plusBtn.addEventListener("click", function () { sprintsInp.value = Math.min(52, (parseInt(sprintsInp.value, 10) || 2) + 1); updateStepperState(); });
        sprintsInp.addEventListener("change", updateStepperState);
        sprintsInner.appendChild(minusBtn);
        sprintsInner.appendChild(sprintsInp);
        sprintsInner.appendChild(plusBtn);
        sprintsWrap.appendChild(sprintsInner);
        item.appendChild(inputWrap);
        item.appendChild(sprintsWrap);
        phasesContainer.appendChild(item);
        updateStepperState();
        phasesContainer.querySelectorAll(".settings-phase-remove").forEach(function (btn) {
          btn.disabled = phasesContainer.querySelectorAll(".settings-phase-item").length < 2;
        });
      });
    })();
    window.openProjectSetupModal = openProjectSetupModal;
    window.closeProjectSetupModal = closeProjectSetupModal;

    function runSamplePopulate() {
      if (!isPlaceholderOnlyProject()) {
        if (typeof showToast === "function") showToast("Auto-populate is only available when the board is empty or has only the default placeholder task.", { type: "error" });
        return;
      }
      if (PHASES.length === 0) {
        if (typeof showToast === "function") showToast("Add at least one phase in Board settings first.");
        if (typeof window.openProjectSetupModal === "function") window.openProjectSetupModal();
        else openSettingsModal();
        return;
      }
      const baseDate = getProjectStartDate() || WEEK_START;
      const sampleTaskNames = ["Research", "Design", "Review", "Build", "Launch"];
      const n = Math.min(sampleTaskNames.length, Math.max(1, PHASES.length));
      const sampleTasks = [];
      for (let i = 0; i < n; i++) {
        const phaseIdx = Math.min(i, PHASES.length - 1);
        const range = getPhaseDateRange(phaseIdx, baseDate);
        const startDate = range ? range.startDate : new Date(baseDate);
        const endDate = range ? range.endDate : new Date(baseDate.getTime() + 13 * (24 * 60 * 60 * 1000));
        sampleTasks.push({
          task: sampleTaskNames[i],
          phase: PHASES[phaseIdx].id,
          party: "Unassigned",
          status: "Not started",
          star: false,
          overview: "",
          subTasks: [],
          blockers: [],
          links: [],
          dependsOn: i === 0 ? null : i - 1,
          startDate,
          endDate
        });
      }
      sampleTasks.forEach(t => {
        t.start = formatDate(t.startDate);
        t.end = formatDate(t.endDate);
      });
      const previousTasks = tasks.map(t => ({
        ...t,
        startDate: t.startDate ? new Date(t.startDate.getTime()) : null,
        endDate: t.endDate ? new Date(t.endDate.getTime()) : null,
        subTasks: Array.isArray(t.subTasks) ? t.subTasks.slice() : [],
        blockers: Array.isArray(t.blockers) ? t.blockers.slice() : [],
        links: Array.isArray(t.links) ? t.links.slice() : []
      }));
      tasks = sampleTasks;
      tasks.forEach((_, i) => { if (tasks.some(t => t.dependsOn === i)) propagateDependencyChanges(i); });
      saveTasks();
      updateChartRange();
      updateEmptyState();
      renderTasks();
      if (typeof updateWeekWidth === "function") updateWeekWidth();
      if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
      const performUndo = () => {
        tasks = previousTasks.map(t => ({
          ...t,
          startDate: t.startDate ? new Date(t.startDate.getTime()) : null,
          endDate: t.endDate ? new Date(t.endDate.getTime()) : null
        }));
        saveTasks();
        if (typeof updateChartRange === "function") updateChartRange();
        if (typeof updateEmptyState === "function") updateEmptyState();
        if (typeof renderTasks === "function") renderTasks();
        if (typeof updateWeekWidth === "function") updateWeekWidth();
        if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
      };
      if (typeof showToast === "function") showToast("Sample tasks added", { onUndo: performUndo });
    }
    function initGantt() {
      grid = document.getElementById("ganttGrid");
      if (!grid) {
        console.error("ganttGrid element not found");
        return;
      }
      let guideEl = document.getElementById("ganttDragGuide");
      if (!guideEl) {
        guideEl = document.createElement("div");
        guideEl.id = "ganttDragGuide";
        guideEl.className = "gantt-drag-guide";
        guideEl.setAttribute("aria-hidden", "true");
        document.body.appendChild(guideEl);
      } else {
        document.body.appendChild(guideEl);
      }
      applyProjectSettings();
      const header = loadPageHeader();
      const titleEl = document.getElementById("pageTitle");
      const descEl = document.getElementById("pageDescription");
      if (titleEl) titleEl.textContent = header.title;
      if (descEl) descEl.textContent = header.description;
      if (currentProjectId) ensureProjectInList(currentProjectId, header.title);
      document.getElementById("settingsBtn")?.addEventListener("click", openSettingsModal);
      document.getElementById("settingsBarStyle")?.addEventListener("click", (e) => {
        const opt = e.target.closest(".settings-segmented-option");
        if (!opt) return;
        opt.parentElement.querySelectorAll(".settings-segmented-option").forEach(o => o.classList.remove("selected"));
        opt.classList.add("selected");
        updatePaletteSwatchPreviews();
        applySettingsPreviewFromForm();
      });
      document.getElementById("settingsRowAppearance")?.addEventListener("change", applySettingsPreviewFromForm);
      document.getElementById("settingsShowDurationOnBar")?.addEventListener("change", applySettingsPreviewFromForm);
      (function initDependentTasksDropdown() {
        const wrap = document.getElementById("settingsDependentWrap");
        const trigger = document.getElementById("settingsDependentTrigger");
        const panel = document.getElementById("settingsDependentPanel");
        const gapSelect = document.getElementById("settingsDependencyGap");
        if (!wrap || !trigger || !panel || !gapSelect) return;
        panel.querySelectorAll(".settings-dependent-option").forEach(btn => {
          btn.addEventListener("click", () => {
            const val = btn.dataset.value;
            gapSelect.value = val;
            trigger.textContent = btn.textContent;
            wrap.classList.remove("open");
            panel.classList.remove("drop-up");
            trigger.setAttribute("aria-expanded", "false");
          });
        });
        const indepCheck = document.getElementById("settingsIndependentDependencies");
        function syncDependentDropdownDisabled() {
          const disabled = !!indepCheck?.checked;
          trigger.disabled = disabled;
          if (disabled) {
            wrap.classList.remove("open");
            panel.classList.remove("drop-up");
            trigger.setAttribute("aria-expanded", "false");
          }
        }
        indepCheck?.addEventListener("change", syncDependentDropdownDisabled);
        trigger.addEventListener("click", (e) => {
          e.stopPropagation();
          if (trigger.disabled) return;
          const open = wrap.classList.toggle("open");
          trigger.setAttribute("aria-expanded", open);
          if (open) {
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const panelRect = panel.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const panelH = Math.min(panelRect.height, 320);
                panel.classList.toggle("drop-up", spaceBelow < panelH + 8);
              });
            });
          } else {
            panel.classList.remove("drop-up");
          }
        });
        syncDependentDropdownDisabled();
        document.addEventListener("click", (e) => {
          if (wrap.classList.contains("open") && !wrap.contains(e.target)) {
            wrap.classList.remove("open");
            panel.classList.remove("drop-up");
            trigger.setAttribute("aria-expanded", "false");
          }
        });
      })();
      (function initPaletteDropdown() {
        const wrap = document.getElementById("settingsPaletteDropdownWrap");
        const trigger = document.getElementById("settingsPaletteTrigger");
        const panel = document.getElementById("settingsPalettePanel");
        if (!wrap || !trigger || !panel) return;
        trigger.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = wrap.classList.toggle("open");
          trigger.setAttribute("aria-expanded", open ? "true" : "false");
          if (open) {
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                const rect = trigger.getBoundingClientRect();
                const panelRect = panel.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                const panelH = Math.min(panelRect.height, 280);
                panel.classList.toggle("drop-up", spaceBelow < panelH + 8);
              });
            });
          } else {
            panel.classList.remove("drop-up");
          }
        });
        document.addEventListener("click", (e) => {
          if (wrap.classList.contains("open") && !wrap.contains(e.target)) {
            wrap.classList.remove("open");
            panel.classList.remove("drop-up");
            trigger.setAttribute("aria-expanded", "false");
          }
        });
      })();
      document.getElementById("settingsPhaseDurationMode")?.addEventListener("change", () => {
        const el = document.getElementById("settingsPhaseDurationMode");
        const list = document.getElementById("settingsPhaseList");
        const snapWrap = document.getElementById("settingsSnapToSprintWrap");
        if (el && list) list.dataset.phaseMode = el.value === "fixed" ? "fixed" : "dynamic";
        const phaseSectionLabel = document.getElementById("settingsPhaseSectionLabel");
        if (phaseSectionLabel) phaseSectionLabel.style.display = el?.value === "dynamic" ? "" : "none";
        if (snapWrap) snapWrap.style.display = el?.value === "fixed" ? "" : "none";
        if (el?.value === "fixed" && list && !list.querySelector(".settings-phase-list-header")) {
          const header = document.createElement("div");
          header.className = "settings-phase-list-header";
          const headerPhase = document.createElement("div");
          headerPhase.className = "settings-phase-list-header-phase";
          headerPhase.textContent = "Phases";
          header.appendChild(headerPhase);
          const headerSprints = document.createElement("div");
          headerSprints.className = "settings-phase-list-header-sprints";
          headerSprints.textContent = "Sprints";
          header.appendChild(headerSprints);
          list.insertBefore(header, list.firstChild);
        }
      });
      document.getElementById("settingsAutoPopulate")?.addEventListener("click", () => {
        if (!isPlaceholderOnlyProject()) {
          if (typeof showToast === "function") showToast("Auto-populate is only available when the board is empty or has only the default placeholder task.", { type: "error" });
          return;
        }
        const baseDate = getProjectStartDate() || WEEK_START;
        const sampleTaskNames = ["Research", "Design", "Review", "Build", "Launch"];
        const n = Math.min(sampleTaskNames.length, Math.max(1, PHASES.length));
        const sampleTasks = [];
        for (let i = 0; i < n; i++) {
          const phaseIdx = Math.min(i, PHASES.length - 1);
          const range = getPhaseDateRange(phaseIdx, baseDate);
          const startDate = range ? range.startDate : new Date(baseDate);
          const endDate = range ? range.endDate : new Date(baseDate.getTime() + 13 * (24 * 60 * 60 * 1000));
          sampleTasks.push({
            task: sampleTaskNames[i],
            phase: PHASES[phaseIdx].id,
            party: "Unassigned",
            status: "Not started",
            star: false,
            overview: "",
            subTasks: [],
            blockers: [],
            links: [],
            dependsOn: i === 0 ? null : i - 1,
            startDate,
            endDate
          });
        }
        sampleTasks.forEach(t => {
          t.start = formatDate(t.startDate);
          t.end = formatDate(t.endDate);
        });
        const previousTasks = tasks.map(t => ({
          ...t,
          startDate: t.startDate ? new Date(t.startDate.getTime()) : null,
          endDate: t.endDate ? new Date(t.endDate.getTime()) : null,
          subTasks: Array.isArray(t.subTasks) ? t.subTasks.slice() : [],
          blockers: Array.isArray(t.blockers) ? t.blockers.slice() : [],
          links: Array.isArray(t.links) ? t.links.slice() : []
        }));
        tasks = sampleTasks;
        tasks.forEach((_, i) => { if (tasks.some(t => t.dependsOn === i)) propagateDependencyChanges(i); });
        saveTasks();
        updateChartRange();
        closeSettingsModal();
        const performUndo = () => {
          tasks = previousTasks.map(t => ({
            ...t,
            startDate: t.startDate ? new Date(t.startDate.getTime()) : null,
            endDate: t.endDate ? new Date(t.endDate.getTime()) : null
          }));
          saveTasks();
          if (typeof updateChartRange === "function") updateChartRange();
          if (typeof updateEmptyState === "function") updateEmptyState();
          if (typeof renderTasks === "function") renderTasks();
          if (typeof updateWeekWidth === "function") updateWeekWidth();
          if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
        };
        if (typeof showToast === "function") showToast("Sample tasks added", { onUndo: performUndo });
      });
      setupPhaseListDrag(document.getElementById("settingsPhaseList"));
      document.addEventListener("click", (e) => {
        if (e.target.closest(".task-detail-add-btn") || e.target.closest(".task-detail-list-remove")) return;
        if (!e.target.closest("#ganttGrid")) {
          document.querySelectorAll(".gantt-row.selected").forEach(r => r.classList.remove("selected"));
          collapseDetail(false);
        }
      });
      document.body.appendChild(addBtn);
      tasks = loadTasks();
      addedPlaceholderThisSession = false;
      const linkAll = (typeof loadProjectSettings === "function" && loadProjectSettings())?.linkAllTasks;
      if (linkAll && typeof applyLinkAllTasks === "function") {
        applyLinkAllTasks();
        if (typeof saveTasks === "function") saveTasks();
      }
      if (typeof computeChartRange === "function") computeChartRange();
      tasks.forEach((_, i) => { if (tasks.some(t => t.dependsOn === i)) propagateDependencyChanges(i); });
      if (tasks.some(function (t) { return t.dependsOn != null; }) && typeof showLinkedTasksToast === "function") showLinkedTasksToast();
      updateEmptyState();
      const emptyConfigureBtn = document.getElementById("ganttEmptyConfigure");
      if (emptyConfigureBtn) emptyConfigureBtn.onclick = function () { if (window.openProjectSetupModal) window.openProjectSetupModal(); };
      var emptyStateEl = document.getElementById("ganttEmptyState");
      if (emptyStateEl && !emptyStateEl.classList.contains("hidden")) {
        var s = loadProjectSettings();
        var canWrite = typeof window.hasWriteAccess !== "function" || window.hasWriteAccess();
        if (canWrite && !s?.onboardingComplete && typeof window.openProjectSetupModal === "function") {
          setTimeout(function () { window.openProjectSetupModal(); }, 400);
        }
      }
      const emptyPopulateBtn = document.getElementById("ganttEmptyPopulate");
      if (emptyPopulateBtn) emptyPopulateBtn.onclick = runSamplePopulate;
      const emptyCloseBtn = document.getElementById("ganttEmptyClose");
      if (emptyCloseBtn) emptyCloseBtn.onclick = function () { if (typeof dismissEmptyState === "function") dismissEmptyState(); };
      const emptyExcelBtn = document.getElementById("ganttEmptyExcelSync");
      if (emptyExcelBtn) emptyExcelBtn.onclick = function () { if (window.openExcelSyncModal) window.openExcelSyncModal(); else if (typeof openExcelSyncModal === "function") openExcelSyncModal(); };
      const viewSelect = document.getElementById("viewMode");
      if (viewSelect) {
        const saved = getSavedView();
        if (saved && VIEW_ORDER.includes(saved)) viewSelect.value = saved;
        else viewSelect.value = "project";
      }
      const ganttWrapperEl = document.getElementById("ganttWrapper");
      if (ganttWrapperEl) {
        try {
          const simpleMode = localStorage.getItem("ganttSimpleMode");
          if (simpleMode === "true") ganttWrapperEl.setAttribute("data-simple-mode", "true");
          else ganttWrapperEl.removeAttribute("data-simple-mode");
        } catch (_) {}
      }
      document.addEventListener("keydown", (e) => {
        if (e.target.closest("input, select, textarea, [contenteditable]")) return;
        const key = e.key.toLowerCase();
        if (key === "c" || key === "f" || key === "d") {
          e.preventDefault();
          const mode = key === "c" ? "compact" : key === "f" ? "fill" : "default";
          const s = loadProjectSettings() || {};
          saveProjectSettings({ ...s, rowAppearance: mode });
          applyRowAppearance();
          const rowAppearanceEl = document.getElementById("settingsRowAppearance");
          if (rowAppearanceEl) rowAppearanceEl.value = mode;
        }
        if (key === "s") {
          e.preventDefault();
          const wrapper = document.getElementById("ganttWrapper");
          if (!wrapper) return;
          const on = wrapper.getAttribute("data-simple-mode") === "true";
          if (on) {
            wrapper.removeAttribute("data-simple-mode");
            try { localStorage.setItem("ganttSimpleMode", "false"); } catch (_) {}
            wrapper.classList.add("simple-mode-reveal");
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                wrapper.classList.remove("simple-mode-reveal");
              });
            });
          } else {
            wrapper.classList.add("simple-mode-hiding");
            setTimeout(() => {
              wrapper.setAttribute("data-simple-mode", "true");
              wrapper.classList.remove("simple-mode-hiding");
              try { localStorage.setItem("ganttSimpleMode", "true"); } catch (_) {}
            }, 200);
          }
        }
      });
      updateChartRange();
      requestAnimationFrame(() => {
        updateWeekWidth();
        renderPhaseHeaders();
        restoreScrollPosition();
      });
      const wrapper = document.querySelector(".gantt-wrapper");
      if (wrapper) {
        wrapper.addEventListener("scroll", () => {
          if (scrollSaveTid) clearTimeout(scrollSaveTid);
          scrollSaveTid = setTimeout(saveScrollPosition, 150);
        });
      }
      window.addEventListener("resize", () => { updateWeekWidth(); renderPhaseHeaders(); });

      let shiftHeld = false;
      let shiftModeUnlinkButtons = [];
      const allLinesEl = document.getElementById("ganttAllDependencyLines");
      const singleLineEl = document.getElementById("ganttDependencyLine");
      let connectorDrag = null;
      let connectorUpdateTid = null;

      function updateAllConnectors() {
        if (!allLinesEl || !grid) return;
        allLinesEl.innerHTML = "";
        allLinesEl.classList.remove("visible");
        if (!shiftHeld) return;
        const childCountByPrimary = {};
        tasks.forEach((t) => {
          if (typeof t.dependsOn === "number") childCountByPrimary[t.dependsOn] = (childCountByPrimary[t.dependsOn] || 0) + 1;
        });
        tasks.forEach((t, i) => {
          if (typeof t.dependsOn !== "number" || !tasks[t.dependsOn]) return;
          const primaryIdx = t.dependsOn;
          const primaryBar = grid.querySelector('.gantt-bar[data-index="' + primaryIdx + '"]');
          const dependentBar = grid.querySelector('.gantt-bar[data-index="' + i + '"]');
          if (!primaryBar || !dependentBar) return;
          const pr = primaryBar.getBoundingClientRect();
          const dr = dependentBar.getBoundingClientRect();
          const parentX = pr.left + pr.width / 2;
          const parentY = pr.bottom;
          const childX = dr.left;
          const childY = dr.top + dr.height / 2 + 2;
          const primaryColor = getPhaseColor(tasks[primaryIdx].phase || PHASES[0]?.id);
          const pathD = connectorPathD(parentX, parentY, childX, childY);
          const pathHit = document.createElementNS("http://www.w3.org/2000/svg", "path");
          pathHit.setAttribute("d", pathD);
          pathHit.setAttribute("stroke", "transparent");
          pathHit.setAttribute("stroke-width", "5");
          pathHit.setAttribute("fill", "none");
          pathHit.setAttribute("pointer-events", "stroke");
          pathHit.setAttribute("class", "connector-path-hit");
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", pathD);
          path.setAttribute("stroke", primaryColor);
          path.setAttribute("stroke-width", "1");
          path.setAttribute("stroke-dasharray", "4 3");
          path.setAttribute("fill", "none");
          path.setAttribute("pointer-events", "none");
          path.setAttribute("class", "connector-path");
          const pathWrap = document.createElementNS("http://www.w3.org/2000/svg", "g");
          pathWrap.setAttribute("class", "connector-path-wrap");
          pathWrap.appendChild(pathHit);
          pathWrap.appendChild(path);
          const ptChild = pointOnConnectorNearChild(parentX, parentY, childX, childY);
          const ptOnLine = pointOnConnectorBetween(parentX, parentY, childX, childY);
          const c2 = document.createElementNS("http://www.w3.org/2000/svg", "g");
          c2.setAttribute("transform", `translate(${ptChild.x}, ${ptChild.y})`);
          c2.setAttribute("class", "connector-dot");
          c2.setAttribute("data-dependent-index", i);
          c2.setAttribute("data-primary-index", primaryIdx);
          c2.setAttribute("data-end", "dependent");
          const c2Hit = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          c2Hit.setAttribute("r", "12");
          c2Hit.setAttribute("fill", "transparent");
          c2Hit.setAttribute("pointer-events", "all");
          c2.appendChild(c2Hit);
          const c2Circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          c2Circle.setAttribute("r", "6");
          c2Circle.setAttribute("fill", "white");
          c2Circle.setAttribute("stroke", "#d4d4d4");
          c2Circle.setAttribute("stroke-width", "1");
          const c2Line1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
          c2Line1.setAttribute("x1", "-4");
          c2Line1.setAttribute("y1", "0");
          c2Line1.setAttribute("x2", "4");
          c2Line1.setAttribute("y2", "0");
          c2Line1.setAttribute("stroke", "#737373");
          c2Line1.setAttribute("stroke-width", "1");
          c2Line1.setAttribute("stroke-linecap", "round");
          const c2Line2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
          c2Line2.setAttribute("x1", "0");
          c2Line2.setAttribute("y1", "-4");
          c2Line2.setAttribute("x2", "0");
          c2Line2.setAttribute("y2", "4");
          c2Line2.setAttribute("stroke", "#737373");
          c2Line2.setAttribute("stroke-width", "1");
          c2Line2.setAttribute("stroke-linecap", "round");
          c2.appendChild(c2Circle);
          c2.appendChild(c2Line1);
          c2.appendChild(c2Line2);
          const addDotHandlers = (circle, fixedX, fixedY, otherX, otherY) => {
            circle.addEventListener("mousedown", (e) => {
              e.preventDefault();
              e.stopPropagation();
              circle.classList.add("connector-dot-dragging");
              path.classList.add("connector-dragging");
              connectorDrag = {
                dependentIdx: parseInt(circle.getAttribute("data-dependent-index"), 10),
                primaryIdx: parseInt(circle.getAttribute("data-primary-index"), 10),
                end: circle.getAttribute("data-end"),
                path, circle, fixedX, fixedY, otherX, otherY
              };
              const onMove = (e2) => {
                e2.preventDefault();
                const cx = e2.clientX;
                const cy = e2.clientY;
                circle.setAttribute("transform", `translate(${cx}, ${cy})`);
                const newD = connectorDrag.end === "primary" ? connectorPathD(cx, cy, fixedX, fixedY) : connectorPathD(connectorDrag.otherX, connectorDrag.otherY, cx, cy);
                path.setAttribute("d", newD);
                pathHit.setAttribute("d", newD);
                let hoveredIdx = null;
                try {
                  allLinesEl.style.pointerEvents = "none";
                  allLinesEl.style.visibility = "hidden";
                  const ganttWrapper = document.querySelector(".gantt-wrapper");
                  const prevWrapperPE = ganttWrapper?.style.pointerEvents;
                  if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
                  const elements = document.elementsFromPoint(cx, cy);
                  if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
                  for (const el of elements) {
                    const row = el.closest?.(".gantt-row[data-index]");
                    if (row && !row.classList.contains("gantt-header")) {
                      hoveredIdx = parseInt(row.getAttribute("data-index"), 10);
                      break;
                    }
                    const barEl = el.closest?.(".gantt-bar");
                    if (barEl) {
                      hoveredIdx = parseInt(barEl.getAttribute("data-index"), 10);
                      break;
                    }
                  }
                } finally {
                  allLinesEl.style.visibility = "visible";
                  allLinesEl.style.pointerEvents = "auto";
                }
                let previewColor = "#a3a3a3";
                if (hoveredIdx !== null && !isNaN(hoveredIdx)) {
                  if (connectorDrag.end === "primary" && hoveredIdx !== connectorDrag.dependentIdx && !wouldCreateCycle(connectorDrag.dependentIdx, hoveredIdx)) {
                    previewColor = getPhaseColor(tasks[hoveredIdx].phase || PHASES[0]?.id);
                  } else if (connectorDrag.end === "dependent" && hoveredIdx !== connectorDrag.dependentIdx && !wouldCreateCycle(connectorDrag.dependentIdx, hoveredIdx)) {
                    previewColor = getPhaseColor(tasks[hoveredIdx].phase || PHASES[0]?.id);
                  }
                }
                path.setAttribute("stroke", previewColor);
              };
              const onUp = (e2) => {
                e2.preventDefault();
                e2.stopPropagation();
                document.removeEventListener("mousemove", onMove);
                document.removeEventListener("mouseup", onUp);
                try {
                  allLinesEl.style.pointerEvents = "none";
                  allLinesEl.style.visibility = "hidden";
                  const ganttWrapper = document.querySelector(".gantt-wrapper");
                  const prevWrapperPE = ganttWrapper?.style.pointerEvents;
                  if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
                  var elements = document.elementsFromPoint(e2.clientX, e2.clientY);
                  if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
                } finally {
                  allLinesEl.style.visibility = "visible";
                  allLinesEl.style.pointerEvents = "auto";
                }
                const overUnlinkBtn = Array.from(elements || []).find((el) => {
                  const btn = el.closest?.(".gantt-dependency-unlink-btn");
                  if (!btn || !btn.dataset.dependentIndex) return false;
                  const depIdx = parseInt(btn.dataset.dependentIndex, 10);
                  const primIdx = parseInt(btn.dataset.primaryIndex, 10);
                  return connectorDrag && depIdx === connectorDrag.dependentIdx && primIdx === connectorDrag.primaryIdx;
                });
                if (overUnlinkBtn && connectorDrag) {
                  const depIdx = connectorDrag.dependentIdx;
                  const primIdx = connectorDrag.primaryIdx;
                  const childTask = tasks[depIdx];
                  const parentTask = tasks[primIdx];
                  const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                  const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
                  circle.classList.remove("connector-dot-dragging");
                  path.classList.remove("connector-dragging");
                  connectorDrag = null;
                  pushTasksUndo();
                  tasks[depIdx].dependsOn = null;
                  saveTasks();
                  renderTasks();
                  showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
                  if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
                  return;
                }
                let newIdx = null;
                for (const el of elements) {
                  const row = el.closest?.(".gantt-row[data-index]");
                  if (row && !row.classList.contains("gantt-header")) {
                    newIdx = parseInt(row.getAttribute("data-index"), 10);
                    break;
                  }
                  const bar = el.closest?.(".gantt-bar");
                  if (bar) {
                    newIdx = parseInt(bar.getAttribute("data-index"), 10);
                    break;
                  }
                }
                let didUpdate = false;
                let toastMessage = "";
                if (connectorDrag && newIdx !== null && !isNaN(newIdx)) {
                  if (connectorDrag.end === "primary" && newIdx !== connectorDrag.dependentIdx && !wouldCreateCycle(connectorDrag.dependentIdx, newIdx)) {
                    pushTasksUndo();
                    tasks[connectorDrag.dependentIdx].dependsOn = newIdx;
                    propagateDependencyChanges(newIdx);
                    didUpdate = true;
                    const childTask = tasks[connectorDrag.dependentIdx];
                    const newParentTask = tasks[newIdx];
                    const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                    const parentName = (newParentTask.star ? "★ " : "") + (newParentTask.task || "Task");
                    toastMessage = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`;
                  } else if (connectorDrag.end === "dependent" && newIdx !== connectorDrag.dependentIdx && !wouldCreateCycle(connectorDrag.dependentIdx, newIdx)) {
                    pushTasksUndo();
                    tasks[connectorDrag.dependentIdx].dependsOn = newIdx;
                    propagateDependencyChanges(newIdx);
                    didUpdate = true;
                    const childTask = tasks[connectorDrag.dependentIdx];
                    const newParentTask = tasks[newIdx];
                    const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                    const parentName = (newParentTask.star ? "★ " : "") + (newParentTask.task || "Task");
                    toastMessage = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`;
                  }
                }
                if (didUpdate) {
                  saveTasks();
                  renderTasks();
                  if (toastMessage) showToast(toastMessage, { onUndo: performUndo });
                  if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
                }
                circle.classList.remove("connector-dot-dragging");
                path.classList.remove("connector-dragging");
                connectorDrag = null;
              };
              document.addEventListener("mousemove", onMove);
              document.addEventListener("mouseup", onUp, { once: true });
              onMove(e);
            });
          };
          addDotHandlers(c2, parentX, parentY, childX, childY);
          allLinesEl.appendChild(pathWrap);
          allLinesEl.appendChild(c2);
          
          // Create unlink button for this connector (visible immediately in shift mode)
          const unlinkBtn = document.createElement("button");
          unlinkBtn.className = "gantt-dependency-unlink-btn connector-unlink-always-visible visible";
          unlinkBtn.type = "button";
          unlinkBtn.title = "Unlink tasks (or drag connector here to unlink)";
          unlinkBtn.dataset.dependentIndex = String(i);
          unlinkBtn.dataset.primaryIndex = String(primaryIdx);
          unlinkBtn.style.position = "fixed";
          unlinkBtn.style.left = ptOnLine.x + "px";
          unlinkBtn.style.top = ptOnLine.y + "px";
          unlinkBtn.style.backgroundColor = primaryColor;
          unlinkBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/>
            <path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/>
            <line x1="8" y1="2" x2="8" y2="5"/>
            <line x1="2" y1="8" x2="5" y2="8"/>
            <line x1="16" y1="19" x2="16" y2="22"/>
            <line x1="19" y1="16" x2="22" y2="16"/>
          </svg>`;
          unlinkBtn.addEventListener("click", () => {
            const childTask = tasks[i];
            const parentTask = tasks[primaryIdx];
            const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
            const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
            pushTasksUndo();
            childTask.dependsOn = null;
            saveTasks();
            renderTasks();
            showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"/><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"/><line x1="8" y1="2" x2="8" y2="5"/><line x1="2" y1="8" x2="5" y2="8"/><line x1="16" y1="19" x2="16" y2="22"/><line x1="19" y1="16" x2="22" y2="16"/></svg> "${childName}" unlinked from "${parentName}"`, { onUndo: performUndo });
          });
          
          // In shift mode unlink button is always visible (no hover-to-show)
          document.body.appendChild(unlinkBtn);
          shiftModeUnlinkButtons.push(unlinkBtn);
        });
        tasks.forEach((t, i) => {
          const bar = grid.querySelector('.gantt-bar[data-index="' + i + '"]');
          if (!bar) return;
          const dr = bar.getBoundingClientRect();
          const hasDep = typeof t.dependsOn === "number" && tasks[t.dependsOn];
          const isPrimary = tasks.some((ot, j) => j !== i && ot.dependsOn === i);
          /* Add standalone dependent dot for every task without a parent so they can attach to one — just to the left of the bar, vertically centered */
          if (!hasDep) {
            const x = dr.left - 12;
            const y = dr.top + dr.height / 2 + 2;
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "g");
            dot.setAttribute("transform", `translate(${x}, ${y})`);
            dot.setAttribute("class", "connector-dot connector-dot-standalone");
            dot.setAttribute("data-dependent-index", i);
            dot.setAttribute("data-standalone", "dependent");
            const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            hitArea.setAttribute("r", "12");
            hitArea.setAttribute("fill", "transparent");
            hitArea.setAttribute("pointer-events", "all");
            dot.appendChild(hitArea);
            const dotCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dotCircle.setAttribute("r", "6");
            dotCircle.setAttribute("fill", "white");
            dotCircle.setAttribute("stroke", "#d4d4d4");
            dotCircle.setAttribute("stroke-width", "1");
            const dotLine1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
            dotLine1.setAttribute("x1", "-4");
            dotLine1.setAttribute("y1", "0");
            dotLine1.setAttribute("x2", "4");
            dotLine1.setAttribute("y2", "0");
            dotLine1.setAttribute("stroke", "#737373");
            dotLine1.setAttribute("stroke-width", "1");
            dotLine1.setAttribute("stroke-linecap", "round");
            const dotLine2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
            dotLine2.setAttribute("x1", "0");
            dotLine2.setAttribute("y1", "-4");
            dotLine2.setAttribute("x2", "0");
            dotLine2.setAttribute("y2", "4");
            dotLine2.setAttribute("stroke", "#737373");
            dotLine2.setAttribute("stroke-width", "1");
            dotLine2.setAttribute("stroke-linecap", "round");
            dot.appendChild(dotCircle);
            dot.appendChild(dotLine1);
            dot.appendChild(dotLine2);
            dot.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            dot.classList.add("connector-dot-dragging");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("stroke", "#a3a3a3");
            path.setAttribute("stroke-width", "1");
            path.setAttribute("stroke-dasharray", "6 4");
            path.setAttribute("fill", "none");
            path.setAttribute("pointer-events", "stroke");
            path.setAttribute("class", "connector-path connector-dragging");
            allLinesEl.insertBefore(path, allLinesEl.firstChild);
            const onMove = (e2) => {
              e2.preventDefault();
              const cx = e2.clientX;
              const cy = e2.clientY;
              dot.setAttribute("transform", `translate(${cx}, ${cy})`);
              path.setAttribute("d", connectorPathD(x, y, cx, cy));
              // Update preview color based on potential parent task
              allLinesEl.style.pointerEvents = "none";
              allLinesEl.style.visibility = "hidden";
              const ganttWrapper = document.querySelector(".gantt-wrapper");
              const prevWrapperPE = ganttWrapper?.style.pointerEvents;
              if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
              const elements = document.elementsFromPoint(cx, cy);
              if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
              allLinesEl.style.visibility = "";
              allLinesEl.style.pointerEvents = "auto";
              let hoveredIdx = null;
              for (const el of elements) {
                const row = el.closest?.(".gantt-row[data-index]");
                if (row && !row.classList.contains("gantt-header")) {
                  hoveredIdx = parseInt(row.getAttribute("data-index"), 10);
                  break;
                }
                const bar = el.closest?.(".gantt-bar");
                if (bar) {
                  hoveredIdx = parseInt(bar.getAttribute("data-index"), 10);
                  break;
                }
              }
              if (hoveredIdx !== null && !isNaN(hoveredIdx) && hoveredIdx !== i && !wouldCreateCycle(i, hoveredIdx)) {
                const potentialParent = tasks[hoveredIdx];
                const color = getPhaseColor(potentialParent.phase || PHASES[0]?.id);
                path.setAttribute("stroke", color);
              } else {
                path.setAttribute("stroke", "#a3a3a3");
              }
            };
            const onUp = (e2) => {
              e2.preventDefault();
              e2.stopPropagation();
              document.removeEventListener("mousemove", onMove);
              document.removeEventListener("mouseup", onUp);
              allLinesEl.style.pointerEvents = "none";
              allLinesEl.style.visibility = "hidden";
              const ganttWrapper = document.querySelector(".gantt-wrapper");
              const prevWrapperPE = ganttWrapper?.style.pointerEvents;
              if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
              const elements = document.elementsFromPoint(e2.clientX, e2.clientY);
              if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
              allLinesEl.style.visibility = "";
              allLinesEl.style.pointerEvents = "auto";
              let newIdx = null;
              for (const el of elements) {
                const row = el.closest?.(".gantt-row[data-index]");
                if (row && !row.classList.contains("gantt-header")) {
                  newIdx = parseInt(row.getAttribute("data-index"), 10);
                  break;
                }
                const barEl = el.closest?.(".gantt-bar");
                if (barEl) {
                  newIdx = parseInt(barEl.getAttribute("data-index"), 10);
                  break;
                }
              }
              path.remove();
              dot.classList.remove("connector-dot-dragging");
              if (newIdx !== null && !isNaN(newIdx) && newIdx !== i && !wouldCreateCycle(i, newIdx)) {
                const childTask = tasks[i];
                const parentTask = tasks[newIdx];
                const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
                pushTasksUndo();
                tasks[i].dependsOn = newIdx;
                propagateDependencyChanges(newIdx);
                saveTasks();
                renderTasks();
                showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`, { onUndo: performUndo });
                if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
              }
            };
            document.addEventListener("mousemove", onMove);
            document.addEventListener("mouseup", onUp, { once: true });
            onMove(e);
          });
          allLinesEl.appendChild(dot);
          }
          /* One primary control per parent: + when no dependents, or # badge in place of + when 1+ dependents */
          if (isPrimary) {
            const x = dr.left + dr.width / 2;
            const y = dr.bottom;
            const primaryColor = getPhaseColor(tasks[i].phase || PHASES[0]?.id);
            const childCount = childCountByPrimary[i] || 0;
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "g");
            dot.setAttribute("transform", `translate(${x}, ${y})`);
            dot.setAttribute("class", "connector-dot connector-dot-standalone");
            dot.setAttribute("data-primary-index", String(i));
            dot.setAttribute("data-standalone", "primary");
            if (childCount >= 1) dot.setAttribute("data-base-count", String(childCount));
            const hitArea = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            hitArea.setAttribute("r", "12");
            hitArea.setAttribute("fill", "transparent");
            hitArea.setAttribute("pointer-events", childCount >= 1 ? "none" : "all");
            dot.appendChild(hitArea);
            if (childCount >= 1) {
              const badgeCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
              badgeCircle.setAttribute("r", "8");
              badgeCircle.setAttribute("fill", primaryColor);
              badgeCircle.setAttribute("stroke", "#fff");
              badgeCircle.setAttribute("stroke-width", "1");
              const badgeText = document.createElementNS("http://www.w3.org/2000/svg", "text");
              badgeText.setAttribute("x", "0");
              badgeText.setAttribute("y", "0");
              badgeText.setAttribute("dy", "0.35em");
              badgeText.setAttribute("text-anchor", "middle");
              badgeText.setAttribute("font-size", "9");
              badgeText.setAttribute("font-weight", "600");
              badgeText.setAttribute("fill", "#fff");
              badgeText.setAttribute("class", "primary-badge-count-text");
              badgeText.textContent = String(childCount);
              dot.appendChild(badgeCircle);
              dot.appendChild(badgeText);
            } else {
              const dotCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
              dotCircle.setAttribute("r", "6");
              dotCircle.setAttribute("fill", "white");
              dotCircle.setAttribute("stroke", "#d4d4d4");
              dotCircle.setAttribute("stroke-width", "1");
              const dotLine1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
              dotLine1.setAttribute("x1", "-4");
              dotLine1.setAttribute("y1", "0");
              dotLine1.setAttribute("x2", "4");
              dotLine1.setAttribute("y2", "0");
              dotLine1.setAttribute("stroke", "#737373");
              dotLine1.setAttribute("stroke-width", "1");
              dotLine1.setAttribute("stroke-linecap", "round");
              const dotLine2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
              dotLine2.setAttribute("x1", "0");
              dotLine2.setAttribute("y1", "-4");
              dotLine2.setAttribute("x2", "0");
              dotLine2.setAttribute("y2", "4");
              dotLine2.setAttribute("stroke", "#737373");
              dotLine2.setAttribute("stroke-width", "1");
              dotLine2.setAttribute("stroke-linecap", "round");
              dot.appendChild(dotCircle);
              dot.appendChild(dotLine1);
              dot.appendChild(dotLine2);
            }
            if (childCount === 0) {
            dot.addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            dot.classList.add("connector-dot-dragging");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("stroke", primaryColor);
            path.setAttribute("stroke-width", "1");
            path.setAttribute("stroke-dasharray", "6 4");
            path.setAttribute("fill", "none");
            path.setAttribute("pointer-events", "stroke");
            path.setAttribute("class", "connector-path connector-dragging");
            allLinesEl.insertBefore(path, allLinesEl.firstChild);
            const onMove = (e2) => {
              e2.preventDefault();
              const cx = e2.clientX;
              const cy = e2.clientY;
              dot.setAttribute("transform", `translate(${cx}, ${cy})`);
              path.setAttribute("d", connectorPathD(x, y, cx, cy));
              allLinesEl.style.pointerEvents = "none";
              allLinesEl.style.visibility = "hidden";
              const ganttWrapper = document.querySelector(".gantt-wrapper");
              const prevWrapperPE = ganttWrapper?.style.pointerEvents;
              if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
              const elements = document.elementsFromPoint(cx, cy);
              if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
              allLinesEl.style.visibility = "";
              allLinesEl.style.pointerEvents = "auto";
              let hoveredIdx = null;
              for (const el of elements) {
                const row = el.closest?.(".gantt-row[data-index]");
                if (row && !row.classList.contains("gantt-header")) {
                  hoveredIdx = parseInt(row.getAttribute("data-index"), 10);
                  break;
                }
                const barEl = el.closest?.(".gantt-bar");
                if (barEl) {
                  hoveredIdx = parseInt(barEl.getAttribute("data-index"), 10);
                  break;
                }
              }
              if (hoveredIdx !== null && !isNaN(hoveredIdx) && hoveredIdx !== i && !wouldCreateCycle(hoveredIdx, i)) {
                path.setAttribute("stroke", getPhaseColor(tasks[hoveredIdx].phase || PHASES[0]?.id));
              } else {
                path.setAttribute("stroke", "#a3a3a3");
              }
              allLinesEl.querySelectorAll("g[data-standalone=\"primary\"][data-base-count]").forEach(function (g) {
                const idx = parseInt(g.getAttribute("data-primary-index"), 10);
                const base = parseInt(g.getAttribute("data-base-count"), 10) || 0;
                const textEl = g.querySelector(".primary-badge-count-text");
                if (textEl) textEl.textContent = String(idx === hoveredIdx && hoveredIdx !== i && !isNaN(hoveredIdx) && !wouldCreateCycle(i, hoveredIdx) ? base + 1 : base);
              });
            };
            const onUp = (e2) => {
              e2.preventDefault();
              e2.stopPropagation();
              document.removeEventListener("mousemove", onMove);
              document.removeEventListener("mouseup", onUp);
              allLinesEl.querySelectorAll("g[data-standalone=\"primary\"][data-base-count] .primary-badge-count-text").forEach(function (textEl) {
                const g = textEl.closest("g[data-base-count]");
                if (g) textEl.textContent = g.getAttribute("data-base-count") || "0";
              });
              allLinesEl.style.pointerEvents = "none";
              allLinesEl.style.visibility = "hidden";
              const ganttWrapper = document.querySelector(".gantt-wrapper");
              const prevWrapperPE = ganttWrapper?.style.pointerEvents;
              if (ganttWrapper) ganttWrapper.style.pointerEvents = "auto";
              const elements = document.elementsFromPoint(e2.clientX, e2.clientY);
              if (ganttWrapper) ganttWrapper.style.pointerEvents = prevWrapperPE || "";
              allLinesEl.style.visibility = "";
              allLinesEl.style.pointerEvents = "auto";
              let newIdx = null;
              for (const el of elements) {
                const row = el.closest?.(".gantt-row[data-index]");
                if (row && !row.classList.contains("gantt-header")) {
                  newIdx = parseInt(row.getAttribute("data-index"), 10);
                  break;
                }
                const barEl = el.closest?.(".gantt-bar");
                if (barEl) {
                  newIdx = parseInt(barEl.getAttribute("data-index"), 10);
                  break;
                }
              }
              path.remove();
              dot.classList.remove("connector-dot-dragging");
              if (newIdx !== null && !isNaN(newIdx) && newIdx !== i && !wouldCreateCycle(newIdx, i)) {
                const childTask = tasks[newIdx];
                const parentTask = tasks[i];
                const childName = (childTask.star ? "★ " : "") + (childTask.task || "Task");
                const parentName = (parentTask.star ? "★ " : "") + (parentTask.task || "Task");
                pushTasksUndo();
                tasks[newIdx].dependsOn = i;
                propagateDependencyChanges(i);
                saveTasks();
                renderTasks();
                showToast(`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> "${childName}" → "${parentName}"`, { onUndo: performUndo });
                if (typeof showLinkedTasksToast === "function") setTimeout(showLinkedTasksToast, 2700);
              }
            };
            document.addEventListener("mousemove", onMove);
            document.addEventListener("mouseup", onUp, { once: true });
            onMove(e);
          });
            }
          allLinesEl.appendChild(dot);
          }
        });
        allLinesEl.setAttribute("viewBox", "0 0 " + window.innerWidth + " " + window.innerHeight);
        allLinesEl.setAttribute("width", window.innerWidth);
        allLinesEl.setAttribute("height", window.innerHeight);
        allLinesEl.classList.add("visible");
      }
      const blockChartPointer = (e) => {
        if (!shiftHeld) return;
        if (e.target.closest("#ganttAllDependencyLines")) return;
        if (e.target.closest("input, select, textarea, button, [contenteditable]")) return;
        if (e.target.closest(".gantt-wrapper")) {
          e.preventDefault();
          e.stopPropagation();
        }
      };
      function enableShiftMode() {
        if (shiftHeld) return;
        shiftHeld = true;
        shiftModeUnlinkButtons.forEach(btn => btn.remove());
        shiftModeUnlinkButtons = [];
        document.body.classList.add("shift-mode");
        const wrapper = document.querySelector(".gantt-wrapper");
        if (wrapper) wrapper.style.pointerEvents = "auto";
        grid?.querySelectorAll(".gantt-row[draggable]").forEach(r => { r.draggable = false; });
        if (singleLineEl) singleLineEl.style.visibility = "hidden";
        updateAllConnectors();
        /* Do not block pointer in shift mode: overlay and bars (pointer-events: none) handle it */
        const debouncedUpdate = () => {
          if (connectorUpdateTid) clearTimeout(connectorUpdateTid);
          connectorUpdateTid = setTimeout(() => {
            connectorUpdateTid = null;
            updateAllConnectors();
          }, 80);
        };
        wrapper?.addEventListener("scroll", debouncedUpdate, true);
        window.addEventListener("scroll", debouncedUpdate, true);
        window.addEventListener("resize", debouncedUpdate);
        document._allConnectorsCleanup = () => {
          wrapper?.removeEventListener("scroll", debouncedUpdate, true);
          window.removeEventListener("scroll", debouncedUpdate, true);
          window.removeEventListener("resize", debouncedUpdate);
          shiftModeUnlinkButtons.forEach(btn => btn.remove());
          shiftModeUnlinkButtons = [];
        };
      }
      function disableShiftMode() {
        if (!shiftHeld) return;
        shiftHeld = false;
        document.body.classList.remove("shift-mode");
        grid?.querySelectorAll(".gantt-row:not(.gantt-header)").forEach(r => { r.draggable = typeof window.hasWriteAccess !== "function" || window.hasWriteAccess(); });
        if (singleLineEl) singleLineEl.style.visibility = "";
        shiftModeUnlinkButtons.forEach(btn => btn.remove());
        shiftModeUnlinkButtons.length = 0;
        if (allLinesEl) {
          allLinesEl.classList.remove("visible");
        }
        if (document._allConnectorsCleanup) {
          document._allConnectorsCleanup();
          document._allConnectorsCleanup = null;
        }
        const wrapper = document.querySelector(".gantt-wrapper");
        if (wrapper) wrapper.style.pointerEvents = "";
      }
      document.addEventListener("keydown", (e) => {
        if (e.getModifierState("CapsLock") && !shiftHeld) enableShiftMode();
        if (e.key === "Escape" && shiftHeld) {
          disableShiftMode();
          return;
        }
        if (e.key === "CapsLock") {
          if (e.getModifierState("CapsLock")) enableShiftMode();
          else disableShiftMode();
          return;
        }
        if (e.key === "Shift" && !shiftHeld) enableShiftMode();
      }, true);
      document.addEventListener("keyup", (e) => {
        if (e.key === "Shift" && shiftHeld && !e.getModifierState("CapsLock")) disableShiftMode();
      }, true);
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && shiftHeld) disableShiftMode();
      });
      window.addEventListener("blur", () => {
        if (shiftHeld) disableShiftMode();
      });
    }

    function migrateLegacySingleProject() {
      const list = loadProjectsList();
      if (list.length > 0) return;
      const legacyTasks = "gantt-chart-tasks-gantt-chart";
      const legacySettings = "gantt-chart-project-settings-gantt-chart";
      const legacyView = "gantt-chart-view-gantt-chart";
      try {
        if (localStorage.getItem(legacyTasks) || localStorage.getItem(legacySettings)) {
          const tasksRaw = localStorage.getItem(legacyTasks);
          const settingsRaw = localStorage.getItem(legacySettings);
          const viewRaw = localStorage.getItem(legacyView);
          if (tasksRaw) localStorage.setItem("gantt-tasks-default", tasksRaw);
          if (settingsRaw) localStorage.setItem("gantt-settings-default", settingsRaw);
          if (viewRaw) localStorage.setItem("gantt-view-default", viewRaw);
          const name = settingsRaw ? (JSON.parse(settingsRaw).title || "My project") : "My project";
          saveProjectsList([{ id: "default", name, createdAt: Date.now() }]);
          if (!location.hash || location.hash === "#" || location.hash === "#/")
            location.hash = "#/project/default";
        }
      } catch (e) { console.warn("Legacy migration skipped:", e); }
    }
    function initAuthUI() {
      if (!window.ganttStorage) return;
      const loginWrap = document.getElementById("ganttAuthLoginWrap");
      if (loginWrap) loginWrap.style.display = window.ganttStorage.isCloudEnabled() ? "" : "none";
      const loginBtn = document.getElementById("ganttAuthLogin");
      const wrap = document.getElementById("ganttAuthWrap");
      const userEmailEl = document.getElementById("ganttAuthUserEmail");
      const userTrigger = document.getElementById("ganttAuthUserTrigger");
      const userDropdown = document.getElementById("ganttAuthUserDropdown");
      const supabaseLink = document.getElementById("ganttAuthSupabaseLink");
      const logoutBtn = document.getElementById("ganttAuthLogout");
      const overlay = document.getElementById("ganttAuthModalOverlay");
      const configSection = document.getElementById("ganttAuthConfigSection");
      const loginSection = document.getElementById("ganttAuthLoginSection");
      const configUrlInput = document.getElementById("ganttAuthConfigUrl");
      const configAnonInput = document.getElementById("ganttAuthConfigAnonKey");
      const configSaveBtn = document.getElementById("ganttAuthConfigSave");
      const cancelConfigBtn = document.getElementById("ganttAuthCancelConfig");
      const showConfigLink = document.getElementById("ganttAuthShowConfig");
      const emailInput = document.getElementById("ganttAuthEmail");
      const passwordInput = document.getElementById("ganttAuthPassword");
      const rememberCheckbox = document.getElementById("ganttAuthRemember");
      const submitBtn = document.getElementById("ganttAuthSubmit");
      const signupSubmitBtn = document.getElementById("ganttAuthSignupSubmit");
      const errorEl = document.getElementById("ganttAuthError");
      const GANTT_AUTH_REMEMBER_EMAIL_KEY = "gantt-auth-remember-email";

      function authErrorMessage(err) {
        if (!err) return "Something went wrong.";
        const msg = typeof err === "string" ? err : (err && err.message ? err.message : String(err));
        const isMobile = /iPhone|iPad|iPod|Android|webOS|Mobile/i.test(navigator.userAgent || "");
        if (/supabase not configured|not configured/i.test(msg)) {
          return isMobile
            ? "Cloud login unavailable. Reload the page — if the Supabase script failed to load (e.g. slow connection), try Wi‑Fi or a different browser."
            : "Supabase not configured. Check config.js has a valid URL and anon key, or reload if the script failed to load.";
        }
        if (/aborted|cancelled|canceled|timeout/i.test(msg)) {
          return isMobile
            ? "Login timed out. Try again on Wi‑Fi, or use a different browser (Chrome instead of Safari, or Safari instead of Chrome). If the app is paused in Supabase, restore it first."
            : "Request was cancelled or took too long. Clear this site's data (browser settings → Site settings → Clear data) and try again.";
        }
        if (/failed to fetch|network error|connection refused|connection failed|load failed|ERR_CONNECTION|NS_ERROR/i.test(msg)) {
          return isMobile
            ? "Connection failed on mobile. Try: (1) Switch to Wi‑Fi if on cellular. (2) Use Chrome or Safari directly (not in-app browser). (3) Disable private/incognito mode. (4) Ensure the app is served over HTTPS."
            : "Connection failed. If developing locally, run 'python3 -m http.server 8000' and open http://localhost:8000/template.html. Otherwise ensure the app is served over HTTPS.";
        }
        return msg;
      }

      function showAuthError(msg) {
        if (!errorEl) return;
        errorEl.textContent = authErrorMessage(msg);
        errorEl.style.display = "block";
      }

      function clearAuthError() {
        if (errorEl) { errorEl.textContent = ""; errorEl.style.display = "none"; }
      }

      function setAuthLoading(which) {
        var isLogin = which === "login";
        var isSignup = which === "signup";
        var busy = isLogin || isSignup;
        if (submitBtn) {
          submitBtn.disabled = busy;
          submitBtn.textContent = isLogin ? "Logging in…" : "Log in";
        }
        if (signupSubmitBtn) {
          signupSubmitBtn.disabled = busy;
          signupSubmitBtn.textContent = isSignup ? "Signing up…" : "Sign up";
        }
      }

      function withTimeout(promise, ms, message) {
        return Promise.race([
          promise,
          new Promise((_, reject) => setTimeout(() => reject(new Error(message)), ms))
        ]);
      }

      function showModalView(view) {
        const isConfig = view === "config";
        if (configSection) configSection.classList.toggle("hidden", !isConfig);
        if (loginSection) loginSection.classList.toggle("hidden", isConfig);
        clearAuthError();
      }

      function fillRememberedEmail() {
        try {
          const saved = localStorage.getItem(GANTT_AUTH_REMEMBER_EMAIL_KEY);
          if (saved && emailInput) emailInput.value = saved;
        } catch (e) {}
      }

      function openModal() {
        overlay?.classList.add("visible");
        if (window.ganttStorage.isCloudEnabled()) {
          showModalView("login");
          var hintEl = document.getElementById("ganttAuthProjectHint");
          if (hintEl) {
            var cfg = window.ganttStorage.getSavedConfig();
            hintEl.textContent = cfg && cfg.url ? "Project: " + cfg.url : "";
          }
          fillRememberedEmail();
          emailInput?.focus();
        } else {
          showModalView("config");
          const saved = window.ganttStorage.getSavedConfig();
          if (configUrlInput) configUrlInput.value = saved?.url || "";
          if (configAnonInput) configAnonInput.value = saved?.anonKey || "";
          configUrlInput?.focus();
        }
      }

      var hadSession = false;
      function updateAuthUI(session) {
        const show = !!session;
        if (hadSession && !show && typeof showToast === "function") {
          showToast("You've logged out.", { type: "error" });
        }
        hadSession = !!session;
        if (wrap) wrap.style.display = show ? "" : "none";
        if (loginBtn) loginBtn.style.display = show ? "none" : "";
        if (userEmailEl) userEmailEl.textContent = show ? (session.user?.email || "Signed in") : "";
        if (supabaseLink && window.ganttStorage) {
          const config = window.ganttStorage.getSavedConfig();
          if (config && config.url) {
            const m = config.url.match(/^https:\/\/([^.]+)\.supabase\.co/);
            supabaseLink.href = m ? "https://supabase.com/dashboard/project/" + m[1] : "https://supabase.com/dashboard";
          } else supabaseLink.href = "https://supabase.com/dashboard";
        }
        wrap?.classList.remove("open");
        if (show && typeof renderHomeView === "function") renderHomeView();
      }
      window.ganttStorage.onAuthChange(updateAuthUI);

      if (loginBtn) loginBtn.addEventListener("click", openModal);
      window.openGanttAuthModal = openModal;
      if (userTrigger && wrap) {
        userTrigger.addEventListener("click", (e) => {
          e.stopPropagation();
          wrap.classList.toggle("open");
          userTrigger.setAttribute("aria-expanded", wrap.classList.contains("open"));
        });
      }
      document.addEventListener("click", (e) => {
        if (wrap && wrap.classList.contains("open") && !wrap.contains(e.target)) wrap.classList.remove("open");
      });
      if (userDropdown) userDropdown.addEventListener("click", (e) => e.stopPropagation());
      if (supabaseLink) supabaseLink.addEventListener("click", () => wrap?.classList.remove("open"));
      if (logoutBtn) logoutBtn.addEventListener("click", async () => {
        wrap?.classList.remove("open");
        await window.ganttStorage.signOut();
        setTimeout(function () { location.reload(); }, 1200);
      });
      if (overlay) overlay.addEventListener("click", (e) => { if (e.target === overlay) overlay.classList.remove("visible"); });
      if (cancelConfigBtn) cancelConfigBtn.addEventListener("click", () => overlay?.classList.remove("visible"));

      if (configSaveBtn) configSaveBtn.addEventListener("click", () => {
        try {
          errorEl.style.display = "none";
          errorEl.textContent = "";
          const url = (configUrlInput && configUrlInput.value || "").trim();
          const anonKey = (configAnonInput && configAnonInput.value || "").trim();
          const result = window.ganttStorage.saveConfig({ url, anonKey });
          if (result && result.error) {
            errorEl.textContent = (result.error.message || "Invalid config");
            errorEl.style.display = "block";
            return;
          }
          if (!result || !result.ok) return;
          showModalView("login");
          fillRememberedEmail();
          emailInput?.focus();
        } catch (err) {
          if (errorEl) {
            errorEl.textContent = (err && err.message) || String(err);
            errorEl.style.display = "block";
          }
        }
      });

      if (showConfigLink) showConfigLink.addEventListener("click", () => {
        const saved = window.ganttStorage.getSavedConfig();
        if (configUrlInput) configUrlInput.value = saved?.url || "";
        if (configAnonInput) configAnonInput.value = saved?.anonKey || "";
        showModalView("config");
        configUrlInput?.focus();
      });

      var clearSessionBtn = document.getElementById("ganttAuthClearSession");
      if (clearSessionBtn) clearSessionBtn.addEventListener("click", async () => {
        if (!confirm("Clear saved session and reload? You’ll need to log in again. Use this if login works in incognito but not in this window (cache issue).")) return;
        if (window.ganttStorage) await window.ganttStorage.signOut();
        location.reload();
      });

      var testResultEl = document.getElementById("ganttAuthTestResult");
      var testConnBtn = document.getElementById("ganttAuthTestConnection");
      if (testConnBtn && testResultEl) testConnBtn.addEventListener("click", async function () {
        testResultEl.textContent = "Testing…";
        testResultEl.className = "auth-test-result";
        var cfg = (configUrlInput?.value?.trim() && configAnonInput?.value?.trim())
          ? { url: configUrlInput.value.trim(), anonKey: configAnonInput.value.trim() }
          : (window.ganttStorage && window.ganttStorage.getSavedConfig());
        if (!cfg || !cfg.url || !cfg.anonKey) {
          testResultEl.textContent = "Enter project URL and key above, or save first.";
          testResultEl.className = "auth-test-result fail";
          return;
        }
        var url = (cfg.url || "").replace(/\/$/, "") + "/auth/v1/health";
        var controller = new AbortController();
        var timeoutId = setTimeout(function () { controller.abort(); }, 8000);
        try {
          var r = await fetch(url, { method: "GET", headers: { apikey: cfg.anonKey }, signal: controller.signal });
          clearTimeout(timeoutId);
          if (r.ok) {
            testResultEl.textContent = "Connection OK — project is reachable.";
            testResultEl.className = "auth-test-result ok";
          } else {
            testResultEl.textContent = "Connection failed: " + r.status + " " + r.statusText;
            testResultEl.className = "auth-test-result fail";
          }
        } catch (e) {
          clearTimeout(timeoutId);
          var msg = e && e.name === "AbortError" ? "Timed out (8s) — project may be paused or unreachable." : (e && e.message ? e.message : String(e));
          testResultEl.textContent = "Connection failed: " + msg;
          testResultEl.className = "auth-test-result fail";
        }
      });

      if (submitBtn) submitBtn.addEventListener("click", async () => {
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value;
        clearAuthError();
        if (!email || !password) { showAuthError("Enter email and password."); return; }
        if (window.location.protocol === "file:") {
          showAuthError("Login doesn't work when the app is opened as a local file. Run a local web server (e.g. python -m http.server 8000), then open http://localhost:8000 in an external browser (Chrome, Safari)—Cursor's built-in browser may not connect to localhost.");
          return;
        }
        var cfg = (configUrlInput?.value?.trim() && configAnonInput?.value?.trim())
          ? { url: configUrlInput.value.trim(), anonKey: configAnonInput.value.trim() }
          : (window.ganttStorage && window.ganttStorage.getSavedConfig());
        if (cfg && cfg.url && cfg.anonKey && !window.ganttStorage?.isCloudEnabled?.()) {
          window.ganttStorage?.init?.(cfg);
          try { await window.ganttStorage?.saveConfig?.(cfg); } catch (e) {}
        }
        setAuthLoading("login");
        try {
          const isMobile = /iPhone|iPad|iPod|Android|webOS|Mobile/i.test(navigator.userAgent || "");
          const loginTimeout = isMobile ? 90000 : 60000;
          const result = await withTimeout(
            window.ganttStorage.signIn(email, password),
            loginTimeout,
            "Login timed out. Try: (1) Restore the project in the Supabase dashboard if it's paused. (2) Use the anon key from Settings → API → Legacy API Keys instead of the Publishable key. (3) Check the project URL above is correct. (4) Ensure the app is served over https or localhost."
          );
          if (result && result.error) { showAuthError(result.error); return; }
          try {
            if (rememberCheckbox?.checked) localStorage.setItem(GANTT_AUTH_REMEMBER_EMAIL_KEY, email);
            else localStorage.removeItem(GANTT_AUTH_REMEMBER_EMAIL_KEY);
            if (typeof setStorageMode === "function") setStorageMode("supabase");
          } catch (e) {}
          overlay.classList.remove("visible");
          if (typeof renderHomeView === "function") renderHomeView();
          if (window.ganttStorage?.refreshAuthUI) await window.ganttStorage.refreshAuthUI();
        } catch (err) {
          var msg = err && err.message ? err.message : "Network or server error. Check your connection and try again.";
          if (typeof console !== "undefined" && console.warn) console.warn("[Login]", msg);
          showAuthError(msg);
        } finally {
          setAuthLoading(false);
        }
      });

      if (signupSubmitBtn) signupSubmitBtn.addEventListener("click", async () => {
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value;
        clearAuthError();
        if (!email || !password) { showAuthError("Enter email and password."); return; }
        if (window.location.protocol === "file:") {
          showAuthError("Sign up doesn't work when the app is opened as a local file. Run a local web server (e.g. python -m http.server 8000), then open http://localhost:8000 in an external browser (Chrome, Safari)—Cursor's built-in browser may not connect to localhost.");
          return;
        }
        var cfg = (configUrlInput?.value?.trim() && configAnonInput?.value?.trim())
          ? { url: configUrlInput.value.trim(), anonKey: configAnonInput.value.trim() }
          : (window.ganttStorage && window.ganttStorage.getSavedConfig());
        if (cfg && cfg.url && cfg.anonKey && !window.ganttStorage?.isCloudEnabled?.()) {
          window.ganttStorage?.init?.(cfg);
          try { await window.ganttStorage?.saveConfig?.(cfg); } catch (e) {}
        }
        setAuthLoading("signup");
        try {
          const isMobile = /iPhone|iPad|iPod|Android|webOS|Mobile/i.test(navigator.userAgent || "");
          const signupTimeout = isMobile ? 30000 : 20000;
          const result = await withTimeout(
            window.ganttStorage.signUp(email, password),
            signupTimeout,
            "Request took too long. Try again or clear this site's data and try again."
          );
          if (result && result.error) { showAuthError(result.error); return; }
          try { if (typeof setStorageMode === "function") setStorageMode("supabase"); } catch (e) {}
          overlay.classList.remove("visible");
          if (typeof renderHomeView === "function") renderHomeView();
          if (window.ganttStorage?.refreshAuthUI) await window.ganttStorage.refreshAuthUI();
        } catch (err) {
          showAuthError(err && err.message ? err.message : "Network or server error. Check your connection and try again.");
        } finally {
          setAuthLoading(false);
        }
      });
    }

    function applyStorageModeUI(mode) {
      var sec = document.getElementById("sharedFileSection");
      var backupSec = document.getElementById("localBackupSection");
      var storageBtn = document.getElementById("homeSettingsBtn");
      if (mode === "github") {
        if (sec) sec.style.display = "";
        if (backupSec) backupSec.style.display = "none";
        if (storageBtn) storageBtn.style.display = "";
        if (typeof initSharedFile === "function") initSharedFile();
      } else {
        window.hasWriteAccess = function () { return true; };
        if (sec) sec.style.display = "none";
        if (storageBtn) storageBtn.style.display = "";
        if (mode === "local_storage") {
          if (backupSec) backupSec.style.display = "flex";
          initLocalBackupHandlers();
        } else {
          if (backupSec) backupSec.style.display = "none";
        }
      }
      if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
    }
    function initSettingsSidebar() {
      document.getElementById("homeSettingsBtn")?.addEventListener("click", openHomeSettings);
      document.getElementById("settingsClose")?.addEventListener("click", closeSettingsModal);
      document.getElementById("settingsSidebarOverlay")?.addEventListener("click", closeSettingsModal);
      (function initShareModal() {
        var overlay = document.getElementById("shareModalOverlay");
        var linkInput = document.getElementById("shareModalLink");
        var copyBtn = document.getElementById("shareModalCopy");
        var statusEl = document.getElementById("shareModalStatus");
        var closeBtn = document.getElementById("shareModalClose");
        document.getElementById("shareBoardBtn")?.addEventListener("click", async function () {
          if (!currentProjectId || !window.ganttStorage?.isCloudEnabled()) return;
          var createLink = window.ganttStorage.createBoardInviteLink;
          if (typeof createLink !== "function") {
            if (typeof showToast === "function") showToast("Invite link unavailable. Update supabase-storage.js and redeploy.", { type: "error" });
            return;
          }
          var result = await createLink(currentProjectId, 168);
          if (result && result.error) {
            var msg = result.error && result.error.message ? result.error.message : (result.error && typeof result.error === "string" ? result.error : "Could not create link");
            if (msg === "not_owner") msg = "Only the board owner can invite people.";
            if (typeof showToast === "function") showToast(msg, { type: "error" });
            return;
          }
          var base = (typeof location !== "undefined" && location.origin) ? location.origin + (location.pathname || "") : "";
          var url = base + "#/project/" + currentProjectId + "?invite=" + (result.token || "");
          if (linkInput) linkInput.value = url;
          if (statusEl) statusEl.textContent = "";
          if (overlay) overlay.style.display = "flex";
        });
        copyBtn?.addEventListener("click", function () {
          if (!linkInput || !linkInput.value) return;
          linkInput.select();
          try {
            navigator.clipboard.writeText(linkInput.value);
            if (statusEl) statusEl.textContent = "Copied to clipboard";
            if (typeof showToast === "function") showToast("Link copied to clipboard");
          } catch (e) {
            if (statusEl) statusEl.textContent = "Could not copy";
          }
        });
        closeBtn?.addEventListener("click", function () {
          if (overlay) overlay.style.display = "none";
        });
        overlay?.addEventListener("click", function (e) {
          if (e.target === overlay) overlay.style.display = "none";
        });
        document.getElementById("collaboratorsInviteBtn")?.addEventListener("click", function () {
          document.getElementById("shareBoardBtn")?.click();
        });
      })();
      document.getElementById("settingsCancel")?.addEventListener("click", closeSettingsModal);
      document.getElementById("settingsSave")?.addEventListener("click", saveSettingsFromModal);
      document.getElementById("settingsExportPdfDownload")?.addEventListener("click", async function () {
        if (typeof html2pdf === "undefined") {
          if (typeof showToast === "function") showToast("PDF library not loaded. Check your connection.", { type: "error" });
          return;
        }
        if (!currentProjectId) {
          if (typeof showToast === "function") showToast("Open a board first, then try Download PDF.", { type: "error" });
          return;
        }
        var el = document.getElementById("ganttView");
        if (!el) {
          if (typeof showToast === "function") showToast("Board not found.", { type: "error" });
          return;
        }
        closeSettingsModal();
        if (typeof showToast === "function") showToast("Generating PDF…", { type: "info" });
        var title = document.getElementById("pageTitle")?.textContent?.trim() || (typeof loadPageHeader === "function" && loadPageHeader()?.title) || "Gantt Chart";
        var safeName = (title || "board").replace(/[^\w\s-]/g, "").replace(/\s+/g, "-").slice(0, 50) || "gantt-board";
        try {
          window.scrollTo(0, 0);
          await new Promise(function (r) { requestAnimationFrame(function () { setTimeout(r, 150); }); });
          var opt = {
            margin: 10,
            filename: safeName + ".pdf",
            image: { type: "jpeg", quality: 0.95 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              logging: false,
              scrollX: 0,
              scrollY: 0,
              onclone: function (clonedDoc) {
                var clone = clonedDoc.getElementById("ganttView");
                if (clone) {
                  clone.style.opacity = "1";
                  clone.style.overflow = "visible";
                  clone.style.pointerEvents = "auto";
                }
              }
            },
            jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
          };
          await html2pdf().set(opt).from(el).save();
          if (typeof showToast === "function") showToast("PDF downloaded.");
        } catch (e) {
          if (typeof showToast === "function") showToast("Could not generate PDF.", { type: "error" });
          console.error(e);
        }
      });
      document.getElementById("settingsExportPdf")?.addEventListener("click", function () {
        try { window.print(); } catch (e) { if (typeof showToast === "function") showToast("Print not available.", { type: "error" }); }
      });
      document.getElementById("settingsExportFigma")?.addEventListener("click", function () {
        try {
          var design = exportBoardAsDesignJson();
          var json = JSON.stringify(design, null, 2);
          var wrap = document.getElementById("settingsExportJsonWrap");
          var ta = document.getElementById("settingsExportJson");
          if (wrap && ta) {
            ta.value = json;
            wrap.style.display = "block";
            ta.focus();
            ta.select();
          } else if (typeof showToast === "function") {
            showToast("Could not show JSON.", { type: "error" });
          }
        } catch (e) {
          if (typeof showToast === "function") showToast("Could not export: " + (e.message || "unknown error"), { type: "error" });
        }
      });
      document.getElementById("settingsExportFigjam")?.addEventListener("click", function () {
        try {
          var design = exportBoardAsDesignJson();
          var json = JSON.stringify(design, null, 2);
          var wrap = document.getElementById("settingsExportJsonWrap");
          var ta = document.getElementById("settingsExportJson");
          if (wrap && ta) {
            ta.value = json;
            wrap.style.display = "block";
            ta.focus();
            ta.select();
          } else if (typeof showToast === "function") {
            showToast("Could not show JSON.", { type: "error" });
          }
        } catch (e) {
          if (typeof showToast === "function") showToast("Could not export: " + (e.message || "unknown error"), { type: "error" });
        }
      });
      document.getElementById("settingsSupabaseAuthBtn")?.addEventListener("click", function () {
        closeSettingsModal();
        if (typeof window.openGanttAuthModal === "function") window.openGanttAuthModal();
      });
      document.getElementById("settingsOpenSyncBtn")?.addEventListener("click", function () {
        closeSettingsModal();
        if (typeof window.openStorageModal === "function") window.openStorageModal();
      });
      document.querySelectorAll(".settings-tabs .settings-tab").forEach(function (tab) {
        tab.addEventListener("click", function () {
          var tabId = this.dataset.tab;
          var tabRow = this.closest(".settings-tabs");
          if (!tabRow) return;
          tabRow.querySelectorAll(".settings-tab").forEach(function (t) { t.classList.remove("active"); });
          this.classList.add("active");
          document.querySelectorAll(".settings-tab-panel").forEach(function (p) { p.classList.remove("active"); });
          var panelId = tabId === "function" ? "Function" : tabId === "style" ? "Style" : tabId === "details" ? "Details" : tabId === "tasks" ? "Tasks" : tabId === "storage" ? "Storage" : "Function";
          var panel = document.getElementById("settingsTab" + panelId);
          if (panel) panel.classList.add("active");
          var body = document.querySelector(".settings-drawer-body");
          if (body) body.scrollTop = 0;
          if (tabId === "tasks" && typeof updateAutoPopulateSectionVisibility === "function") updateAutoPopulateSectionVisibility();
          if (tabId === "storage" && typeof window.switchStorageType === "function") {
            var mode = typeof getStorageMode === "function" ? getStorageMode() : "local_storage";
            var type = (window.ganttStorage?.isCloudEnabled && window.ganttStorage.isCloudEnabled()) ? "supabase" : (mode === "local_cache" ? "local_cache" : (mode === "local_storage" || mode === "github" ? mode : "github"));
            window.switchStorageType(type);
          }
          if (tabId === "function") {
            var isBoard = tabRow.id === "settingsTabsBoard";
            var homePanel = document.getElementById("settingsGeneralHome");
            var boardPanel = document.getElementById("settingsGeneralBoard");
            if (homePanel) homePanel.style.display = isBoard ? "none" : "";
            if (boardPanel) boardPanel.style.display = isBoard ? "" : "none";
          }
        });
      });
    }
    async function bootstrap() {
      migrateLegacySingleProject();
      initAuthUI();
      initSettingsSidebar();
      (function setupStorageTypePicker() {
        var tiles = document.querySelectorAll(".storage-type-tile");
        function getCurrentStorageType() {
          var mode = getStorageMode() || "local_storage";
          if (window.ganttStorage?.isCloudEnabled && window.ganttStorage.isCloudEnabled()) return "supabase";
          return mode;
        }
        function switchStorageType(type) {
          tiles.forEach(function (t) {
            t.classList.toggle("selected", t.dataset.value === type);
          });
          if (type === "local_storage" && typeof initLocalBackupHandlers === "function") initLocalBackupHandlers();
          if (type === "github") {
            if (typeof initSharedFile === "function") initSharedFile();
            if (typeof updateModalStatus === "function") updateModalStatus();
          }
        }
        window.switchStorageTab = function (tab) {
          if (tab === "external") switchStorageType(getStorageMode() === "github" ? "github" : (window.ganttStorage?.isCloudEnabled?.() ? "supabase" : "local_storage"));
          else if (tab === "local") switchStorageType(getStorageMode() === "local_cache" ? "local_cache" : "local_storage");
        };
        window.switchStorageType = switchStorageType;
        window.closeStorageModal = function () {
          document.getElementById("appViewsWrap")?.classList.remove("settings-sidebar-open");
        };
        window.openStorageModal = function () {
          if (typeof initSharedFile === "function") initSharedFile();
          window._settingsContext = "home";
          var titleEl = document.getElementById("settingsSidebarTitle");
          var tabsHome = document.getElementById("settingsTabsHome");
          var tabsBoard = document.getElementById("settingsTabsBoard");
          if (titleEl) titleEl.textContent = "Settings";
          if (tabsHome) tabsHome.style.display = "";
          if (tabsBoard) tabsBoard.style.display = "none";
          switchStorageType(getCurrentStorageType());
          document.getElementById("appViewsWrap")?.classList.add("settings-sidebar-open");
          document.querySelectorAll(".settings-tab").forEach(function (t) { t.classList.remove("active"); });
          document.querySelectorAll(".settings-tab-panel").forEach(function (p) { p.classList.remove("active"); });
          var storageTab = document.querySelector('.settings-tab[data-tab="storage"]');
          var storagePanel = document.getElementById("settingsTabStorage");
          if (storageTab) storageTab.classList.add("active");
          if (storagePanel) storagePanel.classList.add("active");
          if (typeof updateModalStatus === "function") updateModalStatus();
        };
        document.getElementById("storageTypeTiles")?.addEventListener("click", function (e) {
          if (e.target.closest(".storage-type-tile-content")) return;
          var tile = e.target.closest(".storage-type-tile");
          if (!tile) return;
          switchStorageType(tile.dataset.value);
        });
        document.getElementById("storageTypeTiles")?.addEventListener("keydown", function (e) {
          if (e.key !== "Enter" && e.key !== " ") return;
          var tile = e.target.closest(".storage-type-tile");
          if (!tile) return;
          e.preventDefault();
          switchStorageType(tile.dataset.value);
        });
        switchStorageType(getCurrentStorageType());
        document.getElementById("storageModalBackupToFile")?.addEventListener("click", function () {
          var snap = exportSharedSnapshot();
          var blob = new Blob([JSON.stringify(snap, null, 2)], { type: "application/json" });
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "gantt-data.json";
          a.click();
          URL.revokeObjectURL(a.href);
          if (typeof showToast === "function") showToast("Backed up to gantt-data.json", { type: "success" });
        });
        var storageRestoreInput = document.getElementById("storageModalRestoreFileInput");
        document.getElementById("storageModalRestoreFromFile")?.addEventListener("click", function () { if (storageRestoreInput) storageRestoreInput.click(); });
        if (storageRestoreInput) storageRestoreInput.addEventListener("change", function () {
          var f = storageRestoreInput.files && storageRestoreInput.files[0];
          if (!f) return;
          var r = new FileReader();
          r.onload = function () {
            try {
              var data = JSON.parse(r.result);
              importSharedSnapshot(data);
              if (typeof handleRoute === "function") { location.hash = "#/"; handleRoute(); }
              if (typeof renderHomeView === "function") renderHomeView();
              if (typeof window.closeStorageModal === "function") window.closeStorageModal();
              if (typeof showToast === "function") showToast("Boards restored from file.", { type: "success" });
            } catch (e) { if (typeof showToast === "function") showToast("Restore failed: " + (e && e.message ? e.message : String(e)), { type: "error" }); }
            storageRestoreInput.value = "";
          };
          r.readAsText(f);
        });
      })();
      var landingView = document.getElementById("landingView");
      var homeViewEl = document.getElementById("homeView");
      var ganttViewEl = document.getElementById("ganttView");
      // Restore Supabase session from storage so refresh doesn't kick user out (e.g. in Cursor browser)
      if (window.ganttStorage?.isCloudEnabled() && typeof window.ganttStorage.ensureSessionRestored === "function") {
        await window.ganttStorage.ensureSessionRestored();
      }
      if (!getStorageMode() && window.ganttStorage?.isCloudEnabled()) {
        var existingSession = await window.ganttStorage.getSession();
        if (existingSession) {
          try { setStorageMode("supabase"); } catch (e) {}
        }
      }
      try {
        if (!getStorageMode() && (localStorage.getItem(SHARED_FILE_URL_KEY) || "").trim()) setStorageMode("github");
      } catch (e) {}
      if (!getStorageMode()) {
        if (landingView) landingView.classList.add("active");
        if (homeViewEl) homeViewEl.classList.remove("active");
        if (ganttViewEl) ganttViewEl.classList.remove("active");
        if (document.body) document.body.classList.remove("gantt-view-active");
        document.getElementById("landingOptionGitHub")?.addEventListener("click", function () {
          setStorageMode("github");
          if (landingView) landingView.classList.remove("active");
          handleRoute();
          initSharedFile();
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
          if (typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
          else if (typeof window.__fetchSharedUpdates === "function") window.__fetchSharedUpdates();
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
          var openBtn = document.getElementById("sharedFileOpenModal");
          if (openBtn) openBtn.click();
        });
        document.getElementById("landingOptionSupabase")?.addEventListener("click", function () {
          setStorageMode("supabase");
          if (landingView) landingView.classList.remove("active");
          handleRoute();
          if (typeof applyStorageModeUI === "function") applyStorageModeUI("supabase");
          var openBtn = document.getElementById("sharedFileOpenModal");
          if (openBtn) openBtn.click();
        });
        document.getElementById("landingOptionLocalStorage")?.addEventListener("click", function () {
          setStorageMode("local_storage");
          location.reload();
        });
        document.getElementById("landingOptionLocalCache")?.addEventListener("click", function () {
          setStorageMode("local_cache");
          location.reload();
        });
        return;
      }
      if (getStorageMode() !== "github" && !window.ganttStorage?.isCloudEnabled()) {
        window.hasWriteAccess = function () { return true; };
        var sec = document.getElementById("sharedFileSection");
        if (sec) sec.style.display = "none";
        var storageBtn = document.getElementById("homeSettingsBtn");
        if (storageBtn) storageBtn.style.display = "";
        if (getStorageMode() === "local_storage") {
          var backupSec = document.getElementById("localBackupSection");
          if (backupSec) backupSec.style.display = "flex";
          initLocalBackupHandlers();
        }
      }
      if (window.ganttStorage?.isCloudEnabled()) {
        var session = await window.ganttStorage.getSession();
        if (session) {
          try { if (typeof setStorageMode === "function") setStorageMode("supabase"); } catch (e) {}
          await window.ganttStorage.ensureBoardsListLoaded();
        }
        if (window.ganttStorage?.refreshAuthUI) window.ganttStorage.refreshAuthUI();
        [100, 350, 800, 1500, 2500].forEach(function (delay) {
          setTimeout(async function () {
            var s = await window.ganttStorage.getSession();
            if (s) {
              await window.ganttStorage.ensureBoardsListLoaded();
              if (window.ganttStorage?.refreshAuthUI) window.ganttStorage.refreshAuthUI();
            }
          }, delay);
        });
      }
      function initSharedFile() {
        if (window.__sharedFileInited) return;
        window.__sharedFileInited = true;
        var urlInput = document.getElementById("sharedFileUrl");
        var loadBtn = document.getElementById("sharedFileLoad");
        var refreshBtn = document.getElementById("sharedFileRefresh");
        var downloadBtn = document.getElementById("sharedFileDownload");
        var statusDot = document.getElementById("sharedFileStatusDot");
        var statusText = document.getElementById("sharedFileStatusText");
        var modalStatusDot = document.getElementById("sharedFileModalStatusDot");
        var modalStatusText = document.getElementById("sharedFileModalStatusText");
        var modalTokenStatusDot = document.getElementById("sharedFileModalTokenStatusDot");
        var modalTokenStatusText = document.getElementById("sharedFileModalTokenStatusText");
        var modalOverlay = document.getElementById("sharedFileModalOverlay");
        var openModalBtn = document.getElementById("sharedFileOpenModal");
        var closeModalBtn = document.getElementById("sharedFileModalClose");
        var tokenInput = document.getElementById("sharedFileGitHubToken");
        try {
          if (urlInput) urlInput.value = localStorage.getItem(SHARED_FILE_URL_KEY) || "";
        } catch (e) {}
        function getSharedFileStatus(url) {
          var u = (url && url.trim()) || "";
          if (!u) return { type: "none", label: "Not set" };
          var m = u.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/(?:refs\/heads\/)?([^/]+)\/(.+)/);
          if (m) return { type: "github", label: m[1] + "/" + m[2] };
          return { type: "custom", label: "Custom URL" };
        }
        function isSynced() {
          try { var u = localStorage.getItem(SHARED_FILE_URL_KEY); return !!(u && u.trim()); } catch (e) { return false; }
        }
        function hasWriteAccess() {
          if (window.ganttStorage && window.ganttStorage.isCloudEnabled && window.ganttStorage.isCloudEnabled()) {
            if (typeof currentProjectId === "undefined" || !currentProjectId) return true;
            var list = (typeof loadProjectsList === "function" ? loadProjectsList() : []) || [];
            var p = list.find(function (x) { return x.id === currentProjectId; });
            return p ? !!p.isOwner : true;
          }
          if (!isSynced()) return true;
          try { var t = localStorage.getItem(GITHUB_TOKEN_KEY); return !!(t && t.trim()); } catch (e) { return false; }
        }
        window.hasWriteAccess = hasWriteAccess;
        function updateWriteAccessUI() {
          var canWrite = hasWriteAccess();
          var fab = document.getElementById("homeFab");
          if (fab) fab.style.display = canWrite ? "" : "none";
          var fabMobile = document.getElementById("homeFabMobile");
          if (fabMobile) fabMobile.style.display = canWrite ? "" : "none";
          var mobileFabBar = document.getElementById("homeMobileFabBar");
          if (mobileFabBar) mobileFabBar.style.display = canWrite ? "" : "none";
          var readonlyBadge = document.getElementById("homeReadonlyBadge");
          var badgeText = document.getElementById("homeReadonlyBadgeText");
          var synced = typeof isSynced === "function" && isSynced();
          if (readonlyBadge) {
            readonlyBadge.style.display = synced ? "inline-flex" : "none";
            if (badgeText) {
              if (typeof syncInProgress !== "undefined" && syncInProgress) badgeText.textContent = "Syncing…";
              else badgeText.textContent = synced ? (canWrite ? "Synced with Github (write)" : "Synced with Github (read)") : "";
            }
            readonlyBadge.setAttribute("data-tooltip", synced && !canWrite ? "You are in read only, add your access token for edit access" : "Sync Settings");
            readonlyBadge.classList.remove("status-syncing", "status-error");
            if (synced) {
              if (typeof syncInProgress !== "undefined" && syncInProgress) readonlyBadge.classList.add("status-syncing");
              else if (typeof sharedFetchFailCount !== "undefined" && sharedFetchFailCount >= 2) readonlyBadge.classList.add("status-error");
            }
          }
          var addFab = document.getElementById("addTaskFab");
          if (addFab) {
            var homeActive = document.getElementById("homeView")?.classList.contains("active");
            addFab.style.display = (canWrite && !homeActive) ? "" : "none";
          }
          var settingsBtn = document.getElementById("settingsBtn");
          if (settingsBtn) settingsBtn.style.display = canWrite ? "" : "none";
          var shareBoardBtn = document.getElementById("shareBoardBtn");
          var hasInviteLink = typeof window.ganttStorage?.createBoardInviteLink === "function";
          var showShare = window.ganttStorage?.isCloudEnabled() && hasInviteLink && canWrite && typeof currentProjectId === "string" && UUID_REGEX.test(currentProjectId);
          if (shareBoardBtn) shareBoardBtn.style.display = showShare ? "" : "none";
          var ganttView = document.getElementById("ganttView");
          if (ganttView) ganttView.classList.toggle("gantt-read-only", !canWrite);
          document.querySelectorAll("#ganttGrid .gantt-row:not(.gantt-header)").forEach(function (r) { r.draggable = canWrite; });
        }
        window.updateWriteAccessUI = updateWriteAccessUI;
        var syncInProgress = null;
        function updateHomeStatus() {
          if (syncInProgress) {
            if (statusDot) { statusDot.className = "home-shared-file-status-dot synced syncing"; }
            if (statusText) { statusText.textContent = "Syncing…"; statusText.style.display = ""; }
            var openBtn = document.getElementById("sharedFileOpenModal");
            if (openBtn) openBtn.style.display = "none";
            var sec = document.getElementById("sharedFileSection");
            if (sec && typeof getStorageMode === "function" && getStorageMode() === "github") sec.style.display = "none";
            if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
            return;
          }
          var synced = isSynced();
          var dotClass = "home-shared-file-status-dot " + (synced ? "synced" : "local");
          if (synced && sharedFetchFailCount >= 2) dotClass += " error";
          if (statusDot) { statusDot.className = dotClass; }
          if (statusText) {
            statusText.textContent = synced ? (hasWriteAccess() ? "Synced with Github (write)" : "Synced with Github (read)") : "";
            statusText.style.display = synced ? "" : "none";
          }
          var openBtn = document.getElementById("sharedFileOpenModal");
          if (openBtn) openBtn.style.display = synced ? "none" : "";
          var sec = document.getElementById("sharedFileSection");
          if (sec && typeof getStorageMode === "function" && getStorageMode() === "github") {
            sec.style.display = synced ? "none" : "";
          }
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
        }
        function updateModalStatus() {
          var url = (urlInput && urlInput.value) ? urlInput.value : "";
          var st = getSharedFileStatus(url);
          var synced = isSynced();
          if (syncInProgress === "pull") {
            if (modalStatusDot) { modalStatusDot.className = "shared-file-modal-status-dot synced syncing"; }
            if (modalStatusText) modalStatusText.textContent = "Syncing…";
            return;
          }
          if (modalStatusDot) { modalStatusDot.className = "shared-file-modal-status-dot " + (synced ? "synced" : "local"); }
          if (modalStatusText) modalStatusText.textContent = synced ? "Synced" + (st.type !== "none" ? " \u2022 " + (st.type === "github" ? "GitHub: " + st.label : st.label) : "") : "Local";
        }
        function updateModalTokenStatus() {
          var hasToken = (tokenInput && tokenInput.value && tokenInput.value.trim()) ? true : false;
          if (modalTokenStatusDot) modalTokenStatusDot.className = "shared-file-modal-status-dot " + (hasToken ? "synced" : "none");
          if (modalTokenStatusText) modalTokenStatusText.textContent = hasToken ? "Set" : "Not set";
        }
        function openSharedFileModal() {
          if (typeof window.openStorageModal === "function") window.openStorageModal();
          if (window.switchStorageTab) window.switchStorageTab("external");
          try {
            if (urlInput) urlInput.value = localStorage.getItem(SHARED_FILE_URL_KEY) || "";
            if (tokenInput) tokenInput.value = localStorage.getItem(GITHUB_TOKEN_KEY) || "";
          } catch (e) {}
          updateModalStatus();
          updateModalTokenStatus();
        }
        function closeSharedFileModal() {
          try { if (tokenInput && tokenInput.value.trim()) localStorage.setItem(GITHUB_TOKEN_KEY, tokenInput.value.trim()); } catch (e) {}
          document.getElementById("appViewsWrap")?.classList.remove("settings-sidebar-open");
          updateHomeStatus();
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
        }
        if (openModalBtn) openModalBtn.addEventListener("click", openSharedFileModal);
        if (statusText) statusText.addEventListener("click", openSharedFileModal);
        var readonlyBadgeEl = document.getElementById("homeReadonlyBadge");
        if (readonlyBadgeEl) {
          readonlyBadgeEl.addEventListener("click", openSharedFileModal);
          readonlyBadgeEl.addEventListener("keydown", function (e) { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openSharedFileModal(); } });
        }
        if (closeModalBtn) closeModalBtn.addEventListener("click", closeSharedFileModal);
        var clearTokenBtn = document.getElementById("sharedFileClearToken");
        if (clearTokenBtn) clearTokenBtn.addEventListener("click", function () {
          try { localStorage.removeItem(GITHUB_TOKEN_KEY); } catch (e) {}
          if (tokenInput) tokenInput.value = "";
          updateModalTokenStatus();
          updateHomeStatus();
          if (typeof updateWriteAccessUI === "function") updateWriteAccessUI();
          if (typeof showToast === "function") showToast("Token cleared.", { type: "success" });
        });
        if (urlInput) urlInput.addEventListener("input", updateModalStatus);
        if (tokenInput) tokenInput.addEventListener("input", updateModalTokenStatus);
        updateHomeStatus();
        function sharedJsonFetchOptions() {
          return {
            credentials: "omit",
            referrerPolicy: "no-referrer"
          };
        }
        function sharedJsonUrl(u) {
          var base = (u && u.trim()) || "";
          var gh = parseGitHubRawUrl(base);
          if (gh) base = "https://raw.githubusercontent.com/" + gh.owner + "/" + gh.repo + "/" + gh.branch + "/" + gh.path;
          var sep = base.indexOf("?") >= 0 ? "&" : "?";
          return base + sep + "_=" + Date.now() + "&r=" + Math.random().toString(36).slice(2);
        }
        var lastFetchedOid = null;
        function parseGitHubRawUrl(url) {
          if (!url || typeof url !== "string") return null;
          var u = url.trim();
          var m = u.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/refs\/heads\/([^/]+)\/(.+)/);
          if (m) return { owner: m[1], repo: m[2], branch: m[3], path: m[4] };
          m = u.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/([^/]+)\/(.+)/);
          return m ? { owner: m[1], repo: m[2], branch: m[3], path: m[4] } : null;
        }
        var sharedFetchFailCount = 0;
        var sharedFetchPausedUntil = 0;
        function fetchViaGitHubRestApi(gh, token) {
          var pathEnc = gh.path.split("/").map(function (p) { return encodeURIComponent(p); }).join("/");
          var apiUrl = "https://api.github.com/repos/" + encodeURIComponent(gh.owner) + "/" + encodeURIComponent(gh.repo) + "/contents/" + pathEnc + "?ref=" + encodeURIComponent(gh.branch);
          function doFetch(useToken) {
            var headers = { "Accept": "application/vnd.github.raw" };
            if (useToken && token && token.trim()) {
              var authHeader = /^ghp_/.test(token.trim()) ? "token " + token.trim() : "Bearer " + token.trim();
              headers["Authorization"] = authHeader;
            }
            return fetch(apiUrl, {
              credentials: "omit",
              referrerPolicy: "no-referrer",
              headers: headers
            });
          }
          return doFetch(false).then(function (r) {
            if (r.status === 401 && token && token.trim()) return doFetch(true);
            return r;
          }).then(function (r) {
            if (!r.ok) throw new Error(r.status + " " + r.statusText);
            return r.text().then(function (text) {
              try { return JSON.parse(text); } catch (e) { throw new Error("Invalid JSON"); }
            });
          });
        }
        function fetchViaGitHubGraphQL(gh, token) {
          var expr = gh.branch + ":" + gh.path;
          var query = "query($owner: String!, $name: String!, $expr: String!) { repository(owner: $owner, name: $name) { object(expression: $expr) { oid ... on Blob { text } } } }";
          var authHeader = /^ghp_/.test(token) ? "token " + token : "Bearer " + token;
          return fetch("https://api.github.com/graphql", {
            method: "POST",
            credentials: "omit",
            headers: {
              "Content-Type": "application/json",
              "Authorization": authHeader
            },
            body: JSON.stringify({ query: query, variables: { owner: gh.owner, name: gh.repo, expr: expr } })
          }).then(function (r) {
            if (!r.ok) throw new Error(r.status + " " + r.statusText);
            return r.json();
          });
        }
        function canonicalSnapshotForCompare(obj) {
          if (obj === null || typeof obj !== "object") return obj;
          if (Array.isArray(obj)) return obj.map(canonicalSnapshotForCompare);
          var keys = Object.keys(obj).sort();
          var out = {};
          for (var i = 0; i < keys.length; i++) out[keys[i]] = canonicalSnapshotForCompare(obj[keys[i]]);
          return out;
        }
        function snapshotForCompare(snap) {
          if (!snap || !Array.isArray(snap.projects)) return snap;
          var projects = snap.projects.slice().sort(function (a, b) { return String(a.id || "").localeCompare(String(b.id || "")); });
          return canonicalSnapshotForCompare({ projects: projects, boards: snap.boards || {} });
        }
        function fetchSharedUpdates() {
          if (document.visibilityState !== "visible" || !isSynced()) return;
          if (window.ganttStorage && window.ganttStorage.isCloudEnabled && window.ganttStorage.isCloudEnabled()) return;
          if (Date.now() < sharedFetchPausedUntil) return;
          var url;
          try { url = localStorage.getItem(SHARED_FILE_URL_KEY); } catch (e) { return; }
          if (!url || !url.trim()) return;
          syncInProgress = "pull";
          updateHomeStatus();
          var gh = parseGitHubRawUrl(url);
          var token;
          try { token = localStorage.getItem(GITHUB_TOKEN_KEY); } catch (e) {}
          token = (token && token.trim()) || null;
          var fetchPromise;
          if (gh) {
            fetchPromise = fetchViaGitHubRestApi(gh, token).then(function (data) {
              if (data && data.projects) lastFetchedOid = null;
              return data;
            });
          } else {
            fetchPromise = fetch(sharedJsonUrl(url), sharedJsonFetchOptions())
              .then(function (r) { if (!r.ok) return null; return r.json(); })
              .then(function (data) {
                if (data && data.projects) lastFetchedOid = null;
                return data;
              });
          }
          fetchPromise
            .then(function (data) {
              sharedFetchFailCount = 0;
              if (!data || data.skip) return;
              if (!data.projects || !Array.isArray(data.projects)) return;
              var current = exportSharedSnapshot();
              var currentStr = JSON.stringify(snapshotForCompare(current));
              var newStr = JSON.stringify(snapshotForCompare(data));
              if (currentStr === newStr) return;
              if (typeof window.hasWriteAccess === "function" && window.hasWriteAccess()) return;
              importSharedSnapshot(data);
              updateHomeStatus();
              updateModalStatus();
              if (typeof handleRoute === "function") handleRoute();
              else {
                if (typeof renderHomeView === "function") renderHomeView();
                if (currentProjectId && typeof initGantt === "function") initGantt();
              }
              if (typeof showToast === "function") showToast("Data updated from shared file.", { type: "success" });
            })
            .catch(function (err) {
              sharedFetchFailCount++;
              var msg = err && (err.message || String(err));
              var is403 = /403/.test(String(msg));
              if (is403) sharedFetchPausedUntil = Date.now() + 60000;
              if (typeof console !== "undefined" && console.warn && !is403) console.warn("[GitHub sync]", msg);
              if (sharedFetchFailCount >= 2 && typeof showToast === "function") showToast("Sync failed: " + (msg || "Unknown error") + ". Add a GitHub token in Sync Settings to avoid rate limits.", { type: "error" });
            })
            .finally(function () { syncInProgress = null; updateHomeStatus(); });
        }
        window.__fetchSharedUpdates = fetchSharedUpdates;
        window.__doLoadFromStoredUrl = function () {
          try {
            var u = localStorage.getItem(SHARED_FILE_URL_KEY);
            if (u && u.trim()) doLoad(u.trim());
          } catch (e) {}
        };
        setInterval(fetchSharedUpdates, SHARED_FILE_POLL_MS);
        document.addEventListener("visibilitychange", function () { if (document.visibilityState === "visible") fetchSharedUpdates(); });
        if (isSynced()) setTimeout(fetchSharedUpdates, 2000);
        function doLoad(url) {
          var u = (url && url.trim()) || "";
          if (!u) { if (typeof showToast === "function") showToast("Enter a URL first.", { type: "error" }); return; }
          syncInProgress = "pull";
          updateHomeStatus();
          if (typeof updateModalStatus === "function") updateModalStatus();
          var gh = parseGitHubRawUrl(u);
          var token;
          try { token = localStorage.getItem(GITHUB_TOKEN_KEY); } catch (e) {}
          token = (token && token.trim()) || null;
          var loadPromise;
          if (gh) {
            loadPromise = fetchViaGitHubRestApi(gh, token).then(function (data) {
              if (!data) throw new Error("File not found or inaccessible (is the repo public?)");
              return data;
            });
          } else {
            loadPromise = fetch(sharedJsonUrl(u), sharedJsonFetchOptions())
              .then(function (r) { if (!r.ok) throw new Error(r.status + " " + r.statusText); return r.json(); });
          }
          loadPromise
            .then(function (data) {
              var current = typeof exportSharedSnapshot === "function" ? exportSharedSnapshot() : null;
              var currentStr = current ? JSON.stringify(snapshotForCompare(current)) : "";
              var newStr = (data && data.projects) ? JSON.stringify(snapshotForCompare(data)) : "";
              var dataUnchanged = currentStr && newStr && currentStr === newStr;
              if (!dataUnchanged) {
                importSharedSnapshot(data);
              }
              try {
                localStorage.setItem(SHARED_FILE_URL_KEY, u);
                if (typeof setStorageMode === "function") setStorageMode("github");
              } catch (e) {}
              if (urlInput) urlInput.value = u;
              updateHomeStatus();
              updateModalStatus();
              if (!dataUnchanged) {
                var settingsOpen = !!document.getElementById("appViewsWrap")?.classList.contains("settings-sidebar-open");
                if (settingsOpen) {
                  currentProjectId = null;
                  if (typeof renderHomeView === "function") renderHomeView();
                } else {
                  if (typeof handleRoute === "function") { location.hash = "#/"; handleRoute(); } else {
                    if (typeof renderHomeView === "function") renderHomeView();
                    if (currentProjectId && typeof initGantt === "function") initGantt();
                    location.hash = "#/";
                  }
                }
              }
              if (typeof showToast === "function") showToast(dataUnchanged ? "Already up to date." : "Loaded shared file.", { type: "success" });
              if (typeof clearGitHubError === "function") clearGitHubError();
            })
            .catch(function (e) {
              var msg = e && e.message ? e.message : String(e);
              if (typeof setGitHubError === "function") setGitHubError("Load failed: " + msg);
              if (typeof showToast === "function") showToast("Load failed: " + msg, { type: "error" });
            })
            .finally(function () { syncInProgress = null; updateHomeStatus(); if (typeof updateModalStatus === "function") updateModalStatus(); });
        }
        var githubErrorEl = document.getElementById("storageGitHubError");
        function setGitHubError(msg) {
          if (githubErrorEl) { githubErrorEl.textContent = msg || ""; githubErrorEl.classList.toggle("visible", !!(msg && msg.trim())); }
        }
        function clearGitHubError() { setGitHubError(""); }
        if (loadBtn && urlInput) loadBtn.addEventListener("click", function () { clearGitHubError(); doLoad(urlInput.value); });
        if (refreshBtn && urlInput) refreshBtn.addEventListener("click", function () {
          clearGitHubError();
          var url = urlInput.value.trim() || (function () { try { return localStorage.getItem(SHARED_FILE_URL_KEY) || ""; } catch (e) { return ""; } })();
          doLoad(url);
        });
        if (downloadBtn) downloadBtn.addEventListener("click", function () {
          var snap = exportSharedSnapshot();
          var blob = new Blob([JSON.stringify(snap, null, 2)], { type: "application/json" });
          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "gantt-data.json";
          a.click();
          URL.revokeObjectURL(a.href);
          if (typeof showToast === "function") showToast("Downloaded gantt-data.json. Commit to your repo so others can Load/Refresh.", { type: "success" });
        });
        function pushToGitHub(token, gh, pushBtn) {
          syncInProgress = "push";
          updateHomeStatus();
          if (typeof clearGitHubError === "function") clearGitHubError();
          function showPushError(msg) {
            if (typeof setGitHubError === "function") setGitHubError("Push failed: " + msg);
            safeToast("Push failed: " + msg, { type: "error" });
          }
          function statusToMessage(status) {
            if (status === 401) return "Invalid or expired token. Check your Personal Access Token and try again.";
            if (status === 403) return "Access denied. Use a token with repo scope (classic) or Contents read/write (fine-grained) and ensure the token has access to this repository.";
            if (status === 404) return "Repo or file not found. Check URL and that the token can access the repo.";
            if (status === 409) return "Conflict (file changed). Refresh the shared file, then try Push again.";
            if (status === 422) return "Validation failed. Check branch name and file path.";
            if (status >= 500) return "GitHub server error. Try again in a few minutes.";
            return null;
          }
          function readErrorFromBody(text, status) {
            try { var d = JSON.parse(text); return d.message || d.error || (Array.isArray(d.errors) && d.errors[0] && d.errors[0].message) || statusToMessage(status) || status + " error"; } catch (e) { return text && text.length < 120 ? text : (statusToMessage(status) || status + " error"); }
          }
          var snap = exportSharedSnapshot();
          if (snap.boards) {
            Object.keys(snap.boards).forEach(function (id) {
              delete snap.boards[id].view;
              if (snap.boards[id].settings && typeof snap.boards[id].settings === "object") delete snap.boards[id].settings.rowAppearance;
            });
          }
          var json = JSON.stringify(snap, null, 2);
          var content;
          try { content = btoa(unescape(encodeURIComponent(json))); } catch (e) { showPushError("Could not encode data."); if (pushBtn) pushBtn.disabled = false; return; }
          var pathEnc = gh.path.split("/").map(function (p) { return encodeURIComponent(p); }).join("/");
          var api = "https://api.github.com/repos/" + encodeURIComponent(gh.owner) + "/" + encodeURIComponent(gh.repo) + "/contents/" + pathEnc;
          var authHeader = /^ghp_/.test(token) ? "token " + token : "Bearer " + token;
          var fetchOpts = { credentials: "omit", mode: "cors", referrerPolicy: "no-referrer" };
          function getSha() {
            return fetch(api + "?ref=" + encodeURIComponent(gh.branch) + "&_=" + Date.now(), Object.assign({ method: "GET", headers: { "Accept": "application/vnd.github.v3+json", "Authorization": authHeader } }, fetchOpts))
              .then(function (r) {
                return r.text().then(function (text) {
                  if (r.status === 404) return { sha: null };
                  if (!r.ok) throw new Error(readErrorFromBody(text, r.status));
                  try {
                    var d = JSON.parse(text);
                    var shaVal = d.sha;
                    if (Array.isArray(d)) {
                      var baseName = gh.path.split("/").pop();
                      var found = d.find(function (x) { return x.name === baseName || x.path === gh.path; });
                      shaVal = found ? found.sha : null;
                    }
                    if (!shaVal && (d.projects || d.boards)) {
                      throw new Error("Could not read file metadata. Try Load/Refresh first, then Push.");
                    }
                    return { sha: shaVal || null };
                  } catch (e) {
                    if (e && e.message && e.message.indexOf("Could not read") === 0) throw e;
                    throw new Error("Invalid response from GitHub.");
                  }
                });
              });
          }
          function doPut(sha) {
            return fetch(api, Object.assign({
              method: "PUT",
              headers: {
                "Accept": "application/vnd.github.v3+json",
                "Content-Type": "application/json",
                "Authorization": authHeader
              },
              body: JSON.stringify({
                message: "Update gantt data",
                content: content,
                branch: gh.branch,
                sha: sha || undefined
              })
            }, fetchOpts));
          }
          getSha()
            .then(function (o) {
              if (!o) throw new Error("Could not read existing file info.");
              return doPut(o.sha);
            })
            .then(function (r) {
              if (r.status === 409 || r.status === 422) {
                return getSha().then(function (o) {
                  var sha = o && (o.sha || null);
                  if (!sha) throw new Error("Could not get file SHA. Ensure the shared URL is correct and try Load/Refresh first.");
                  return doPut(sha);
                });
              }
              return r;
            })
            .then(function (r) {
              return r.text().then(function (text) {
                if (!r.ok) throw new Error(readErrorFromBody(text, r.status));
                try {
                  if (token && token.trim()) localStorage.setItem(GITHUB_TOKEN_KEY, token.trim());
                  var rawUrl = "https://raw.githubusercontent.com/" + gh.owner + "/" + gh.repo + "/" + gh.branch + "/" + gh.path;
                  localStorage.setItem(SHARED_FILE_URL_KEY, rawUrl);
                } catch (e) {}
                updateHomeStatus();
                updateModalStatus();
                if (typeof showToast === "function") showToast("Pushed to GitHub. Others can Refresh to see changes.", { type: "success" });
                if (typeof clearGitHubError === "function") clearGitHubError();
              });
            })
            .catch(function (e) {
              var msg = e && e.message ? e.message : String(e);
              if (msg.indexOf("Failed to fetch") !== -1 || msg.indexOf("NetworkError") !== -1) showPushError("Network error. Check connection or run the app from a local server (not file://)."); else showPushError(msg);
            })
            .finally(function () {
              syncInProgress = null;
              updateHomeStatus();
              if (pushBtn) pushBtn.disabled = false;
            });
        }
        var pushBtn = document.getElementById("sharedFilePush");
        function safeToast(msg, type) {
          try { if (typeof showToast === "function") showToast(msg, type || {}); else if (typeof alert !== "undefined") alert(msg); } catch (err) { if (typeof console !== "undefined") console.warn("Push:", msg); }
        }
        function onPushClick(e) {
          var btn = e.target.id === "sharedFilePush" ? e.target : (e.target.closest && e.target.closest("#sharedFilePush"));
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          var urlEl = document.getElementById("sharedFileUrl");
          var tokenEl = document.getElementById("sharedFileGitHubToken");
          var token = (tokenEl && tokenEl.value || "").trim();
          if (!token) { safeToast("Paste a GitHub Personal Access Token first.", { type: "error" }); return; }
          var url = (urlEl && urlEl.value || "").trim() || (function () { try { return localStorage.getItem(SHARED_FILE_URL_KEY) || ""; } catch (e) { return ""; } })();
          var gh = parseGitHubRawUrl(url);
          if (!gh) { safeToast("Shared file URL must be a GitHub raw URL (raw.githubusercontent.com/...).", { type: "error" }); return; }
          btn.disabled = true;
          pushToGitHub(token, gh, btn);
        }
        document.addEventListener("click", onPushClick, true);
        var autoPushTimer = null;
        var AUTO_PUSH_DEBOUNCE_MS = 3000;
        function doAutoPush() {
          if (window.ganttStorage && window.ganttStorage.isCloudEnabled && window.ganttStorage.isCloudEnabled()) return;
          if (!isSynced()) return;
          var token;
          try { token = localStorage.getItem(GITHUB_TOKEN_KEY); } catch (e) { return; }
          if (!token || !token.trim()) return;
          var url;
          try { url = localStorage.getItem(SHARED_FILE_URL_KEY); } catch (e) { return; }
          var gh = parseGitHubRawUrl(url);
          if (!gh) return;
          pushToGitHub(token.trim(), gh, null);
        }
        function scheduleAutoPush() {
          clearTimeout(autoPushTimer);
          autoPushTimer = setTimeout(doAutoPush, AUTO_PUSH_DEBOUNCE_MS);
        }
        window.notifySharedDataChanged = scheduleAutoPush;
      }
      window.addEventListener("hashchange", () => handleRoute());
      async function createNewSharedBoard() {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
        if (!window.ganttStorage?.isCloudEnabled()) {
          if (typeof showToast === "function") showToast("Log in to create shared boards that sync in realtime.", { type: "error" });
          return;
        }
        let session = null;
        try {
          session = await window.ganttStorage.getSession();
        } catch (e) {}
        if (!session) {
          if (typeof showToast === "function") showToast("Session expired or not logged in. Please log in again.", { type: "error" });
          if (typeof window.openGanttAuthModal === "function") window.openGanttAuthModal();
          return;
        }
        const name = getUniqueProjectName("Shared Board");
        let newId;
        try {
          newId = await window.ganttStorage.createBoard(name);
        } catch (err) {
          if (typeof showToast === "function") showToast("Could not create shared board. If you were logged out, try logging in again (Settings → Clear saved session if login fails).", { type: "error" });
          return;
        }
        if (newId) {
          try {
            ensureProjectInList(newId, name);
            location.hash = "#/project/" + newId;
            if (typeof handleRoute === "function") await handleRoute();
            if (typeof showToast === "function") showToast("Shared board created. Use the Share button (↑) to invite collaborators.");
          } catch (navErr) {
            if (typeof showToast === "function") showToast("Board created but navigation failed. Open it from your boards list.", { type: "error" });
            if (typeof renderHomeView === "function") renderHomeView();
          }
        } else {
          if (typeof showToast === "function") showToast("Could not create shared board. Try logging in again (Settings → Storage → Clear saved session if needed).", { type: "error" });
        }
      }
      async function createNewProject() {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
        if (window.ganttStorage?.isCloudEnabled()) {
          const name = getUniqueProjectName("My Board");
          let newId;
          try {
            newId = await window.ganttStorage.createBoard(name);
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create project. Try again or log out and back in.", { type: "error" });
            return;
          }
          if (newId) {
            ensureProjectInList(newId, name);
            location.hash = "#/project/" + newId;
            if (typeof handleRoute === "function") await handleRoute();
          } else {
            if (typeof showToast === "function") showToast("Could not create project. Check connection or try logging out and back in.", { type: "error" });
          }
          return;
        }
        const newId = "p-" + Date.now();
        ensureProjectInList(newId, getUniqueProjectName("My Board"));
        location.hash = "#/project/" + newId;
        if (typeof handleRoute === "function") await handleRoute();
      }
      function buildSampleTasksForNewBoard(phases, baseDate) {
        const WEEK_MS_LOCAL = 7 * 24 * 60 * 60 * 1000;
        const DAY_MS_LOCAL = 24 * 60 * 60 * 1000;
        const sampleTaskNames = ["Research", "Design", "Review", "Build", "Launch"];
        const n = Math.min(sampleTaskNames.length, Math.max(1, phases.length));
        const sampleTasks = [];
        let startWeekOffset = 0;
        for (let i = 0; i < n; i++) {
          const phaseIdx = Math.min(i, phases.length - 1);
          const p = phases[phaseIdx];
          const sprints = Math.max(1, parseInt(p.sprints, 10) || 2);
          const spanWeeks = sprints * 2;
          const startDate = new Date(baseDate.getTime() + startWeekOffset * WEEK_MS_LOCAL);
          const endDate = new Date(baseDate.getTime() + (startWeekOffset + spanWeeks) * WEEK_MS_LOCAL - DAY_MS_LOCAL);
          sampleTasks.push({
            task: sampleTaskNames[i],
            phase: p.id,
            party: "Unassigned",
            status: "Not started",
            star: false,
            overview: "",
            subTasks: [],
            blockers: [],
            links: [],
            dependsOn: i === 0 ? null : i - 1,
            startDate,
            endDate
          });
          startWeekOffset += spanWeeks;
        }
        sampleTasks.forEach(function (t) {
          t.start = (t.startDate.getMonth() + 1) + "/" + t.startDate.getDate();
          t.end = (t.endDate.getMonth() + 1) + "/" + t.endDate.getDate();
        });
        return sampleTasks;
      }
      async function createNewLinkedBoard() {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return;
        const defaultPhases = DEFAULT_PHASES.map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373", sprints: 2 }; });
        const baseDate = new Date();
        baseDate.setHours(0, 0, 0, 0);
        const sampleTasks = buildSampleTasksForNewBoard(defaultPhases, baseDate);
        const toSave = sampleTasks.map(function (t) {
          return {
            task: t.task,
            phase: t.phase,
            phaseSecondary: null,
            party: t.party,
            start: t.start,
            end: t.end,
            startDate: t.startDate ? t.startDate.toISOString() : null,
            endDate: t.endDate ? t.endDate.toISOString() : null,
            star: t.star,
            overview: t.overview || "",
            subTasks: t.subTasks || [],
            blockers: t.blockers || [],
            links: t.links || [],
            dependsOn: typeof t.dependsOn === "number" ? t.dependsOn : null
          };
        });
        if (window.ganttStorage?.isCloudEnabled()) {
          const name = getUniqueProjectName("My Linked Board");
          let newId;
          try {
            newId = await window.ganttStorage.createBoard(name);
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create project. Try again or log out and back in.", { type: "error" });
            return;
          }
          if (newId) {
            try {
              await window.ganttStorage.saveTasks(newId, toSave);
            } catch (e) { console.warn("Could not save sample tasks:", e); }
            ensureProjectInList(newId, name);
            location.hash = "#/project/" + newId;
            if (typeof handleRoute === "function") await handleRoute();
          } else {
            if (typeof showToast === "function") showToast("Could not create project. Check connection or try logging out and back in.", { type: "error" });
          }
          return;
        }
        const newId = "p-" + Date.now();
        try {
          localStorage.setItem("gantt-tasks-" + newId, JSON.stringify(toSave));
          if (window.notifySharedDataChanged) window.notifySharedDataChanged();
        } catch (e) { console.warn("Could not save sample tasks:", e); }
        ensureProjectInList(newId, getUniqueProjectName("My Linked Board"));
        location.hash = "#/project/" + newId;
        if (typeof handleRoute === "function") await handleRoute();
      }
      function smartMapColumns(headers) {
        if (!headers) return { task: 0, start: null, end: null, party: null, phase: null, status: null };
        var normalized = headers.map(function (h) {
          if (h instanceof Date) return "";
          return (h == null ? "" : String(h)).toLowerCase().replace(/\s+/g, " ").trim();
        });
        var map = { task: null, start: null, end: null, party: null, phase: null, status: null };
        /* Reference layout: Col A = Phase, B = Task, C = Status, D = Start date, E = (e.g. Duration), F = End date. Mapping is by header text. */
        var taskPatterns = ["task", "name", "title", "activity", "item", "description", "work package", "wbs", "summary"];
        var startPatterns = ["start", "begin", "from", "planned start", "start date", "started", "baseline start"];
        var endPatterns = ["end", "finish", "to", "due", "deadline", "planned end", "end date", "completed", "finish date", "target end"];
        var partyPatterns = ["assignee", "owner", "responsible", "person", "team", "who", "resource", "member"];
        var phasePatterns = ["phase", "stage", "category", "milestone"];
        var statusPatterns = ["status", "state", "progress", "completion", "stats"];
        function headerMatches(n, patterns) {
          if (!n) return false;
          for (var p = 0; p < patterns.length; p++) {
            if (n.indexOf(patterns[p]) !== -1 || patterns[p].indexOf(n) !== -1) return true;
          }
          return false;
        }
        function bestMatch(patterns) {
          for (var i = 0; i < normalized.length; i++) {
            if (headerMatches(normalized[i], patterns)) return i;
          }
          return null;
        }
        for (var i = 0; i < normalized.length; i++) {
          var n = normalized[i];
          if (!n) continue;
          if (map.phase === null && headerMatches(n, phasePatterns)) map.phase = i;
          else if (map.task === null && headerMatches(n, taskPatterns)) map.task = i;
          else if (map.status === null && headerMatches(n, statusPatterns)) map.status = i;
          else if (map.start === null && headerMatches(n, startPatterns)) map.start = i;
          else if (map.end === null && headerMatches(n, endPatterns)) map.end = i;
          else if (map.party === null && headerMatches(n, partyPatterns)) map.party = i;
        }
        if (map.phase === null) map.phase = bestMatch(phasePatterns);
        if (map.task === null) map.task = bestMatch(taskPatterns);
        if (map.status === null) map.status = bestMatch(statusPatterns);
        if (map.start === null) map.start = bestMatch(startPatterns);
        if (map.end === null) map.end = bestMatch(endPatterns);
        if (map.party === null) map.party = bestMatch(partyPatterns);
        /* Do not fallback party to column 0 — if no assignee column is detected, leave null so rows get "Unassigned" and phase content is not used as team member. */
        if (map.task === null && headers.length > 0) map.task = 0;
        return map;
      }
      function normalizeExcelStatus(val) {
        if (val == null || val === "") return "Not started";
        var s = String(val).trim().toLowerCase();
        if (s === "complete" || s === "completed" || s === "done" || s === "finished") return "Done";
        if (s === "in progress" || s === "in-progress" || s === "inprogress") return "In progress";
        if (s === "blocked") return "Blocked";
        if (s === "not started" || s === "pending") return "Not started";
        return "Not started";
      }
      function scoreHeaderRow(candidateHeaders) {
        var normalized = candidateHeaders.map(function (h) { return (h == null ? "" : String(h)).toLowerCase().replace(/\s+/g, " ").trim(); });
        var map = smartMapColumns(candidateHeaders);
        var score = 0;
        if (map.task != null) score += 2;
        if (map.start != null) score += 1;
        if (map.end != null) score += 1;
        if (map.phase != null) score += 1;
        if (map.status != null) score += 1;
        if (map.party != null) score += 1;
        var refPhase = normalized[0] && (normalized[0].indexOf("phase") !== -1 || normalized[0].indexOf("stage") !== -1);
        var refTask = normalized[1] && (normalized[1].indexOf("task") !== -1 || normalized[1].indexOf("name") !== -1 || normalized[1].indexOf("title") !== -1);
        var refStatus = normalized[2] && (normalized[2].indexOf("status") !== -1 || normalized[2].indexOf("state") !== -1 || normalized[2].indexOf("stats") !== -1);
        var refStart = normalized[3] && (normalized[3].indexOf("start") !== -1 || normalized[3].indexOf("begin") !== -1);
        var refEnd = (normalized[4] && (normalized[4].indexOf("end") !== -1 || normalized[4].indexOf("finish") !== -1)) || (normalized[5] && (normalized[5].indexOf("end") !== -1 || normalized[5].indexOf("finish") !== -1));
        if (refPhase && refTask && (refStatus || refStart)) score += 4;
        return score;
      }
      function detectExcelHeaderRow(aoa) {
        var maxScore = 0;
        var bestRow = 0;
        var maxRowsToTry = Math.min(15, aoa.length - 1);
        for (var r = 0; r <= maxRowsToTry; r++) {
          var row = aoa[r];
          if (!row || !row.length) continue;
          var headers = row.map(function (c) { return c != null ? String(c).trim() : ""; });
          var score = scoreHeaderRow(headers);
          if (score > maxScore) {
            maxScore = score;
            bestRow = r;
          }
        }
        return bestRow;
      }
      var EXCEL_PHASE_COLORS = ["#EAB308", "#0D9488", "#0284C7", "#14B8A6", "#6366F1", "#F97316", "#E11D48", "#7C3AED"];
      function isExcelDateLike(val) {
        if (val == null || val === "") return false;
        if (val instanceof Date) return true;
        if (typeof val === "number" && val > 1000) return true;
        var s = String(val).trim();
        if (/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s/i.test(s)) return true;
        if (/^\d{4}-\d{2}-\d{2}/.test(s) || /^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) return true;
        if (/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2}/i.test(s)) return true;
        return false;
      }
      function isExcelTaskRow(row, columnMap) {
        if (columnMap.task == null) return true;
        var cell = row[columnMap.task];
        if (cell instanceof Date) return false;
        if (cell == null || cell === "") return true;
        var s = String(cell).trim();
        if (!s) return true;
        if (isExcelDateLike(cell)) return false;
        if (/^[MTWFS]$/i.test(s) || s === "TH" || /^[MTWTFSS]\s*$/i.test(s)) return false;
        return true;
      }
      function excelCellEmpty(val) {
        if (val == null || val === "") return true;
        if (typeof val === "string" && val.trim() === "") return true;
        return false;
      }
      function isExcelRowEmpty(row, columnMap) {
        var taskEmpty = columnMap.task == null || excelCellEmpty(row[columnMap.task]);
        var phaseEmpty = columnMap.phase == null || excelCellEmpty(row[columnMap.phase]);
        var startEmpty = columnMap.start == null || excelCellEmpty(row[columnMap.start]);
        var endEmpty = columnMap.end == null || excelCellEmpty(row[columnMap.end]);
        return taskEmpty && phaseEmpty && startEmpty && endEmpty;
      }
      function buildPhasesFromExcelRows(rows, columnMap) {
        var phaseCol = columnMap.phase;
        var seen = {};
        var order = [];
        if (phaseCol != null && rows.length > 0) {
          for (var r = 0; r < rows.length; r++) {
            var val = rows[r][phaseCol];
            if (val instanceof Date || isExcelDateLike(val)) continue;
            var name = (val != null && val !== "") ? String(val).trim() : "";
            if (name && !seen[name.toLowerCase()]) {
              seen[name.toLowerCase()] = true;
              order.push(name);
            }
          }
        }
        if (order.length === 0) {
          return [{ id: "discovery", name: "Discovery", color: EXCEL_PHASE_COLORS[0], sprints: 2 }];
        }
        var slug = typeof slugify === "function" ? slugify : function (t) { return String(t || "").trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "") || "phase"; };
        return order.map(function (name, i) {
          var id = slug(name) || "phase-" + i;
          return { id: id, name: name, color: EXCEL_PHASE_COLORS[i % EXCEL_PHASE_COLORS.length], sprints: 2 };
        });
      }
      function parseExcelDate(val, baseDate) {
        if (val == null || val === "") return null;
        if (val instanceof Date) return val;
        if (typeof val === "number") {
          var d = new Date((val - 25569) * 86400 * 1000);
          return isNaN(d.getTime()) ? null : d;
        }
        var s = String(val).trim();
        if (!s) return null;
        var m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10));
        m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (m) return new Date(parseInt(m[3], 10), parseInt(m[1], 10) - 1, parseInt(m[2], 10));
        m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})/);
        if (m) return new Date(parseInt(m[3], 10), parseInt(m[2], 10) - 1, parseInt(m[1], 10));
        m = s.match(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{1,2})(?:\s|$|,)/i);
        if (m) {
          var months = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11 };
          var mon = months[m[1].toLowerCase().substring(0, 3)];
          var day = parseInt(m[2], 10);
          var year = (baseDate && baseDate.getFullYear) ? baseDate.getFullYear() : new Date().getFullYear();
          return new Date(year, mon, day);
        }
        var parsed = Date.parse(s);
        return isNaN(parsed) ? null : new Date(parsed);
      }
      function excelRowsToTasks(rows, columnMap, phases) {
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var fileMinDate = null;
        var fileMaxDate = null;
        var fileYear = null;
        for (var r = 0; r < rows.length; r++) {
          if (typeof isExcelTaskRow === "function" && !isExcelTaskRow(rows[r], columnMap)) continue;
          if (typeof isExcelRowEmpty === "function" && isExcelRowEmpty(rows[r], columnMap)) continue;
          var s = columnMap.start != null ? parseExcelDate(rows[r][columnMap.start], today) : null;
          var e = columnMap.end != null ? parseExcelDate(rows[r][columnMap.end], today) : null;
          if (s) { fileMinDate = fileMinDate == null ? s : (s < fileMinDate ? s : fileMinDate); fileMaxDate = fileMaxDate == null ? s : (s > fileMaxDate ? s : fileMaxDate); if (fileYear == null) fileYear = s.getFullYear(); }
          if (e) { fileMinDate = fileMinDate == null ? e : (e < fileMinDate ? e : fileMinDate); fileMaxDate = fileMaxDate == null ? e : (e > fileMaxDate ? e : fileMaxDate); if (fileYear == null) fileYear = e.getFullYear(); }
        }
        var baseDate = (fileMinDate && fileMinDate.getTime()) ? new Date(fileMinDate.getTime()) : new Date(today.getTime());
        baseDate.setHours(0, 0, 0, 0);
        if (fileYear != null) baseDate.setFullYear(fileYear);
        var phaseByName = {};
        phases.forEach(function (p) { phaseByName[p.name.toLowerCase().trim()] = p.id; });
        var lastPhaseId = (phases[0] && phases[0].id) || "discovery";
        var taskIndex = 0;
        var defaultStart = fileMinDate ? new Date(fileMinDate.getTime()) : new Date(today.getTime());
        defaultStart.setHours(0, 0, 0, 0);
        return rows.reduce(function (acc, row, idx) {
          if (typeof isExcelTaskRow === "function" && !isExcelTaskRow(row, columnMap)) return acc;
          if (typeof isExcelRowEmpty === "function" && isExcelRowEmpty(row, columnMap)) return acc;
          taskIndex += 1;
          var rawTask = columnMap.task != null ? row[columnMap.task] : null;
          var taskName = (rawTask != null && !(rawTask instanceof Date)) ? String(rawTask).trim() : "";
          if (isExcelDateLike(taskName)) taskName = "";
          if (!taskName) taskName = "Task " + taskIndex;
          var startDate = columnMap.start != null ? parseExcelDate(row[columnMap.start], baseDate) : null;
          var endDate = columnMap.end != null ? parseExcelDate(row[columnMap.end], baseDate) : null;
          if (!startDate && endDate) startDate = new Date(endDate.getTime());
          if (startDate && !endDate) endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000);
          if (!startDate) {
            startDate = new Date(defaultStart.getTime() + (acc.length * 7) * 24 * 60 * 60 * 1000);
            endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000 - 1);
          }
          var phaseValCell = columnMap.phase != null ? row[columnMap.phase] : null;
          if (phaseValCell instanceof Date || isExcelDateLike(phaseValCell)) phaseValCell = null;
          var phaseVal = (phaseValCell != null && phaseValCell !== "") ? String(phaseValCell).trim() : "";
          var rawParty = (columnMap.party != null && row[columnMap.party] != null) ? String(row[columnMap.party]).trim() : "";
          /* Never use phase content as team member: if party value matches this row's phase or any known phase name, treat as empty. */
          var party = "Unassigned";
          if (rawParty) {
            var rawLower = rawParty.toLowerCase();
            var isPhaseName = phaseVal && rawLower === phaseVal.toLowerCase();
            if (!isPhaseName && phases.length) {
              for (var pi = 0; pi < phases.length; pi++) {
                if (phases[pi].name && rawLower === String(phases[pi].name).trim().toLowerCase()) { isPhaseName = true; break; }
              }
            }
            if (!isPhaseName) party = rawParty;
          }
          if (phaseVal) {
            var resolved = phaseByName[phaseVal.toLowerCase()];
            if (resolved) lastPhaseId = resolved;
          }
          var phaseId = phaseVal ? (phaseByName[phaseVal.toLowerCase()] || lastPhaseId) : lastPhaseId;
          var statusVal = (columnMap.status != null && row[columnMap.status] != null) ? String(row[columnMap.status]).trim() : "";
          var status = typeof normalizeExcelStatus === "function" ? normalizeExcelStatus(statusVal) : "Not started";
          startDate.setHours(0, 0, 0, 0);
          endDate.setHours(23, 59, 59, 999);
          var startStr = (startDate.getMonth() + 1) + "/" + startDate.getDate();
          var endStr = (endDate.getMonth() + 1) + "/" + endDate.getDate();
          acc.push({
            task: taskName,
            phase: phaseId,
            phaseSecondary: null,
            party: party,
            status: status,
            start: startStr,
            end: endStr,
            startDate: startDate.toISOString(),
            endDate: endDate.toISOString(),
            star: false,
            overview: "",
            subTasks: [],
            blockers: [],
            links: [],
            dependsOn: null
          });
          return acc;
        }, []);
      }
      function toYYYYMMDDFromTask(dateVal) {
        if (!dateVal) return null;
        var d = typeof dateVal === "string" ? new Date(dateVal) : dateVal;
        if (isNaN(d.getTime())) return null;
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, "0");
        var day = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + day;
      }
      async function createNewBoardFromExcel(toSave, phasesFromExcel, boardNameFromFile) {
        if (typeof window.hasWriteAccess === "function" && !window.hasWriteAccess()) return null;
        var defaultPhases = phasesFromExcel && phasesFromExcel.length > 0
          ? phasesFromExcel.map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373", sprints: p.sprints != null ? p.sprints : 2 }; })
          : (typeof DEFAULT_PHASES !== "undefined" ? DEFAULT_PHASES : []).map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373", sprints: 2 }; });
        if (defaultPhases.length === 0) defaultPhases = [{ id: "discovery", name: "Discovery", color: "#EAB308", sprints: 2 }];
        var baseName = (boardNameFromFile && String(boardNameFromFile).trim()) ? String(boardNameFromFile).trim().replace(/\.(xlsx|xls|csv)$/i, "") : "From Excel";
        var projectStartDate = null;
        var projectEndDate = null;
        if (toSave && toSave.length > 0) {
          var minStart = null;
          var maxEnd = null;
          for (var i = 0; i < toSave.length; i++) {
            var t = toSave[i];
            if (t.startDate) {
              var sd = typeof t.startDate === "string" ? new Date(t.startDate) : t.startDate;
              if (!isNaN(sd.getTime())) { minStart = minStart ? (sd.getTime() < minStart.getTime() ? sd : minStart) : new Date(sd.getTime()); }
            }
            if (t.endDate) {
              var ed = typeof t.endDate === "string" ? new Date(t.endDate) : t.endDate;
              if (!isNaN(ed.getTime())) { maxEnd = maxEnd ? (ed.getTime() > maxEnd.getTime() ? ed : maxEnd) : new Date(ed.getTime()); }
            }
          }
          projectStartDate = toYYYYMMDDFromTask(minStart);
          projectEndDate = toYYYYMMDDFromTask(maxEnd);
        }
        var initialSettings = { phases: defaultPhases, phaseDurationMode: "dynamic" };
        if (projectStartDate) initialSettings.projectStartDate = projectStartDate;
        if (projectEndDate) initialSettings.projectEndDate = projectEndDate;
        if (window.ganttStorage && window.ganttStorage.isCloudEnabled()) {
          var name = getUniqueProjectName(baseName);
          var newId;
          try {
            newId = await window.ganttStorage.createBoard(name);
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create project. Try again or log out and back in.", { type: "error" });
            return null;
          }
          if (newId) {
            try {
              await window.ganttStorage.saveTasks(newId, toSave);
              if (typeof window.ganttStorage.saveSettings === "function") window.ganttStorage.saveSettings(newId, initialSettings);
            } catch (e) { console.warn("Could not save tasks:", e); }
            ensureProjectInList(newId, name);
            return newId;
          }
          if (typeof showToast === "function") showToast("Could not create project.", { type: "error" });
          return null;
        }
        var newId = "p-" + Date.now();
        try {
          localStorage.setItem("gantt-tasks-" + newId, JSON.stringify(toSave));
          localStorage.setItem("gantt-settings-" + newId, JSON.stringify(initialSettings));
          if (window.notifySharedDataChanged) window.notifySharedDataChanged();
        } catch (e) { console.warn("Could not save:", e); }
        ensureProjectInList(newId, getUniqueProjectName(baseName));
        return newId;
      }
      var excelSyncModalData = { rows: null, headers: null, columnMap: null, fileName: null };
      function openExcelSyncModal() {
        var overlay = document.getElementById("excelSyncModalOverlay");
        var stepUpload = document.getElementById("excelSyncStepUpload");
        var stepMap = document.getElementById("excelSyncStepMap");
        var stepPreview = document.getElementById("excelSyncStepPreview");
        var fileInput = document.getElementById("excelSyncFileInput");
        var errorEl = document.getElementById("excelSyncError");
        if (!overlay) {
          if (typeof showToast === "function") showToast("Excel sync modal not found.", { type: "error" });
          return;
        }
        if (!stepUpload || !stepPreview || !fileInput) {
          if (typeof showToast === "function") showToast("Excel sync setup error. Refresh the page.", { type: "error" });
          return;
        }
        excelSyncModalData.rows = null;
        excelSyncModalData.headers = null;
        excelSyncModalData.columnMap = null;
        excelSyncModalData.fileName = null;
        stepUpload.style.display = "";
        if (stepMap) stepMap.style.display = "none";
        stepPreview.style.display = "none";
        if (errorEl) { errorEl.style.display = "none"; errorEl.textContent = ""; }
        if (fileInput) fileInput.value = "";
        overlay.style.display = "flex";
        overlay.classList.add("visible");
        overlay.setAttribute("aria-hidden", "false");
      }
      function closeExcelSyncModal() {
        var overlay = document.getElementById("excelSyncModalOverlay");
        if (overlay) {
          overlay.style.display = "";
          overlay.classList.remove("visible");
          overlay.setAttribute("aria-hidden", "true");
        }
      }
      window.openExcelSyncModal = openExcelSyncModal;
      window.closeExcelSyncModal = closeExcelSyncModal;
      (function initExcelSyncModal() {
        var overlay = document.getElementById("excelSyncModalOverlay");
        var fileInput = document.getElementById("excelSyncFileInput");
        var stepUpload = document.getElementById("excelSyncStepUpload");
        var stepMap = document.getElementById("excelSyncStepMap");
        var stepPreview = document.getElementById("excelSyncStepPreview");
        var mapGrid = document.getElementById("excelSyncMapGrid");
        var rowCountEl = document.getElementById("excelSyncRowCount");
        var mappingSummaryEl = document.getElementById("excelSyncMappingSummary");
        var previewTable = document.getElementById("excelSyncPreviewTable");
        var chooseAnother = document.getElementById("excelSyncChooseAnother");
        var createBoardBtn = document.getElementById("excelSyncCreateBoard");
        var closeBtn = document.getElementById("excelSyncModalClose");
        var errorEl = document.getElementById("excelSyncError");
        var fileLabel = document.querySelector(".excel-sync-file-label-inner");
        var EXCEL_MAP_FIELDS = [
          { key: "task", label: "Task", required: true },
          { key: "start", label: "Start date", required: false },
          { key: "end", label: "End date", required: false },
          { key: "party", label: "Responsible", required: false },
          { key: "phase", label: "Phase", required: false },
          { key: "status", label: "Status", required: false }
        ];
        function mappingIsPoor(map) {
          return map && map.task === null;
        }
        function indexToExcelColLetter(i) {
          var letter = "";
          do {
            letter = String.fromCharCode(65 + (i % 26)) + letter;
            i = Math.floor(i / 26) - 1;
          } while (i >= 0);
          return letter || "A";
        }
        function buildExcelSyncMapGrid() {
          if (!mapGrid) return;
          var headers = excelSyncModalData.headers || [];
          var rows = excelSyncModalData.rows || [];
          var numCols = headers.length;
          if (rows.length > 0) {
            var maxCol = rows.reduce(function (max, row) {
              var keys = Object.keys(row).filter(function (k) { return /^\d+$/.test(k); }).map(Number);
              var rowMax = keys.length ? Math.max.apply(null, keys) + 1 : 0;
              return Math.max(max, rowMax);
            }, 0);
            if (maxCol > numCols) numCols = maxCol;
          }
          var map = excelSyncModalData.columnMap || { task: null, start: null, end: null, party: null, phase: null, status: null };
          mapGrid.innerHTML = "";
          EXCEL_MAP_FIELDS.forEach(function (f) {
            var row = document.createElement("div");
            row.className = "excel-sync-map-row";
            var label = document.createElement("label");
            label.textContent = f.label;
            if (f.required) {
              var req = document.createElement("span");
              req.className = "excel-sync-map-required";
              req.textContent = " (required)";
              label.appendChild(req);
            }
            var sel = document.createElement("select");
            sel.setAttribute("data-map-key", f.key);
            var optNone = document.createElement("option");
            optNone.value = "";
            optNone.textContent = "\u2014 Don't map";
            sel.appendChild(optNone);
            for (var i = 0; i < numCols; i++) {
              var h = headers[i];
              var hasHeader = h != null && h !== "" && String(h).trim() !== "";
              var colLetter = indexToExcelColLetter(i);
              var labelText = hasHeader ? colLetter + " — " + (String(h).trim()) : "Column " + colLetter;
              var opt = document.createElement("option");
              opt.value = String(i);
              opt.textContent = labelText;
              if (map[f.key] === i) opt.selected = true;
              sel.appendChild(opt);
            }
            row.appendChild(label);
            row.appendChild(sel);
            mapGrid.appendChild(row);
          });
        }
        function readExcelSyncMapFromGrid() {
          if (!mapGrid) return;
          var map = { task: null, start: null, end: null, party: null, phase: null, status: null };
          mapGrid.querySelectorAll("select[data-map-key]").forEach(function (sel) {
            var key = sel.getAttribute("data-map-key");
            var val = sel.value;
            if (val !== "") map[key] = parseInt(val, 10);
          });
          excelSyncModalData.columnMap = map;
        }
        function fillExcelSyncPreview() {
          var map = excelSyncModalData.columnMap || {};
          var headers = excelSyncModalData.headers || [];
          var parts = [];
          function colLabel(idx) {
            var h = headers[idx];
            if (h != null && h !== "" && String(h).trim() !== "") return String(h).trim();
            return "Column " + (typeof indexToExcelColLetter === "function" ? indexToExcelColLetter(idx) : String(idx));
          }
          if (map.task != null) parts.push("Task \u2192 " + colLabel(map.task));
          if (map.start != null) parts.push("Start \u2192 " + colLabel(map.start));
          if (map.end != null) parts.push("End \u2192 " + colLabel(map.end));
          if (map.party != null) parts.push("Assignee \u2192 " + colLabel(map.party));
          if (map.phase != null) parts.push("Phase \u2192 " + colLabel(map.phase));
          if (map.status != null) parts.push("Status \u2192 " + colLabel(map.status));
          if (rowCountEl) rowCountEl.textContent = excelSyncModalData.rows.length;
          if (mappingSummaryEl) mappingSummaryEl.textContent = parts.length ? parts.join("; ") : "None selected.";
          if (previewTable) {
            var headersForPreview = headers.slice();
            var numCols = headersForPreview.length;
            if (excelSyncModalData.rows.length > 0) {
              var maxCol = excelSyncModalData.rows.reduce(function (max, row) {
                var keys = Object.keys(row).filter(function (k) { return /^\d+$/.test(k); }).map(Number);
                var rowMax = keys.length ? Math.max.apply(null, keys) + 1 : 0;
                return Math.max(max, rowMax);
              }, 0);
              if (maxCol > numCols) numCols = maxCol;
              while (headersForPreview.length < numCols) {
                headersForPreview.push("");
              }
            }
            if (numCols === 0 && excelSyncModalData.rows.length > 0 && excelSyncModalData.rows[0]) {
              var keys = Object.keys(excelSyncModalData.rows[0]).filter(function (k) { return /^\d+$/.test(k); }).sort(function (a, b) { return parseInt(a, 10) - parseInt(b, 10); });
              numCols = keys.length;
              headersForPreview = keys.map(function (k) {
                return typeof indexToExcelColLetter === "function" ? "Column " + indexToExcelColLetter(parseInt(k, 10)) : "Col " + k;
              });
            }
            var thead = "<tr>";
            for (var hi = 0; hi < numCols; hi++) {
              var h = headersForPreview[hi];
              var thText = (h != null && h !== "" && String(h).trim() !== "") ? String(h).replace(/</g, "&lt;") : ("Column " + (typeof indexToExcelColLetter === "function" ? indexToExcelColLetter(hi) : String(hi)));
              thead += "<th>" + thText + "</th>";
            }
            thead += "</tr>";
            var tbody = "";
            for (var i = 0; i < Math.min(5, excelSyncModalData.rows.length); i++) {
              tbody += "<tr>";
              for (var j = 0; j < numCols; j++) {
                var cell = excelSyncModalData.rows[i][j];
                tbody += "<td>" + (cell != null && cell !== "" ? String(cell).replace(/</g, "&lt;").substring(0, 40) : "\u2014") + "</td>";
              }
              tbody += "</tr>";
            }
            previewTable.innerHTML = thead + tbody;
          }
        }
        function showError(msg) {
          if (errorEl) { errorEl.textContent = msg; errorEl.style.display = "block"; }
        }
        function hideError() {
          if (errorEl) { errorEl.style.display = "none"; errorEl.textContent = ""; }
        }
        function onFileChosen(file) {
          hideError();
          if (!file) return;
          excelSyncModalData.fileName = file.name || null;
          var ext = (file.name || "").toLowerCase();
          var reader = new FileReader();
          reader.onload = function (e) {
            try {
              var data = e.target && e.target.result;
              var wb;
              if (ext.endsWith(".csv")) {
                var csv = typeof data === "string" ? data : new TextDecoder().decode(data);
                var lines = csv.split(/\r?\n/).filter(function (l) { return l.length; });
                var headers = lines.length ? lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(function (c) { return c.replace(/^"|"$/g, "").trim(); }) : [];
                var rows = [];
                for (var i = 1; i < lines.length; i++) {
                  var cells = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(function (c) { return c.replace(/^"|"$/g, "").trim(); });
                  var row = {};
                  headers.forEach(function (h, j) { row[j] = cells[j] !== undefined ? cells[j] : ""; });
                  rows.push(row);
                }
                excelSyncModalData.headers = headers.slice();
                excelSyncModalData.rows = rows;
              } else {
                if (typeof XLSX === "undefined") { showError("Excel library not loaded. Refresh the page."); return; }
                wb = XLSX.read(data, { type: "binary", cellDates: true });
                var firstSheet = wb.SheetNames[0];
                if (!firstSheet) { showError("No sheet found in the file."); return; }
                var sheet = wb.Sheets[firstSheet];
                var aoa = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                if (!aoa.length) { showError("Sheet is empty."); return; }
                var headerRowIndex = typeof detectExcelHeaderRow === "function" ? detectExcelHeaderRow(aoa) : 0;
                var headerRow = aoa[headerRowIndex];
                var headers = (headerRow || []).map(function (c) {
                  if (c instanceof Date) return "";
                  return c != null ? String(c).trim() : "";
                });
                var rows = [];
                for (var r = headerRowIndex + 1; r < aoa.length; r++) {
                  var row = {};
                  (aoa[r] || []).forEach(function (cell, c) { row[c] = cell; });
                  rows.push(row);
                }
                excelSyncModalData.headers = headers;
                excelSyncModalData.rows = rows;
              }
              if (!excelSyncModalData.rows.length) { showError("No data rows found."); return; }
              var phases = (typeof getProjectPhases === "function" && currentProjectId) ? getProjectPhases(currentProjectId) : (typeof DEFAULT_PHASES !== "undefined" ? DEFAULT_PHASES.map(function (p) { return { id: p.id, name: p.name, color: p.color || "#737373" }; }) : [{ id: "discovery", name: "Discovery", color: "#EAB308" }]);
              excelSyncModalData.columnMap = smartMapColumns(excelSyncModalData.headers);
              var map = excelSyncModalData.columnMap;
              stepUpload.style.display = "none";
              if (mappingIsPoor(map)) {
                stepPreview.style.display = "none";
                if (stepMap) {
                  stepMap.style.display = "block";
                  buildExcelSyncMapGrid();
                } else {
                  fillExcelSyncPreview();
                  stepPreview.style.display = "block";
                }
              } else {
                if (stepMap) stepMap.style.display = "none";
                fillExcelSyncPreview();
                stepPreview.style.display = "block";
              }
            } catch (err) {
              showError(err && err.message ? err.message : "Could not read file.");
            }
          };
          if (ext.endsWith(".csv")) reader.readAsText(file);
          else reader.readAsBinaryString(file);
        }
        if (fileInput) {
          fileInput.addEventListener("change", function () {
            var f = fileInput.files && fileInput.files[0];
            onFileChosen(f);
          });
        }
        var fileLabelEl = document.getElementById("excelSyncFileLabel");
        if (fileLabelEl) {
          function isExcelOrCsv(file) {
            if (!file || !file.name) return false;
            var n = file.name.toLowerCase();
            return n.endsWith(".xlsx") || n.endsWith(".xls") || n.endsWith(".csv");
          }
          fileLabelEl.addEventListener("dragenter", function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.dataTransfer && e.dataTransfer.types.indexOf("Files") !== -1) fileLabelEl.classList.add("drag-over");
          });
          fileLabelEl.addEventListener("dragover", function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.dataTransfer) {
              e.dataTransfer.dropEffect = "copy";
              if (e.dataTransfer.types.indexOf("Files") !== -1) fileLabelEl.classList.add("drag-over");
            }
          });
          fileLabelEl.addEventListener("dragleave", function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (!fileLabelEl.contains(e.relatedTarget)) fileLabelEl.classList.remove("drag-over");
          });
          fileLabelEl.addEventListener("drop", function (e) {
            e.preventDefault();
            e.stopPropagation();
            fileLabelEl.classList.remove("drag-over");
            var files = e.dataTransfer && e.dataTransfer.files;
            if (!files || files.length === 0) return;
            var file = files[0];
            if (!isExcelOrCsv(file)) {
              showError("Please drop an Excel or CSV file (.xlsx, .xls, or .csv).");
              return;
            }
            hideError();
            onFileChosen(file);
          });
        }
        /* Do not add a click handler on the label: the label's for="excelSyncFileInput" already triggers the input once; a second click() would open the file dialog twice. */
        if (chooseAnother) chooseAnother.addEventListener("click", function () {
          stepPreview.style.display = "none";
          if (stepMap) stepMap.style.display = "none";
          stepUpload.style.display = "";
          if (fileInput) fileInput.value = "";
          hideError();
        });
        var mapContinueBtn = document.getElementById("excelSyncMapContinue");
        var mapAutoDetectBtn = document.getElementById("excelSyncMapAutoDetect");
        var changeMappingBtn = document.getElementById("excelSyncChangeMapping");
        if (mapContinueBtn) mapContinueBtn.addEventListener("click", function () {
          readExcelSyncMapFromGrid();
          var map = excelSyncModalData.columnMap;
          if (mappingIsPoor(map)) {
            showError("Please map at least the Task column to continue.");
            return;
          }
          hideError();
          if (stepMap) stepMap.style.display = "none";
          fillExcelSyncPreview();
          stepPreview.style.display = "block";
        });
        if (mapAutoDetectBtn) mapAutoDetectBtn.addEventListener("click", function () {
          excelSyncModalData.columnMap = smartMapColumns(excelSyncModalData.headers || []);
          buildExcelSyncMapGrid();
          hideError();
        });
        if (changeMappingBtn) {
          changeMappingBtn.style.display = stepMap ? "" : "none";
          changeMappingBtn.addEventListener("click", function () {
            stepPreview.style.display = "none";
            if (stepMap) {
              stepMap.style.display = "block";
              buildExcelSyncMapGrid();
            }
            hideError();
          });
        }
        if (createBoardBtn) createBoardBtn.addEventListener("click", async function () {
          var rows = excelSyncModalData.rows || [];
          var columnMap = excelSyncModalData.columnMap || {};
          var phases = buildPhasesFromExcelRows(rows, columnMap);
          var toSave = excelRowsToTasks(rows, columnMap, phases);
          var boardName = excelSyncModalData.fileName ? String(excelSyncModalData.fileName).trim().replace(/\.(xlsx|xls|csv)$/i, "").trim() : null;
          try {
            var newId = await createNewBoardFromExcel(toSave, phases, boardName);
            closeExcelSyncModal();
            if (newId) {
              if (typeof location !== "undefined") location.hash = "#/project/" + newId;
              if (typeof handleRoute === "function") await handleRoute();
              var taskCount = toSave ? toSave.length : 0;
              var msg = taskCount === 1
                ? "Board created from Excel. 1 task imported."
                : "Board created from Excel. " + taskCount + " tasks imported.";
              if (typeof showToast === "function") showToast(msg, { type: "success" });
            }
          } catch (err) {
            showError(err && err.message ? err.message : "Could not create board.");
          }
        });
        if (closeBtn) closeBtn.addEventListener("click", closeExcelSyncModal);
        if (overlay) overlay.addEventListener("click", function (e) {
          if (e.target === overlay) closeExcelSyncModal();
        });
      })();
      const homeFabBtn = document.getElementById("homeFab");
      const homeFabMobileBtn = document.getElementById("homeFabMobile");
      const homeNewBoardMenu = document.getElementById("homeNewBoardMenu");
      function closeHomeNewBoardMenu() {
        if (!homeNewBoardMenu) return;
        homeNewBoardMenu.classList.remove("visible");
        homeNewBoardMenu.classList.remove("home-new-board-menu-drop-up");
        if (homeFabBtn) homeFabBtn.setAttribute("aria-expanded", "false");
        if (homeFabMobileBtn) homeFabMobileBtn.setAttribute("aria-expanded", "false");
        document.removeEventListener("click", homeNewBoardMenu._outsideClick);
        document.removeEventListener("keydown", homeNewBoardMenu._escapeKey);
      }
      document.addEventListener("click", async (e) => {
        var trigger = e.target.closest("#homeFab, #homeFabMobile");
        if (!trigger) return;
        const homeView = document.getElementById("homeView");
        if (!homeView?.classList.contains("active")) return;
        e.preventDefault();
        e.stopPropagation();
        if (homeNewBoardMenu?.classList.contains("visible")) {
          closeHomeNewBoardMenu();
          return;
        }
        const triggerEl = trigger.id === "homeFab" ? homeFabBtn : (trigger.id === "homeFabMobile" ? document.getElementById("homeFabMobile") : trigger);
        const rect = triggerEl ? triggerEl.getBoundingClientRect() : null;
        const isMobile = window.matchMedia("(max-width: 768px)").matches;
        homeNewBoardMenu.classList.toggle("home-new-board-menu-drop-up", isMobile);
        if (isMobile && rect) {
          homeNewBoardMenu.style.left = rect.left + "px";
          homeNewBoardMenu.style.right = (window.innerWidth - rect.right) + "px";
          homeNewBoardMenu.style.width = "auto";
          homeNewBoardMenu.style.bottom = (window.innerHeight - rect.top + 8) + "px";
          homeNewBoardMenu.style.top = "auto";
        } else {
          const rightOffset = rect ? Math.max(12, window.innerWidth - rect.right) : 12;
          homeNewBoardMenu.style.right = rightOffset + "px";
          homeNewBoardMenu.style.left = "auto";
          homeNewBoardMenu.style.bottom = "auto";
          homeNewBoardMenu.style.top = (rect ? rect.bottom + 8 : 88) + "px";
          homeNewBoardMenu.style.bottom = "auto";
        }
        const sharedItem = document.getElementById("homeNewBoardSharedItem");
        if (sharedItem) sharedItem.style.display = (window.ganttStorage?.isCloudEnabled() ? "" : "none");
        homeNewBoardMenu.classList.add("visible");
        if (homeFabBtn) homeFabBtn.setAttribute("aria-expanded", "true");
        if (homeFabMobileBtn) homeFabMobileBtn.setAttribute("aria-expanded", "true");
        homeNewBoardMenu._outsideClick = (ev) => {
          if (homeNewBoardMenu.contains(ev.target) || (triggerEl && triggerEl.contains(ev.target))) return;
          closeHomeNewBoardMenu();
        };
        homeNewBoardMenu._escapeKey = (ev) => { if (ev.key === "Escape") closeHomeNewBoardMenu(); };
        setTimeout(() => {
          document.addEventListener("click", homeNewBoardMenu._outsideClick);
          document.addEventListener("keydown", homeNewBoardMenu._escapeKey);
        }, 0);
      });
      homeNewBoardMenu?.addEventListener("click", async (e) => {
        const item = e.target.closest(".fab-phase-menu-item[data-action]");
        if (!item || item.disabled) return;
        e.preventDefault();
        e.stopPropagation();
        const action = item.dataset.action;
        closeHomeNewBoardMenu();
        if (action === "scratch") {
          try {
            await createNewProject();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create project.", { type: "error" });
          }
        } else if (action === "linked") {
          try {
            await createNewLinkedBoard();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create linked board.", { type: "error" });
          }
        } else if (action === "shared") {
          try {
            await createNewSharedBoard();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create shared board.", { type: "error" });
          }
        } else if (action === "excel") {
          try {
            var openModal = window.openExcelSyncModal;
            if (openModal) openModal(); else if (typeof openExcelSyncModal === "function") openExcelSyncModal();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not open Excel sync.", { type: "error" });
          }
        }
      });
      document.addEventListener("click", function (e) {
        var excelBtn = e.target.closest("#homeNewBoardExcelItem");
        if (!excelBtn) return;
        e.preventDefault();
        e.stopPropagation();
        closeHomeNewBoardMenu();
        try {
          if (window.openExcelSyncModal) window.openExcelSyncModal();
          else if (typeof openExcelSyncModal === "function") openExcelSyncModal();
        } catch (err) {
          if (typeof showToast === "function") showToast("Could not open Excel sync.", { type: "error" });
        }
      }, true);
      document.addEventListener("click", async (e) => {
        const actionBtn = e.target.closest(".home-empty-state-action-btn[data-action]");
        if (!actionBtn) return;
        const homeView = document.getElementById("homeView");
        if (!homeView?.classList.contains("active")) return;
        const action = actionBtn.dataset.action;
        if (action === "scratch") {
          try {
            await createNewProject();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create project.", { type: "error" });
          }
        } else if (action === "linked") {
          try {
            await createNewLinkedBoard();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create linked board.", { type: "error" });
          }
        } else if (action === "shared") {
          try {
            await createNewSharedBoard();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not create shared board.", { type: "error" });
          }
        } else if (action === "excel") {
          try {
            if (window.openExcelSyncModal) window.openExcelSyncModal();
            else if (typeof openExcelSyncModal === "function") openExcelSyncModal();
          } catch (err) {
            if (typeof showToast === "function") showToast("Could not open Excel sync.", { type: "error" });
          }
        }
      });
      (function initViewCycling() {
        const viewSelect = document.getElementById("viewMode");
        if (!viewSelect) return;
        const applyView = () => {
          setSavedView(viewSelect.value);
          if (typeof updateWeekWidth === "function") updateWeekWidth();
          if (typeof renderPhaseHeaders === "function") renderPhaseHeaders();
        };
        viewSelect.addEventListener("change", applyView);
        document.addEventListener("keydown", (e) => {
          if (!currentProjectId) return;
          if (e.target.closest("input, select, textarea, [contenteditable]")) return;
          let idx = VIEW_ORDER.indexOf(viewSelect.value);
          if (idx < 0) idx = 2;
          if (e.key === "=" || e.key === "+") {
            e.preventDefault();
            idx = idx > 0 ? idx - 1 : VIEW_ORDER.length - 1;
            viewSelect.value = VIEW_ORDER[idx];
            applyView();
          } else if (e.key === "-") {
            e.preventDefault();
            idx = idx < VIEW_ORDER.length - 1 ? idx + 1 : 0;
            viewSelect.value = VIEW_ORDER[idx];
            applyView();
          }
        });
      })();
      await handleRoute();
      if (getStorageMode() === "supabase" || getStorageMode() === "github") initSharedFile();
      if (typeof window.updateWriteAccessUI === "function") window.updateWriteAccessUI();
      if (typeof window.__doLoadFromStoredUrl === "function") window.__doLoadFromStoredUrl();
      else if (typeof window.__fetchSharedUpdates === "function") window.__fetchSharedUpdates();
      if (typeof window.updateWriteAccessUI === "function") window.updateWriteAccessUI();
    }
    function initLocalBackupHandlers() {
      if (window.__localBackupHandlersInited) return;
      window.__localBackupHandlersInited = true;
      var backupBtn = document.getElementById("localBackupToFile");
      var restoreBtn = document.getElementById("localRestoreFromFile");
      var fileInput = document.getElementById("localRestoreFileInput");
      if (backupBtn) backupBtn.addEventListener("click", function () {
        var snap = exportSharedSnapshot();
        var blob = new Blob([JSON.stringify(snap, null, 2)], { type: "application/json" });
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "gantt-data.json";
        a.click();
        URL.revokeObjectURL(a.href);
        if (typeof showToast === "function") showToast("Backed up to gantt-data.json", { type: "success" });
      });
      if (restoreBtn && fileInput) restoreBtn.addEventListener("click", function () { fileInput.click(); });
      if (fileInput) fileInput.addEventListener("change", function () {
        var f = fileInput.files && fileInput.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function () {
          try {
            var data = JSON.parse(r.result);
            importSharedSnapshot(data);
            if (typeof handleRoute === "function") { location.hash = "#/"; handleRoute(); }
            if (typeof renderHomeView === "function") renderHomeView();
            if (typeof showToast === "function") showToast("Boards restored from file.", { type: "success" });
          } catch (e) { if (typeof showToast === "function") showToast("Restore failed: " + (e && e.message ? e.message : String(e)), { type: "error" }); }
          fileInput.value = "";
        };
        r.readAsText(f);
      });
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", bootstrap);
    } else {
      bootstrap();
    }
  </script>
</body>
</html>
